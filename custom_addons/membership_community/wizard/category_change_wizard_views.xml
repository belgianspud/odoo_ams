<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- CATEGORY CHANGE WIZARD VIEWS -->
        <!-- ========================================== -->

        <!-- Category Change Wizard Form View -->
        <record id="view_category_change_wizard_form" model="ir.ui.view">
            <field name="name">category.change.wizard.form</field>
            <field name="model">category.change.wizard</field>
            <field name="arch" type="xml">
                <form string="Change Member Category">
                    <sheet>
                        <div class="alert alert-info" role="alert" attrs="{'invisible': [('transition_warnings', '=', False)]}">
                            <strong>Warnings:</strong>
                            <field name="transition_warnings" readonly="1" nolabel="1"/>
                        </div>

                        <group>
                            <group string="Current Membership">
                                <field name="subscription_id" readonly="1"/>
                                <field name="partner_id" readonly="1"/>
                                <field name="current_category_id" readonly="1"/>
                                <field name="current_product_id" readonly="1"/>
                                <field name="current_price" readonly="1" widget="monetary"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                            <group string="Change Type">
                                <field name="change_type" widget="radio"/>
                            </group>
                        </group>

                        <group>
                            <group string="New Category">
                                <field name="available_categories" invisible="1"/>
                                <field name="new_category_id" 
                                       domain="[('id', 'in', available_categories)]"
                                       options="{'no_create': True}"/>
                                <field name="is_allowed_transition" invisible="1"/>
                            </group>
                            <group string="Eligibility">
                                <field name="requires_verification" readonly="1"/>
                                <field name="eligibility_verified" 
                                       attrs="{'invisible': [('requires_verification', '=', False)],
                                               'required': [('requires_verification', '=', True)]}"/>
                                <field name="verification_notes" 
                                       placeholder="Notes about eligibility verification..."
                                       attrs="{'invisible': [('requires_verification', '=', False)]}"/>
                            </group>
                        </group>

                        <group attrs="{'invisible': [('new_category_id', '=', False)]}">
                            <field name="eligibility_requirements" readonly="1" nolabel="1" colspan="2"/>
                        </group>

                        <group>
                            <group string="Product Change">
                                <field name="change_product"/>
                                <field name="available_products" invisible="1"/>
                                <field name="new_product_id" 
                                       attrs="{'invisible': [('change_product', '=', False)],
                                               'required': [('change_product', '=', True)]}"
                                       domain="[('id', 'in', available_products)]"
                                       options="{'no_create': True}"/>
                            </group>
                            <group string="Pricing">
                                <field name="discount_percent" readonly="1"/>
                                <field name="new_price" readonly="1" widget="monetary"/>
                                <field name="price_difference" readonly="1" widget="monetary"/>
                            </group>
                        </group>

                        <group>
                            <group string="Billing">
                                <field name="prorate_billing"/>
                                <field name="prorated_amount" 
                                       readonly="1" 
                                       widget="monetary"
                                       attrs="{'invisible': [('prorate_billing', '=', False)]}"/>
                                <field name="create_invoice"/>
                            </group>
                            <group string="Timing">
                                <field name="apply_immediately"/>
                                <field name="effective_date" 
                                       attrs="{'readonly': [('apply_immediately', '=', True)]}"/>
                            </group>
                        </group>

                        <group>
                            <group string="Documentation">
                                <field name="reason" 
                                       placeholder="Explain why the category is being changed..."
                                       required="1"/>
                            </group>
                            <group string="Notifications">
                                <field name="send_notification"/>
                            </group>
                        </group>

                        <group>
                            <field name="internal_notes" 
                                   placeholder="Additional internal notes (not visible to member)..."
                                   colspan="2"
                                   nolabel="1"/>
                        </group>
                    </sheet>

                    <footer>
                        <button string="Change Category" 
                                name="action_change_category" 
                                type="object" 
                                class="btn-primary"
                                attrs="{'invisible': ['|', ('is_allowed_transition', '=', False), ('new_category_id', '=', False)]}"/>
                        <button string="Verify and Change" 
                                name="action_change_category" 
                                type="object" 
                                class="btn-warning"
                                attrs="{'invisible': ['|', ('is_allowed_transition', '=', True), ('new_category_id', '=', False)]}"
                                confirm="This category change has warnings. Are you sure you want to proceed?"/>
                        <button string="Cancel" class="btn-secondary" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Category Change Wizard Action -->
        <record id="action_category_change_wizard" model="ir.actions.act_window">
            <field name="name">Change Member Category</field>
            <field name="res_model">category.change.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
            <field name="binding_model_id" ref="subscription_management.model_subscription_subscription"/>
            <field name="binding_view_types">form</field>
        </record>

    </data>
</odoo>