<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- PARTNER/MEMBER VIEWS (ENHANCED - CORRECTED) -->
        <!-- ========================================== -->

        <!-- Inherited Form View - Add Membership Tab -->
        <record id="view_partner_form_membership" model="ir.ui.view">
            <field name="name">res.partner.form.membership</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="arch" type="xml">
                
                <!-- Add smart buttons -->
                <div name="button_box" position="inside">
                    <button name="action_view_memberships" type="object" 
                            class="oe_stat_button" icon="fa-refresh"
                            invisible="not is_member">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value">
                                <field name="active_membership_count"/>/<field name="membership_count"/>
                            </span>
                            <span class="o_stat_text">Memberships</span>
                        </div>
                    </button>
                </div>

                <!-- Add membership status after name -->
                <field name="function" position="after">
                    <field name="is_member" invisible="1"/>
                    <field name="membership_state" invisible="1"/>
                    <field name="is_lifetime_member" invisible="1"/>
                    <field name="is_emeritus_eligible" invisible="1"/>
                    
                    <div class="badge-container" invisible="not is_member">
                        <span class="badge text-bg-success me-1" invisible="membership_state != 'active'">
                            <i class="fa fa-check-circle"/> Active Member
                        </span>
                        <span class="badge text-bg-info me-1" invisible="membership_state != 'trial'">
                            <i class="fa fa-clock-o"/> Trial
                        </span>
                        <span class="badge text-bg-danger me-1" invisible="membership_state != 'expired'">
                            <i class="fa fa-times-circle"/> Expired
                        </span>
                        <span class="badge text-bg-info me-1" invisible="not is_lifetime_member">
                            <i class="fa fa-star"/> Lifetime
                        </span>
                        <span class="badge text-bg-primary me-1" invisible="not is_emeritus_eligible">
                            <i class="fa fa-graduation-cap"/> Emeritus Eligible
                        </span>
                    </div>
                </field>

                <!-- Add membership page -->
                <xpath expr="//notebook" position="inside">
                    <page string="Membership" name="membership" invisible="not is_member">
                        
                        <!-- Membership Status Section -->
                        <group name="membership_status" string="Membership Status">
                            <group name="status_left">
                                <field name="is_member" readonly="1"/>
                                <field name="member_number" readonly="1"/>
                                <field name="membership_state" widget="badge" 
                                       decoration-success="membership_state == 'active'"
                                       decoration-info="membership_state == 'trial'"
                                       decoration-danger="membership_state == 'expired'"/>
                                <field name="membership_category_id" 
                                       options="{'no_create': True}"/>
                                <field name="member_category_type" readonly="1"/>
                            </group>
                            <group name="status_right">
                                <field name="member_since"/>
                                <field name="membership_start_date" readonly="1"/>
                                <field name="membership_end_date" readonly="1"/>
                                <field name="days_until_expiry" readonly="1" 
                                       invisible="membership_state not in ['active', 'trial']"/>
                            </group>
                        </group>

                        <!-- Lifetime & Emeritus Info Section -->
                        <group name="lifetime_emeritus" string="Lifetime &amp; Emeritus Information"
                               invisible="not is_lifetime_member and not is_emeritus_eligible">
                            <group name="lifetime_left">
                                <field name="birthdate"/>
                                <field name="age" readonly="1"/>
                                <field name="years_of_membership" readonly="1" widget="float"/>
                            </group>
                            <group name="lifetime_right">
                                <field name="is_lifetime_member" readonly="1"/>
                                <field name="is_emeritus_eligible" readonly="1"/>
                                
                                <button name="action_transition_to_emeritus" 
                                        string="Transition to Emeritus" 
                                        type="object" 
                                        class="btn-primary"
                                        invisible="not is_emeritus_eligible"
                                        groups="membership_community.group_membership_manager"/>
                            </group>
                        </group>

                        <!-- Alert for Emeritus Eligibility -->
                        <div class="alert alert-info" role="alert" 
                             invisible="not is_emeritus_eligible">
                            <p class="mb-0">
                                <i class="fa fa-info-circle"/> 
                                <strong>Emeritus Eligible:</strong> This member qualifies for emeritus status 
                                based on age and/or years of membership. Click the button above to transition them.
                            </p>
                        </div>

                        <!-- Primary Subscription Section -->
                        <group name="primary_subscription" string="Primary Subscription"
                               invisible="not primary_membership_id">
                            <group>
                                <field name="primary_membership_id" readonly="1"/>
                            </group>
                            <group>
                                <button name="action_view_memberships" 
                                        string="View Subscription Details" 
                                        type="object" 
                                        class="btn-link"
                                        icon="fa-external-link"/>
                            </group>
                        </group>

                        <!-- Organization Seat Info (for seat members) -->
                        <group name="seat_info" string="Organization Seat Information"
                               invisible="not is_seat_member">
                            <group>
                                <field name="parent_organization_id" readonly="1"/>
                                <field name="seat_subscription_id" readonly="1"/>
                                <field name="is_seat_member" readonly="1"/>
                            </group>
                            <group>
                                <field name="organizational_role"/>
                            </group>
                        </group>

                        <!-- Organizational Members (for organizations with seats) -->
                        <group name="org_members" string="Organization Seat Members"
                               invisible="not child_member_ids">
                            <field name="child_member_ids" nolabel="1">
                                <list>
                                    <field name="name"/>
                                    <field name="email"/>
                                    <field name="organizational_role"/>
                                    <field name="membership_state" widget="badge"
                                           decoration-success="membership_state=='active'"
                                           decoration-info="membership_state=='trial'"
                                           decoration-danger="membership_state=='expired'"/>
                                    <field name="seat_subscription_id"/>
                                </list>
                            </field>
                        </group>

                        <!-- Portal Access -->
                        <group name="portal_access" string="Portal Access">
                            <group>
                                <field name="portal_access_level" readonly="1"/>
                                <field name="has_portal_access" readonly="1"/>
                            </group>
                        </group>

                        <!-- Lifecycle Status -->
                        <group name="lifecycle" string="Lifecycle Status" 
                               invisible="not is_in_grace_period and lifecycle_stage == 'active'">
                            <group>
                                <field name="paid_through_date" readonly="1"/>
                                <field name="grace_period_end_date" readonly="1" 
                                       invisible="not is_in_grace_period"/>
                                <field name="lifecycle_stage" widget="badge" readonly="1"
                                       decoration-success="lifecycle_stage=='active'"
                                       decoration-warning="lifecycle_stage=='grace'"
                                       decoration-danger="lifecycle_stage in ('suspended','terminated')"/>
                            </group>
                            <group>
                                <field name="is_in_grace_period" readonly="1" 
                                       invisible="not is_in_grace_period"/>
                                <field name="days_until_suspension" readonly="1" 
                                       invisible="not is_in_grace_period"/>
                                <field name="days_until_termination" readonly="1" 
                                       invisible="lifecycle_stage not in ('grace','suspended')"/>
                            </group>
                        </group>

                        <!-- Features & Benefits -->
                        <group name="features_benefits" string="Available Features &amp; Benefits">
                            <group name="features">
                                <field name="available_features" widget="many2many_tags"/>
                            </group>
                            <group name="benefits">
                                <field name="available_benefits" widget="many2many_tags"/>
                            </group>
                        </group>

                        <!-- All Subscriptions List -->
                        <separator string="All Membership Subscriptions"/>
                        <field name="membership_subscription_ids" nolabel="1" 
                               context="{'default_partner_id': id}">
                            <list string="Subscriptions" 
                                  decoration-success="state=='active'" 
                                  decoration-info="state=='trial'" 
                                  decoration-muted="state in ('expired','cancelled')">
                                <field name="name"/>
                                <field name="plan_id"/>
                                <field name="membership_category_id"/>
                                <field name="is_seat_subscription" optional="show"/>
                                <field name="state" widget="badge"
                                       decoration-success="state=='active'"
                                       decoration-info="state=='trial'"
                                       decoration-danger="state in ('expired','cancelled')"/>
                                <field name="date_start"/>
                                <field name="date_end"/>
                                <field name="is_lifetime" optional="show"/>
                                <field name="price" sum="Total"/>
                            </list>
                        </field>

                        <!-- Chapter Memberships (if applicable) -->
                        <group name="chapters" string="Chapter Memberships"
                               invisible="not chapter_count">
                            <group>
                                <field name="chapter_count" readonly="1"/>
                                <field name="chapter_memberships" widget="many2many_tags" readonly="1"/>
                            </group>
                            <group>
                                <button name="action_view_eligible_chapters" 
                                        string="View Eligible Chapters" 
                                        type="object" 
                                        class="btn-link"
                                        icon="fa-map-marker"/>
                            </group>
                        </group>

                    </page>
                </xpath>

            </field>
        </record>

        <!-- Members List View -->
        <record id="view_partner_list_members" model="ir.ui.view">
            <field name="name">res.partner.list.members</field>
            <field name="model">res.partner</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <list string="Members">
                    <field name="name" string="Member Name"/>
                    <field name="member_number" optional="show"/>
                    <field name="email"/>
                    <field name="phone"/>
                    <field name="membership_category_id"/>
                    <field name="membership_state" widget="badge"
                           decoration-success="membership_state == 'active'"
                           decoration-info="membership_state == 'trial'"
                           decoration-danger="membership_state == 'expired'"/>
                    <field name="is_lifetime_member" optional="hide"/>
                    <field name="is_emeritus_eligible" optional="hide"/>
                    <field name="is_seat_member" optional="hide"/>
                    <field name="member_since"/>
                    <field name="membership_start_date" optional="hide"/>
                    <field name="membership_end_date"/>
                    <field name="parent_organization_id" optional="hide"/>
                </list>
            </field>
        </record>

        <!-- Members Search View -->
        <record id="view_partner_search_members" model="ir.ui.view">
            <field name="name">res.partner.search.members</field>
            <field name="model">res.partner</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <search string="Members">
                    <field name="name" string="Member Name"/>
                    <field name="member_number"/>
                    <field name="email"/>
                    <field name="membership_category_id"/>
                    
                    <filter string="Active Members" name="active_members" 
                            domain="[('membership_state', '=', 'active')]"/>
                    <filter string="Trial Members" name="trial_members" 
                            domain="[('membership_state', '=', 'trial')]"/>
                    <filter string="Expired Members" name="expired_members" 
                            domain="[('membership_state', '=', 'expired')]"/>
                    
                    <separator/>
                    <filter string="Seat Members" name="seat_members" 
                            domain="[('is_seat_member', '=', True)]"/>
                    <filter string="Organizations with Seats" name="organizations_with_seats" 
                            domain="[('child_member_ids', '!=', False)]"/>
                    
                    <separator/>
                    <filter string="Individual" name="individual_members"
                            domain="[('member_category_type', '=', 'individual')]"/>
                    <filter string="Organizational" name="org_members"
                            domain="[('member_category_type', '=', 'organizational')]"/>
                    <filter string="Emeritus" name="emeritus_members"
                            domain="[('member_category_type', '=', 'emeritus')]"/>
                    <filter string="Honorary" name="honorary_members"
                            domain="[('member_category_type', '=', 'honorary')]"/>
                    
                    <separator/>
                    <filter string="Expiring Soon" name="expiring_soon"
                            domain="[('membership_end_date', '&lt;=', (context_today() + relativedelta(months=1)).strftime('%Y-%m-%d')), ('membership_end_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
                    
                    <group expand="0" string="Group By">
                        <filter string="Membership Category" name="group_category" 
                                context="{'group_by': 'membership_category_id'}"/>
                        <filter string="Membership State" name="group_state" 
                                context="{'group_by': 'membership_state'}"/>
                        <filter string="Member Type" name="group_type" 
                                context="{'group_by': 'member_category_type'}"/>
                        <filter string="Lifecycle Stage" name="group_lifecycle" 
                                context="{'group_by': 'lifecycle_stage'}"/>
                        <filter string="Join Year" name="group_join_year" 
                                context="{'group_by': 'member_since:year'}"/>
                        <filter string="Parent Organization" name="group_parent_org" 
                                context="{'group_by': 'parent_organization_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Members Kanban View -->
        <record id="view_partner_kanban_members" model="ir.ui.view">
            <field name="name">res.partner.kanban.members</field>
            <field name="model">res.partner</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <kanban class="o_res_partner_kanban">
                    <field name="name"/>
                    <field name="member_number"/>
                    <field name="email"/>
                    <field name="phone"/>
                    <field name="membership_category_id"/>
                    <field name="membership_state"/>
                    <field name="is_lifetime_member"/>
                    <field name="is_emeritus_eligible"/>
                    <field name="is_seat_member"/>
                    <field name="member_since"/>
                    <field name="parent_organization_id"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <br/>
                                        <span class="o_kanban_record_subtitle text-muted">
                                            <field name="member_number"/>
                                        </span>
                                        <br/>
                                        <span class="o_kanban_record_subtitle">
                                            <field name="membership_category_id"/>
                                        </span>
                                    </div>
                                    <span class="float-end">
                                        <span t-if="record.membership_state.raw_value == 'active'" 
                                              class="badge text-bg-success">Active</span>
                                        <span t-if="record.membership_state.raw_value == 'trial'" 
                                              class="badge text-bg-info">Trial</span>
                                        <span t-if="record.membership_state.raw_value == 'expired'" 
                                              class="badge text-bg-danger">Expired</span>
                                    </span>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div t-if="record.email.value">
                                        <i class="fa fa-envelope"/> <field name="email"/>
                                    </div>
                                    <div t-if="record.phone.value">
                                        <i class="fa fa-phone"/> <field name="phone"/>
                                    </div>
                                    <div t-if="record.parent_organization_id.value" class="text-muted">
                                        <i class="fa fa-building"/> <field name="parent_organization_id"/>
                                    </div>
                                    <div class="mt-2">
                                        <span t-if="record.is_lifetime_member.raw_value" 
                                              class="badge text-bg-info me-1">
                                            <i class="fa fa-star"/> Lifetime
                                        </span>
                                        <span t-if="record.is_emeritus_eligible.raw_value" 
                                              class="badge text-bg-primary me-1">
                                            <i class="fa fa-graduation-cap"/> Emeritus Eligible
                                        </span>
                                        <span t-if="record.is_seat_member.raw_value" 
                                              class="badge text-bg-warning me-1">
                                            <i class="fa fa-users"/> Seat
                                        </span>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span t-if="record.member_since.value">
                                            Member since <field name="member_since"/>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Members Action -->
        <record id="action_membership_members" model="ir.actions.act_window">
            <field name="name">Members</field>
            <field name="res_model">res.partner</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('is_member', '=', True)]</field>
            <field name="context">{'search_default_active_members': 1}</field>
            <field name="search_view_id" ref="view_partner_search_members"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No members found
                </p>
                <p>
                    Create your first member or convert existing contacts to members.
                </p>
            </field>
        </record>

    </data>
</odoo>