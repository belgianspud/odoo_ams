<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- RES.PARTNER VIEWS (MEMBERSHIP EXTENSIONS) -->
        <!-- ========================================== -->

        <!-- Inherit Partner Form View to Add Membership Info -->
        <record id="view_partner_membership_form" model="ir.ui.view">
            <field name="name">res.partner.membership.form</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="arch" type="xml">
                
                <!-- Add Smart Buttons -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_view_memberships" type="object" class="oe_stat_button" icon="fa-id-card" attrs="{'invisible': [('membership_count', '=', 0)]}">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value"><field name="active_membership_count"/>/<field name="membership_count"/></span>
                            <span class="o_stat_text">Memberships</span>
                        </div>
                    </button>
                    <button name="action_view_subscriptions" type="object" class="oe_stat_button" icon="fa-sync" attrs="{'invisible': [('subscription_count', '=', 0)]}">
                        <field name="subscription_count" widget="statinfo" string="Subscriptions"/>
                    </button>
                    <button name="action_create_membership" type="object" class="oe_stat_button" icon="fa-plus-circle" attrs="{'invisible': [('is_member', '=', True)]}" string="Create Membership"/>
                    <button name="action_renew_membership" type="object" class="oe_stat_button" icon="fa-refresh" attrs="{'invisible': ['|', ('is_member', '=', False), ('membership_renewal_due', '=', False)]}" string="Renew" class="btn-warning"/>
                </xpath>

                <!-- Add Membership Status Ribbon -->
                <xpath expr="//sheet" position="before">
                    <widget name="web_ribbon" title="Active Member" bg_color="bg-success" attrs="{'invisible': [('membership_state', '!=', 'active')]}"/>
                    <widget name="web_ribbon" title="Expired" bg_color="bg-danger" attrs="{'invisible': [('membership_state', '!=', 'expired')]}"/>
                    <widget name="web_ribbon" title="Renewal Due" bg_color="bg-warning" attrs="{'invisible': [('membership_renewal_due', '=', False)]}"/>
                </xpath>

                <!-- Add Membership Fields in Main Form -->
                <xpath expr="//field[@name='category_id']" position="after">
                    <field name="is_member" attrs="{'invisible': [('is_member', '=', False)]}"/>
                    <field name="membership_state" attrs="{'invisible': [('is_member', '=', False)]}"/>
                    <field name="membership_category_id" attrs="{'invisible': [('is_member', '=', False)]}"/>
                </xpath>

                <!-- Add Membership Page in Notebook -->
                <xpath expr="//notebook" position="inside">
                    <page name="membership" string="Membership" attrs="{'invisible': [('membership_count', '=', 0)]}">
                        
                        <group name="membership_summary" string="Membership Summary">
                            <group name="status">
                                <field name="is_member"/>
                                <field name="membership_state"/>
                                <field name="member_since"/>
                                <field name="membership_category_id"/>
                                <field name="member_category_type" readonly="1"/>
                            </group>
                            <group name="dates">
                                <field name="membership_start_date"/>
                                <field name="membership_end_date"/>
                                <field name="days_until_expiry" attrs="{'invisible': [('membership_state', '!=', 'active')]}"/>
                                <field name="membership_renewal_due"/>
                            </group>
                        </group>

                        <group name="classification" string="Classification">
                            <group name="member_types">
                                <field name="is_organizational_member"/>
                                <field name="is_student_member"/>
                                <field name="is_honorary_member"/>
                                <field name="is_retired_member"/>
                            </group>
                            <group name="portal_access">
                                <field name="portal_access_level"/>
                                <field name="has_portal_access"/>
                            </group>
                        </group>

                        <group name="organizational_info" string="Organizational Details" attrs="{'invisible': [('is_seat_member', '=', False)]}">
                            <group>
                                <field name="is_seat_member"/>
                                <field name="parent_organization_id"/>
                                <field name="organizational_role"/>
                            </group>
                            <group>
                                <field name="employee_number"/>
                            </group>
                        </group>

                        <group name="current_membership" string="Current Membership">
                            <field name="current_membership_id" nolabel="1" attrs="{'invisible': [('current_membership_id', '=', False)]}">
                                <tree>
                                    <field name="name"/>
                                    <field name="product_id"/>
                                    <field name="start_date"/>
                                    <field name="end_date"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </group>

                        <separator string="All Memberships"/>
                        <field name="membership_ids" nolabel="1">
                            <tree decoration-success="state=='active'" decoration-muted="state in ('expired','cancelled')">
                                <field name="name"/>
                                <field name="product_id"/>
                                <field name="membership_category_id"/>
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="state"/>
                                <field name="amount" sum="Total"/>
                            </tree>
                        </field>

                        <group name="chapters" string="Chapter Memberships" attrs="{'invisible': [('chapter_count', '=', 0)]}">
                            <field name="chapter_count"/>
                            <field name="chapter_membership_ids" nolabel="1">
                                <tree>
                                    <field name="name"/>
                                    <field name="product_id"/>
                                    <field name="start_date"/>
                                    <field name="end_date"/>
                                    <field name="state"/>
                                </tree>
                            </field>
                        </group>

                        <group name="financial" string="Financial Summary">
                            <group>
                                <field name="total_membership_fees" widget="monetary"/>
                                <field name="current_membership_value" widget="monetary"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </group>

                    </page>

                    <page name="member_features" string="Features &amp; Benefits" attrs="{'invisible': [('is_member', '=', False)]}">
                        
                        <group name="module_features" string="Module Features">
                            <group name="professional">
                                <field name="has_professional_features"/>
                                <field name="has_professional_profile" attrs="{'invisible': [('has_professional_features', '=', False)]}"/>
                                <field name="has_credentials" attrs="{'invisible': [('has_professional_features', '=', False)]}"/>
                                <field name="has_ce_records" attrs="{'invisible': [('has_professional_features', '=', False)]}"/>
                            </group>
                            <group name="organizational">
                                <field name="has_organizational_features"/>
                                <field name="has_organizational_seat" attrs="{'invisible': [('has_organizational_features', '=', False)]}"/>
                            </group>
                        </group>

                        <separator string="Available Features"/>
                        <field name="available_features" nolabel="1" widget="many2many_tags">
                            <tree>
                                <field name="name"/>
                                <field name="category"/>
                                <field name="feature_type"/>
                            </tree>
                        </field>

                        <separator string="Available Benefits"/>
                        <field name="available_benefits" nolabel="1" widget="many2many_tags">
                            <tree>
                                <field name="name"/>
                                <field name="category"/>
                                <field name="benefit_type"/>
                                <field name="monetary_value"/>
                            </tree>
                        </field>

                    </page>

                    <page name="member_engagement" string="Engagement" attrs="{'invisible': [('is_member', '=', False)]}">
                        <group name="engagement_metrics" string="Engagement Metrics">
                            <group>
                                <field name="last_membership_activity"/>
                                <field name="engagement_score" widget="progressbar"/>
                            </group>
                        </group>
                    </page>
                </xpath>

            </field>
        </record>

        <!-- Inherit Partner Tree View -->
        <record id="view_partner_membership_tree" model="ir.ui.view">
            <field name="name">res.partner.membership.tree</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='display_name']" position="after">
                    <field name="is_member" optional="show"/>
                    <field name="membership_state" optional="show"/>
                    <field name="membership_category_id" optional="hide"/>
                    <field name="membership_end_date" optional="hide"/>
                </xpath>
            </field>
        </record>

        <!-- Inherit Partner Search View -->
        <record id="view_partner_membership_search" model="ir.ui.view">
            <field name="name">res.partner.membership.search</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_res_partner_filter"/>
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='customer']" position="after">
                    <separator/>
                    <filter string="Members" name="members" domain="[('is_member', '=', True)]"/>
                    <filter string="Active Members" name="active_members" domain="[('membership_state', '=', 'active')]"/>
                    <filter string="Expired Members" name="expired_members" domain="[('membership_state', '=', 'expired')]"/>
                    <filter string="Renewal Due" name="renewal_due" domain="[('membership_renewal_due', '=', True)]"/>
                    <separator/>
                    <filter string="Individual Members" name="individual_members" domain="[('member_category_type', '=', 'individual')]"/>
                    <filter string="Organizational Members" name="org_members" domain="[('is_organizational_member', '=', True)]"/>
                    <filter string="Student Members" name="student_members" domain="[('is_student_member', '=', True)]"/>
                    <separator/>
                    <filter string="Has Portal Access" name="has_portal" domain="[('has_portal_access', '=', True)]"/>
                    <filter string="Seat Members" name="seat_members" domain="[('is_seat_member', '=', True)]"/>
                </xpath>
                <xpath expr="//group" position="inside">
                    <filter string="Membership State" name="group_membership_state" context="{'group_by': 'membership_state'}"/>
                    <filter string="Member Category" name="group_member_category" context="{'group_by': 'membership_category_id'}"/>
                </xpath>
            </field>
        </record>

        <!-- Member Directory Action -->
        <record id="action_member_directory" model="ir.actions.act_window">
            <field name="name">Member Directory</field>
            <field name="res_model">res.partner</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('is_member', '=', True)]</field>
            <field name="context">{'search_default_active_members': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No members found
                </p>
                <p>
                    The member directory shows all active members of your association.
                </p>
            </field>
        </record>

        <!-- Kanban View for Member Directory -->
        <record id="view_partner_member_directory_kanban" model="ir.ui.view">
            <field name="name">res.partner.member.directory.kanban</field>
            <field name="model">res.partner</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="name"/>
                    <field name="email"/>
                    <field name="phone"/>
                    <field name="is_member"/>
                    <field name="membership_state"/>
                    <field name="membership_category_id"/>
                    <field name="member_since"/>
                    <field name="image_128"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                                <div class="o_kanban_image_fill_left d-none d-md-block" t-attf-style="background-image: url('#{kanban_image('res.partner', 'image_128', record.id.raw_value)}')"/>
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                        </div>
                                        <span class="float-right">
                                            <field name="membership_state" widget="label_selection" options="{'classes': {'active': 'success', 'expired': 'danger'}}"/>
                                        </span>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <field name="membership_category_id"/>
                                        <div t-if="record.member_since.raw_value">
                                            <i class="fa fa-calendar"/> Member since <field name="member_since"/>
                                        </div>
                                        <div t-if="record.email.raw_value">
                                            <i class="fa fa-envelope"/> <field name="email"/>
                                        </div>
                                        <div t-if="record.phone.raw_value">
                                            <i class="fa fa-phone"/> <field name="phone"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

    </data>
</odoo>