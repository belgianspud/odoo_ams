<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- SUBSCRIPTION.SUBSCRIPTION VIEWS (BASE - ENHANCED) -->
        <!-- ========================================== -->

        <!-- Extend Subscription List View -->
        <record id="view_subscription_membership_tree" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.list</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_list"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id" optional="show"/>
                    <field name="subscription_product_type" optional="hide"/>
                    <field name="is_membership" invisible="1"/>
                    <field name="lifecycle_stage" optional="show" widget="badge"
                           decoration-success="lifecycle_stage=='active'"
                           decoration-warning="lifecycle_stage=='grace'"
                           decoration-danger="lifecycle_stage in ('suspended','terminated')"/>
                    <field name="days_until_suspension" optional="hide"/>
                    <field name="supports_seats" invisible="1"/>
                    <field name="allocated_seat_count" optional="hide" string="Seats Used"/>
                    <field name="available_seat_count" optional="hide" string="Seats Available"/>
                </xpath>
            </field>
        </record>

        <!-- Extend Subscription Form View -->
        <record id="view_subscription_membership_form" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.form</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_form"/>
            <field name="arch" type="xml">
                
                <!-- Add membership status ribbons -->
                <xpath expr="//header" position="before">
                    <widget name="web_ribbon" title="Eligibility Not Verified" bg_color="text-bg-warning" 
                            invisible="eligibility_verified or not is_membership"/>
                    <widget name="web_ribbon" title="In Grace Period" 
                            bg_color="text-bg-warning" 
                            invisible="not is_in_grace_period"/>
                    <widget name="web_ribbon" title="Pending Suspension" 
                            bg_color="text-bg-danger" 
                            invisible="not is_pending_suspension"/>
                </xpath>

                <!-- Add membership verification button to header -->
                <xpath expr="//header/button[@name='action_renew']" position="after">
                    <button name="action_verify_eligibility" string="Verify Eligibility" type="object" 
                            class="btn-primary" invisible="eligibility_verified or not is_membership"
                            groups="membership_community.group_membership_manager"/>
                </xpath>

                <!-- Add seat management button to header for org subscriptions -->
                <xpath expr="//header/button[@name='action_verify_eligibility']" position="after">
                    <button name="action_view_seats" string="View Seats" type="object" 
                            class="btn-info" invisible="not supports_seats"
                            groups="membership_community.group_membership_user"/>
                </xpath>

                <!-- Add smart button for seat count -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_view_seats" type="object" 
                            class="oe_stat_button" icon="fa-users"
                            invisible="not supports_seats">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value">
                                <field name="allocated_seat_count"/>/<field name="max_seats"/>
                            </span>
                            <span class="o_stat_text">Seats</span>
                        </div>
                    </button>
                </xpath>

                <!-- Add membership category after plan -->
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="is_membership" invisible="1"/>
                    <field name="supports_seats" invisible="1"/>
                    <field name="membership_category_id" options="{'no_create': True}" invisible="not is_membership"/>
                    <field name="subscription_product_type" invisible="1"/>
                </xpath>

                <!-- Add membership details as fields in existing groups -->
                <xpath expr="//field[@name='last_invoice_date']" position="after">
                    <field name="eligibility_verified" invisible="not is_membership"/>
                    <field name="eligibility_verified_by" invisible="not eligibility_verified or not is_membership"/>
                    <field name="eligibility_verified_date" invisible="not eligibility_verified or not is_membership"/>
                </xpath>

                <xpath expr="//field[@name='date_start']" position="after">
                    <field name="join_date" invisible="not is_membership"/>
                    <field name="source_type" invisible="not is_membership"/>
                </xpath>

                <!-- Add seat configuration fields for org subscriptions -->
                <xpath expr="//field[@name='tag_ids']" position="after">
                    <field name="max_seats" invisible="not supports_seats"/>
                    <field name="allocated_seat_count" invisible="not supports_seats"/>
                    <field name="available_seat_count" invisible="not supports_seats"/>
                </xpath>

            </field>
        </record>

        <!-- Add Seat Management Page to Subscription Form -->
        <record id="view_subscription_membership_seats" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.seats</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_form"/>
            <field name="arch" type="xml">
                
                <!-- Add Seat Management page to notebook -->
                <xpath expr="//notebook" position="inside">
                    <page name="seats" string="ðŸª‘ Seat Management" invisible="not supports_seats">
                        
                        <div class="alert alert-info" role="alert">
                            <h4 class="alert-heading">
                                <i class="fa fa-users"/> Organizational Seat Management
                            </h4>
                            <p class="mb-0">
                                Allocate seats to employees so they can access membership benefits. 
                                Each seat creates a linked subscription for the individual.
                            </p>
                        </div>
                        
                        <group>
                            <group string="Seat Capacity">
                                <label for="max_seats"/>
                                <div>
                                    <field name="max_seats" readonly="1" class="oe_inline"/>
                                    <span class="text-muted"> total seats</span>
                                </div>
                                
                                <label for="allocated_seat_count"/>
                                <div>
                                    <field name="allocated_seat_count" readonly="1" class="oe_inline"/>
                                    <span class="text-muted"> seats allocated</span>
                                </div>
                                
                                <label for="available_seat_count"/>
                                <div>
                                    <field name="available_seat_count" readonly="1" class="oe_inline"/>
                                    <span class="text-success" invisible="available_seat_count == 0">
                                        <i class="fa fa-check-circle"/> seats available
                                    </span>
                                    <span class="text-danger" invisible="available_seat_count &gt; 0">
                                        <i class="fa fa-exclamation-triangle"/> no seats available
                                    </span>
                                </div>
                            </group>
                            
                            <group string="Seat Utilization">
                                <field name="seat_utilization" widget="progressbar"/>
                                <div class="text-muted" colspan="2">
                                    <small>
                                        <i class="fa fa-info-circle"/> 
                                        To add more seats, increase the <strong>max_seats</strong> value or 
                                        contact your administrator to upgrade your plan.
                                    </small>
                                </div>
                            </group>
                        </group>
                        
                        <group>
                            <button name="%(membership_community.action_seat_allocation_wizard)d" 
                                    string="ðŸŽ¯ Allocate Seats" 
                                    type="action" 
                                    class="btn-primary"
                                    context="{'default_subscription_id': id}"
                                    invisible="available_seat_count &lt;= 0 or state not in ('active', 'trial')"/>
                            
                            <button name="action_view_seats" 
                                    string="ðŸ“‹ View All Seats" 
                                    type="object" 
                                    class="btn-secondary"
                                    invisible="allocated_seat_count == 0"/>
                        </group>
                        
                        <separator string="Allocated Seats"/>
                        
                        <field name="child_subscription_ids" nolabel="1" 
                               context="{'default_parent_subscription_id': id}">
                            <list decoration-success="state=='active'" 
                                  decoration-warning="state=='suspended'"
                                  decoration-muted="state in ('cancelled','expired')"
                                  create="false" delete="false">
                                <field name="name"/>
                                <field name="seat_holder_id"/>
                                <field name="partner_id" optional="hide"/>
                                <field name="date_start"/>
                                <field name="date_end" optional="hide"/>
                                <field name="state" widget="badge"
                                       decoration-success="state=='active'"
                                       decoration-warning="state=='suspended'"
                                       decoration-danger="state in ('cancelled','expired')"/>
                                <button name="action_view_seat_holder" 
                                        string="View Member" 
                                        type="object" 
                                        icon="fa-user"
                                        class="btn-link"/>
                                <button name="%(membership_community.action_deallocate_seat_wizard)d" 
                                        string="Remove Seat" 
                                        type="action" 
                                        icon="fa-trash"
                                        class="btn-link text-danger"
                                        context="{'default_subscription_id': parent.id, 'default_seat_subscription_id': id}"
                                        confirm="Are you sure you want to remove this seat allocation?"/>
                            </list>
                        </field>
                        
                        <div class="alert alert-warning mt-3" role="alert" invisible="allocated_seat_count &gt; 0">
                            <p class="mb-0">
                                <i class="fa fa-exclamation-circle"/> 
                                <strong>No seats allocated yet.</strong> Click "Allocate Seats" above to assign seats to employees.
                            </p>
                        </div>
                        
                    </page>
                </xpath>

            </field>
        </record>

        <!-- Add Lifecycle Management Page to Subscription Form -->
        <record id="view_subscription_membership_lifecycle" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.lifecycle</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_form"/>
            <field name="arch" type="xml">
                
                <!-- Add lifecycle page to notebook -->
                <xpath expr="//notebook" position="inside">
                    <page name="lifecycle" string="Lifecycle Management" invisible="not is_membership">
                        <group>
                            <group name="lifecycle_dates" string="Lifecycle Dates">
                                <field name="paid_through_date" readonly="1"/>
                                <field name="grace_period_end_date" readonly="1"/>
                                <field name="suspend_end_date" readonly="1"/>
                                <field name="terminate_date" readonly="1"/>
                            </group>
                            <group name="lifecycle_status" string="Lifecycle Status">
                                <field name="lifecycle_stage" widget="badge"
                                       decoration-success="lifecycle_stage=='active'"
                                       decoration-warning="lifecycle_stage=='grace'"
                                       decoration-danger="lifecycle_stage in ('suspended','terminated')"/>
                                <field name="is_in_grace_period" invisible="1"/>
                                <field name="days_until_suspension" 
                                       invisible="not is_in_grace_period"/>
                                <field name="days_until_termination" 
                                       invisible="lifecycle_stage not in ('grace','suspended')"/>
                            </group>
                        </group>
                        
                        <group string="Period Overrides">
                            <group>
                                <field name="grace_period_days"/>
                                <field name="suspend_period_days"/>
                            </group>
                            <group>
                                <field name="terminate_period_days"/>
                            </group>
                        </group>
                        
                        <group string="Tracking">
                            <group>
                                <field name="grace_period_start_date" readonly="1"/>
                                <field name="actual_suspend_date" readonly="1"/>
                            </group>
                            <group>
                                <field name="actual_terminate_date" readonly="1"/>
                                <field name="last_grace_email_date" readonly="1"/>
                            </group>
                        </group>
                    </page>
                </xpath>

            </field>
        </record>

        <!-- Extend Subscription Search View -->
        <record id="view_subscription_membership_search" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.search</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_search"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id"/>
                    <field name="subscription_product_type"/>
                </xpath>
                
                <xpath expr="//filter[@name='active']" position="after">
                    <separator/>
                    <filter string="Not Verified" name="not_verified" 
                            domain="[('eligibility_verified', '=', False), ('is_membership', '=', True)]"/>
                    <filter string="Individual Memberships" name="individual" 
                            domain="[('subscription_product_type', '=', 'membership')]"/>
                    <filter string="Organizational Memberships" name="organizational" 
                            domain="[('subscription_product_type', '=', 'organizational_membership')]"/>
                    <filter string="Chapter Memberships" name="chapters" 
                            domain="[('subscription_product_type', '=', 'chapter')]"/>
                    <filter string="Has Available Seats" name="has_seats" 
                            domain="[('available_seat_count', '>', 0)]"/>
                    <filter string="Seats Full" name="seats_full" 
                            domain="[('supports_seats', '=', True), ('available_seat_count', '=', 0)]"/>
                    <filter string="New Members (This Month)" name="new_this_month" 
                            domain="[('join_date', '&gt;=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-01'))]"/>
                </xpath>
                
                <xpath expr="//filter[@name='customer']" position="after">
                    <filter string="Member Category" name="group_category" context="{'group_by': 'membership_category_id'}"/>
                    <filter string="Subscription Type" name="group_sub_type" context="{'group_by': 'subscription_product_type'}"/>
                    <filter string="Source Type" name="group_source" context="{'group_by': 'source_type'}"/>
                </xpath>
            </field>
        </record>

        <!-- Membership-focused Subscription Actions -->
        
        <!-- All Memberships -->
        <record id="action_membership_subscription_all" model="ir.actions.act_window">
            <field name="name">All Memberships</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[('is_membership', '=', True)]</field>
            <field name="context">{
                'search_default_active': 1,
                'default_product_id': False
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No memberships found
                </p>
                <p>
                    Create your first membership subscription.
                </p>
            </field>
        </record>

        <!-- Active Memberships -->
        <record id="action_membership_subscription_active" model="ir.actions.act_window">
            <field name="name">Active Memberships</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('state', 'in', ['active', 'trial'])
            ]</field>
            <field name="context">{}</field>
        </record>

        <!-- Pending Verification -->
        <record id="action_membership_subscription_pending" model="ir.actions.act_window">
            <field name="name">Pending Verification</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('eligibility_verified', '=', False)
            ]</field>
            <field name="context">{'search_default_not_verified': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No pending verifications
                </p>
                <p>
                    Membership subscriptions requiring verification will appear here.
                </p>
            </field>
        </record>

        <!-- Due for Renewal -->
        <record id="action_membership_subscription_renewal" model="ir.actions.act_window">
            <field name="name">Due for Renewal</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('state', '=', 'active'),
                ('date_end', '!=', False),
                ('date_end', '&lt;=', (context_today() + relativedelta(days=90)).strftime('%Y-%m-%d'))
            ]</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No renewals due
                </p>
                <p>
                    Memberships due for renewal within 90 days will appear here.
                </p>
            </field>
        </record>

        <!-- Subscription Kanban View with Membership Info -->
        <record id="view_subscription_membership_kanban" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.kanban</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_kanban"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id"/>
                    <field name="subscription_product_type"/>
                    <field name="is_membership"/>
                    <field name="supports_seats"/>
                    <field name="allocated_seat_count"/>
                    <field name="available_seat_count"/>
                </xpath>
                
                <xpath expr="//div[@class='o_kanban_record_body']//div[last()]" position="after">
                    <div invisible="not membership_category_id">
                        Category: <field name="membership_category_id"/>
                    </div>
                    <div invisible="not supports_seats" class="mt-1">
                        <span class="badge text-bg-info">
                            <i class="fa fa-users"/> 
                            <field name="allocated_seat_count"/>/<field name="max_seats"/> seats
                        </span>
                    </div>
                </xpath>
            </field>
        </record>

    </data>
</odoo>