<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ========================================== -->
        <!-- SUBSCRIPTION.SUBSCRIPTION VIEWS (BASE - FIXED) -->
        <!-- ========================================== -->

        <!-- Extend Subscription List View -->
        <record id="view_subscription_membership_tree" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.list</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_list"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id" optional="show"/>
                    <field name="subscription_product_type" optional="hide"/>
                    <field name="is_membership" invisible="1"/>
                </xpath>
            </field>
        </record>

        <!-- Extend Subscription Form View -->
        <record id="view_subscription_membership_form" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.form</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_form"/>
            <field name="arch" type="xml">
                
                <!-- Add membership status ribbons -->
                <xpath expr="//header" position="before">
                    <widget name="web_ribbon" title="Eligibility Not Verified" bg_color="text-bg-warning" 
                            invisible="eligibility_verified or not is_membership"/>
                </xpath>

                <!-- Add membership verification button to header -->
                <xpath expr="//header/button[@name='action_reactivate']" position="after">
                    <button name="action_verify_eligibility" string="Verify Eligibility" type="object" 
                            class="btn-primary" invisible="eligibility_verified or not is_membership"
                            groups="membership_community.group_membership_manager"/>
                </xpath>

                <!-- Add membership category after plan -->
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="is_membership" invisible="1"/>
                    <field name="membership_category_id" options="{'no_create': True}" invisible="not is_membership"/>
                    <field name="subscription_product_type" invisible="1"/>
                </xpath>

                <!-- Add membership verification group -->
                <xpath expr="//group[@string='Billing Information']" position="after">
                    <group string="Membership Details" invisible="not is_membership">
                        <group name="verification">
                            <field name="eligibility_verified"/>
                            <field name="eligibility_verified_by" invisible="not eligibility_verified"/>
                            <field name="eligibility_verified_date" invisible="not eligibility_verified"/>
                        </group>
                        <group name="source">
                            <field name="join_date"/>
                            <field name="source_type"/>
                        </group>
                    </group>
                </xpath>

            </field>
        </record>

        <!-- Extend Subscription Search View -->
        <record id="view_subscription_membership_search" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.search</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_search"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id"/>
                    <field name="subscription_product_type"/>
                </xpath>
                
                <xpath expr="//filter[@name='due_billing']" position="after">
                    <separator/>
                    <filter string="Not Verified" name="not_verified" 
                            domain="[('eligibility_verified', '=', False), ('is_membership', '=', True)]"/>
                    <filter string="Individual Memberships" name="individual" 
                            domain="[('subscription_product_type', '=', 'membership')]"/>
                    <filter string="Organizational Memberships" name="organizational" 
                            domain="[('subscription_product_type', '=', 'organizational_membership')]"/>
                    <filter string="Chapter Memberships" name="chapters" 
                            domain="[('subscription_product_type', '=', 'chapter')]"/>
                    <filter string="New Members (This Month)" name="new_this_month" 
                            domain="[('join_date', '&gt;=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-01'))]"/>
                </xpath>
                
                <xpath expr="//filter[@name='status']" position="after">
                    <filter string="Member Category" name="group_category" context="{'group_by': 'membership_category_id'}"/>
                    <filter string="Subscription Type" name="group_sub_type" context="{'group_by': 'subscription_product_type'}"/>
                    <filter string="Source Type" name="group_source" context="{'group_by': 'source_type'}"/>
                </xpath>
            </field>
        </record>

        <!-- Membership-focused Subscription Actions -->
        
        <!-- All Memberships -->
        <record id="action_membership_subscription_all" model="ir.actions.act_window">
            <field name="name">All Memberships</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[('is_membership', '=', True)]</field>
            <field name="context">{
                'search_default_active': 1,
                'default_product_id': False
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No memberships found
                </p>
                <p>
                    Create your first membership subscription.
                </p>
            </field>
        </record>

        <!-- Active Memberships -->
        <record id="action_membership_subscription_active" model="ir.actions.act_window">
            <field name="name">Active Memberships</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('state', 'in', ['active', 'trial'])
            ]</field>
            <field name="context">{}</field>
        </record>

        <!-- Pending Verification -->
        <record id="action_membership_subscription_pending" model="ir.actions.act_window">
            <field name="name">Pending Verification</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('eligibility_verified', '=', False)
            ]</field>
            <field name="context">{'search_default_not_verified': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No pending verifications
                </p>
                <p>
                    Membership subscriptions requiring verification will appear here.
                </p>
            </field>
        </record>

        <!-- Due for Renewal -->
        <record id="action_membership_subscription_renewal" model="ir.actions.act_window">
            <field name="name">Due for Renewal</field>
            <field name="res_model">subscription.subscription</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[
                ('is_membership', '=', True),
                ('state', '=', 'active'),
                ('date_end', '!=', False),
                ('date_end', '&lt;=', (context_today() + relativedelta(days=90)).strftime('%Y-%m-%d'))
            ]</field>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No renewals due
                </p>
                <p>
                    Memberships due for renewal within 90 days will appear here.
                </p>
            </field>
        </record>

        <!-- Subscription Kanban View with Membership Info -->
        <record id="view_subscription_membership_kanban" model="ir.ui.view">
            <field name="name">subscription.subscription.membership.kanban</field>
            <field name="model">subscription.subscription</field>
            <field name="inherit_id" ref="subscription_management.subscription_subscription_view_kanban"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='plan_id']" position="after">
                    <field name="membership_category_id"/>
                    <field name="subscription_product_type"/>
                    <field name="is_membership"/>
                </xpath>
                
                <xpath expr="//div[@class='o_kanban_record_body']//div[last()]" position="after">
                    <div t-if="record.membership_category_id.value">
                        Category: <field name="membership_category_id"/>
                    </div>
                </xpath>
            </field>
        </record>

    </data>
</odoo>