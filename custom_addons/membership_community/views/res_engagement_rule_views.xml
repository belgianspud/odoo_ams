<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Engagement Rule List View -->
        <record id="view_ams_engagement_rule_list" model="ir.ui.view">
            <field name="name">ams.engagement.rule.list</field>
            <field name="model">ams.engagement.rule</field>
            <field name="arch" type="xml">
                <list string="Engagement Rules" default_order="sequence,name">
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="rule_type"/>
                    <field name="points_value"/>
                    <field name="frequency_limit"/>
                    <field name="time_period"/>
                    <field name="active"/>
                </list>
            </field>
        </record>

        <!-- Engagement Rule Form View -->
        <record id="view_ams_engagement_rule_form" model="ir.ui.view">
            <field name="name">ams.engagement.rule.form</field>
            <field name="model">ams.engagement.rule</field>
            <field name="arch" type="xml">
                <form string="Engagement Rule">
                    <sheet>
                        <widget name="web_ribbon" title="Archived" bg_color="bg-danger" 
                                invisible="active"/>
                        
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Rule Name"/>
                            </h1>
                            <div class="o_row">
                                <field name="rule_code" placeholder="Rule Code"/>
                            </div>
                        </div>

                        <group>
                            <group string="Rule Configuration">
                                <field name="rule_type"/>
                                <field name="points_value"/>
                                <field name="sequence"/>
                                <field name="active"/>
                            </group>
                            <group string="Frequency &amp; Limits">
                                <field name="frequency_limit"/>
                                <field name="time_period" 
                                       invisible="not frequency_limit"/>
                                <field name="max_points_per_period"
                                       invisible="not frequency_limit"/>
                                <field name="reset_frequency"
                                       invisible="not frequency_limit"/>
                            </group>
                        </group>

                        <group>
                            <group string="Conditions">
                                <field name="member_type_ids" widget="many2many_tags"/>
                                <field name="apply_to_all_members"/>
                                <field name="min_membership_duration"/>
                                <field name="requires_approval" 
                                       invisible="rule_type not in ['manual_override', 'special_recognition']"/>
                            </group>
                            <group string="Date Range">
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="auto_expire"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Rule Description" name="description">
                                <field name="description" 
                                       placeholder="Describe when and how this engagement rule should be applied..."/>
                            </page>
                            
                            <page string="Conditions &amp; Logic" name="conditions">
                                <group>
                                    <group string="Event Conditions" 
                                           invisible="rule_type not in ['event_attendance', 'event_speaking']">
                                        <field name="event_category_filter"/>
                                        <field name="event_categories" widget="many2many_tags"
                                               invisible="not event_category_filter"/>
                                        <field name="min_event_hours"/>
                                        <field name="ce_credit_multiplier"/>
                                    </group>
                                    <group string="Communication Conditions"
                                           invisible="rule_type not in ['email_engagement', 'newsletter_engagement']">
                                        <field name="email_open_points"/>
                                        <field name="email_click_points"/>
                                        <field name="survey_completion_points"/>
                                    </group>
                                </group>
                                
                                <group>
                                    <group string="Portal Activity"
                                           invisible="rule_type not in ['portal_login', 'profile_update']">
                                        <field name="login_streak_bonus"/>
                                        <field name="profile_completeness_bonus"/>
                                        <field name="document_download_points"/>
                                    </group>
                                    <group string="Payment &amp; Renewal"
                                           invisible="rule_type not in ['early_renewal', 'payment_method']">
                                        <field name="early_renewal_days"/>
                                        <field name="auto_pay_bonus"/>
                                        <field name="loyalty_year_bonus"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="Advanced Configuration" name="advanced"
                                  groups="membership_community.group_membership_manager">
                                <group>
                                    <group string="Calculation Logic">
                                        <field name="calculation_formula"/>
                                        <field name="use_custom_formula"/>
                                        <field name="custom_python_code"
                                               invisible="not use_custom_formula"/>
                                    </group>
                                    <group string="Integration">
                                        <field name="external_system_sync"/>
                                        <field name="api_endpoint"
                                               invisible="not external_system_sync"/>
                                        <field name="webhook_trigger"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="Usage Statistics" name="statistics">
                                <group>
                                    <group string="Application Stats">
                                        <field name="times_applied" readonly="True"/>
                                        <field name="total_points_awarded" readonly="True"/>
                                        <field name="average_points_per_application" readonly="True"/>
                                        <field name="last_applied" readonly="True"/>
                                    </group>
                                    <group string="Member Impact">
                                        <field name="unique_members_affected" readonly="True"/>
                                        <field name="most_recent_application" readonly="True"/>
                                        <button name="action_view_applications" 
                                                string="View Applications" 
                                                type="object" 
                                                class="btn-primary"
                                                invisible="not times_applied"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <chatter/>
                    </div>
                </form>
            </field>
        </record>

        <!-- Engagement Rule Search View -->
        <record id="view_ams_engagement_rule_search" model="ir.ui.view">
            <field name="name">ams.engagement.rule.search</field>
            <field name="model">ams.engagement.rule</field>
            <field name="arch" type="xml">
                <search string="Engagement Rules">
                    <field name="name"/>
                    <field name="rule_code"/>
                    <field name="rule_type"/>
                    <field name="description"/>
                    <separator/>
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
                    <separator/>
                    <filter string="Has Frequency Limit" name="frequency_limited" 
                            domain="[('frequency_limit', '=', True)]"/>
                    <filter string="Requires Approval" name="requires_approval" 
                            domain="[('requires_approval', '=', True)]"/>
                    <filter string="Auto Expire" name="auto_expire" 
                            domain="[('auto_expire', '=', True)]"/>
                    <separator/>
                    <filter string="Event Rules" name="event_rules" 
                            domain="[('rule_type', 'in', ['event_attendance', 'event_speaking', 'event_organizing'])]"/>
                    <filter string="Communication Rules" name="communication_rules" 
                            domain="[('rule_type', 'in', ['email_engagement', 'newsletter_engagement', 'survey_participation'])]"/>
                    <filter string="Portal Rules" name="portal_rules" 
                            domain="[('rule_type', 'in', ['portal_login', 'profile_update', 'document_access'])]"/>
                    <filter string="Payment Rules" name="payment_rules" 
                            domain="[('rule_type', 'in', ['early_renewal', 'payment_method', 'referral'])]"/>
                    <separator/>
                    <filter string="Expiring Soon" name="expiring_soon" 
                            domain="[('end_date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d')), ('end_date', '!=', False)]"/>
                    <group expand="0" string="Group By">
                        <filter string="Rule Type" name="group_rule_type" 
                                domain="[]" context="{'group_by': 'rule_type'}"/>
                        <filter string="Points Value" name="group_points" 
                                domain="[]" context="{'group_by': 'points_value'}"/>
                        <filter string="Time Period" name="group_period" 
                                domain="[]" context="{'group_by': 'time_period'}"/>
                        <filter string="Active Status" name="group_active" 
                                domain="[]" context="{'group_by': 'active'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Engagement Rule Kanban View -->
        <record id="view_ams_engagement_rule_kanban" model="ir.ui.view">
            <field name="name">ams.engagement.rule.kanban</field>
            <field name="model">ams.engagement.rule</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="rule_type">
                    <field name="name"/>
                    <field name="rule_type"/>
                    <field name="points_value"/>
                    <field name="frequency_limit"/>
                    <field name="times_applied"/>
                    <field name="active"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                                <div class="row">
                                    <div class="col-8">
                                        <strong><t t-esc="record.name.value"/></strong>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span t-attf-class="badge badge-pill badge-#{record.active.raw_value ? 'success' : 'secondary'}">
                                            <t t-if="record.active.raw_value">Active</t>
                                            <t t-else="">Inactive</t>
                                        </span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <span class="badge badge-info">
                                            <t t-esc="record.points_value.value"/> points
                                        </span>
                                        <t t-if="record.frequency_limit.raw_value">
                                            <span class="badge badge-warning">Limited</span>
                                        </t>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <small>Applied <t t-esc="record.times_applied.value"/> times</small>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Engagement Rule Action -->
        <record id="action_ams_engagement_rule" model="ir.actions.act_window">
            <field name="name">Engagement Rules</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">ams.engagement.rule</field>
            <field name="view_mode">list,kanban,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first engagement rule
                </p>
                <p>
                    Engagement rules define how member activities are scored and tracked. 
                    Create rules for events, portal usage, communication engagement, and more 
                    to build a comprehensive member engagement scoring system.
                </p>
            </field>
        </record>

    </data>
</odoo>