<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Action to view participations with this cancellation reason -->
    <record id="action_view_participations_by_reason" model="ir.actions.act_window">
        <field name="name">Participations</field>
        <field name="res_model">ams.participation</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('cancellation_reason_id', '!=', False)]</field>
    </record>

    <!-- Cancellation Reason List View -->
    <record id="view_ams_cancellation_reason_list" model="ir.ui.view">
        <field name="name">ams.cancellation.reason.list</field>
        <field name="model">ams.cancellation.reason</field>
        <field name="arch" type="xml">
            <list string="Cancellation Reasons" default_order="sequence,name">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="code"/>
                <field name="category"/>
                <field name="requires_approval"/>
                <field name="allows_reinstatement"/>
                <field name="refund_eligible"/>
                <field name="usage_count"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <!-- Cancellation Reason Form View -->
    <record id="view_ams_cancellation_reason_form" model="ir.ui.view">
        <field name="name">ams.cancellation.reason.form</field>
        <field name="model">ams.cancellation.reason</field>
        <field name="arch" type="xml">
            <form string="Cancellation Reason">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_participations" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-users"
                                invisible="usage_count == 0">
                            <field name="usage_count" widget="statinfo" string="Uses"/>
                        </button>
                    </div>

                    <widget name="web_ribbon" title="Archived" bg_color="bg-danger"
                            invisible="active"/>

                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Cancellation Reason Name..."/>
                        </h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="code"/>
                            <field name="category"/>
                            <field name="sequence"/>
                        </group>
                        <group>
                            <field name="requires_approval"/>
                            <field name="allows_reinstatement"/>
                            <field name="refund_eligible"/>
                            <field name="active"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Description">
                            <field name="description" 
                                   placeholder="Detailed description of this cancellation reason..."/>
                        </page>
                        <page string="Processing Guidelines" 
                              invisible="not internal_notes">
                            <group>
                                <field name="internal_notes" 
                                       placeholder="Internal staff guidance for handling this cancellation reason..."
                                       nolabel="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Cancellation Reason Kanban View -->
    <record id="view_ams_cancellation_reason_kanban" model="ir.ui.view">
        <field name="name">ams.cancellation.reason.kanban</field>
        <field name="model">ams.cancellation.reason</field>
        <field name="arch" type="xml">
            <kanban default_order="sequence" class="o_kanban_small_column">
                <field name="category"/>
                <field name="usage_count"/>
                <field name="requires_approval"/>
                <field name="allows_reinstatement"/>
                <field name="refund_eligible"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_dropdown_kanban dropdown">
                                <a role="button" class="dropdown-toggle o-no-caret btn" data-toggle="dropdown" data-display="static" href="#" aria-label="Dropdown menu" title="Dropdown menu">
                                    <span class="fa fa-ellipsis-v"/>
                                </a>
                                <div class="dropdown-menu" role="menu">
                                    <a t-if="widget.editable" role="menuitem" type="edit" class="dropdown-item">Edit</a>
                                    <a t-if="widget.deletable" role="menuitem" type="delete" class="dropdown-item">Delete</a>
                                    <ul class="oe_kanban_colorpicker" data-field="color"/>
                                </div>
                            </div>
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="text-muted">
                                        <field name="code"/> â€¢ 
                                        <span class="badge" 
                                              t-attf-class="badge-#{record.category.raw_value === 'voluntary' ? 'success' : record.category.raw_value === 'involuntary' ? 'danger' : 'info'}">
                                            <field name="category"/>
                                        </span>
                                    </div>
                                    <div class="mt8">
                                        <t t-if="record.requires_approval.raw_value">
                                            <span class="fa fa-check-circle text-warning" title="Requires Approval"/> 
                                        </t>
                                        <t t-if="record.refund_eligible.raw_value">
                                            <span class="fa fa-money text-success" title="Refund Eligible"/> 
                                        </t>
                                        <t t-if="record.allows_reinstatement.raw_value">
                                            <span class="fa fa-refresh text-primary" title="Allows Reinstatement"/> 
                                        </t>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span class="oe_kanban_text_red">
                                            <t t-esc="record.usage_count.value"/> Uses
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Cancellation Reason Search View -->
    <record id="view_ams_cancellation_reason_search" model="ir.ui.view">
        <field name="name">ams.cancellation.reason.search</field>
        <field name="model">ams.cancellation.reason</field>
        <field name="arch" type="xml">
            <search string="Search Cancellation Reasons">
                <field name="name"/>
                <field name="code"/>
                <field name="description"/>
                <field name="internal_notes"/>
                
                <filter string="Voluntary" name="voluntary" 
                        domain="[('category', '=', 'voluntary')]"/>
                <filter string="Involuntary" name="involuntary" 
                        domain="[('category', '=', 'involuntary')]"/>
                <filter string="Administrative" name="administrative" 
                        domain="[('category', '=', 'administrative')]"/>
                <separator/>
                <filter string="Requires Approval" name="requires_approval" 
                        domain="[('requires_approval', '=', True)]"/>
                <filter string="Allows Reinstatement" name="allows_reinstatement" 
                        domain="[('allows_reinstatement', '=', True)]"/>
                <filter string="Refund Eligible" name="refund_eligible" 
                        domain="[('refund_eligible', '=', True)]"/>
                <separator/>
                <filter string="Active" name="active" 
                        domain="[('active', '=', True)]"/>
                <filter string="Archived" name="inactive" 
                        domain="[('active', '=', False)]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Category" name="group_by_category" 
                            context="{'group_by': 'category'}"/>
                    <filter string="Approval Required" name="group_by_approval" 
                            context="{'group_by': 'requires_approval'}"/>
                    <filter string="Reinstatement Allowed" name="group_by_reinstatement" 
                            context="{'group_by': 'allows_reinstatement'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Cancellation Reason Action -->
    <record id="action_ams_cancellation_reason" model="ir.actions.act_window">
        <field name="name">Cancellation Reasons</field>
        <field name="res_model">ams.cancellation.reason</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first cancellation reason
            </p>
            <p>
                Cancellation reasons help track why participations end and provide 
                valuable analytics for retention efforts. Configure reasons with 
                appropriate processing rules like approval requirements and 
                reinstatement policies.
            </p>
        </field>
    </record>

    <!-- Cancellation Reasons menu under Configuration -->
    <menuitem id="menu_ams_cancellation_reason" 
              name="Cancellation Reasons" 
              parent="ams_system_config.menu_ams_configuration"
              action="action_ams_cancellation_reason" 
              sequence="30"/>
</odoo>