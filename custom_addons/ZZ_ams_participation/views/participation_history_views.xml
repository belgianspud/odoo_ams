<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Participation History List View -->
    <record id="view_ams_participation_history_list" model="ir.ui.view">
        <field name="name">ams.participation.history.list</field>
        <field name="model">ams.participation.history</field>
        <field name="arch" type="xml">
            <list string="Participation History" default_order="change_date desc" 
                  create="false" edit="false" delete="false">
                <field name="change_date"/>
                <field name="partner_id"/>
                <field name="participation_type"/>
                <field name="status_change_description"/>
                <field name="changed_by"/>
                <field name="automated"/>
                <field name="reason"/>
                <field name="reference_document"/>
            </list>
        </field>
    </record>

    <!-- Participation History Form View -->
    <record id="view_ams_participation_history_form" model="ir.ui.view">
        <field name="name">ams.participation.history.form</field>
        <field name="model">ams.participation.history</field>
        <field name="arch" type="xml">
            <form string="Participation History Entry" create="false" edit="false" delete="false">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_participation" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-user">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">View Participation</span>
                            </div>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="display_name"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group string="Change Information">
                            <field name="participation_id"/>
                            <field name="partner_id"/>
                            <field name="participation_type"/>
                            <field name="change_date"/>
                            <field name="effective_date"/>
                        </group>
                        <group string="Status Change">
                            <field name="old_status"/>
                            <field name="new_status"/>
                            <field name="status_change_description"/>
                            <field name="automated"/>
                        </group>
                    </group>

                    <group>
                        <group string="Change Details">
                            <field name="changed_by"/>
                            <field name="reference_document"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Reason">
                            <field name="reason" 
                                   placeholder="Explanation for this status change..."
                                   nolabel="1"/>
                        </page>
                        <page string="Previous Values" invisible="not previous_values">
                            <group>
                                <field name="previous_values" 
                                       widget="ace"
                                       options="{'mode': 'json'}"
                                       nolabel="1"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Participation History Search View -->
    <record id="view_ams_participation_history_search" model="ir.ui.view">
        <field name="name">ams.participation.history.search</field>
        <field name="model">ams.participation.history</field>
        <field name="arch" type="xml">
            <search string="Search Participation History">
                <field name="partner_id"/>
                <field name="participation_id"/>
                <field name="changed_by"/>
                <field name="reason"/>
                <field name="reference_document"/>
                
                <filter string="Today" name="today" 
                        domain="[('change_date', '&gt;=', context_today().strftime('%Y-%m-%d 00:00:00')), 
                                ('change_date', '&lt;=', context_today().strftime('%Y-%m-%d 23:59:59'))]"/>
                <filter string="This Week" name="this_week" 
                        domain="[('change_date', '&gt;=', (context_today() - relativedelta(weeks=1)).strftime('%Y-%m-%d 00:00:00'))]"/>
                <filter string="This Month" name="this_month" 
                        domain="[('change_date', '&gt;=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-%d 00:00:00'))]"/>
                <separator/>
                <filter string="Automated Changes" name="automated" 
                        domain="[('automated', '=', True)]"/>
                <filter string="Manual Changes" name="manual" 
                        domain="[('automated', '=', False)]"/>
                <separator/>
                <filter string="Activations" name="activations" 
                        domain="[('new_status', '=', 'active')]"/>
                <filter string="Grace Periods" name="grace_periods" 
                        domain="[('new_status', '=', 'grace')]"/>
                <filter string="Suspensions" name="suspensions" 
                        domain="[('new_status', '=', 'suspended')]"/>
                <filter string="Cancellations" name="cancellations" 
                        domain="[('new_status', 'in', ['cancelled', 'terminated'])]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Member" name="group_by_partner" 
                            context="{'group_by': 'partner_id'}"/>
                    <filter string="Participation Type" name="group_by_participation_type" 
                            context="{'group_by': 'participation_type'}"/>
                    <filter string="New Status" name="group_by_new_status" 
                            context="{'group_by': 'new_status'}"/>
                    <filter string="Change Date" name="group_by_change_date" 
                            context="{'group_by': 'change_date:day'}"/>
                    <filter string="Changed By" name="group_by_changed_by" 
                            context="{'group_by': 'changed_by'}"/>
                    <filter string="Automated" name="group_by_automated" 
                            context="{'group_by': 'automated'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Participation History Action -->
    <record id="action_ams_participation_history" model="ir.actions.act_window">
        <field name="name">Participation History</field>
        <field name="res_model">ams.participation.history</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_this_month': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No participation history found
            </p>
            <p>
                Participation history automatically tracks all status changes 
                for member participations, providing a complete audit trail 
                of membership lifecycle events.
            </p>
        </field>
    </record>

    <!-- Participation History Reporting Action -->
    <record id="action_ams_participation_history_report" model="ir.actions.act_window">
        <field name="name">Status Change Analytics</field>
        <field name="res_model">ams.participation.history</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="context">{
            'search_default_this_month': 1,
            'pivot_measures': ['__count__'],
            'pivot_column_groupby': ['new_status'],
            'pivot_row_groupby': ['change_date:day']
        }</field>
    </record>

    <!-- Extended Participation History List View for Member Context -->
    <record id="view_ams_participation_history_member_list" model="ir.ui.view">
        <field name="name">ams.participation.history.member.list</field>
        <field name="model">ams.participation.history</field>
        <field name="arch" type="xml">
            <list string="Member Participation History" default_order="change_date desc" 
                  create="false" edit="false" delete="false">
                <field name="change_date"/>
                <field name="participation_type"/>
                <field name="old_status"/>
                <field name="new_status"/>
                <field name="reason"/>
                <field name="changed_by"/>
                <field name="automated"/>
                <field name="reference_document"/>
            </list>
        </field>
    </record>

    <!-- Member-specific History Action -->
    <record id="action_ams_participation_history_member" model="ir.actions.act_window">
        <field name="name">Member Participation History</field>
        <field name="res_model">ams.participation.history</field>
        <field name="view_mode">list,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
                                      (0, 0, {'view_mode': 'list', 'view_id': ref('view_ams_participation_history_member_list')}),
                                      (0, 0, {'view_mode': 'form', 'view_id': ref('view_ams_participation_history_form')})]"/>
    </record>

    <!-- MENUS - These menus reference parents defined in participation_views.xml -->
    <!-- which should be loaded before this file based on the manifest order -->
    
    <!-- Add History submenu under Participations -->
    <menuitem id="menu_ams_participation_history" 
              name="Change History" 
              parent="menu_ams_participations"
              action="action_ams_participation_history" 
              sequence="50"/>

    <!-- Add Analytics submenu under Reports -->
    <menuitem id="menu_ams_participation_analytics" 
              name="Status Change Analytics" 
              parent="menu_ams_reports"
              action="action_ams_participation_history_report" 
              sequence="20"/>
</odoo>