<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Enhanced Portal Home Extension -->
        <template id="portal_my_home_membership" name="Portal My Home: Membership" inherit_id="portal.portal_my_home" priority="30">
            
            <!-- Add member status card BEFORE the portal docs -->
            <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
                <t t-if="is_member">
                    <div class="row">
                        <!-- Member Status Card -->
                        <div class="col-lg-12 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="fa fa-id-card me-2"/>Membership Status
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Member ID:</strong><br/>
                                            <span class="text-primary fs-5" t-esc="member_number or 'Not Assigned'"/>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Member Type:</strong><br/>
                                            <span t-esc="member_type or 'Not Set'"/>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Status:</strong><br/>
                                            <span t-attf-class="badge bg-#{(member_status == 'active') and 'success' or (member_status == 'grace') and 'warning' or 'secondary'}" 
                                                  t-esc="(member_status and str(member_status).title()) or 'Unknown'"/>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Membership Expires:</strong><br/>
                                            <span t-esc="membership_end_date or 'Not Set'"/>
                                        </div>
                                    </div>
                                    
                                    <!-- Chapter membership summary -->
                                    <div class="row mt-3" t-if="chapter_membership_count and chapter_membership_count > 0">
                                        <div class="col-12">
                                            <div class="alert alert-info mb-0">
                                                <i class="fa fa-map-marker me-2"/>
                                                <strong>Chapter Memberships:</strong> 
                                                <span t-esc="chapter_membership_count"/> active chapter<t t-if="chapter_membership_count != 1">s</t>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3" t-if="next_renewal_date">
                                        <div class="col-12">
                                            <div class="alert alert-warning mb-0">
                                                <i class="fa fa-clock-o me-2"/>
                                                <strong>Next Renewal Due:</strong> 
                                                <span t-esc="next_renewal_date"/>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <a href="/my/member/profile" class="btn btn-primary btn-sm me-2">
                                                <i class="fa fa-user"/> View Member Profile
                                            </a>
                                            <a href="/my/memberships" class="btn btn-outline-primary btn-sm me-2">
                                                <i class="fa fa-id-card"/> Manage Memberships
                                            </a>
                                            <t t-if="chapter_membership_count and chapter_membership_count > 0">
                                                <a href="/my/chapters" class="btn btn-outline-info btn-sm">
                                                    <i class="fa fa-map-marker"/> Chapter Activities
                                                </a>
                                            </t>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </xpath>
            
            <!-- MANUAL membership/subscription links -->
            <xpath expr="//div[contains(@class,'o_portal_docs')]/div" position="after">
                <t t-if="is_member">
                    <!-- Manual Membership Link -->
                    <div class="col-lg-3 col-6 o_portal_docs">
                        <a href="/my/memberships" class="d-flex align-items-center text-decoration-none">
                            <div class="o_portal_docs_entry">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-id-card fa-2x text-primary me-3"/>
                                    <div>
                                        <h4 class="mb-0">Memberships</h4>
                                        <small class="text-muted">Follow your membership status and renewals</small>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Chapter Memberships Link -->
                    <t t-if="chapter_membership_count and chapter_membership_count > 0">
                        <div class="col-lg-3 col-6 o_portal_docs">
                            <a href="/my/chapters" class="d-flex align-items-center text-decoration-none">
                                <div class="o_portal_docs_entry">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-map-marker fa-2x text-info me-3"/>
                                        <div>
                                            <h4 class="mb-0">Chapters</h4>
                                            <small class="text-muted">Manage your chapter memberships and activities</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </t>
                    
                    <!-- Manual Subscription Link -->
                    <t t-if="total_subscription_count and total_subscription_count > 0">
                        <div class="col-lg-3 col-6 o_portal_docs">
                            <a href="/my/subscriptions" class="d-flex align-items-center text-decoration-none">
                                <div class="o_portal_docs_entry">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-refresh fa-2x text-success me-3"/>
                                        <div>
                                            <h4 class="mb-0">Subscriptions</h4>
                                            <small class="text-muted">Manage your publication and service subscriptions</small>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </t>
                </t>
            </xpath>
            
        </template>

        <!-- Enhanced Member Profile Dashboard -->
        <template id="portal_member_profile" name="Member Profile">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'member_profile'"/>
                
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fa fa-user-circle"/> Member Profile</h2>
                                <span t-attf-class="badge bg-#{(member_status == 'active') and 'success' or (member_status == 'grace') and 'warning' or 'secondary'} fs-6" 
                                      t-esc="(member_status and str(member_status).title()) or 'Unknown'"/>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Member Information Card -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-id-card me-2"/>Member Information</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td width="40%"><strong>Member ID:</strong></td>
                                            <td class="text-primary fs-6"><strong t-esc="member_number or 'Not Assigned'"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Name:</strong></td>
                                            <td t-esc="(partner and partner.name) or 'Not Available'"/>
                                        </tr>
                                        <tr>
                                            <td><strong>Email:</strong></td>
                                            <td t-esc="(partner and partner.email) or 'Not Available'"/>
                                        </tr>
                                        <tr t-if="member_type and member_type != 'Not Set'">
                                            <td><strong>Member Type:</strong></td>
                                            <td t-esc="member_type"/>
                                        </tr>
                                        <tr>
                                            <td><strong>Status:</strong></td>
                                            <td>
                                                <span t-attf-class="badge bg-#{(member_status == 'active') and 'success' or (member_status == 'grace') and 'warning' or 'secondary'}" 
                                                      t-esc="(member_status and str(member_status).title()) or 'Unknown'"/>
                                            </td>
                                        </tr>
                                        <tr t-if="membership_start_date">
                                            <td><strong>Member Since:</strong></td>
                                            <td t-esc="membership_start_date"/>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Current Membership Card -->
                        <div class="col-lg-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-certificate me-2"/>Current Membership</h5>
                                </div>
                                <div class="card-body">
                                    <t t-if="current_membership">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td width="40%"><strong>Product:</strong></td>
                                                <td t-esc="(current_membership.product_id and current_membership.product_id.name) or 'Not Available'"/>
                                            </tr>
                                            <tr>
                                                <td><strong>Start Date:</strong></td>
                                                <td t-esc="current_membership.start_date or 'Not Set'"/>
                                            </tr>
                                            <tr>
                                                <td><strong>End Date:</strong></td>
                                                <td t-esc="current_membership.end_date or 'Not Set'"/>
                                            </tr>
                                            <tr>
                                                <td><strong>Auto Renew:</strong></td>
                                                <td>
                                                    <span t-if="current_membership.auto_renew" class="text-success">
                                                        <i class="fa fa-check"/> Enabled
                                                    </span>
                                                    <span t-else="" class="text-muted">
                                                        <i class="fa fa-times"/> Disabled
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Payment Status:</strong></td>
                                                <td>
                                                    <span t-attf-class="badge bg-#{(current_membership.payment_status == 'paid') and 'success' or (current_membership.payment_status == 'pending') and 'warning' or 'secondary'}"
                                                          t-esc="(current_membership.payment_status and str(current_membership.payment_status).title()) or 'Unknown'"/>
                                                </td>
                                            </tr>
                                        </table>
                                        <div class="text-end mt-3">
                                            <a t-attf-href="/my/memberships/#{current_membership.id}" class="btn btn-primary btn-sm">
                                                <i class="fa fa-eye"/> View Details
                                            </a>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-info">
                                            <h6>No Active Membership</h6>
                                            <p class="mb-0">You don't currently have an active membership.</p>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Chapter Memberships Summary -->
                        <div class="col-12 mb-4" t-if="chapter_memberships">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fa fa-map-marker me-2"/>Chapter Memberships 
                                        <span class="badge bg-info ms-2" t-esc="len(chapter_memberships)"/>
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <t t-foreach="chapter_memberships[:3]" t-as="chapter">
                                            <div class="col-md-4 mb-3">
                                                <div class="card border-info h-100">
                                                    <div class="card-body p-3">
                                                        <h6 class="card-title">
                                                            <i class="fa fa-map-marker text-info me-1"/>
                                                            <span t-esc="chapter.product_id.name"/>
                                                        </h6>
                                                        <p class="card-text mb-2">
                                                            <small class="text-muted">
                                                                <strong>Type:</strong> <span t-esc="chapter.chapter_type and chapter.chapter_type.replace('_', ' ').title() or 'Chapter'"/><br/>
                                                                <strong>Role:</strong> <span t-esc="chapter.chapter_role and chapter.chapter_role.replace('_', ' ').title() or 'Member'"/>
                                                            </small>
                                                        </p>
                                                        <t t-if="chapter.chapter_engagement_score and chapter.chapter_engagement_score > 0">
                                                            <div class="progress mb-2" style="height: 6px;">
                                                                <div class="progress-bar bg-info" role="progressbar" 
                                                                     t-attf-style="width: #{chapter.chapter_engagement_score}%"
                                                                     t-attf-aria-valuenow="#{chapter.chapter_engagement_score}" aria-valuemin="0" aria-valuemax="100">
                                                                </div>
                                                            </div>
                                                            <small class="text-muted">Engagement: <span t-esc="int(chapter.chapter_engagement_score or 0)"/>%</small>
                                                        </t>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                    <div class="text-end mt-3" t-if="len(chapter_memberships) > 3">
                                        <a href="/my/chapters" class="btn btn-outline-info btn-sm">
                                            <i class="fa fa-eye"/> View All Chapters
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Benefits -->
                        <div class="col-12 mb-4" t-if="active_benefits">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-gift me-2"/>Active Benefits</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <t t-foreach="active_benefits" t-as="benefit">
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card border-success border-opacity-25 h-100">
                                                    <div class="card-body text-center">
                                                        <h6 class="card-title">
                                                            <i class="fa fa-check-circle text-success me-2"/>
                                                            <span t-esc="benefit.name or 'Benefit'"/>
                                                        </h6>
                                                        <small class="text-muted" t-esc="(benefit.benefit_type and str(benefit.benefit_type).title()) or 'Benefit'"/>
                                                        <t t-if="benefit.benefit_type == 'discount' and benefit.discount_percentage">
                                                            <div class="badge bg-success mt-2">
                                                                <span t-esc="benefit.discount_percentage or 0"/>% Discount
                                                            </div>
                                                        </t>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fa fa-bolt me-2"/>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <a href="/my/memberships" class="btn btn-outline-primary">
                                            <i class="fa fa-id-card"/> View All Memberships
                                        </a>
                                        <t t-if="chapter_memberships">
                                            <a href="/my/chapters" class="btn btn-outline-info">
                                                <i class="fa fa-map-marker"/> Manage Chapters
                                            </a>
                                        </t>
                                        <a href="/my/subscriptions" class="btn btn-outline-success" t-if="total_subscription_count and total_subscription_count > 0">
                                            <i class="fa fa-refresh"/> View Subscriptions
                                        </a>
                                        <t t-if="current_membership and not current_membership.auto_renew">
                                            <a t-attf-href="/my/memberships/#{current_membership.id}/renew" class="btn btn-warning">
                                                <i class="fa fa-refresh"/> Renew Membership
                                            </a>
                                        </t>
                                        <t t-if="pending_renewals_count and pending_renewals_count > 0">
                                            <a href="/my/renewals" class="btn btn-danger">
                                                <i class="fa fa-clock-o"/> Pending Renewals (<span t-esc="pending_renewals_count"/>)
                                            </a>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Enhanced My Memberships List -->
        <template id="portal_my_memberships" name="My Memberships">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'membership'"/>
                
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2><i class="fa fa-id-card"/> My Memberships</h2>
                                <div>
                                    <t t-if="is_member">
                                        <a href="/my/member/profile" class="btn btn-outline-primary me-2">
                                            <i class="fa fa-user"/> Member Profile
                                        </a>
                                    </t>
                                    <t t-if="chapter_memberships">
                                        <a href="/my/chapters" class="btn btn-outline-info">
                                            <i class="fa fa-map-marker"/> Chapter Activities
                                        </a>
                                    </t>
                                </div>
                            </div>

                            <!-- Member Summary -->
                            <t t-if="is_member">
                                <div class="alert alert-primary mb-4">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Member ID:</strong> <span class="text-primary" t-esc="member_number or 'Not Assigned'"/>
                                        </div>
                                        <div class="col-md-3" t-if="member_type and member_type != 'Not Set'">
                                            <strong>Type:</strong> <span t-esc="member_type"/>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Status:</strong> 
                                            <span t-attf-class="badge bg-#{(member_status == 'active') and 'success' or (member_status == 'grace') and 'warning' or 'secondary'}" 
                                                  t-esc="(member_status and str(member_status).title()) or 'Unknown'"/>
                                        </div>
                                        <div class="col-md-3" t-if="membership_end_date">
                                            <strong>Expires:</strong> <span t-esc="membership_end_date"/>
                                        </div>
                                    </div>
                                    <t t-if="chapter_memberships">
                                        <hr class="my-2"/>
                                        <div class="row">
                                            <div class="col-12">
                                                <i class="fa fa-map-marker text-info me-2"/>
                                                <strong>Chapter Memberships:</strong> 
                                                <span t-esc="len(chapter_memberships)"/> active chapter<t t-if="len(chapter_memberships) != 1">s</t>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </t>
                            
                            <t t-if="not memberships">
                                <div class="alert alert-info">
                                    <h4>No memberships found</h4>
                                    <p>You don't have any memberships yet. Contact us to learn about membership options.</p>
                                    <a href="/contactus" class="btn btn-primary">Contact Us</a>
                                </div>
                            </t>
                            
                            <t t-if="memberships">
                                <!-- Regular Memberships -->
                                <t t-set="regular_memberships" t-value="[m for m in memberships if not m.is_chapter_membership]"/>
                                <t t-if="regular_memberships">
                                    <h4 class="mb-3">
                                        <i class="fa fa-id-card text-primary"/> Regular Memberships
                                    </h4>
                                    <div class="row mb-4">
                                        <t t-foreach="regular_memberships" t-as="membership">
                                            <div class="col-lg-6 col-12 mb-4">
                                                <div class="card h-100">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0" t-esc="(membership.product_id and membership.product_id.name) or 'Membership'"/>
                                                        <span t-attf-class="badge bg-#{(membership.state == 'active') and 'success' or (membership.state == 'grace') and 'warning' or 'secondary'}" 
                                                              t-esc="(membership.state and str(membership.state).title()) or 'Unknown'"/>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-2">
                                                            Membership ID: <span t-esc="membership.name or 'Not Available'"/>
                                                        </p>
                                                        <div class="row text-sm">
                                                            <div class="col-6">
                                                                <strong>Start:</strong><br/>
                                                                <span t-esc="membership.start_date or 'Not Set'"/>
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>End:</strong><br/>
                                                                <span t-esc="membership.end_date or 'Not Set'"/>
                                                            </div>
                                                        </div>
                                                        <t t-if="membership.days_until_expiry and membership.days_until_expiry &lt; 30 and membership.days_until_expiry &gt; 0">
                                                            <div class="alert alert-warning mt-2 py-1">
                                                                <i class="fa fa-clock-o"/> Expires in <strong t-esc="membership.days_until_expiry"/> days
                                                            </div>
                                                        </t>
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                Payment: 
                                                                <span t-attf-class="badge bg-#{(membership.payment_status == 'paid') and 'success' or (membership.payment_status == 'pending') and 'warning' or 'secondary'} badge-sm" 
                                                                      t-esc="(membership.payment_status and str(membership.payment_status).title()) or 'Unknown'"/>
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer">
                                                        <div class="d-flex gap-2">
                                                            <a t-attf-href="/my/memberships/#{membership.id}" class="btn btn-sm btn-outline-primary">
                                                                <i class="fa fa-eye"/> View Details
                                                            </a>
                                                            <t t-if="membership.state == 'active' and not membership.auto_renew">
                                                                <a t-attf-href="/my/memberships/#{membership.id}/renew" class="btn btn-sm btn-success">
                                                                    <i class="fa fa-refresh"/> Renew
                                                                </a>
                                                            </t>
                                                            <t t-if="membership.invoice_id">
                                                                <a t-if="membership.invoice_id.access_token"
                                                                   t-attf-href="/my/invoices/#{membership.invoice_id.id}?access_token=#{membership.invoice_id.access_token}" 
                                                                   class="btn btn-sm btn-outline-secondary">
                                                                    <i class="fa fa-file-text-o"/> Invoice
                                                                </a>
                                                                <a t-if="not membership.invoice_id.access_token"
                                                                   t-attf-href="/my/invoices/#{membership.invoice_id.id}" 
                                                                   class="btn btn-sm btn-outline-secondary">
                                                                    <i class="fa fa-file-text-o"/> Invoice
                                                                </a>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </t>

                                <!-- Chapter Memberships -->
                                <t t-if="chapter_memberships">
                                    <h4 class="mb-3">
                                        <i class="fa fa-map-marker text-info"/> Chapter Memberships
                                        <span class="badge bg-info ms-2" t-esc="len(chapter_memberships)"/>
                                    </h4>
                                    <div class="row">
                                        <t t-foreach="chapter_memberships" t-as="chapter">
                                            <div class="col-lg-6 col-12 mb-4">
                                                <div class="card h-100 border-info">
                                                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                                                        <h6 class="mb-0">
                                                            <i class="fa fa-map-marker text-info me-1"/>
                                                            <span t-esc="(chapter.product_id and chapter.product_id.name) or 'Chapter'"/>
                                                        </h6>
                                                        <span t-attf-class="badge bg-#{(chapter.state == 'active') and 'success' or (chapter.state == 'grace') and 'warning' or 'secondary'}" 
                                                              t-esc="(chapter.state and str(chapter.state).title()) or 'Unknown'"/>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="text-muted mb-2">
                                                            Chapter ID: <span t-esc="chapter.name or 'Not Available'"/>
                                                        </p>
                                                        <div class="row text-sm mb-2">
                                                            <div class="col-6">
                                                                <strong>Type:</strong><br/>
                                                                <span t-esc="chapter.chapter_type and chapter.chapter_type.replace('_', ' ').title() or 'Chapter'"/>
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>Role:</strong><br/>
                                                                <span t-esc="chapter.chapter_role and chapter.chapter_role.replace('_', ' ').title() or 'Member'"/>
                                                            </div>
                                                        </div>
                                                        <t t-if="chapter.chapter_location">
                                                            <div class="mb-2">
                                                                <small class="text-muted">
                                                                    <i class="fa fa-location-arrow"/> <span t-esc="chapter.chapter_location"/>
                                                                </small>
                                                            </div>
                                                        </t>
                                                        <t t-if="chapter.chapter_engagement_score and chapter.chapter_engagement_score > 0">
                                                            <div class="mb-2">
                                                                <small class="text-muted">Engagement Score:</small>
                                                                <div class="progress mb-1" style="height: 6px;">
                                                                    <div class="progress-bar bg-info" role="progressbar" 
                                                                         t-attf-style="width: #{chapter.chapter_engagement_score}%"
                                                                         t-attf-aria-valuenow="#{chapter.chapter_engagement_score}" aria-valuemin="0" aria-valuemax="100">
                                                                    </div>
                                                                </div>
                                                                <small class="text-muted"><span t-esc="int(chapter.chapter_engagement_score or 0)"/>%</small>
                                                            </div>
                                                        </t>
                                                        <div class="row text-sm">
                                                            <div class="col-6">
                                                                <strong>Start:</strong><br/>
                                                                <span t-esc="chapter.start_date or 'Not Set'"/>
                                                            </div>
                                                            <div class="col-6">
                                                                <strong>End:</strong><br/>
                                                                <span t-esc="chapter.end_date or 'Not Set'"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-footer">
                                                        <div class="d-flex gap-2">
                                                            <a t-attf-href="/my/chapters/#{chapter.id}" class="btn btn-sm btn-outline-info">
                                                                <i class="fa fa-eye"/> View Details
                                                            </a>
                                                            <t t-if="chapter.chapter_events_attended or chapter.chapter_volunteer_hours">
                                                                <a t-attf-href="/my/chapters/#{chapter.id}/activities" class="btn btn-sm btn-outline-success">
                                                                    <i class="fa fa-calendar"/> Activities
                                                                </a>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- New Chapter Memberships Portal Page -->
        <template id="portal_my_chapters" name="My Chapter Memberships">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'chapters'"/>
                
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fa fa-map-marker"/> My Chapter Activities</h2>
                                <a href="/my/memberships" class="btn btn-outline-primary">
                                    <i class="fa fa-arrow-left"/> Back to Memberships
                                </a>
                            </div>

                            <t t-if="not chapter_memberships">
                                <div class="alert alert-info">
                                    <h4>No chapter memberships found</h4>
                                    <p>You don't have any active chapter memberships yet.</p>
                                    <a href="/my/memberships" class="btn btn-primary">View All Memberships</a>
                                </div>
                            </t>
                            
                            <t t-if="chapter_memberships">
                                <!-- Chapter engagement summary -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <h4 class="text-info" t-esc="len(chapter_memberships)"/>
                                                        <small class="text-muted">Active Chapters</small>
                                                    </div>
                                                    <div class="col-md-3" t-if="total_events_attended">
                                                        <h4 class="text-success" t-esc="total_events_attended"/>
                                                        <small class="text-muted">Events Attended</small>
                                                    </div>
                                                    <div class="col-md-3" t-if="total_volunteer_hours">
                                                        <h4 class="text-warning" t-esc="total_volunteer_hours"/>
                                                        <small class="text-muted">Volunteer Hours</small>
                                                    </div>
                                                    <div class="col-md-3" t-if="average_engagement_score">
                                                        <h4 class="text-primary"><span t-esc="int(average_engagement_score)"/>%</h4>
                                                        <small class="text-muted">Avg Engagement</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chapter memberships -->
                                <div class="row">
                                    <t t-foreach="chapter_memberships" t-as="chapter">
                                        <div class="col-12 mb-4">
                                            <div class="card border-info">
                                                <div class="card-header bg-info text-white">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-8">
                                                            <h5 class="mb-0">
                                                                <i class="fa fa-map-marker me-2"/>
                                                                <span t-esc="chapter.product_id.name"/>
                                                            </h5>
                                                            <small>
                                                                <span t-esc="chapter.chapter_type and chapter.chapter_type.replace('_', ' ').title() or 'Chapter'"/>
                                                                <t t-if="chapter.chapter_location">
                                                                    - <span t-esc="chapter.chapter_location"/>
                                                                </t>
                                                            </small>
                                                        </div>
                                                        <div class="col-md-4 text-end">
                                                            <span class="badge bg-light text-dark">
                                                                <span t-esc="chapter.chapter_role and chapter.chapter_role.replace('_', ' ').title() or 'Member'"/>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <h6>Chapter Access &amp; Benefits</h6>
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <small class="text-muted">Access Level:</small><br/>
                                                                    <span t-esc="chapter.chapter_access_level and chapter.chapter_access_level.replace('_', ' ').title() or 'Basic'"/>
                                                                </div>
                                                                <div class="col-sm-6">
                                                                    <small class="text-muted">Membership:</small><br/>
                                                                    <span t-esc="chapter.start_date"/> - <span t-esc="chapter.end_date"/>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Access permissions -->
                                                            <div class="mt-3">
                                                                <h6>Your Permissions</h6>
                                                                <div class="row">
                                                                    <div class="col-sm-6">
                                                                        <t t-if="chapter.has_local_events_access">
                                                                            <i class="fa fa-check text-success"/> Local Events<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_chapter_documents_access">
                                                                            <i class="fa fa-check text-success"/> Chapter Documents<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_chapter_training_access">
                                                                            <i class="fa fa-check text-success"/> Chapter Training<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_networking_access">
                                                                            <i class="fa fa-check text-success"/> Networking<br/>
                                                                        </t>
                                                                    </div>
                                                                    <div class="col-sm-6">
                                                                        <t t-if="chapter.has_mentorship_access">
                                                                            <i class="fa fa-check text-success"/> Mentorship<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_certification_access">
                                                                            <i class="fa fa-check text-success"/> Certification<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_job_board_access">
                                                                            <i class="fa fa-check text-success"/> Job Board<br/>
                                                                        </t>
                                                                        <t t-if="chapter.has_newsletter_access">
                                                                            <i class="fa fa-check text-success"/> Newsletter<br/>
                                                                        </t>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <h6>Your Activity</h6>
                                                            <div class="text-center">
                                                                <t t-if="chapter.chapter_engagement_score and chapter.chapter_engagement_score > 0">
                                                                    <div class="mb-3">
                                                                        <div class="progress mb-2" style="height: 8px;">
                                                                            <div class="progress-bar bg-success" role="progressbar" 
                                                                                 t-attf-style="width: #{chapter.chapter_engagement_score}%"
                                                                                 t-attf-aria-valuenow="#{chapter.chapter_engagement_score}" aria-valuemin="0" aria-valuemax="100">
                                                                            </div>
                                                                        </div>
                                                                        <strong><span t-esc="int(chapter.chapter_engagement_score or 0)"/>%</strong>
                                                                        <small class="text-muted d-block">Engagement Score</small>
                                                                    </div>
                                                                </t>
                                                                
                                                                <div class="row text-center">
                                                                    <div class="col-6" t-if="chapter.chapter_events_attended">
                                                                        <strong t-esc="chapter.chapter_events_attended"/>
                                                                        <small class="text-muted d-block">Events</small>
                                                                    </div>
                                                                    <div class="col-6" t-if="chapter.chapter_volunteer_hours">
                                                                        <strong t-esc="chapter.chapter_volunteer_hours"/>
                                                                        <small class="text-muted d-block">Vol. Hours</small>
                                                                    </div>
                                                                </div>
                                                                
                                                                <t t-if="chapter.chapter_meeting_attendance">
                                                                    <div class="mt-2">
                                                                        <strong><span t-esc="int(chapter.chapter_meeting_attendance or 0)"/>%</strong>
                                                                        <small class="text-muted d-block">Meeting Attendance</small>
                                                                    </div>
                                                                </t>
                                                            </div>
                                                            
                                                            <div class="mt-3">
                                                                <a t-attf-href="/my/chapters/#{chapter.id}" class="btn btn-outline-info btn-sm d-block mb-2">
                                                                    <i class="fa fa-eye"/> View Details
                                                                </a>
                                                                <t t-if="chapter.chapter_activity_ids">
                                                                    <a t-attf-href="/my/chapters/#{chapter.id}/activities" class="btn btn-outline-success btn-sm d-block">
                                                                        <i class="fa fa-calendar"/> View Activities
                                                                    </a>
                                                                </t>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Enhanced Membership Detail Template with Chapter Support -->
        <template id="portal_membership_detail" name="Membership Details">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'membership'"/>
                
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item">
                                        <a href="/my">My Account</a>
                                    </li>
                                    <li class="breadcrumb-item">
                                        <a href="/my/memberships">Memberships</a>
                                    </li>
                                    <li class="breadcrumb-item active" t-esc="(membership.product_id and membership.product_id.name) or 'Membership'"/>
                                </ol>
                            </nav>

                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h3 class="mb-0">
                                            <t t-if="membership.is_chapter_membership">
                                                <i class="fa fa-map-marker text-info"/> 
                                            </t>
                                            <t t-else="">
                                                <i class="fa fa-id-card text-primary"/> 
                                            </t>
                                            <span t-esc="(membership.product_id and membership.product_id.name) or 'Membership'"/>
                                        </h3>
                                        <div>
                                            <t t-if="membership.is_chapter_membership">
                                                <span class="badge bg-info me-1">Chapter</span>
                                            </t>
                                            <span t-attf-class="badge bg-#{(membership.state == 'active') and 'success' or (membership.state == 'grace') and 'warning' or 'secondary'} fs-6" 
                                                  t-esc="(membership.state and str(membership.state).title()) or 'Unknown'"/>
                                        </div>
                                    </div>
                                    <div class="text-muted mt-2">
                                        <strong>Member ID:</strong> <span class="text-primary" t-esc="member_number or 'Not Available'"/> | 
                                        <strong>Membership ID:</strong> <span t-esc="membership.name or 'Not Available'"/>
                                    </div>
                                </div>
                                
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h5>Membership Period</h5>
                                            <table class="table table-borderless table-sm">
                                                <tr>
                                                    <td width="40%"><strong>Start Date:</strong></td>
                                                    <td t-esc="membership.start_date or 'Not Set'"/>
                                                </tr>
                                                <tr>
                                                    <td><strong>End Date:</strong></td>
                                                    <td t-esc="membership.end_date or 'Not Set'"/>
                                                </tr>
                                                <tr t-if="membership.last_renewal_date">
                                                    <td><strong>Last Renewed:</strong></td>
                                                    <td t-esc="membership.last_renewal_date"/>
                                                </tr>
                                                <tr t-if="membership.days_until_expiry and membership.days_until_expiry > 0">
                                                    <td><strong>Days Remaining:</strong></td>
                                                    <td>
                                                        <span t-attf-class="badge bg-#{(membership.days_until_expiry &lt; 30) and 'warning' or 'info'}"
                                                              t-esc="membership.days_until_expiry"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h5>Details</h5>
                                            <table class="table table-borderless table-sm">
                                                <tr t-if="membership.member_type_id and membership.member_type_id.name">
                                                    <td width="40%"><strong>Member Type:</strong></td>
                                                    <td t-esc="membership.member_type_id.name"/>
                                                </tr>
                                                <tr>
                                                    <td><strong>Type:</strong></td>
                                                    <td>
                                                        <t t-if="membership.is_chapter_membership">
                                                            <span class="badge bg-info">Chapter Membership</span>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="badge bg-primary">Regular Membership</span>
                                                        </t>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Auto Renew:</strong></td>
                                                    <td>
                                                        <span t-if="membership.auto_renew" class="text-success">
                                                            <i class="fa fa-check"/> Enabled
                                                        </span>
                                                        <span t-else="" class="text-muted">
                                                            <i class="fa fa-times"/> Disabled
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Payment:</strong></td>
                                                    <td>
                                                        <span t-attf-class="badge bg-#{(membership.payment_status == 'paid') and 'success' or (membership.payment_status == 'pending') and 'warning' or 'secondary'}" 
                                                              t-esc="(membership.payment_status and str(membership.payment_status).title()) or 'Unknown'"/>
                                                    </td>
                                                </tr>
                                                <tr t-if="membership.membership_fee">
                                                    <td><strong>Membership Fee:</strong></td>
                                                    <td>
                                                        <t t-if="membership.currency_id">
                                                            <t t-esc="membership.currency_id.symbol or '$'"/>
                                                        </t>
                                                        <t t-else="">$</t>
                                                        <t t-esc="'{:,.2f}'.format(membership.membership_fee)"/>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Chapter-specific information -->
                                    <t t-if="membership.is_chapter_membership">
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <h5><i class="fa fa-map-marker text-info"/> Chapter Information</h5>
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <table class="table table-borderless table-sm">
                                                                    <tr>
                                                                        <td width="40%"><strong>Chapter Type:</strong></td>
                                                                        <td t-esc="membership.chapter_type and membership.chapter_type.replace('_', ' ').title() or 'Chapter'"/>
                                                                    </tr>
                                                                    <tr t-if="membership.chapter_location">
                                                                        <td><strong>Location:</strong></td>
                                                                        <td t-esc="membership.chapter_location"/>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><strong>Your Role:</strong></td>
                                                                        <td>
                                                                            <span class="badge bg-info">
                                                                                <t t-esc="membership.chapter_role and membership.chapter_role.replace('_', ' ').title() or 'Member'"/>
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td><strong>Access Level:</strong></td>
                                                                        <td t-esc="membership.chapter_access_level and membership.chapter_access_level.replace('_', ' ').title() or 'Basic'"/>
                                                                    </tr>
                                                                </table>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <t t-if="membership.chapter_engagement_score and membership.chapter_engagement_score > 0">
                                                                    <div class="text-center mb-3">
                                                                        <h6>Your Engagement</h6>
                                                                        <div class="progress mb-2" style="height: 12px;">
                                                                            <div class="progress-bar bg-info" role="progressbar" 
                                                                                 t-attf-style="width: #{membership.chapter_engagement_score}%"
                                                                                 t-attf-aria-valuenow="#{membership.chapter_engagement_score}" aria-valuemin="0" aria-valuemax="100">
                                                                            </div>
                                                                        </div>
                                                                        <strong><span t-esc="int(membership.chapter_engagement_score or 0)"/>%</strong>
                                                                        <small class="text-muted d-block">Engagement Score</small>
                                                                    </div>
                                                                </t>
                                                                
                                                                <div class="row text-center" t-if="membership.chapter_events_attended or membership.chapter_volunteer_hours">
                                                                    <div class="col-6" t-if="membership.chapter_events_attended">
                                                                        <strong t-esc="membership.chapter_events_attended"/>
                                                                        <small class="text-muted d-block">Events Attended</small>
                                                                    </div>
                                                                    <div class="col-6" t-if="membership.chapter_volunteer_hours">
                                                                        <strong t-esc="membership.chapter_volunteer_hours"/>
                                                                        <small class="text-muted d-block">Volunteer Hours</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Chapter Access Summary -->
                                                        <div class="mt-3">
                                                            <h6>Your Chapter Access</h6>
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <t t-if="membership.has_local_events_access">
                                                                        <i class="fa fa-check text-success me-1"/> Local Events<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_chapter_documents_access">
                                                                        <i class="fa fa-check text-success me-1"/> Chapter Documents<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_chapter_training_access">
                                                                        <i class="fa fa-check text-success me-1"/> Chapter Training<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_networking_access">
                                                                        <i class="fa fa-check text-success me-1"/> Networking Access<br/>
                                                                    </t>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <t t-if="membership.has_mentorship_access">
                                                                        <i class="fa fa-check text-success me-1"/> Mentorship Programs<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_certification_access">
                                                                        <i class="fa fa-check text-success me-1"/> Certification Programs<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_job_board_access">
                                                                        <i class="fa fa-check text-success me-1"/> Job Board<br/>
                                                                    </t>
                                                                    <t t-if="membership.has_newsletter_access">
                                                                        <i class="fa fa-check text-success me-1"/> Chapter Newsletter<br/>
                                                                    </t>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                    
                                    <!-- Benefits Section -->
                                    <t t-if="membership.benefit_ids">
                                        <h5>Your Benefits</h5>
                                        <div class="row mb-4">
                                            <t t-foreach="membership.benefit_ids" t-as="benefit">
                                                <div class="col-md-6 mb-3">
                                                    <div class="card border-primary border-opacity-25">
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                <i class="fa fa-gift text-primary"/> <span t-esc="benefit.name or 'Benefit'"/>
                                                            </h6>
                                                            <p class="card-text text-muted" t-esc="benefit.description or 'No description'"/>
                                                            <t t-if="benefit.benefit_type == 'discount' and benefit.discount_percentage">
                                                                <span class="badge bg-primary">
                                                                    <span t-esc="benefit.discount_percentage or 0"/>% Discount
                                                                </span>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                    
                                    <!-- Action Buttons -->
                                    <div class="d-flex gap-2 justify-content-end">
                                        <t t-if="membership.state == 'active' and not membership.auto_renew">
                                            <a t-attf-href="/my/memberships/#{membership.id}/renew" class="btn btn-success">
                                                <i class="fa fa-refresh"/> Renew Membership
                                            </a>
                                        </t>
                                        
                                        <t t-if="membership.is_chapter_membership and membership.chapter_activity_ids">
                                            <a t-attf-href="/my/chapters/#{membership.id}/activities" class="btn btn-info">
                                                <i class="fa fa-calendar"/> View Activities
                                            </a>
                                        </t>
                                        
                                        <!-- Invoice button with proper access token -->
                                        <t t-if="membership.invoice_id">
                                            <a t-if="membership.invoice_id.access_token"
                                               t-attf-href="/my/invoices/#{membership.invoice_id.id}?access_token=#{membership.invoice_id.access_token}" 
                                               class="btn btn-outline-primary">
                                                <i class="fa fa-file-text-o"/> View Invoice
                                            </a>
                                            <a t-if="not membership.invoice_id.access_token"
                                               t-attf-href="/my/invoices/#{membership.invoice_id.id}" 
                                               class="btn btn-outline-primary">
                                                <i class="fa fa-file-text-o"/> View Invoice
                                            </a>
                                        </t>
                                        
                                        <a href="/my/memberships" class="btn btn-outline-secondary">
                                            <i class="fa fa-arrow-left"/> Back to Memberships
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- Keep existing subscription templates unchanged -->
        <template id="portal_my_subscriptions" name="My Subscriptions">
            <t t-call="portal.portal_layout">
                <t t-set="page_name" t-value="'subscription'"/>
                
                <div class="container mt-4">
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2><i class="fa fa-refresh"/> My Subscriptions</h2>
                            </div>
                            
                            <t t-if="not subscriptions">
                                <div class="alert alert-info">
                                    <h4>No subscriptions found</h4>
                                    <p>You don't have any subscriptions yet. Browse our publications and services to get started.</p>
                                </div>
                            </t>
                            
                            <t t-if="subscriptions">
                                <div class="row">
                                    <t t-foreach="subscriptions" t-as="subscription">
                                        <div class="col-lg-6 col-12 mb-4">
                                            <div class="card h-100">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <h6 class="mb-0" t-esc="(subscription.product_id and subscription.product_id.name) or 'Subscription'"/>
                                                    <div>
                                                        <span class="badge bg-info me-1" t-esc="(subscription.subscription_type and str(subscription.subscription_type).title()) or 'Subscription'"/>
                                                        <span t-attf-class="badge bg-#{(subscription.state == 'active') and 'success' or (subscription.state == 'paused') and 'info' or (subscription.state == 'suspended') and 'warning' or 'secondary'}" 
                                                              t-esc="(subscription.state and str(subscription.state).title()) or 'Unknown'"/>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted mb-2">
                                                        ID: <span t-esc="subscription.name or 'Not Available'"/>
                                                    </p>
                                                    <div class="row text-sm">
                                                        <div class="col-6">
                                                            <strong>Start:</strong><br/>
                                                            <span t-esc="subscription.start_date or 'Not Set'"/>
                                                        </div>
                                                        <div class="col-6">
                                                            <strong>End:</strong><br/>
                                                            <span t-esc="subscription.end_date or 'Not Set'"/>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Publication specific info -->
                                                    <t t-if="subscription.subscription_type == 'publication'">
                                                        <div class="mt-2">
                                                            <span t-if="subscription.digital_access" class="badge bg-light text-dark me-1">
                                                                <i class="fa fa-desktop"/> Digital
                                                            </span>
                                                            <span t-if="subscription.print_delivery" class="badge bg-light text-dark">
                                                                <i class="fa fa-print"/> Print
                                                            </span>
                                                        </div>
                                                    </t>
                                                </div>
                                                <div class="card-footer">
                                                    <a t-attf-href="/my/subscriptions/#{subscription.id}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fa fa-eye"/> View Details
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </template>

        <!-- No Membership Access Template -->
        <template id="portal_no_membership_access" name="No Membership Access">
            <t t-call="portal.portal_layout">
                <div class="container mt-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="alert alert-info">
                                <h4>Membership Portal</h4>
                                <p>This section is available for members only.</p>
                                <a href="/contactus" class="btn btn-primary">Contact Us About Membership</a>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>

    </data>
</odoo>