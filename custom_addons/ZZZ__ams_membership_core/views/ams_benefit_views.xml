<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- AMS Benefit List View -->
        <record id="view_ams_benefit_list" model="ir.ui.view">
            <field name="name">ams.benefit.list</field>
            <field name="model">ams.benefit</field>
            <field name="arch" type="xml">
                <list string="Benefits" default_order="sequence,name">
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="code"/>
                    <field name="benefit_type"/>
                    <field name="applies_to"/>
                    <field name="is_quantifiable"/>
                    <field name="quantity_limit" optional="hide"/>
                    <field name="discount_percentage" optional="hide" 
                           invisible="benefit_type != 'discount'"/>
                    <field name="member_count" optional="show"/>
                    <field name="usage_count" optional="hide"/>
                    <field name="active"/>
                </list>
            </field>
        </record>

        <!-- AMS Benefit Form View - CORRECTED -->
        <record id="view_ams_benefit_form" model="ir.ui.view">
            <field name="name">ams.benefit.form</field>
            <field name="model">ams.benefit</field>
            <field name="arch" type="xml">
                <form string="Benefit">
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_usage_log" type="object" 
                                    class="oe_stat_button" icon="fa-history"
                                    invisible="not usage_count"
                                    groups="ams_membership_core.group_membership_user">
                                <field name="usage_count" widget="statinfo" string="Usage Count"/>
                            </button>
                            
                            <button name="action_view_active_members" type="object" 
                                    class="oe_stat_button" icon="fa-users"
                                    groups="ams_membership_core.group_membership_user">
                                <field name="member_count" widget="statinfo" string="Active Members"/>
                            </button>
                        </div>

                        <widget name="web_ribbon" title="Archived" bg_color="bg-danger" 
                                invisible="active"/>

                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Benefit Name"/>
                            </h1>
                            <div class="o_row">
                                <field name="code" placeholder="BENEFIT_CODE"/>
                            </div>
                        </div>

                        <group>
                            <group string="Basic Information">
                                <field name="benefit_type"/>
                                <field name="applies_to"/>
                                <field name="sequence"/>
                                <field name="active"/>
                            </group>
                            <group string="Usage Configuration">
                                <field name="is_quantifiable"/>
                                <field name="quantity_limit" 
                                       invisible="not is_quantifiable"/>
                                <field name="reset_period" 
                                       invisible="not is_quantifiable"/>
                                <field name="auto_apply"/>
                                <field name="requires_approval"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Description" name="description">
                                <field name="description" 
                                       placeholder="Detailed description of this benefit and how it works..."/>
                            </page>

                            <page string="Discount Settings" name="discount" 
                                  invisible="benefit_type != 'discount'">
                                <group>
                                    <group string="Discount Configuration">
                                        <field name="discount_type"/>
                                        <field name="discount_percentage" 
                                               invisible="discount_type != 'percentage'"/>
                                        <field name="discount_amount" widget="monetary"
                                               invisible="discount_type != 'fixed'"/>
                                        <field name="currency_id" invisible="True"/>
                                    </group>
                                    <group string="Product Filters">
                                        <field name="applies_to_products"/>
                                        <field name="product_ids" widget="many2many_tags"
                                               invisible="not applies_to_products"/>
                                        <field name="product_category_ids" widget="many2many_tags"
                                               invisible="not applies_to_products"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Access Control" name="access" 
                                  invisible="benefit_type != 'access'">
                                <group>
                                    <group string="Portal Access">
                                        <field name="portal_access_group_ids" widget="many2many_tags"/>
                                        <field name="website_access_pages"/>
                                    </group>
                                    <group string="Content Access">
                                        <field name="content_categories"/>
                                        <field name="digital_resources"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Event Access" name="event" 
                                  invisible="benefit_type != 'event'">
                                <group>
                                    <group string="Event Configuration">
                                        <field name="event_access_level"/>
                                        <field name="early_bird_access"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Physical Benefits" name="physical" 
                                  invisible="benefit_type != 'physical'">
                                <group>
                                    <group string="Shipping Configuration">
                                        <field name="shipping_required"/>
                                        <field name="shipping_frequency" 
                                               invisible="not shipping_required"/>
                                    </group>
                                </group>
                            </page>

                            <page string="Active Members" name="members">
                                <group>
                                    <group string="Memberships with this Benefit">
                                        <field name="membership_ids" nolabel="1">
                                            <list>
                                                <field name="partner_id"/>
                                                <field name="product_id"/>
                                                <field name="state"/>
                                                <field name="end_date"/>
                                            </list>
                                        </field>
                                    </group>
                                    <group string="Subscriptions with this Benefit">
                                        <field name="subscription_ids" nolabel="1">
                                            <list>
                                                <field name="partner_id"/>
                                                <field name="product_id"/>
                                                <field name="state"/>
                                                <field name="end_date"/>
                                            </list>
                                        </field>
                                    </group>
                                </group>
                            </page>

                            <page string="Usage Log" name="usage" 
                                  invisible="not usage_count">
                                <field name="usage_log_ids" nolabel="1">
                                    <list>
                                        <field name="partner_id"/>
                                        <field name="quantity"/>
                                        <field name="usage_date"/>
                                        <field name="notes"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <chatter/>
                    </div>
                </form>
            </field>
        </record>

        <!-- AMS Benefit Kanban View -->
        <record id="view_ams_benefit_kanban" model="ir.ui.view">
            <field name="name">ams.benefit.kanban</field>
            <field name="model">ams.benefit</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile" default_group_by="benefit_type">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="benefit_type"/>
                    <field name="applies_to"/>
                    <field name="is_quantifiable"/>
                    <field name="quantity_limit"/>
                    <field name="member_count"/>
                    <field name="usage_count"/>
                    <field name="active"/>
                    <field name="discount_percentage"/>
                    <field name="discount_amount"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                                <div class="row">
                                    <div class="col-8">
                                        <strong><t t-esc="record.name.value"/></strong>
                                    </div>
                                    <div class="col-4 text-right">
                                        <span t-if="record.code.value" class="badge badge-pill badge-info">
                                            <t t-esc="record.code.value"/>
                                        </span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <span t-attf-class="badge badge-#{record.applies_to.raw_value === 'membership' ? 'primary' : record.applies_to.raw_value === 'subscription' ? 'success' : 'secondary'}">
                                            <t t-esc="record.applies_to.value"/>
                                        </span>
                                        <t t-if="record.is_quantifiable.raw_value">
                                            <span class="badge badge-warning">
                                                Limit: <t t-esc="record.quantity_limit.value"/>
                                            </span>
                                        </t>
                                    </div>
                                </div>
                                <div class="row" t-if="record.benefit_type.raw_value === 'discount'">
                                    <div class="col-12">
                                        <t t-if="record.discount_percentage.raw_value">
                                            <strong><t t-esc="record.discount_percentage.value"/>% discount</strong>
                                        </t>
                                        <t t-if="record.discount_amount.raw_value">
                                            <strong>$<t t-esc="record.discount_amount.value"/> discount</strong>
                                        </t>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small><t t-esc="record.member_count.value"/> members</small>
                                    </div>
                                    <div class="col-6 text-right" t-if="record.usage_count.raw_value">
                                        <small><t t-esc="record.usage_count.value"/> uses</small>
                                    </div>
                                </div>
                                <div class="row" t-if="!record.active.raw_value">
                                    <div class="col-12">
                                        <span class="badge badge-danger">Archived</span>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- AMS Benefit Search View -->
        <record id="view_ams_benefit_search" model="ir.ui.view">
            <field name="name">ams.benefit.search</field>
            <field name="model">ams.benefit</field>
            <field name="arch" type="xml">
                <search string="Benefits">
                    <field name="name"/>
                    <field name="code"/>
                    <field name="description"/>
                    <separator/>
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Archived" name="inactive" domain="[('active', '=', False)]"/>
                    <separator/>
                    <filter string="Membership Benefits" name="membership_benefits" 
                            domain="[('applies_to', 'in', ['membership', 'both'])]"/>
                    <filter string="Subscription Benefits" name="subscription_benefits" 
                            domain="[('applies_to', 'in', ['subscription', 'both'])]"/>
                    <separator/>
                    <filter string="Discount Benefits" name="discount_benefits" 
                            domain="[('benefit_type', '=', 'discount')]"/>
                    <filter string="Access Benefits" name="access_benefits" 
                            domain="[('benefit_type', '=', 'access')]"/>
                    <filter string="Content Benefits" name="content_benefits" 
                            domain="[('benefit_type', '=', 'content')]"/>
                    <filter string="Event Benefits" name="event_benefits" 
                            domain="[('benefit_type', '=', 'event')]"/>
                    <separator/>
                    <filter string="Auto Apply" name="auto_apply" 
                            domain="[('auto_apply', '=', True)]"/>
                    <filter string="Requires Approval" name="requires_approval" 
                            domain="[('requires_approval', '=', True)]"/>
                    <filter string="Has Usage Limit" name="quantifiable" 
                            domain="[('is_quantifiable', '=', True)]"/>
                    <separator/>
                    <filter string="Recently Used" name="recently_used" 
                            domain="[('usage_count', '>', 0)]"/>
                    <group expand="0" string="Group By">
                        <filter string="Benefit Type" name="group_benefit_type" 
                                domain="[]" context="{'group_by': 'benefit_type'}"/>
                        <filter string="Applies To" name="group_applies_to" 
                                domain="[]" context="{'group_by': 'applies_to'}"/>
                        <filter string="Reset Period" name="group_reset_period" 
                                domain="[]" context="{'group_by': 'reset_period'}"/>
                        <filter string="Active Status" name="group_active" 
                                domain="[]" context="{'group_by': 'active'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Rest of the views remain the same -->
        <!-- AMS Benefit Usage List View -->
        <record id="view_ams_benefit_usage_list" model="ir.ui.view">
            <field name="name">ams.benefit.usage.list</field>
            <field name="model">ams.benefit.usage</field>
            <field name="arch" type="xml">
                <list string="Benefit Usage Log" default_order="usage_date desc" create="false">
                    <field name="benefit_id"/>
                    <field name="partner_id"/>
                    <field name="quantity"/>
                    <field name="usage_date"/>
                    <field name="sale_order_id" optional="hide"/>
                    <field name="invoice_id" optional="hide"/>
                    <field name="notes"/>
                </list>
            </field>
        </record>

        <!-- AMS Benefit Usage Form View -->
        <record id="view_ams_benefit_usage_form" model="ir.ui.view">
            <field name="name">ams.benefit.usage.form</field>
            <field name="model">ams.benefit.usage</field>
            <field name="arch" type="xml">
                <form string="Benefit Usage" create="false">
                    <sheet>
                        <group>
                            <group string="Usage Information">
                                <field name="benefit_id" readonly="True"/>
                                <field name="partner_id" readonly="True"/>
                                <field name="quantity" readonly="True"/>
                                <field name="usage_date" readonly="True"/>
                            </group>
                            <group string="Related Records">
                                <field name="sale_order_id" readonly="True"/>
                                <field name="invoice_id" readonly="True"/>
                            </group>
                        </group>
                        <group string="Notes">
                            <field name="notes" readonly="True" nolabel="1"/>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- AMS Benefit Usage Search View -->
        <record id="view_ams_benefit_usage_search" model="ir.ui.view">
            <field name="name">ams.benefit.usage.search</field>
            <field name="model">ams.benefit.usage</field>
            <field name="arch" type="xml">
                <search string="Benefit Usage">
                    <field name="benefit_id"/>
                    <field name="partner_id"/>
                    <field name="notes"/>
                    <separator/>
                    <filter string="This Month" name="this_month" 
                            domain="[('usage_date', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                    <filter string="This Year" name="this_year" 
                            domain="[('usage_date', '&gt;=', (context_today() - datetime.timedelta(days=365)).strftime('%Y-%m-%d'))]"/>
                    <group expand="0" string="Group By">
                        <filter string="Benefit" name="group_benefit" 
                                domain="[]" context="{'group_by': 'benefit_id'}"/>
                        <filter string="Member" name="group_partner" 
                                domain="[]" context="{'group_by': 'partner_id'}"/>
                        <filter string="Usage Date" name="group_usage_date" 
                                domain="[]" context="{'group_by': 'usage_date:month'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- AMS Benefit Actions -->
        <record id="action_ams_benefit" model="ir.actions.act_window">
            <field name="name">Benefits</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">ams.benefit</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first member benefit
                </p>
                <p>
                    Benefits define the advantages and services available to members
                    and subscribers. Configure discounts, access permissions, content
                    access, and other valuable benefits.
                </p>
            </field>
        </record>

        <!-- Discount Benefits Action -->
        <record id="action_ams_benefit_discounts" model="ir.actions.act_window">
            <field name="name">Discount Benefits</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">ams.benefit</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[('benefit_type', '=', 'discount')]</field>
            <field name="context">{
                'default_benefit_type': 'discount',
                'search_default_active': 1
            }</field>
        </record>

        <!-- Access Benefits Action -->
        <record id="action_ams_benefit_access" model="ir.actions.act_window">
            <field name="name">Access Benefits</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">ams.benefit</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[('benefit_type', '=', 'access')]</field>
            <field name="context">{
                'default_benefit_type': 'access',
                'search_default_active': 1
            }</field>
        </record>

        <!-- Benefit Usage Action -->
        <record id="action_ams_benefit_usage" model="ir.actions.act_window">
            <field name="name">Benefit Usage</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">ams.benefit.usage</field>
            <field name="view_mode">list,form</field>
            <field name="context">{'search_default_this_month': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No benefit usage recorded yet
                </p>
                <p>
                    This report shows how members are using their benefits.
                    Usage is tracked automatically when benefits have quantity limits.
                </p>
            </field>
        </record>

    </data>
</odoo>