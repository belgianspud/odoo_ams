<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<!-- Communication Log List View -->
	<record id="view_ams_communication_log_list" model="ir.ui.view">
		<field name="name">ams.communication.log.list</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<list string="Communication Log" default_order="sent_date desc" create="false">
				<field name="sent_date"/>
				<field name="partner_name"/>
				<field name="communication_type"/>
				<field name="category"/>
				<field name="subject"/>
				<field name="delivery_status" decoration-success="delivery_status in ('delivered','opened','clicked')" 
                       decoration-danger="delivery_status in ('failed','bounced')"
                       decoration-warning="delivery_status == 'sent'"
                       decoration-info="delivery_status in ('complained','unsubscribed')"/>
				<field name="engagement_score" optional="hide"/>
				<field name="campaign_id" optional="hide"/>
				<field name="template_id" optional="hide"/>
				<field name="is_member" optional="hide"/>
				<field name="days_since_sent" optional="hide"/>
				<field name="delivery_successful" invisible="1"/>
				<field name="response_tracked" optional="hide"/>
			</list>
		</field>
	</record>
	<!-- Communication Log Form View -->
	<record id="view_ams_communication_log_form" model="ir.ui.view">
		<field name="name">ams.communication.log.form</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<form string="Communication Log" create="false" edit="false">
				<header>
					<field name="delivery_status" widget="statusbar" 
                           statusbar_visible="sent,delivered,opened,clicked"/>
				</header>
				<sheet>
					<div class="oe_button_box" name="button_box">
						<button name="track_open" string="Track Open" type="object" 
                                class="oe_stat_button" icon="fa-eye"
                                invisible="communication_type != 'email'">
							<div class="o_field_widget o_stat_info">
								<span class="o_stat_value">
									<field name="open_count"/>
								</span>
								<span class="o_stat_text">Opens</span>
							</div>
						</button>
						<button name="track_click" string="Track Click" type="object" 
                                class="oe_stat_button" icon="fa-mouse-pointer"
                                invisible="response_tracked == False">
							<div class="o_field_widget o_stat_info">
								<span class="o_stat_value">
									<field name="click_count"/>
								</span>
								<span class="o_stat_text">Clicks</span>
							</div>
						</button>
					</div>
					<div class="oe_title">
						<h1>
							<field name="subject" placeholder="Communication Subject"/>
						</h1>
						<div class="o_row">
							<field name="display_name" invisible="1"/>
						</div>
					</div>
					<group>
						<group>
							<field name="partner_id" readonly="1"/>
							<field name="communication_type" readonly="1"/>
							<field name="category" readonly="1"/>
							<field name="sent_date" readonly="1"/>
							<field name="delivery_date" readonly="1"/>
						</group>
						<group>
							<field name="template_id" readonly="1"/>
							<field name="campaign_id" readonly="1"/>
							<field name="automation_rule_id" readonly="1"/>
							<field name="external_message_id" readonly="1"/>
							<field name="external_provider" readonly="1"/>
						</group>
					</group>
					<group string="Delivery &amp; Engagement">
						<group>
							<field name="delivery_successful" readonly="1"/>
							<field name="bounce_reason" readonly="1" 
                                   invisible="delivery_status not in ('bounced', 'failed')"
                                   placeholder="Reason for delivery failure..."/>
							<field name="response_tracked" readonly="1"/>
							<field name="engagement_score" readonly="1"/>
						</group>
						<group>
							<field name="opened_date" readonly="1"/>
							<field name="clicked_date" readonly="1"/>
							<field name="days_since_sent" readonly="1"/>
						</group>
					</group>
					<notebook>
						<page string="Content" invisible="not body_plain and not body_html">
							<group>
								<field name="body_html" widget="html" readonly="1" 
                                       invisible="not body_html"/>
								<field name="body_plain" readonly="1" 
                                       invisible="not body_plain"
                                       widget="text"/>
							</group>
						</page>
						<page string="Attachments" invisible="not attachment_ids">
							<field name="attachment_ids" mode="kanban" readonly="1">
								<kanban>
									<templates>
										<t t-name="kanban-box">
											<div class="oe_kanban_card oe_kanban_global_click o_kanban_attachment">
												<div class="o_kanban_image">
													<div class="o_kanban_image_wrapper">
														<i class="fa fa-file-text-o fa-2x"/>
													</div>
												</div>
												<div class="oe_kanban_details">
													<div class="o_kanban_record_title">
														<field name="name"/>
													</div>
												</div>
											</div>
										</t>
									</templates>
								</kanban>
							</field>
						</page>
						<page string="Partner Information">
							<group>
								<group>
									<field name="partner_email" readonly="1"/>
									<field name="is_member" readonly="1"/>
								</group>
							</group>
						</page>
						<page string="Technical Details" groups="base.group_no_one">
							<group>
								<field name="external_message_id" readonly="1"/>
								<field name="external_provider" readonly="1"/>
							</group>
						</page>
					</notebook>
				</sheet>
			</form>
		</field>
	</record>
	<!-- Communication Log Search View -->
	<record id="view_ams_communication_log_search" model="ir.ui.view">
		<field name="name">ams.communication.log.search</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<search string="Search Communication Log">
				<field name="partner_id"/>
				<field name="subject"/>
				<field name="communication_type"/>
				<field name="category"/>
				<field name="campaign_id"/>
				<field name="template_id"/>
				<!-- Quick Filters -->
				<filter string="Email" name="email" 
                        domain="[('communication_type', '=', 'email')]"/>
				<filter string="SMS" name="sms" 
                        domain="[('communication_type', '=', 'sms')]"/>
				<filter string="Mail" name="mail" 
                        domain="[('communication_type', '=', 'mail')]"/>
				<filter string="Phone" name="phone" 
                        domain="[('communication_type', '=', 'phone')]"/>
				<separator/>
				<filter string="Delivered" name="delivered" 
                        domain="[('delivery_status', 'in', ['delivered', 'opened', 'clicked'])]"/>
				<filter string="Failed" name="failed" 
                        domain="[('delivery_status', 'in', ['failed', 'bounced'])]"/>
				<filter string="Opened" name="opened" 
                        domain="[('delivery_status', 'in', ['opened', 'clicked'])]"/>
				<filter string="Clicked" name="clicked" 
                        domain="[('delivery_status', '=', 'clicked')]"/>
				<filter string="Bounced" name="bounced" 
                        domain="[('delivery_status', '=', 'bounced')]"/>
				<separator/>
				<filter string="Marketing" name="marketing" 
                        domain="[('category', '=', 'marketing')]"/>
				<filter string="Membership" name="membership" 
                        domain="[('category', '=', 'membership')]"/>
				<filter string="Events" name="events" 
                        domain="[('category', '=', 'events')]"/>
				<filter string="Education" name="education" 
                        domain="[('category', '=', 'education')]"/>
				<filter string="Emergency" name="emergency" 
                        domain="[('category', '=', 'emergency')]"/>
				<separator/>
				<filter string="Members Only" name="members_only" 
                        domain="[('is_member', '=', True)]"/>
				<filter string="With Campaign" name="with_campaign" 
                        domain="[('campaign_id', '!=', False)]"/>
				<filter string="With Template" name="with_template" 
                        domain="[('template_id', '!=', False)]"/>
				<filter string="Response Tracked" name="response_tracked" 
                        domain="[('response_tracked', '=', True)]"/>
				<separator/>
				<filter string="Today" name="today" 
                        domain="[('sent_date', '&gt;=', context_today().strftime('%Y-%m-%d 00:00:00')), ('sent_date', '&lt;=', context_today().strftime('%Y-%m-%d 23:59:59'))]"/>
				<filter string="Last 7 Days" name="last_week" 
                        domain="[('sent_date', '&gt;=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d 00:00:00'))]"/>
				<filter string="Last 30 Days" name="last_month" 
                        domain="[('sent_date', '&gt;=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d 00:00:00'))]"/>
				<group expand="0" string="Group By">
					<filter string="Partner" name="group_partner" 
                            context="{'group_by': 'partner_id'}"/>
					<filter string="Communication Type" name="group_type" 
                            context="{'group_by': 'communication_type'}"/>
					<filter string="Category" name="group_category" 
                            context="{'group_by': 'category'}"/>
					<filter string="Delivery Status" name="group_status" 
                            context="{'group_by': 'delivery_status'}"/>
					<filter string="Campaign" name="group_campaign" 
                            context="{'group_by': 'campaign_id'}"/>
					<filter string="Template" name="group_template" 
                            context="{'group_by': 'template_id'}"/>
					<filter string="Sent Date" name="group_sent_date" 
                            context="{'group_by': 'sent_date:day'}"/>
					<filter string="Sent Month" name="group_sent_month" 
                            context="{'group_by': 'sent_date:month'}"/>
				</group>
			</search>
		</field>
	</record>
	<!-- Communication Log Kanban View -->
	<record id="view_ams_communication_log_kanban" model="ir.ui.view">
		<field name="name">ams.communication.log.kanban</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<kanban class="o_kanban_small_column" default_group_by="delivery_status">
				<field name="partner_name"/>
				<field name="communication_type"/>
				<field name="category"/>
				<field name="subject"/>
				<field name="sent_date"/>
				<field name="delivery_status"/>
				<field name="engagement_score"/>
				<field name="open_count"/>
				<field name="click_count"/>
				<templates>
					<t t-name="kanban-box">
						<div class="oe_kanban_card oe_kanban_global_click">
							<div class="oe_kanban_content">
								<div class="o_kanban_record_top mb8">
									<div class="o_kanban_record_headings">
										<strong class="o_kanban_record_title">
											<field name="partner_name"/>
										</strong>
									</div>
									<div class="o_kanban_record_subtitle text-muted">
										<t t-esc="record.communication_type.value"/> - 
										<t t-esc="record.category.value"/>
									</div>
								</div>
								<div class="o_kanban_record_body">
									<div class="row">
										<div class="col-12">
											<strong>
												<field name="subject"/>
											</strong>
										</div>
									</div>
									<div class="row mt-2">
										<div class="col-6">
											<span class="text-muted">
												<field name="sent_date" widget="datetime"/>
											</span>
										</div>
										<div class="col-6 text-right">
											<t t-if="record.engagement_score.raw_value > 0">
												<span class="badge badge-info">
                                                    Score: 
													<t t-esc="record.engagement_score.value"/>
												</span>
											</t>
										</div>
									</div>
								</div>
								<div class="o_kanban_record_bottom">
									<div class="oe_kanban_bottom_left">
										<t t-if="record.open_count.raw_value > 0">
											<span class="text-success">
												<i class="fa fa-eye"/>
												<t t-esc="record.open_count.value"/>
											</span>
										</t>
										<t t-if="record.click_count.raw_value > 0">
											<span class="text-primary ml-2">
												<i class="fa fa-mouse-pointer"/>
												<t t-esc="record.click_count.value"/>
											</span>
										</t>
									</div>
									<div class="oe_kanban_bottom_right">
										<span t-if="record.delivery_status.raw_value == 'delivered'" 
                                              class="badge badge-success">Delivered</span>
										<span t-if="record.delivery_status.raw_value == 'failed'" 
                                              class="badge badge-danger">Failed</span>
										<span t-if="record.delivery_status.raw_value == 'bounced'" 
                                              class="badge badge-warning">Bounced</span>
										<span t-if="record.delivery_status.raw_value == 'opened'" 
                                              class="badge badge-info">Opened</span>
										<span t-if="record.delivery_status.raw_value == 'clicked'" 
                                              class="badge badge-primary">Clicked</span>
									</div>
								</div>
							</div>
						</div>
					</t>
				</templates>
			</kanban>
		</field>
	</record>
	<!-- Communication Log Graph View -->
	<record id="view_ams_communication_log_graph" model="ir.ui.view">
		<field name="name">ams.communication.log.graph</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<graph string="Communication Statistics" type="bar">
				<field name="sent_date" type="row" interval="day"/>
				<field name="delivery_status" type="col"/>
			</graph>
		</field>
	</record>
	<!-- Communication Log Pivot View -->
	<record id="view_ams_communication_log_pivot" model="ir.ui.view">
		<field name="name">ams.communication.log.pivot</field>
		<field name="model">ams.communication.log</field>
		<field name="arch" type="xml">
			<pivot string="Communication Analysis">
				<field name="communication_type" type="col"/>
				<field name="category" type="row"/>
				<field name="delivery_successful" type="measure"/>
				<field name="engagement_score" type="measure"/>
			</pivot>
		</field>
	</record>
	<!-- Main Action for Communication Log -->
	<record id="action_ams_communication_log" model="ir.actions.act_window">
		<field name="name">Communication Log</field>
		<field name="res_model">ams.communication.log</field>
		<field name="view_mode">list,kanban,form,graph,pivot</field>
		<field name="context">{'search_default_last_month': 1}</field>
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
                No communications logged yet
            </p>
			<p>
                The communication log automatically tracks all communications 
                sent to members across all channels including email, SMS, 
                mail, and phone calls.
            </p>
			<p>
                Use this log to monitor delivery success, track engagement,
                and analyze communication effectiveness.
            </p>
		</field>
	</record>
	<!-- Action for Failed Communications -->
	<record id="action_ams_communication_log_failed" model="ir.actions.act_window">
		<field name="name">Failed Communications</field>
		<field name="res_model">ams.communication.log</field>
		<field name="view_mode">list,form</field>
		<field name="domain">[('delivery_status', 'in', ['failed', 'bounced'])]</field>
		<field name="context">{'search_default_failed': 1}</field>
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
                No failed communications - excellent delivery rates!
            </p>
			<p>
                This view shows communications that failed to deliver or bounced.
                Use this to identify and fix delivery issues, update member
                contact information, or investigate delivery problems.
            </p>
		</field>
	</record>
	<!-- Action for High Engagement Communications -->
	<record id="action_ams_communication_log_high_engagement" model="ir.actions.act_window">
		<field name="name">High Engagement Communications</field>
		<field name="res_model">ams.communication.log</field>
		<field name="view_mode">list,form</field>
		<field name="domain">[('engagement_score', '&gt;=', 3.0)]</field>
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
                No high-engagement communications yet
            </p>
			<p>
                Communications with high engagement scores (opens, clicks, responses).
                Analyze these to understand what content resonates best with your members.
            </p>
		</field>
	</record>
	<!-- Dashboard Action -->
	<record id="action_ams_communication_dashboard" model="ir.actions.act_window">
		<field name="name">Communication Dashboard</field>
		<field name="res_model">ams.communication.log</field>
		<field name="view_mode">graph,pivot</field>
		<field name="context">{'search_default_last_month': 1}</field>
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
                Communication Dashboard
            </p>
			<p>
                Analyze communication performance, delivery rates, and 
                engagement metrics across all communication channels.
            </p>
		</field>
	</record>
	<!-- Add menu items -->
	<menuitem id="menu_ams_communication_log" 
              name="Communication History" 
              parent="menu_ams_communication" 
              action="action_ams_communication_log" 
              sequence="30"/>
	<menuitem id="menu_ams_communication_failed" 
              name="Failed Deliveries" 
              parent="menu_ams_communication" 
              action="action_ams_communication_log_failed" 
              sequence="40"/>
	<menuitem id="menu_ams_communication_dashboard" 
              name="Communication Dashboard" 
              parent="menu_ams_communication_reports" 
              action="action_ams_communication_dashboard" 
              sequence="10"/>
<!-- Add Communication tab to Partner form -->
    <record id="view_partner_form_communication" model="ir.ui.view">
        <field name="name">res.partner.form.communication</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <notebook position="inside">
                <page string="Communication" name="communication" invisible="not member_type_id">
                    <div class="oe_button_box" name="communication_button_box">
                        <button name="action_view_communication_preferences" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-cog">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="opted_in_count"/>
                                </span>
                                <span class="o_stat_text">Opted In</span>
                            </div>
                        </button>
                        <button name="action_view_communication_log" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-envelope">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="total_communications_sent"/>
                                </span>
                                <span class="o_stat_text">Communications</span>
                            </div>
                        </button>
                        <button name="action_create_default_preferences" 
                                type="object" 
                                class="oe_stat_button" 
                                icon="fa-plus" 
                                string="Create Preferences"
                                invisible="has_communication_preferences == True"/>
                    </div>
                    
                    <group string="Communication Summary">
                        <group>
                            <field name="email_opted_in" readonly="1"/>
                            <field name="sms_opted_in" readonly="1"/>
                            <field name="mail_opted_in" readonly="1"/>
                            <field name="phone_opted_in" readonly="1"/>
                        </group>
                        <group>
                            <field name="marketing_communications" readonly="1"/>
                            <field name="membership_communications" readonly="1"/>
                            <field name="event_communications" readonly="1"/>
                            <field name="education_communications" readonly="1"/>
                        </group>
                    </group>

                    <group string="Communication Statistics">
                        <group>
                            <field name="last_communication_date" readonly="1"/>
                            <field name="email_bounce_count" readonly="1"/>
                            <field name="last_email_open_date" readonly="1"/>
                        </group>
                        <group>
                            <field name="communication_engagement_score" readonly="1"/>
                            <field name="preference_count" readonly="1"/>
                            <field name="opted_out_count" readonly="1"/>
                        </group>
                    </group>

                    <group string="Recent Communications" invisible="total_communications_sent == 0">
                        <field name="communication_log_ids" nolabel="1" readonly="1"/>
                    </group>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Simple tree view for communication log in partner form -->
    <record id="view_communication_log_partner_tree" model="ir.ui.view">
        <field name="name">ams.communication.log.partner.list</field>
        <field name="model">ams.communication.log</field>
        <field name="arch" type="xml">
            <list create="false" edit="false" limit="10" decoration-success="delivery_status in ('delivered','opened','clicked')" decoration-danger="delivery_status in ('failed','bounced')">
                <field name="sent_date"/>
                <field name="communication_type"/>
                <field name="category"/>
                <field name="subject"/>
                <field name="delivery_status"/>
            </list>
        </field>
    </record>

</odoo>