<!-- views/business_automation_views.xml -->
<odoo>
    <data>
        
        <!-- Main Automation Form View -->
        <record id="view_business_automation_form" model="ir.ui.view">
            <field name="name">business.automation.form</field>
            <field name="model">business.automation</field>
            <field name="arch" type="xml">
                <form string="Business Automation">
                    <header>
                        <button name="execute_automation" string="Run Now" type="object" 
                                class="btn-primary" confirm="Execute this automation now?"/>
                        <field name="active" widget="boolean_toggle"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="e.g. Unpublish low stock products"/>
                            </h1>
                        </div>
                        
                        <group>
                            <group name="basic">
                                <field name="model_id" options="{'no_create': True}" required="1"/>
                                <field name="sequence"/>
                            </group>
                            <group name="stats">
                                <field name="execution_count"/>
                                <field name="last_execution"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="Trigger" name="trigger">
                                <group>
                                    <group name="trigger_config">
                                        <field name="trigger_type" widget="radio" options="{'horizontal': true}"/>
                                        <field name="trigger_field_ids" widget="many2many_tags"
                                               attrs="{'invisible': [('trigger_type', '!=', 'on_write_fields')],
                                                       'required': [('trigger_type', '=', 'on_write_fields')]}"
                                               domain="[('model_id', '=', model_id)]"/>
                                    </group>
                                    <group name="time_config" attrs="{'invisible': [('trigger_type', '!=', 'time_based')]}">
                                        <label for="time_delay_number" string="Execute"/>
                                        <div class="o_row">
                                            <field name="time_delay_number" class="oe_inline"/>
                                            <field name="time_delay_type" class="oe_inline"/>
                                            <span class="oe_inline">after</span>
                                        </div>
                                        <field name="time_field_id" domain="[('model_id', '=', model_id), ('ttype', 'in', ['date', 'datetime'])]"/>
                                    </group>
                                </group>
                                
                                <div class="alert alert-info mt-3">
                                    <h4>When does this rule run?</h4>
                                    <ul>
                                        <li><strong>Record Creation:</strong> When a new record is created</li>
                                        <li><strong>Record Update:</strong> When any field on the record is updated</li>
                                        <li><strong>Specific Field Update:</strong> Only when specified fields are updated</li>
                                        <li><strong>Time-based:</strong> Periodically, based on a date field (requires scheduled action)</li>
                                    </ul>
                                </div>
                            </page>
                            
                            <page string="Conditions" name="conditions">
                                <div class="row">
                                    <div class="col-12">
                                        <field name="use_simple_conditions" widget="boolean_toggle"/>
                                        <span class="ml-2">Use simple condition builder</span>
                                    </div>
                                </div>
                                
                                <div attrs="{'invisible': [('use_simple_conditions', '=', False)]}">
                                    <group>
                                        <field name="condition_type" widget="radio" 
                                               attrs="{'invisible': [('condition_ids', '=', [])]}"/>
                                    </group>
                                    
                                    <field name="condition_ids">
                                        <tree editable="bottom">
                                            <field name="sequence" widget="handle"/>
                                            <field name="field_id" domain="[('model_id', '=', parent.model_id)]" 
                                                   options="{'no_create': True}"/>
                                            <field name="field_type" invisible="1"/>
                                            <field name="operator"/>
                                            <field name="value_type"/>
                                            
                                            <!-- Fixed values based on field type -->
                                            <field name="value_char" 
                                                   attrs="{'invisible': ['|', ('value_type', '!=', 'fixed'), 
                                                           ('field_type', 'not in', ['char', 'text', 'html', 'selection'])],
                                                           'required': [('value_type', '=', 'fixed'), 
                                                                       ('field_type', 'in', ['char', 'text', 'html', 'selection'])]}"/>
                                            <field name="value_integer"
                                                   attrs="{'invisible': ['|', ('value_type', '!=', 'fixed'), 
                                                           ('field_type', '!=', 'integer')],
                                                           'required': [('value_type', '=', 'fixed'), ('field_type', '=', 'integer')]}"/>
                                            <field name="value_float"
                                                   attrs="{'invisible': ['|', ('value_type', '!=', 'fixed'), 
                                                           ('field_type', 'not in', ['float', 'monetary'])],
                                                           'required': [('value_type', '=', 'fixed'), 
                                                                       ('field_type', 'in', ['float', 'monetary'])]}"/>
                                            <field name="value_boolean"
                                                   attrs="{'invisible': ['|', ('value_type', '!=', 'fixed'), 
                                                           ('field_type', '!=', 'boolean')],
                                                           'required': [('value_type', '=', 'fixed'), ('field_type', '=', 'boolean')]}"/>
                                            <field name="value_date"
                                                   attrs="{'invisible': ['|', ('value_type', '!=', 'fixed'), 
                                                           ('field_type', '!=', 'date')],
                                                           'required': [('value_type', '=', 'fixed'), ('field_type', '=', 'date')]}"/>
                                            
                                            <!-- Field reference -->
                                            <field name="value_field_id" domain="[('model_id', '=', parent.model_id)]"
                                                   attrs="{'invisible': [('value_type', '!=', 'field')],
                                                           'required': [('value_type', '=', 'field')]}"
                                                   options="{'no_create': True}"/>
                                        </tree>
                                    </field>
                                </div>
                                
                                <div attrs="{'invisible': [('use_simple_conditions', '=', True)]}">
                                    <group>
                                        <field name="domain_filter" widget="domain" 
                                               options="{'model': 'model_name', 'in_dialog': false}"/>
                                    </group>
                                </div>
                                
                                <div class="alert alert-warning mt-3">
                                    <strong>Tip:</strong> Conditions filter which records this automation applies to. 
                                    If no conditions are set, the automation applies to all records.
                                </div>
                            </page>
                            
                            <page string="Actions" name="actions">
                                <field name="action_ids">
                                    <tree editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="action_type"/>
                                        
                                        <!-- Update Field -->
                                        <field name="update_field_id" domain="[('model_id', '=', parent.model_id)]"
                                               attrs="{'invisible': [('action_type', '!=', 'set_field')],
                                                       'required': [('action_type', '=', 'set_field')]}"
                                               options="{'no_create': True}"/>
                                        <field name="update_value_type"
                                               attrs="{'invisible': [('action_type', '!=', 'set_field')]}"/>
                                        <field name="update_value_char"
                                               attrs="{'invisible': ['|', ('action_type', '!=', 'set_field'), 
                                                       ('update_value_type', '!=', 'fixed')]}"/>
                                        <field name="update_value_boolean"
                                               attrs="{'invisible': ['|', ('action_type', '!=', 'set_field'), 
                                                       ('update_value_type', '!=', 'fixed')]}"/>
                                        
                                        <!-- Activity -->
                                        <field name="activity_type_id"
                                               attrs="{'invisible': [('action_type', '!=', 'create_activity')],
                                                       'required': [('action_type', '=', 'create_activity')]}"
                                               options="{'no_create': True}"/>
                                        <field name="activity_summary"
                                               attrs="{'invisible': [('action_type', '!=', 'create_activity')]}"/>
                                        <field name="activity_user_type"
                                               attrs="{'invisible': [('action_type', '!=', 'create_activity')]}"/>
                                        
                                        <!-- Email -->
                                        <field name="email_template_id"
                                               attrs="{'invisible': [('action_type', '!=', 'send_email')],
                                                       'required': [('action_type', '=', 'send_email')]}"
                                               options="{'no_create': True}"/>
                                        
                                        <!-- Method -->
                                        <field name="method_name"
                                               attrs="{'invisible': [('action_type', '!=', 'execute_method')],
                                                       'required': [('action_type', '=', 'execute_method')]}"/>
                                    </tree>
                                </field>
                                
                                <div class="alert alert-success mt-3">
                                    <h4>Available Actions:</h4>
                                    <ul>
                                        <li><strong>Update Field:</strong> Change a field value</li>
                                        <li><strong>Create Activity:</strong> Schedule a task or reminder</li>
                                        <li><strong>Send Email:</strong> Send email using a template</li>
                                        <li><strong>Archive/Unarchive:</strong> Hide or show the record</li>
                                        <li><strong>Execute Method:</strong> Call a specific method on the record</li>
                                    </ul>
                                </div>
                            </page>
                            
                            <page string="Examples" name="examples">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h3>ðŸ“¦ Product Management</h3>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>Unpublish Low Stock Products</h5>
                                                    <p><strong>Trigger:</strong> When qty_available is updated</p>
                                                    <p><strong>Condition:</strong> qty_available &lt; 5</p>
                                                    <p><strong>Action:</strong> Set is_published = False</p>
                                                </div>
                                            </div>
                                            
                                            <div class="card mt-2">
                                                <div class="card-body">
                                                    <h5>Auto-reorder Products</h5>
                                                    <p><strong>Trigger:</strong> When qty_available is updated</p>
                                                    <p><strong>Condition:</strong> qty_available &lt; reordering_min_qty</p>
                                                    <p><strong>Action:</strong> Create activity for purchasing team</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h3>ðŸ’¼ Sales Process</h3>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>High-Value Lead Alert</h5>
                                                    <p><strong>Trigger:</strong> When expected_revenue is updated</p>
                                                    <p><strong>Condition:</strong> expected_revenue &gt; 50000</p>
                                                    <p><strong>Action:</strong> Create activity for sales manager</p>
                                                </div>
                                            </div>
                                            
                                            <div class="card mt-2">
                                                <div class="card-body">
                                                    <h5>Follow-up Overdue Leads</h5>
                                                    <p><strong>Trigger:</strong> Time-based (daily)</p>
                                                    <p><strong>Condition:</strong> 7 days after date_deadline</p>
                                                    <p><strong>Action:</strong> Send follow-up email</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <h3>ðŸ“‹ Project Management</h3>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>Project Deadline Alert</h5>
                                                    <p><strong>Trigger:</strong> Time-based (daily)</p>
                                                    <p><strong>Condition:</strong> 3 days before date_deadline</p>
                                                    <p><strong>Action:</strong> Send email to project manager</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h3>ðŸ“„ Document Management</h3>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5>Archive Old Records</h5>
                                                    <p><strong>Trigger:</strong> Time-based (weekly)</p>
                                                    <p><strong>Condition:</strong> 90 days after last_activity_date</p>
                                                    <p><strong>Action:</strong> Archive record</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Automation Tree View -->
        <record id="view_business_automation_tree" model="ir.ui.view">
            <field name="name">business.automation.tree</field>
            <field name="model">business.automation</field>
            <field name="arch" type="xml">
                <tree string="Business Automations" decoration-muted="active == False" 
                      decoration-success="execution_count > 0">
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="model_id"/>
                    <field name="trigger_type"/>
                    <field name="execution_count"/>
                    <field name="last_execution"/>
                    <field name="active" widget="boolean_toggle"/>
                </tree>
            </field>
        </record>

        <!-- Automation Kanban View -->
        <record id="view_business_automation_kanban" model="ir.ui.view">
            <field name="name">business.automation.kanban</field>
            <field name="model">business.automation</field>
            <field name="arch" type="xml">
                <kanban default_group_by="model_id" class="o_kanban_small_column">
                    <field name="name"/>
                    <field name="model_id"/>
                    <field name="trigger_type"/>
                    <field name="active"/>
                    <field name="execution_count"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card #{record.active.raw_value ? '' : 'o_kanban_color_2'}">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="name"/>
                                            </strong>
                                        </div>
                                        <div class="o_kanban_manage_button_section">
                                            <a class="o_kanban_manage_toggle_button" href="#">
                                                <i class="fa fa-ellipsis-v"/>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div class="text-muted">
                                            <i class="fa fa-play-circle"/> <t t-esc="record.trigger_type.value"/>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge badge-pill badge-info">
                                                Executed: <t t-esc="record.execution_count.value"/> times
                                            </span>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_bottom">
                                        <div class="oe_kanban_bottom_right">
                                            <field name="active" widget="boolean_toggle"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Search View -->
        <record id="view_business_automation_search" model="ir.ui.view">
            <field name="name">business.automation.search</field>
            <field name="model">business.automation</field>
            <field name="arch" type="xml">
                <search string="Business Automations">
                    <field name="name"/>
                    <field name="model_id"/>
                    <field name="trigger_type"/>
                    
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Inactive" name="inactive" domain="[('active', '=', False)]"/>
                    <separator/>
                    <filter string="Recently Executed" name="recent" 
                            domain="[('last_execution', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                    <filter string="Never Executed" name="never_executed" domain="[('execution_count', '=', 0)]"/>
                    
                    <group expand="1" string="Group By">
                        <filter string="Model" name="group_model" context="{'group_by': 'model_id'}"/>
                        <filter string="Trigger Type" name="group_trigger" context="{'group_by': 'trigger_type'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Quick Setup Wizard -->
        <record id="view_automation_wizard" model="ir.ui.view">
            <field name="name">automation.wizard.form</field>
            <field name="model">automation.wizard</field>
            <field name="arch" type="xml">
                <form string="Quick Automation Setup">
                    <div class="alert alert-info">
                        <h4>ðŸš€ Quick Automation Setup</h4>
                        <p>Set up common automation rules in seconds</p>
                    </div>
                    
                    <group>
                        <field name="template_type" widget="radio"/>
                    </group>
                    
                    <group string="Configuration">
                        <field name="target_model_id" options="{'no_create': True}" required="1"/>
                        <field name="rule_name" placeholder="e.g. Unpublish Low Stock Products"/>
                        
                        <!-- Template-specific fields -->
                        <field name="threshold_value" 
                               attrs="{'invisible': [('template_type', 'not in', ['low_stock', 'high_value'])]}"/>
                        <field name="days_value"
                               attrs="{'invisible': [('template_type', 'not in', ['overdue', 'archive_old'])]}"/>
                        <field name="target_field_id" domain="[('model_id', '=', target_model_id)]"
                               attrs="{'invisible': [('template_type', '=', 'custom')]}"
                               options="{'no_create': True}"/>
                    </group>
                    
                    <footer>
                        <button name="create_automation" string="Create Automation" type="object" class="btn-primary"/>
                        <button string="Cancel" class="btn-secondary" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Actions -->
        <record id="action_business_automation" model="ir.actions.act_window">
            <field name="name">Business Automations</field>
            <field name="res_model">business.automation</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first automation rule!
                </p>
                <p>
                    Automate repetitive tasks with trigger-based rules:
                    <br/>â€¢ Update fields automatically
                    <br/>â€¢ Create activities and reminders  
                    <br/>â€¢ Send emails when conditions are met
                    <br/>â€¢ Archive old records
                </p>
                <p>
                    <button type="object" name="%(action_automation_wizard)d" class="btn-primary">
                        Quick Setup
                    </button>
                </p>
            </field>
        </record>

        <record id="action_automation_wizard" model="ir.actions.act_window">
            <field name="name">Quick Automation Setup</field>
            <field name="res_model">automation.wizard</field>
            <field name="view_mode">form</field>
            <field name="target">new</field>
        </record>

        <!-- Cron Job for Time-based Rules -->
        <record id="cron_business_automation" model="ir.cron">
            <field name="name">Business Automation: Time-based Rules</field>
            <field name="model_id" ref="model_business_automation"/>
            <field name="state">code</field>
            <field name="code">
                # Execute time-based automation rules
                time_based_rules = env['business.automation'].search([
                    ('active', '=', True),
                    ('trigger_type', '=', 'time_based')
                ])
                for rule in time_based_rules:
                    rule.execute_automation()
            </field>
            <field name="interval_number">1</field>
            <field name="interval_type">hours</field>
            <field name="numbercall">-1</field>
            <field name="active" eval="True"/>
        </record>

        <!-- Menu Structure -->
        <menuitem
            id="menu_business_automation_root"
            name="Automation"
            web_icon="business_automation,static/description/icon.png"
            sequence="90"/>

        <menuitem
            id="menu_automations"
            name="Automation Rules"
            parent="menu_business_automation_root"
            action="action_business_automation"
            sequence="10"/>

        <menuitem
            id="menu_automation_wizard"
            name="Quick Setup"
            parent="menu_business_automation_root"
            action="action_automation_wizard"
            sequence="20"/>

        <!-- Security -->
        <record id="business_automation_user_access" model="ir.model.access">
            <field name="name">business.automation.user</field>
            <field name="model_id" ref="model_business_automation"/>
            <field name="group_id" ref="base.group_user"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

        <record id="business_automation_condition_user_access" model="ir.model.access">
            <field name="name">business.automation.condition.user</field>
            <field name="model_id" ref="model_business_automation_condition"/>
            <field name="group_id" ref="base.group_user"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

        <record id="business_automation_action_user_access" model="ir.model.access">
            <field name="name">business.automation.action.user</field>
            <field name="model_id" ref="model_business_automation_action"/>
            <field name="group_id" ref="base.group_user"/>
            <field name="perm_read" eval="1"/>
            <field name="perm_write" eval="1"/>
            <field name="perm_create" eval="1"/>
            <field name="perm_unlink" eval="1"/>
        </record>

    </data>
</odoo>