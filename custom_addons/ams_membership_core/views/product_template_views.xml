<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Extend Product Template Form View for Comprehensive Subscription Configuration -->
        <record id="view_product_template_form_subscription" model="ir.ui.view">
            <field name="name">product.template.form.subscription</field>
            <field name="model">product.template</field>
            <field name="inherit_id" ref="product.product_template_form_view"/>
            <field name="arch" type="xml">
                
                <!-- Move Subscription Product checkbox into the options section -->
                <xpath expr="//div[@name='options']//span[last()]" position="after">
                    <span class="d-inline-flex">
                        <field name="is_subscription_product"/>
                        <label for="is_subscription_product" string="Subscription"/>
                    </span>
                </xpath>

                <!-- Add comprehensive subscription stats buttons -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <!-- Membership/Chapter stats -->
                    <button name="action_view_memberships" type="object"
                            class="oe_stat_button" icon="fa-users"
                            invisible="not is_subscription_product or subscription_product_type not in ['membership', 'chapter']"
                            groups="ams_membership_core.group_membership_user">
                        <field name="active_memberships_count" widget="statinfo" string="Memberships"/>
                    </button>
                    
                    <!-- Chapter-specific stats -->
                    <button name="action_view_chapter_members" type="object"
                            class="oe_stat_button" icon="fa-map-marker"
                            invisible="not is_chapter_product"
                            groups="ams_membership_core.group_membership_user">
                        <field name="chapter_member_count" widget="statinfo" string="Chapter Members"/>
                    </button>
                    
                    <!-- Fixed: Simple sub-chapters button without non-existent field -->
                    <button name="action_view_child_chapters" type="object"
                            class="oe_stat_button" icon="fa-sitemap"
                            string="Sub-Chapters"
                            invisible="not is_chapter_product or not child_chapter_ids"
                            groups="ams_membership_core.group_membership_user"/>
                    
                    <button name="action_chapter_dashboard" type="object"
                            class="oe_stat_button" icon="fa-dashboard"
                            string="Chapter Dashboard"
                            invisible="not is_chapter_product"
                            groups="ams_membership_core.group_membership_manager"/>
                    
                    <!-- Subscription stats -->
                    <button name="action_view_subscriptions" type="object"
                            class="oe_stat_button" icon="fa-refresh"
                            invisible="not is_subscription_product or subscription_product_type in ['membership', 'chapter']"
                            groups="ams_membership_core.group_membership_user">
                        <field name="active_subscriptions_count" widget="statinfo" string="Subscriptions"/>
                    </button>
                    
                    <!-- Revenue stats -->
                    <button name="action_view_revenue_report" type="object" class="oe_stat_button" icon="fa-money"
                            invisible="not is_subscription_product"
                            groups="ams_membership_core.group_membership_manager">
                        <field name="total_subscription_revenue" widget="statinfo" string="Total Revenue"/>
                    </button>
                    
                    <!-- Chapter retention rate -->
                    <button name="action_view_retention_report" type="object" class="oe_stat_button" icon="fa-heart"
                            invisible="not is_chapter_product"
                            groups="ams_membership_core.group_membership_manager">
                        <div class="o_stat_info">
                            <span class="o_stat_text">Retention</span>
                            <span class="o_stat_text"><field name="chapter_retention_rate" widget="percentage"/></span>
                        </div>
                    </button>
                    
                    <!-- Benefits configuration -->
                    <button name="action_configure_benefits" type="object"
                            class="oe_stat_button" icon="fa-gift"
                            string="Benefits"
                            invisible="not is_subscription_product"
                            groups="ams_membership_core.group_membership_manager"/>
                </xpath>

                <!-- Add comprehensive Subscription Configuration tab -->
                <xpath expr="//notebook" position="inside">
                    <page string="Subscription Settings" name="subscription_settings" 
                          invisible="not is_subscription_product">
                        
                        <group>
                            <group string="Subscription Configuration">
                                <field name="subscription_product_type" required="is_subscription_product"/>
                                <field name="is_chapter_product" readonly="True" invisible="subscription_product_type != 'chapter'"/>
                                <field name="subscription_period"/>
                                <field name="auto_renew_default"/>
                                <field name="renewal_reminder_days"/>
                                <field name="grace_period_days"/>
                            </group>
                            <group string="Portal &amp; Access">
                                <field name="grant_portal_access"/>
                                <field name="portal_access_groups" widget="many2many_tags"
                                       invisible="not grant_portal_access"/>
                            </group>
                        </group>

                        <group string="Product Capabilities">
                            <group>
                                <field name="supports_proration"/>
                                <field name="allows_upgrades"/>
                                <field name="allows_downgrades"/>
                            </group>
                            <group>
                                <field name="revenue_recognition_method"/>
                            </group>
                        </group>

                        <!-- Publication-specific settings -->
                        <group string="Publication Settings" 
                               invisible="subscription_product_type != 'publication'">
                            <group>
                                <field name="publication_digital_access"/>
                                <field name="publication_print_delivery"/>
                            </group>
                            <group>
                                <field name="publication_frequency"/>
                            </group>
                        </group>

                        <!-- Comprehensive Chapter-specific settings -->
                        <group string="Chapter Configuration" 
                               invisible="subscription_product_type != 'chapter'">
                            <group string="Basic Chapter Info">
                                <field name="chapter_type"/>
                                <field name="chapter_access_level"/>
                                <field name="chapter_status"/>
                                <field name="chapter_established_date"/>
                            </group>
                            <group string="Chapter Hierarchy">
                                <field name="parent_chapter_id"/>
                                <field name="chapter_level" readonly="True"/>
                                <button name="action_create_sub_chapter" type="object" 
                                        string="Create Sub-Chapter" class="btn-primary"
                                        invisible="not is_chapter_product"
                                        groups="ams_membership_core.group_membership_manager"/>
                            </group>
                        </group>

                        <!-- Chapter Location Information -->
                        <group string="Chapter Location" 
                               invisible="subscription_product_type != 'chapter'">
                            <group>
                                <field name="chapter_location"/>
                                <field name="chapter_city"/>
                                <field name="chapter_state"/>
                                <field name="chapter_zip"/>
                            </group>
                            <group>
                                <field name="chapter_country_id"/>
                                <field name="chapter_timezone"/>
                            </group>
                        </group>

                        <!-- Chapter Contact Information -->
                        <group string="Chapter Contacts &amp; Communication" 
                               invisible="subscription_product_type != 'chapter'">
                            <group string="Leadership">
                                <field name="chapter_president"/>
                                <field name="chapter_contact_email"/>
                                <field name="chapter_contact_phone"/>
                                <field name="chapter_website"/>
                            </group>
                            <group string="Meeting Information">
                                <field name="chapter_meeting_schedule" placeholder="e.g., 2nd Tuesday of each month at 7:00 PM"/>
                                <field name="chapter_meeting_location" placeholder="Meeting location details"/>
                            </group>
                        </group>

                        <!-- Chapter Member Management -->
                        <group string="Chapter Member Management" 
                               invisible="subscription_product_type != 'chapter'">
                            <group>
                                <field name="chapter_member_limit"/>
                                <field name="chapter_minimum_members"/>
                            </group>
                            <group>
                                <field name="chapter_member_count" readonly="True"/>
                                <field name="chapter_retention_rate" readonly="True" widget="percentage"/>
                            </group>
                        </group>

                        <!-- Enhanced Chapter Benefits -->
                        <group string="Chapter Benefits &amp; Access" 
                               invisible="subscription_product_type != 'chapter'">
                            <group string="Core Benefits">
                                <field name="provides_local_events"/>
                                <field name="provides_chapter_documents"/>
                                <field name="provides_chapter_training"/>
                                <field name="provides_networking_access"/>
                            </group>
                            <group string="Extended Benefits">
                                <field name="provides_mentorship"/>
                                <field name="provides_certification"/>
                                <field name="provides_job_board"/>
                                <field name="provides_newsletter"/>
                            </group>
                        </group>

                        <!-- Benefits Configuration -->
                        <group string="Included Benefits">
                            <field name="benefit_ids" nolabel="1" 
                                   domain="[('active', '=', True)]">
                                <list editable="bottom">
                                    <field name="name"/>
                                    <field name="benefit_type"/>
                                    <field name="applies_to"/>
                                    <field name="discount_percentage" 
                                           invisible="benefit_type != 'discount'"/>
                                </list>
                            </field>
                        </group>

                    </page>
                    
                    <!-- Chapter Sub-Chapters tab for hierarchy management -->
                    <page string="Sub-Chapters" name="sub_chapters"
                          invisible="not is_chapter_product or not child_chapter_ids">
                        <div class="row">
                            <div class="col-12">
                                <button name="action_create_sub_chapter" type="object" 
                                        string="Create Sub-Chapter" class="btn btn-primary mb-3"
                                        groups="ams_membership_core.group_membership_manager"/>
                            </div>
                        </div>
                        <field name="child_chapter_ids" nolabel="1">
                            <kanban>
                                <field name="name"/>
                                <field name="chapter_location"/>
                                <field name="chapter_member_count"/>
                                <field name="chapter_status"/>
                                <field name="list_price"/>
                                <templates>
                                    <t t-name="kanban-box">
                                        <div class="oe_kanban_card oe_kanban_global_click">
                                            <div class="oe_kanban_content">
                                                <div class="row">
                                                    <div class="col-8">
                                                        <strong><t t-esc="record.name.value"/></strong>
                                                        <br/>
                                                        <t t-if="record.chapter_location.value">
                                                            <small class="text-muted">
                                                                <i class="fa fa-map-marker"/> <t t-esc="record.chapter_location.value"/>
                                                            </small>
                                                        </t>
                                                    </div>
                                                    <div class="col-4 text-right">
                                                        <span t-attf-class="badge bg-#{record.chapter_status.raw_value == 'active' ? 'success' : record.chapter_status.raw_value == 'forming' ? 'warning' : 'secondary'}">
                                                            <t t-esc="record.chapter_status.value"/>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-6">
                                                        <small><i class="fa fa-users"/> <t t-esc="record.chapter_member_count.value"/> members</small>
                                                    </div>
                                                    <div class="col-6 text-right">
                                                        <small>$<t t-esc="record.list_price.value"/></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </t>
                                </templates>
                            </kanban>
                        </field>
                    </page>
                </xpath>

                <!-- Add subscription revenue field to sales tab -->
                <xpath expr="//field[@name='list_price']" position="after">
                    <field name="total_subscription_revenue" 
                           invisible="not is_subscription_product"
                           readonly="True"
                           groups="ams_membership_core.group_membership_user"/>
                </xpath>

                <!-- Fixed: Remove OWL directive from form view -->
                <xpath expr="//div[hasclass('oe_title')]" position="inside">
                    <div class="o_row" invisible="subscription_product_type != 'chapter'">
                        <span class="badge bg-info">
                            <i class="fa fa-map-marker"/> Chapter Product
                        </span>
                        <span invisible="not parent_chapter_id" class="badge bg-secondary ms-2">
                            Sub-Chapter of: <field name="parent_chapter_id" readonly="1" nolabel="1"/>
                        </span>
                    </div>
                </xpath>

            </field>
        </record>

        <!-- Enhanced Subscription Products List View -->
        <record id="view_product_template_list_subscription" model="ir.ui.view">
            <field name="name">product.template.list.subscription</field>
            <field name="model">product.template</field>
            <field name="arch" type="xml">
                <list string="Subscription Products"
                      decoration-info="subscription_product_type == 'chapter'"
                      decoration-success="subscription_product_type == 'membership'">
                    <field name="name"/>
                    <field name="subscription_product_type"/>
                    <field name="subscription_period"/>
                    <field name="list_price" widget="monetary"/>
                    <field name="active_memberships_count" 
                           invisible="subscription_product_type not in ['membership', 'chapter']"/>
                    <field name="active_subscriptions_count"
                           invisible="subscription_product_type in ['membership', 'chapter']"/>
                    <field name="chapter_member_count" optional="hide" 
                           invisible="subscription_product_type != 'chapter'"/>
                    <field name="chapter_status" optional="hide"
                           invisible="subscription_product_type != 'chapter'"/>
                    <field name="chapter_location" optional="hide"
                           invisible="subscription_product_type != 'chapter'"/>
                    <field name="auto_renew_default"/>
                    <field name="total_subscription_revenue" widget="monetary" optional="hide"/>
                    <field name="active"/>
                    <field name="is_subscription_product" invisible="1"/>
                    <field name="is_chapter_product" invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Enhanced Subscription Products Kanban View -->
        <record id="view_product_template_kanban_subscription" model="ir.ui.view">
            <field name="name">product.template.kanban.subscription</field>
            <field name="model">product.template</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="name"/>
                    <field name="subscription_product_type"/>
                    <field name="list_price"/>
                    <field name="active_memberships_count"/>
                    <field name="active_subscriptions_count"/>
                    <field name="chapter_member_count"/>
                    <field name="chapter_location"/>
                    <field name="chapter_status"/>
                    <field name="is_chapter_product"/>
                    <field name="image_128"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.is_chapter_product.raw_value ? 'border-info' : ''}">
                                <div class="o_kanban_image">
                                    <img t-att-src="kanban_image('product.template', 'image_128', record.id.raw_value)" 
                                         alt="Product" class="o_image_64_contain"/>
                                </div>
                                <div class="oe_kanban_details">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <t t-if="record.is_chapter_product.raw_value">
                                                    <i class="fa fa-map-marker text-info me-1"/>
                                                </t>
                                                <t t-esc="record.name.value"/>
                                            </strong>
                                            <div class="o_kanban_record_subtitle">
                                                <t t-esc="record.subscription_product_type.value and record.subscription_product_type.value.replace('_', ' ').title()"/>
                                                <t t-if="record.is_chapter_product.raw_value and record.chapter_location.value">
                                                    - <t t-esc="record.chapter_location.value"/>
                                                </t>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column">
                                            <span class="badge badge-pill badge-primary">
                                                $<t t-esc="record.list_price.value"/>
                                            </span>
                                            <t t-if="record.is_chapter_product.raw_value and record.chapter_status.raw_value">
                                                <span t-attf-class="badge badge-pill badge-#{record.chapter_status.raw_value == 'active' ? 'success' : record.chapter_status.raw_value == 'forming' ? 'warning' : 'secondary'} mt-1">
                                                    <t t-esc="record.chapter_status.value"/>
                                                </span>
                                            </t>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div t-if="record.subscription_product_type.raw_value in ['membership', 'chapter']">
                                            <i class="fa fa-users"/> 
                                            <t t-if="record.is_chapter_product.raw_value">
                                                <t t-esc="record.chapter_member_count.value"/> Chapter Members
                                            </t>
                                            <t t-else="">
                                                <t t-esc="record.active_memberships_count.value"/> Active Memberships
                                            </t>
                                        </div>
                                        <div t-if="record.subscription_product_type.raw_value not in ['membership', 'chapter']">
                                            <i class="fa fa-refresh"/> 
                                            <t t-esc="record.active_subscriptions_count.value"/> Active Subscriptions
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Enhanced Chapter Products Search -->
        <record id="view_product_template_search_chapter" model="ir.ui.view">
            <field name="name">product.template.search.chapter</field>
            <field name="model">product.template</field>
            <field name="priority">20</field>
            <field name="arch" type="xml">
                <search string="Chapter Products">
                    <field name="name"/>
                    <field name="chapter_location"/>
                    <field name="chapter_type"/>
                    <field name="chapter_status"/>
                    <separator/>
                    <filter string="Active Chapters" name="active_chapters" 
                            domain="[('chapter_status', '=', 'active')]"/>
                    <filter string="Forming Chapters" name="forming_chapters" 
                            domain="[('chapter_status', '=', 'forming')]"/>
                    <filter string="Parent Chapters" name="parent_chapters" 
                            domain="[('parent_chapter_id', '=', False)]"/>
                    <filter string="Sub-Chapters" name="sub_chapters" 
                            domain="[('parent_chapter_id', '!=', False)]"/>
                    <separator/>
                    <filter string="Local Chapters" name="local_chapters" 
                            domain="[('chapter_type', '=', 'local')]"/>
                    <filter string="Regional Chapters" name="regional_chapters" 
                            domain="[('chapter_type', '=', 'regional')]"/>
                    <filter string="State Chapters" name="state_chapters" 
                            domain="[('chapter_type', '=', 'state')]"/>
                    <filter string="Special Interest" name="special_chapters" 
                            domain="[('chapter_type', '=', 'special')]"/>
                    <group expand="0" string="Group By">
                        <filter string="Chapter Type" name="group_chapter_type" 
                                context="{'group_by': 'chapter_type'}"/>
                        <filter string="Chapter Status" name="group_chapter_status" 
                                context="{'group_by': 'chapter_status'}"/>
                        <filter string="Location" name="group_chapter_location" 
                                context="{'group_by': 'chapter_location'}"/>
                        <filter string="Parent Chapter" name="group_parent_chapter" 
                                context="{'group_by': 'parent_chapter_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- Enhanced Chapter Products Action -->
        <record id="action_chapter_products" model="ir.actions.act_window">
            <field name="name">Chapter Membership Products</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('is_subscription_product', '=', True), ('subscription_product_type', '=', 'chapter')]</field>
            <field name="context">{
                'default_is_subscription_product': True,
                'default_subscription_product_type': 'chapter',
                'default_type': 'service',
                'default_sale_ok': True,
                'search_default_active_chapters': 1
            }</field>
            <field name="search_view_id" ref="view_product_template_search_chapter"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first chapter membership product
                </p>
                <p>
                    Chapter membership products provide access to local or regional 
                    chapter events, documents, training, and networking opportunities.
                    Configure chapter hierarchy, contact information, and member benefits.
                </p>
            </field>
        </record>

        <!-- Subscription Products Action -->
        <record id="action_subscription_products" model="ir.actions.act_window">
            <field name="name">Subscription Products</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('is_subscription_product', '=', True)]</field>
            <field name="context">{
                'search_default_subscription_products': 1,
                'default_is_subscription_product': True,
                'default_type': 'service',
                'default_sale_ok': True
            }</field>
            <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_product_template_kanban_subscription')}),
                (0, 0, {'view_mode': 'list', 'view_id': ref('view_product_template_list_subscription')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('view_product_template_form_subscription')})
            ]"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first subscription product
                </p>
                <p>
                    Subscription products automatically create memberships or subscriptions 
                    when purchased. Configure benefits, renewal settings, portal access,
                    and chapter hierarchy for each product type.
                </p>
            </field>
        </record>

        <!-- Membership Products Action -->
        <record id="action_membership_products" model="ir.actions.act_window">
            <field name="name">Membership Products</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('is_subscription_product', '=', True), ('subscription_product_type', '=', 'membership')]</field>
            <field name="context">{
                'search_default_membership_products': 1,
                'default_is_subscription_product': True,
                'default_subscription_product_type': 'membership',
                'default_type': 'service',
                'default_sale_ok': True
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first membership product
                </p>
                <p>
                    Membership products create member records when purchased. 
                    Only one active membership is allowed per member.
                </p>
            </field>
        </record>

        <!-- Publication Products Action -->
        <record id="action_publication_products" model="ir.actions.act_window">
            <field name="name">Publication Products</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">product.template</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('is_subscription_product', '=', True), ('subscription_product_type', '=', 'publication')]</field>
            <field name="context">{
                'search_default_publication_products': 1,
                'default_is_subscription_product': True,
                'default_subscription_product_type': 'publication',
                'default_type': 'service',
                'default_sale_ok': True
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first publication product
                </p>
                <p>
                    Publication products provide digital and/or print access to 
                    journals, magazines, and other recurring publications.
                </p>
            </field>
        </record>

    </data>
</odoo>