<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================================================== -->
    <!-- ENHANCED PRODUCT CATEGORY FORM VIEW - INHERITING FROM STOCK MODULE -->
    <!-- ========================================================================== -->
    <record id="product_category_form_view_enhanced" model="ir.ui.view">
        <field name="name">product.category.form.enhanced</field>
        <field name="model">product.category</field>
        <field name="inherit_id" ref="stock.product_category_form_view_inherit"/>
        <field name="arch" type="xml">
            
            <!-- Add AMS stat buttons in the button box -->
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_ams_products" 
                        icon="fa-cube" invisible="not is_ams_category or ams_product_count == 0">
                    <field name="ams_product_count" widget="statinfo" string="AMS Products"/>
                </button>
                <button class="oe_stat_button" type="object" name="action_view_all_products" 
                        icon="fa-cubes" invisible="total_product_count == 0">
                    <field name="total_product_count" widget="statinfo" string="Total Products"/>
                </button>
                <button class="oe_stat_button" type="object" name="action_create_ams_product" 
                        icon="fa-plus-circle" invisible="not is_ams_category"
                        string="Create Product"/>
            </xpath>

            <!-- ========================================================================== -->
            <!-- BASIC CATEGORY DEFINITION FIELDS -->
            <!-- ========================================================================== -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="code" string="Category Code" placeholder="e.g. MEMBERSHIP, EVENT"/>
                <field name="is_ams_category" string="Enable AMS Features" widget="boolean_toggle"/>
                <field name="ams_category_type" string="AMS Category Type"/>
                <field name="description" string="Description" placeholder="Detailed description of this category..."/>
            </xpath>

            <!-- ========================================================================== -->
            <!-- ADD AMS SECTIONS AFTER THE STOCK LOGISTICS GROUP -->
            <!-- ========================================================================== -->
            <xpath expr="//group[@name='logistics']" position="after">
                
                <!-- PRODUCT TYPE CONTROLS -->
                <group string="Product Type Controls" invisible="not is_ams_category">
                    <group>
                        <field name="default_product_type" string="Default Product Type"/>
                        <field name="fulfillment_type" string="Fulfillment Type"/>
                        <field name="delivery_mode" string="Delivery Mode"/>
                    </group>
                    <group>
                        <field name="default_income_account_id" string="Income Account" optional="hide"/>
                        <field name="default_expense_account_id" string="Expense Account" optional="hide"/>
                        <field name="default_tax_ids" widget="many2many_tags" string="Default Taxes" optional="hide"/>
                        <field name="tax_exemption_reason" string="Tax Exemption Reason" 
                               invisible="default_tax_ids" optional="hide"/>
                    </group>
                </group>

                <!-- ASSOCIATION-SPECIFIC METADATA -->
                <group string="Association Metadata" invisible="not is_ams_category">
                    <group string="Membership Settings">
                        <field name="is_membership_category" string="Membership Category" widget="boolean_toggle"/>
                        <field name="default_membership_level" string="Default Membership Level"
                               invisible="not is_membership_category"/>
                        <field name="renewal_behavior" string="Renewal Behavior"/>
                        <field name="grace_period_days" string="Grace Period (Days)"
                               invisible="renewal_behavior == 'one_time'"/>
                    </group>
                    <group string="Access Control">
                        <field name="grants_portal_access" string="Grants Portal Access" widget="boolean_toggle"/>
                        <field name="portal_group_ids" widget="many2many_tags" string="Portal Groups"
                               invisible="not grants_portal_access"/>
                        <field name="visibility_control" string="Visibility Control"/>
                        <field name="benefit_description" string="Benefits Description" 
                               placeholder="Describe benefits included with this category..."/>
                    </group>
                </group>

                <!-- OPERATIONAL CONTROLS -->
                <group string="Operational Controls" invisible="not is_ams_category">
                    <group string="Product Attributes">
                        <field name="requires_member_pricing" string="Member Pricing" widget="boolean_toggle"/>
                        <field name="is_subscription_category" string="Subscription" widget="boolean_toggle"/>
                        <field name="is_digital_category" string="Digital" widget="boolean_toggle"/>
                        <field name="requires_inventory" string="Inventory Tracking" widget="boolean_toggle" 
                               invisible="is_digital_category"/>
                    </group>
                    <group string="Workflow Automation">
                        <field name="auto_send_welcome_email" string="Send Welcome Email" widget="boolean_toggle"/>
                        <field name="welcome_email_template_id" string="Welcome Email Template"
                               invisible="not auto_send_welcome_email"/>
                        <field name="auto_create_invoice" string="Auto-create Invoice" widget="boolean_toggle"/>
                        <field name="digital_asset_template" string="Digital Asset Template"
                               invisible="not is_digital_category"/>
                    </group>
                </group>

                <!-- PRICING & DISCOUNTING -->
                <group string="Pricing &amp; Discounting" invisible="not is_ams_category">
                    <group string="Price Lists &amp; Discounts">
                        <field name="default_pricelist_id" string="Default Price List"/>
                        <field name="member_discount_percent" string="Member Discount %"
                               invisible="not requires_member_pricing"/>
                        <field name="allows_student_pricing" string="Student Pricing" widget="boolean_toggle"/>
                        <field name="allows_early_bird_pricing" string="Early Bird Pricing" widget="boolean_toggle"/>
                    </group>
                    <group string="Donation Settings">
                        <field name="is_tax_deductible_donation" string="Tax Deductible Donation" 
                               widget="boolean_toggle"/>
                        <field name="donation_receipt_template_id" string="Donation Receipt Template"
                               invisible="not is_tax_deductible_donation"/>
                    </group>
                </group>

                <!-- REPORTING & SEGMENTATION -->
                <group string="Reporting &amp; Segmentation" invisible="not is_ams_category">
                    <group>
                        <field name="revenue_recognition_type" string="Revenue Recognition"/>
                        <field name="analytics_tag_ids" widget="many2many_tags" string="Analytics Tags"/>
                    </group>
                    <group>
                        <field name="default_uom_id" string="Default Unit of Measure"/>
                        <field name="default_route_ids" widget="many2many_tags" string="Default Routes"
                               invisible="not requires_inventory"/>
                    </group>
                </group>

                <!-- COMPUTED SUMMARIES -->
                <group string="Category Summary" invisible="not is_ams_category">
                    <group>
                        <field name="category_type_display" string="Category Type" readonly="1"/>
                        <field name="category_summary" string="Attributes Summary" readonly="1"/>
                    </group>
                    <group>
                        <field name="fulfillment_summary" string="Fulfillment Summary" readonly="1"/>
                    </group>
                </group>

                <!-- CATEGORY INFORMATION DISPLAY -->
                <group string="Category Information" invisible="not is_ams_category">
                    <div class="alert alert-info" role="alert">
                        <h5><i class="fa fa-info-circle"></i> AMS Category Active</h5>
                        <p class="mb-2">
                            <strong>Products created in this category will automatically inherit:</strong>
                        </p>
                        <ul class="mb-2">
                            <li invisible="not requires_member_pricing">Member pricing functionality</li>
                            <li invisible="not is_digital_category">Digital product delivery settings</li>
                            <li invisible="not requires_inventory">Inventory tracking and stock management</li>
                            <li invisible="not is_subscription_category">Subscription billing configuration</li>
                            <li invisible="not grants_portal_access">Portal access permissions</li>
                            <li invisible="not auto_send_welcome_email">Automated welcome emails</li>
                            <li invisible="not is_tax_deductible_donation">Tax deductible donation receipts</li>
                            <li>AMS product features and enhanced functionality</li>
                        </ul>
                        <div class="mt-3">
                            <button name="action_create_ams_product" type="object" 
                                    string="Create Product Now" class="btn btn-primary btn-sm"/>
                        </div>
                    </div>
                </group>

            </xpath>

        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- ENHANCED PRODUCT CATEGORY LIST VIEW - WITH KEY AMS FIELDS -->
    <!-- ========================================================================== -->
    <record id="product_category_list_view_enhanced" model="ir.ui.view">
        <field name="name">product.category.list.enhanced</field>
        <field name="model">product.category</field>
        <field name="arch" type="xml">
            <list string="Product Categories" 
                  decoration-info="is_ams_category==True"
                  decoration-muted="is_ams_category==False"
                  editable="top">
                
                <!-- BASIC FIELDS -->
                <field name="name"/>
                <field name="code" optional="show"/>
                <field name="parent_id"/>
                
                <!-- AMS CORE SETTINGS -->
                <field name="is_ams_category" string="AMS" widget="boolean_toggle"/>
                <field name="ams_category_type" string="AMS Type"/>
                
                <!-- OPERATIONAL CONTROLS -->
                <field name="requires_member_pricing" string="Member Pricing" widget="boolean_toggle"/>
                <field name="is_subscription_category" string="Subscription" widget="boolean_toggle"/>
                <field name="is_digital_category" string="Digital" widget="boolean_toggle"/>
                <field name="requires_inventory" string="Inventory" widget="boolean_toggle" 
                       invisible="is_digital_category"/>
                
                <!-- FULFILLMENT -->
                <field name="fulfillment_type" string="Fulfillment" optional="show"/>
                <field name="delivery_mode" string="Delivery" optional="hide"/>
                
                <!-- COMPUTED SUMMARIES -->
                <field name="category_type_display" string="Type Display" optional="show"/>
                <field name="category_summary" string="Summary" optional="hide"/>
                
                <!-- PRODUCT COUNTS -->
                <field name="ams_product_count" string="AMS Products" optional="show"/>
                <field name="total_product_count" string="Total Products" optional="show"/>
                
            </list>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- ENHANCED PRODUCT CATEGORY SEARCH VIEW -->
    <!-- ========================================================================== -->
    <record id="product_category_search_view_enhanced" model="ir.ui.view">
        <field name="name">product.category.search.enhanced</field>
        <field name="model">product.category</field>
        <field name="inherit_id" ref="product.product_category_search_view"/>
        <field name="arch" type="xml">
            
            <!-- Add AMS-specific search fields -->
            <xpath expr="//field[@name='name']" position="after">
                <field name="code" string="Category Code"/>
                <field name="ams_category_type" string="AMS Type"/>
                <field name="fulfillment_type" string="Fulfillment Type"/>
            </xpath>

            <!-- Add comprehensive AMS filters -->
            <xpath expr="//search" position="inside">
                <separator/>
                <!-- BASIC AMS FILTERS -->
                <filter string="AMS Categories" name="ams_categories" domain="[('is_ams_category', '=', True)]"/>
                <filter string="Standard Categories" name="standard_categories" domain="[('is_ams_category', '=', False)]"/>
                
                <separator/>
                <!-- OPERATIONAL CONTROL FILTERS -->
                <filter string="Member Pricing" name="member_pricing" domain="[('requires_member_pricing', '=', True)]"/>
                <filter string="Digital Categories" name="digital_categories" domain="[('is_digital_category', '=', True)]"/>
                <filter string="Subscription Categories" name="subscription_categories" domain="[('is_subscription_category', '=', True)]"/>
                
                <separator/>
                <!-- AMS CATEGORY TYPE FILTERS -->
                <filter string="Membership" name="membership" domain="[('ams_category_type', '=', 'membership')]"/>
                <filter string="Events" name="events" domain="[('ams_category_type', '=', 'event')]"/>
                <filter string="Education" name="education" domain="[('ams_category_type', '=', 'education')]"/>
                <filter string="Publications" name="publications" domain="[('ams_category_type', '=', 'publication')]"/>
                <filter string="Merchandise" name="merchandise" domain="[('ams_category_type', '=', 'merchandise')]"/>
                <filter string="Certifications" name="certifications" domain="[('ams_category_type', '=', 'certification')]"/>
                <filter string="Digital Products" name="digital_products" domain="[('ams_category_type', '=', 'digital')]"/>
                
                <!-- Add AMS grouping options -->
                <group expand="0" string="Group By">
                    <filter string="AMS Category Type" name="group_ams_type" 
                            context="{'group_by': 'ams_category_type'}"/>
                    <filter string="AMS Status" name="group_ams_status" 
                            context="{'group_by': 'is_ams_category'}"/>
                </group>
            </xpath>

        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- AMS CATEGORIES ACTIONS -->
    <!-- ========================================================================== -->
    
    <!-- Main AMS Categories Action -->
    <record id="action_ams_product_categories" model="ir.actions.act_window">
        <field name="name">AMS Product Categories</field>
        <field name="res_model">product.category</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="domain">[('is_ams_category', '=', True)]</field>
        <field name="context">{'search_default_ams_categories': 1}</field>
        <field name="view_id" ref="product_category_list_view_enhanced"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first AMS product category!
            </p>
            <p>
                AMS product categories provide enhanced classification for association products.
            </p>
        </field>
    </record>
    <!-- ========================================================================== -->
    <!-- OVERRIDE STANDARD PRODUCT CATEGORY ACTION -->
    <!-- ========================================================================== -->
    <record id="product.product_category_action_form" model="ir.actions.act_window">
        <field name="name">Product Categories</field>
        <field name="res_model">product.category</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="view_id" ref="product_category_list_view_enhanced"/>
        <field name="search_view_id" ref="product_category_search_view_enhanced"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first product category!
            </p>
            <p>
                Product categories help organize your products and drive their behavior. 
                Use the AMS settings to configure fulfillment, membership integration, 
                pricing rules, and automation workflows.
            </p>
        </field>
    </record>

    <!-- Also override the stock module's category menu if it exists -->
    <record id="stock.menu_product_category_config_stock" model="ir.ui.menu">
        <field name="action" ref="product.product_category_action_form"/>
    </record>
    <!-- Menu Items -->
    <menuitem id="menu_ams_product_categories"
              name="AMS Categories"
              parent="base.menu_administration"
              action="action_ams_product_categories"
              sequence="25"
              groups="base.group_system"/>

</odoo>