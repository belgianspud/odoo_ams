<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ==============================================
         PRODUCT TEMPLATE FINANCIAL VIEWS
         ============================================== -->
    
    <!-- Inherit Product Template Form to Add Financial Tab -->
    <record id="view_product_template_form_inherit_ams_financial" model="ir.ui.view">
        <field name="name">product.template.form.inherit.ams.financial</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            
            <!-- Add Financial Setup button in header -->
            <div name="button_box" position="inside">
                <button name="action_open_financial_setup_wizard" type="object" 
                        class="oe_stat_button" icon="fa-calculator"
                        attrs="{'invisible': [('is_subscription_product', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="financial_setup_complete" widget="boolean_toggle"/>
                        </span>
                        <span class="o_stat_text">Financial Setup</span>
                    </div>
                </button>
                
                <button name="action_view_accounting_entries" type="object" 
                        class="oe_stat_button" icon="fa-book"
                        attrs="{'invisible': ['|', ('is_subscription_product', '=', False), ('accounting_entry_count', '=', 0)]}">
                    <field name="accounting_entry_count" widget="statinfo" string="Accounting Entries"/>
                </button>
            </div>
            
            <!-- Add Financial tab in notebook -->
            <xpath expr="//notebook" position="inside">
                <page name="financial" string="Financial" 
                      attrs="{'invisible': [('is_subscription_product', '=', False)]}">
                    
                    <!-- Financial Setup Status -->
                    <div class="alert alert-info" role="alert" 
                         attrs="{'invisible': [('financial_setup_complete', '=', True)]}">
                        <p><strong>Financial Setup Required</strong></p>
                        <p>This subscription product needs financial configuration to properly track revenue and generate accounting entries.</p>
                        <button name="action_open_financial_setup_wizard" type="object" 
                                class="btn btn-primary btn-sm">
                            <i class="fa fa-magic"/> Setup Financial Accounts
                        </button>
                    </div>
                    
                    <div class="alert alert-success" role="alert" 
                         attrs="{'invisible': [('financial_setup_complete', '=', False)]}">
                        <p><strong><i class="fa fa-check"/> Financial Setup Complete</strong></p>
                        <p>This product is configured for automated accounting entries.</p>
                    </div>
                    
                    <group>
                        <group string="Revenue Recognition">
                            <field name="revenue_recognition_method" 
                                   widget="radio" 
                                   options="{'horizontal': true}"/>
                            <field name="requires_deferred_revenue" readonly="1"/>
                            <field name="auto_create_journal_entries"/>
                            <field name="financial_setup_complete" readonly="1"/>
                        </group>
                        <group string="Financial Summary" 
                               attrs="{'invisible': [('financial_setup_complete', '=', False)]}">
                            <field name="total_subscription_revenue" readonly="1"/>
                            <field name="total_deferred_revenue" readonly="1"/>
                            <field name="accounting_entry_count" readonly="1"/>
                        </group>
                    </group>
                    
                    <separator string="Account Configuration"/>
                    <group>
                        <group string="Revenue Accounts">
                            <field name="revenue_account_id" 
                                   domain="[('account_type', 'in', ['income', 'income_membership', 'income_chapter', 'income_publication', 'income_other']), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'income'}"/>
                            <field name="deferred_revenue_account_id" 
                                   domain="[('account_type', '=', 'liability_deferred_revenue'), ('company_id', '=', current_company_id)]"
                                   attrs="{'required': [('requires_deferred_revenue', '=', True)], 'invisible': [('requires_deferred_revenue', '=', False)]}"
                                   context="{'default_account_type': 'liability_deferred_revenue'}"/>
                        </group>
                        <group string="Other Accounts">
                            <field name="receivable_account_id" 
                                   domain="[('account_type', '=', 'asset_receivable'), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'asset_receivable'}"/>
                            <field name="cash_account_id" 
                                   domain="[('account_type', '=', 'asset_cash'), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'asset_cash'}"/>
                            <field name="expense_account_id" 
                                   domain="[('account_type', '=', 'expense'), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'expense'}"/>
                            <field name="cogs_account_id" 
                                   domain="[('account_type', '=', 'expense_direct_cost'), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'expense_direct_cost'}"
                                   attrs="{'invisible': [('type', '!=', 'product')]}"/>
                        </group>
                    </group>
                    
                    <separator string="Adjustments & Corrections"/>
                    <group>
                        <group string="Special Accounts">
                            <field name="bad_debt_account_id" 
                                   domain="[('account_type', '=', 'expense'), ('company_id', '=', current_company_id)]"
                                   context="{'default_account_type': 'expense'}"/>
                            <field name="discount_account_id" 
                                   domain="[('account_type', 'in', ['expense', 'income']), ('company_id', '=', current_company_id)]"/>
                        </group>
                        <group string="Journal Settings">
                            <field name="default_journal_id" 
                                   domain="[('company_id', '=', current_company_id)]"/>
                            <field name="revenue_recognition_journal_id" 
                                   domain="[('ams_journal_type', '=', 'revenue_recognition'), ('company_id', '=', current_company_id)]"
                                   attrs="{'invisible': [('requires_deferred_revenue', '=', False)]}"/>
                        </group>
                    </group>
                    
                    <!-- Revenue Recognition Schedule Preview -->
                    <separator string="Revenue Recognition Preview" 
                               attrs="{'invisible': ['|', ('requires_deferred_revenue', '=', False), ('subscription_period', '=', False)]}"/>
                    <group attrs="{'invisible': ['|', ('requires_deferred_revenue', '=', False), ('subscription_period', '=', False)]}">
                        <group string="Recognition Schedule">
                            <field name="recognition_schedule_preview" readonly="1" nolabel="1" widget="html"/>
                        </group>
                    </group>
                    
                    <!-- Recent Accounting Entries -->
                    <separator string="Recent Accounting Entries" 
                               attrs="{'invisible': [('accounting_entry_count', '=', 0)]}"/>
                    <field name="recent_accounting_entries" nolabel="1" readonly="1"
                           attrs="{'invisible': [('accounting_entry_count', '=', 0)]}">
                        <tree string="Recent Entries" limit="10" create="false" edit="false">
                            <field name="date"/>
                            <field name="name"/>
                            <field name="journal_id"/>
                            <field name="partner_id"/>
                            <field name="amount_total"/>
                            <field name="state"/>
                            <field name="subscription_id"/>
                        </tree>
                    </field>
                </page>
            </xpath>
            
            <!-- Add helper field for company context -->
            <field name="company_id" position="after">
                <field name="current_company_id" invisible="1"/>
            </field>
        </field>
    </record>
    
    <!-- Product Template Tree View - Add Financial Columns -->
    <record id="view_product_template_tree_inherit_ams_financial" model="ir.ui.view">
        <field name="name">product.template.tree.inherit.ams.financial</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <field name="list_price" position="after">
                <field name="financial_setup_complete" string="Financial Setup" widget="boolean_toggle"
                       attrs="{'column_invisible': [('parent.context', 'not in', ['subscription_products'])]}"/>
                <field name="revenue_recognition_method" string="Recognition Method"
                       attrs="{'column_invisible': [('parent.context', 'not in', ['subscription_products'])]}"/>
            </field>
        </field>
    </record>
    
    <!-- Product Template Search View - Add Financial Filters -->
    <record id="view_product_template_search_inherit_ams_financial" model="ir.ui.view">
        <field name="name">product.template.search.inherit.ams.financial</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <filter name="services" position="after">
                <separator/>
                <filter name="subscription_products" string="Subscription Products" 
                        domain="[('is_subscription_product', '=', True)]"/>
                <filter name="financial_setup_complete" string="Financial Setup Complete" 
                        domain="[('financial_setup_complete', '=', True)]"/>
                <filter name="financial_setup_required" string="Financial Setup Required" 
                        domain="[('is_subscription_product', '=', True), ('financial_setup_complete', '=', False)]"/>
                <filter name="deferred_revenue_products" string="Deferred Revenue" 
                        domain="[('requires_deferred_revenue', '=', True)]"/>
            </filter>
            
            <filter name="categ_id" position="after">
                <filter name="group_revenue_recognition" string="Revenue Recognition Method" 
                        context="{'group_by': 'revenue_recognition_method'}"/>
            </filter>
        </field>
    </record>
    
    <!-- ==============================================
         SUBSCRIPTION PRODUCT SPECIFIC VIEWS
         ============================================== -->
    
    <!-- Subscription Products Kanban View -->
    <record id="view_subscription_product_kanban" model="ir.ui.view">
        <field name="name">subscription.product.kanban</field>
        <field name="model">product.template</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile">
                <field name="id"/>
                <field name="name"/>
                <field name="ams_product_type"/>
                <field name="list_price"/>
                <field name="subscription_period"/>
                <field name="financial_setup_complete"/>
                <field name="revenue_recognition_method"/>
                <field name="total_subscription_revenue"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="row">
                                <div class="col-8">
                                    <strong t-esc="record.name.value"/>
                                </div>
                                <div class="col-4 text-right">
                                    <span t-if="record.financial_setup_complete.raw_value" 
                                          class="badge badge-success">
                                        <i class="fa fa-check"/> Setup
                                    </span>
                                    <span t-if="!record.financial_setup_complete.raw_value" 
                                          class="badge badge-warning">
                                        <i class="fa fa-exclamation-triangle"/> Setup Required
                                    </span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <span class="badge badge-info" t-esc="record.ams_product_type.value"/>
                                </div>
                                <div class="col-6 text-right">
                                    <span t-esc="record.list_price.value" t-options="{'widget': 'monetary'}"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <small>
                                        <i class="fa fa-calendar"/> <span t-esc="record.subscription_period.value"/>
                                        | <i class="fa fa-money"/> <span t-esc="record.revenue_recognition_method.value"/>
                                    </small>
                                </div>
                            </div>
                            <div class="row" t-if="record.total_subscription_revenue.raw_value">
                                <div class="col-12">
                                    <small class="text-muted">
                                        Total Revenue: <span t-esc="record.total_subscription_revenue.value" t-options="{'widget': 'monetary'}"/>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- ==============================================
         ACTIONS FOR SUBSCRIPTION PRODUCTS
         ============================================== -->
    
    <!-- Subscription Products Action -->
    <record id="action_subscription_products" model="ir.actions.act_window">
        <field name="name">Subscription Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True)]</field>
        <field name="context">{
            'search_default_subscription_products': 1,
            'subscription_products': True
        }</field>
        <field name="view_id" ref="view_subscription_product_kanban"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first subscription product!
            </p>
            <p>
                Subscription products require financial setup to properly
                track revenue recognition and generate accounting entries.
            </p>
        </field>
    </record>
    
    <!-- Products Requiring Financial Setup -->
    <record id="action_products_financial_setup_required" model="ir.actions.act_window">
        <field name="name">Products Requiring Financial Setup</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('financial_setup_complete', '=', False)]</field>
        <field name="context">{'search_default_financial_setup_required': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Great! All subscription products have financial setup complete.
            </p>
            <p>
                Products shown here need financial account configuration
                to enable automated revenue recognition.
            </p>
        </field>
    </record>
    
    <!-- Products with Deferred Revenue -->
    <record id="action_products_deferred_revenue" model="ir.actions.act_window">
        <field name="name">Products with Deferred Revenue</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('requires_deferred_revenue', '=', True)]</field>
        <field name="context">{'search_default_deferred_revenue_products': 1}</field>
    </record>
    
    <!-- ==============================================
         FINANCIAL SETUP WIZARD ACTIONS
         ============================================== -->
    
    <!-- Financial Setup Wizard from Product -->
    <record id="action_product_financial_setup_wizard" model="ir.actions.act_window">
        <field name="name">Financial Setup</field>
        <field name="res_model">ams.product.financial.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{
            'default_product_id': active_id,
            'default_setup_mode': 'guided'
        }</field>
    </record>
    
    <!-- Bulk Financial Setup Wizard -->
    <record id="action_bulk_financial_setup_wizard" model="ir.actions.act_window">
        <field name="name">Bulk Financial Setup</field>
        <field name="res_model">ams.product.financial.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{
            'default_setup_mode': 'bulk',
            'active_ids': active_ids
        }</field>
    </record>
    
    <!-- ==============================================
         SERVER ACTIONS
         ============================================== -->
    
    <!-- Server Action for Financial Setup -->
    <record id="server_action_setup_product_financial" model="ir.actions.server">
        <field name="name">Setup Financial Accounts</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="binding_model_id" ref="product.model_product_template"/>
        <field name="binding_view_types">form,list</field>
        <field name="state">code</field>
        <field name="code">
if records.filtered(lambda p: p.is_subscription_product):
    action = {
        'type': 'ir.actions.act_window',
        'res_model': 'ams.product.financial.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': {
            'default_product_id': records[0].id if len(records) == 1 else False,
            'default_setup_mode': 'guided' if len(records) == 1 else 'bulk',
            'active_ids': records.ids
        }
    }
else:
    raise UserError('Financial setup is only available for subscription products.')
        </field>
    </record>
    
    <!-- Server Action for Revenue Recognition Preview -->
    <record id="server_action_preview_revenue_recognition" model="ir.actions.server">
        <field name="name">Preview Revenue Recognition</field>
        <field name="model_id" ref="product.model_product_template"/>
        <field name="binding_model_id" ref="product.model_product_template"/>
        <field name="binding_view_types">form</field>
        <field name="state">code</field>
        <field name="code">
if record.is_subscription_product and record.requires_deferred_revenue:
    action = {
        'type': 'ir.actions.act_window',
        'res_model': 'ams.revenue.recognition.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': {
            'default_wizard_type': 'analysis',
            'default_product_filter_id': record.id
        }
    }
else:
    raise UserError('Revenue recognition preview is only available for subscription products with deferred revenue.')
        </field>
    </record>
    
    <!-- ==============================================
         PRODUCT VARIANT FINANCIAL INHERITANCE
         ============================================== -->
    
    <!-- Inherit Product Variant Form for Financial Info -->
    <record id="view_product_product_form_inherit_ams_financial" model="ir.ui.view">
        <field name="name">product.product.form.inherit.ams.financial</field>
        <field name="model">product.product</field>
        <field name="inherit_id" ref="product.product_normal_form_view"/>
        <field name="arch" type="xml">
            <div name="button_box" position="inside">
                <button name="action_view_variant_accounting" type="object" 
                        class="oe_stat_button" icon="fa-line-chart"
                        attrs="{'invisible': [('is_subscription_product', '=', False)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Accounting</span>
                    </div>
                </button>
            </div>
        </field>
    </record>
    
    <!-- ==============================================
         MENU ITEMS (if needed here)
         ============================================== -->
    
    <!-- Quick access menu items could go here, but typically these would be in the main menu file -->
    
</odoo>