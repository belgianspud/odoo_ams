<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- ==============================================
         AMS ACCOUNT JOURNAL VIEWS
         ============================================== -->
    
    <!-- Journal Tree View -->
    <record id="view_ams_account_journal_tree" model="ir.ui.view">
        <field name="name">ams.account.journal.tree</field>
        <field name="model">ams.account.journal</field>
        <field name="arch" type="xml">
            <tree string="Journals" default_order="sequence,name"
                  decoration-info="type in ('sale', 'purchase')"
                  decoration-success="ams_journal_type == 'membership'"
                  decoration-warning="ams_journal_type == 'revenue_recognition'"
                  decoration-muted="not active">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="code"/>
                <field name="type"/>
                <field name="ams_journal_type" string="AMS Type"/>
                <field name="default_account_id"/>
                <field name="active" invisible="1"/>
                <field name="show_on_dashboard" string="Dashboard"/>
                <field name="auto_post_entries" string="Auto Post"/>
                <field name="company_id" groups="base.group_multi_company"/>
                <field name="entry_count" string="Entries"/>
            </tree>
        </field>
    </record>
    
    <!-- Journal Form View -->
    <record id="view_ams_account_journal_form" model="ir.ui.view">
        <field name="name">ams.account.journal.form</field>
        <field name="model">ams.account.journal</field>
        <field name="arch" type="xml">
            <form string="Journal">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_journal_entries" type="object" 
                                class="oe_stat_button" icon="fa-book"
                                attrs="{'invisible': [('entry_count', '=', 0)]}">
                            <field name="entry_count" widget="statinfo" string="Entries"/>
                        </button>
                        <button name="toggle_favorite" type="object" 
                                class="oe_stat_button" icon="fa-star-o"
                                attrs="{'invisible': [('show_on_dashboard', '=', True)]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Add to Dashboard</span>
                            </div>
                        </button>
                        <button name="toggle_favorite" type="object" 
                                class="oe_stat_button" icon="fa-star"
                                attrs="{'invisible': [('show_on_dashboard', '=', False)]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">On Dashboard</span>
                            </div>
                        </button>
                    </div>
                    
                    <widget name="web_ribbon" title="Archived" bg_color="bg-danger" 
                            attrs="{'invisible': [('active', '=', True)]}"/>
                    
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" placeholder="e.g. Membership Sales"/>
                        </h1>
                        <div class="o_row">
                            <label for="code" class="oe_edit_only"/>
                            <field name="code" placeholder="MEMB"/>
                        </div>
                    </div>
                    
                    <group>
                        <group>
                            <field name="type" widget="radio" options="{'horizontal': true}"/>
                            <field name="ams_journal_type" widget="selection"/>
                            <field name="company_id" groups="base.group_multi_company" options="{'no_create': True}"/>
                        </group>
                        <group>
                            <field name="active"/>
                            <field name="sequence"/>
                            <field name="color" widget="color"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page name="journal_entries" string="Journal Entries">
                            <group>
                                <group string="Posting">
                                    <field name="auto_post_entries"/>
                                    <field name="restrict_mode_hash_table"/>
                                    <field name="sequence_override_regex" groups="base.group_no_one"/>
                                </group>
                                <group string="Default Account">
                                    <field name="default_account_id" 
                                           domain="[('deprecated', '=', False), ('company_id', '=', company_id)]"
                                           context="{'default_account_type': 'income' if type == 'sale' else 'expense' if type == 'purchase' else 'asset_cash'}"/>
                                    <field name="suspense_account_id" 
                                           domain="[('deprecated', '=', False), ('company_id', '=', company_id)]"
                                           attrs="{'invisible': [('type', 'not in', ['bank', 'cash'])]}"/>
                                </group>
                            </group>
                            
                            <group string="Sequence">
                                <field name="sequence_id" readonly="1"/>
                                <field name="sequence_number_next" 
                                       attrs="{'readonly': [('sequence_id', '=', False)]}"/>
                            </group>
                        </page>
                        
                        <page name="ams_settings" string="AMS Settings"
                              attrs="{'invisible': [('ams_journal_type', '=', 'general')]}">
                            <group>
                                <group string="Automation Settings"
                                       attrs="{'invisible': [('ams_journal_type', 'not in', ['membership', 'revenue_recognition'])]}">
                                    <field name="auto_create_subscription_entries"
                                           attrs="{'invisible': [('ams_journal_type', '!=', 'membership')]}"/>
                                    <field name="auto_recognize_revenue"
                                           attrs="{'invisible': [('ams_journal_type', '!=', 'revenue_recognition')]}"/>
                                    <field name="recognition_day_of_month"
                                           attrs="{'invisible': ['|', ('ams_journal_type', '!=', 'revenue_recognition'), ('auto_recognize_revenue', '=', False)]}"/>
                                </group>
                                <group string="Integration Settings">
                                    <field name="subscription_types" widget="many2many_tags"
                                           attrs="{'invisible': [('ams_journal_type', 'not in', ['membership', 'chapter', 'publication'])]}"/>
                                    <field name="product_categories" widget="many2many_tags"
                                           attrs="{'invisible': [('ams_journal_type', 'not in', ['membership', 'chapter', 'publication', 'event'])]}"/>
                                </group>
                            </group>
                            
                            <separator string="Account Mapping" 
                                       attrs="{'invisible': [('ams_journal_type', 'not in', ['membership', 'chapter', 'publication'])]}"/>
                            <group attrs="{'invisible': [('ams_journal_type', 'not in', ['membership', 'chapter', 'publication'])]}">
                                <group string="Revenue Accounts">
                                    <field name="default_revenue_account_id" 
                                           domain="[('account_type', 'in', ['income', 'income_membership', 'income_chapter', 'income_publication']), ('company_id', '=', company_id)]"/>
                                    <field name="default_deferred_revenue_account_id" 
                                           domain="[('account_type', '=', 'liability_deferred_revenue'), ('company_id', '=', company_id)]"/>
                                </group>
                                <group string="Other Accounts">
                                    <field name="default_receivable_account_id" 
                                           domain="[('account_type', '=', 'asset_receivable'), ('company_id', '=', company_id)]"/>
                                    <field name="default_cash_account_id" 
                                           domain="[('account_type', '=', 'asset_cash'), ('company_id', '=', company_id)]"/>
                                </group>
                            </group>
                        </page>
                        
                        <page name="advanced_settings" string="Advanced Settings">
                            <group>
                                <group string="Communication">
                                    <field name="alias_id" readonly="1"/>
                                </group>
                                <group string="Payment Settings" attrs="{'invisible': [('type', 'not in', ['bank', 'cash'])]}">
                                    <field name="profit_account_id" 
                                           domain="[('deprecated', '=', False), ('company_id', '=', company_id)]"/>
                                    <field name="loss_account_id" 
                                           domain="[('deprecated', '=', False), ('company_id', '=', company_id)]"/>
                                </group>
                            </group>
                            
                            <group string="Security" groups="base.group_no_one">
                                <field name="restrict_mode_hash_table"/>
                                <field name="sequence_override_regex"/>
                            </group>
                        </page>
                        
                        <page name="journal_entries_tab" string="Journal Entries" 
                              attrs="{'invisible': [('entry_count', '=', 0)]}">
                            <field name="move_ids" nolabel="1" readonly="1">
                                <tree string="Journal Entries" limit="20" default_order="date desc">
                                    <field name="name"/>
                                    <field name="date"/>
                                    <field name="partner_id"/>
                                    <field name="ref"/>
                                    <field name="state"/>
                                    <field name="amount_total" sum="Total"/>
                                    <field name="subscription_id" 
                                           attrs="{'column_invisible': [('parent.ams_journal_type', 'not in', ['membership', 'chapter', 'publication'])]}"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>
    
    <!-- Journal Search View -->
    <record id="view_ams_account_journal_search" model="ir.ui.view">
        <field name="name">ams.account.journal.search</field>
        <field name="model">ams.account.journal</field>
        <field name="arch" type="xml">
            <search string="Search Journals">
                <field name="name" filter_domain="['|', ('name', 'ilike', self), ('code', 'ilike', self)]"/>
                <field name="code"/>
                <field name="type"/>
                <field name="ams_journal_type"/>
                <field name="company_id" groups="base.group_multi_company"/>
                
                <separator/>
                <filter name="dashboard" string="Dashboard" domain="[('show_on_dashboard', '=', True)]"/>
                <filter name="auto_post" string="Auto Post" domain="[('auto_post_entries', '=', True)]"/>
                <filter name="active" string="Active" domain="[('active', '=', True)]"/>
                <filter name="inactive" string="Archived" domain="[('active', '=', False)]"/>
                
                <separator/>
                <filter name="sale_journals" string="Sales" domain="[('type', '=', 'sale')]"/>
                <filter name="purchase_journals" string="Purchase" domain="[('type', '=', 'purchase')]"/>
                <filter name="cash_journals" string="Cash" domain="[('type', '=', 'cash')]"/>
                <filter name="bank_journals" string="Bank" domain="[('type', '=', 'bank')]"/>
                <filter name="general_journals" string="General" domain="[('type', '=', 'general')]"/>
                
                <separator/>
                <filter name="membership_journals" string="Membership" domain="[('ams_journal_type', '=', 'membership')]"/>
                <filter name="chapter_journals" string="Chapter" domain="[('ams_journal_type', '=', 'chapter')]"/>
                <filter name="publication_journals" string="Publication" domain="[('ams_journal_type', '=', 'publication')]"/>
                <filter name="revenue_recognition_journals" string="Revenue Recognition" domain="[('ams_journal_type', '=', 'revenue_recognition')]"/>
                <filter name="event_journals" string="Event" domain="[('ams_journal_type', '=', 'event')]"/>
                
                <group expand="0" string="Group By">
                    <filter name="group_type" string="Type" context="{'group_by': 'type'}"/>
                    <filter name="group_ams_type" string="AMS Type" context="{'group_by': 'ams_journal_type'}"/>
                    <filter name="group_company" string="Company" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
                </group>
            </search>
        </field>
    </record>
    
    <!-- Journal Kanban View -->
    <record id="view_ams_account_journal_kanban" model="ir.ui.view">
        <field name="name">ams.account.journal.kanban</field>
        <field name="model">ams.account.journal</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_order="sequence">
                <field name="name"/>
                <field name="code"/>
                <field name="type"/>
                <field name="ams_journal_type"/>
                <field name="color"/>
                <field name="show_on_dashboard"/>
                <field name="entry_count"/>
                <field name="active"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click o_kanban_record_has_image_fill #{record.active.raw_value ? '' : 'o_kanban_color_muted'}" 
                             t-attf-style="border-left: 4px solid #{kanban_color(record.color.raw_value)}">
                            <div class="oe_kanban_content">
                                <div class="row">
                                    <div class="col-6">
                                        <strong t-esc="record.name.value"/>
                                    </div>
                                    <div class="col-6 text-right">
                                        <span class="badge badge-secondary" t-esc="record.code.value"/>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <span class="badge badge-info" t-esc="record.type.value"/>
                                        <span class="badge badge-primary ml-1" t-esc="record.ams_journal_type.value"/>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-8">
                                        <span t-esc="record.entry_count.value"/> entries
                                    </div>
                                    <div class="col-4 text-right">
                                        <i t-if="record.show_on_dashboard.raw_value" class="fa fa-star text-warning" title="On Dashboard"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- Journal Dashboard View -->
    <record id="view_ams_account_journal_dashboard" model="ir.ui.view">
        <field name="name">ams.account.journal.dashboard</field>
        <field name="model">ams.account.journal</field>
        <field name="arch" type="xml">
            <kanban class="o_journal_dashboard_kanban" create="false" js_class="account_journal_dashboard_kanban">
                <field name="name"/>
                <field name="code"/>
                <field name="type"/>
                <field name="ams_journal_type"/>
                <field name="color"/>
                <field name="show_on_dashboard"/>
                <field name="entry_count"/>
                <field name="dashboard_info"/>
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="o_journal_kanban #{record.type.raw_value}" 
                             t-attf-style="border-color: #{kanban_color(record.color.raw_value)}">
                            <div class="o_kanban_card_header">
                                <div class="o_kanban_card_header_title">
                                    <div class="o_primary">
                                        <field name="name"/>
                                    </div>
                                    <div class="o_secondary">
                                        <field name="code"/>
                                    </div>
                                </div>
                                <div class="o_kanban_manage_button_section">
                                    <a class="o_kanban_manage_toggle_button" href="#" data-toggle="dropdown">
                                        <i class="fa fa-ellipsis-v" role="img" aria-label="Manage" title="Manage"/>
                                    </a>
                                    <div class="dropdown-menu" role="menu">
                                        <a name="action_view_journal_entries" type="object" class="dropdown-item">View Entries</a>
                                        <a name="create_journal_entry" type="object" class="dropdown-item">New Entry</a>
                                        <div class="dropdown-divider"/>
                                        <a name="open_journal_configuration" type="object" class="dropdown-item">Configuration</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="container o_kanban_card_content">
                                <div class="row">
                                    <div class="col-6 o_kanban_primary_left">
                                        <button class="btn btn-primary btn-sm" name="action_view_journal_entries" type="object">
                                            <span t-esc="record.entry_count.value"/> Entries
                                        </button>
                                    </div>
                                    <div class="col-6 o_kanban_primary_right text-right">
                                        <span class="badge" t-attf-class="badge-#{record.ams_journal_type.raw_value == 'membership' ? 'success' : 'info'}" 
                                              t-esc="record.ams_journal_type.value"/>
                                    </div>
                                </div>
                                
                                <div class="row mt-3" t-if="record.dashboard_info.raw_value">
                                    <div class="col-12">
                                        <t t-raw="record.dashboard_info.raw_value"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    
    <!-- ==============================================
         ACTIONS
         ============================================== -->
    
    <!-- Main Journal Action -->
    <record id="action_ams_account_journal" model="ir.actions.act_window">
        <field name="name">Journals</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="view_id" ref="view_ams_account_journal_tree"/>
        <field name="search_view_id" ref="view_ams_account_journal_search"/>
        <field name="context">{
            'search_default_active': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first journal!
            </p>
            <p>
                Journals are used to categorize accounting entries. Set up specific
                journals for memberships, chapters, publications, and events.
            </p>
        </field>
    </record>
    
    <!-- Journal Dashboard Action -->
    <record id="action_ams_journal_dashboard" model="ir.actions.act_window">
        <field name="name">Journal Dashboard</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="view_ams_account_journal_dashboard"/>
        <field name="domain">[('show_on_dashboard', '=', True)]</field>
        <field name="context">{}</field>
    </record>
    
    <!-- Membership Journals Action -->
    <record id="action_ams_membership_journals" model="ir.actions.act_window">
        <field name="name">Membership Journals</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('ams_journal_type', '=', 'membership')]</field>
        <field name="context">{'default_ams_journal_type': 'membership', 'default_type': 'sale'}</field>
    </record>
    
    <!-- Revenue Recognition Journals Action -->
    <record id="action_ams_revenue_recognition_journals" model="ir.actions.act_window">
        <field name="name">Revenue Recognition Journals</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('ams_journal_type', '=', 'revenue_recognition')]</field>
        <field name="context">{'default_ams_journal_type': 'revenue_recognition', 'default_type': 'general'}</field>
    </record>
    
    <!-- Chapter Journals Action -->
    <record id="action_ams_chapter_journals" model="ir.actions.act_window">
        <field name="name">Chapter Journals</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('ams_journal_type', '=', 'chapter')]</field>
        <field name="context">{'default_ams_journal_type': 'chapter', 'default_type': 'general'}</field>
    </record>
    
    <!-- Publication Journals Action -->
    <record id="action_ams_publication_journals" model="ir.actions.act_window">
        <field name="name">Publication Journals</field>
        <field name="res_model">ams.account.journal</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('ams_journal_type', '=', 'publication')]</field>
        <field name="context">{'default_ams_journal_type': 'publication', 'default_type': 'sale'}</field>
    </record>
    
    <!-- ==============================================
         DASHBOARD ACTIONS
         ============================================== -->
    
    <!-- Create Journal Entry Action -->
    <record id="action_create_journal_entry" model="ir.actions.act_window">
        <field name="name">Create Journal Entry</field>
        <field name="res_model">ams.account.move</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="context">{
            'default_move_type': 'entry',
            'default_journal_id': active_id
        }</field>
    </record>
    
    <!-- View Journal Entries Action -->
    <record id="action_view_journal_entries" model="ir.actions.act_window">
        <field name="name">Journal Entries</field>
        <field name="res_model">ams.account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('journal_id', '=', active_id)]</field>
        <field name="context">{
            'default_journal_id': active_id,
            'search_default_journal_id': active_id
        }</field>
    </record>
    
    <!-- ==============================================
         SERVER ACTIONS FOR WIZARDS
         ============================================== -->
    
    <!-- Open Journal Setup Wizard -->
    <record id="action_open_journal_setup_wizard" model="ir.actions.server">
        <field name="name">Setup Journal</field>
        <field name="model_id" ref="model_ams_account_journal"/>
        <field name="binding_model_id" ref="model_ams_account_journal"/>
        <field name="state">code</field>
        <field name="code">
            action = {
                'type': 'ir.actions.act_window',
                'res_model': 'ams.accounting.setup.wizard',
                'view_mode': 'form',
                'target': 'new',
                'context': {'default_create_journals': True}
            }
        </field>
    </record>
    
</odoo>