<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Product Template Form View Extension for Subscription Toggle -->
    <record id="view_product_template_subscription_form" model="ir.ui.view">
        <field name="name">product.template.subscription.form</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            
            <!-- Add Subscription stat buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_configure_subscription"
                        invisible="not is_subscription_product" icon="fa-cog">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Configure</span>
                        <span class="o_stat_text">Subscription</span>
                    </div>
                </button>
                
                <button class="oe_stat_button" type="object" name="action_manage_pricing_tiers"
                        invisible="not is_subscription_product" icon="fa-tags">
                    <field name="pricing_tier_count" widget="statinfo" string="Pricing Tiers"/>
                </button>
                
                <button class="oe_stat_button" type="object" name="action_create_subscription_wizard"
                        invisible="is_subscription_product" icon="fa-plus">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">Create</span>
                        <span class="o_stat_text">Subscription</span>
                    </div>
                </button>
            </xpath>

            <!-- Add Subscription Toggle in General Information -->
            <xpath expr="//div[@name='options']" position="inside">
                <div class="o_row">
                    <field name="is_subscription_product"/>
                    <label for="is_subscription_product" string="Subscription"/>
                </div>
            </xpath>

            <!-- Add Subscription Information group after General Information -->
            <xpath expr="//group[@name='group_general']" position="after">
                <group string="Subscription Information" name="group_subscription_info" 
                       invisible="not is_subscription_product">
                    <group>
                        <field name="subscription_scope" readonly="1"/>
                        <field name="subscription_product_type" readonly="1"/>
                        <field name="default_duration" readonly="1"/>
                        <field name="duration_unit" readonly="1"/>
                    </group>
                    <group>
                        <field name="subscription_price" widget="monetary" readonly="1"/>
                        <field name="is_renewable" readonly="1"/>
                        <field name="auto_renewal_enabled" readonly="1"/>
                    </group>
                </group>
                
                <group string="Access Control" name="group_subscription_access" 
                       invisible="not is_subscription_product">
                    <group>
                        <field name="requires_approval" readonly="1"/>
                        <field name="member_only" readonly="1"/>
                    </group>
                </group>
            </xpath>

            <!-- Add Subscription Configuration notebook page -->
            <xpath expr="//notebook" position="inside">
                <page string="Subscription Configuration" name="subscription_config"
                      invisible="not is_subscription_product">
                    
                    <div class="alert alert-info" role="alert">
                        <h6><i class="fa fa-info-circle"/> Subscription Product Configuration</h6>
                        <p>This product is configured as a subscription offering. Use the buttons above to configure subscription behavior, pricing tiers, and member benefits.</p>
                    </div>
                    
                    <group>
                        <group string="Basic Configuration">
                            <field name="subscription_product_id" readonly="1"/>
                            <label for="default_duration" string="Duration"/>
                            <div class="o_row">
                                <field name="default_duration" readonly="1"/>
                                <field name="duration_unit" readonly="1"/>
                            </div>
                            <field name="subscription_price" widget="monetary" readonly="1"/>
                        </group>
                        
                        <group string="Features">
                            <field name="subscription_scope" readonly="1"/>
                            <field name="subscription_product_type" readonly="1"/>
                            <field name="is_renewable" readonly="1"/>
                            <field name="auto_renewal_enabled" readonly="1"/>
                        </group>
                    </group>
                    
                    <group string="Member Pricing">
                        <field name="pricing_tier_count" readonly="1"/>
                        <div class="text-muted" invisible="pricing_tier_count > 0">
                            No member-specific pricing tiers configured. Click "Pricing Tiers" button to set up different prices for member types.
                        </div>
                        <div class="text-success" invisible="pricing_tier_count == 0">
                            <i class="fa fa-check"/> Member pricing tiers configured
                        </div>
                    </group>
                    
                    <group string="Access Requirements">
                        <div class="o_row">
                            <field name="requires_approval" readonly="1"/>
                            <span invisible="not requires_approval" class="text-warning">
                                <i class="fa fa-exclamation-triangle"/> Staff approval required
                            </span>
                        </div>
                        <div class="o_row">
                            <field name="member_only" readonly="1"/>
                            <span invisible="not member_only" class="text-info">
                                <i class="fa fa-users"/> Members only
                            </span>
                        </div>
                    </group>
                    
                    <div class="mt16">
                        <button name="action_configure_subscription" string="Open Full Configuration" 
                                type="object" class="btn-primary"/>
                        <button name="action_manage_pricing_tiers" string="Manage Pricing Tiers" 
                                type="object" class="btn-secondary ml8"/>
                    </div>
                </page>
            </xpath>

        </field>
    </record>

    <!-- Product Template List View Extension -->
    <record id="view_product_template_subscription_tree" model="ir.ui.view">
        <field name="name">product.template.subscription.list</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='list_price']" position="after">
                <field name="is_subscription_product" optional="show"/>
                <field name="subscription_scope" optional="hide"/>
                <field name="subscription_product_type" optional="hide"/>
                <field name="pricing_tier_count" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Product Template Search View Extension -->
    <record id="view_product_template_subscription_search" model="ir.ui.view">
        <field name="name">product.template.subscription.search</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            
            <!-- Add subscription filters -->
            <xpath expr="//filter[@name='consumable']" position="after">
                <separator/>
                <filter string="Subscription Products" name="subscription_products" 
                        domain="[('is_subscription_product', '=', True)]"/>
                <filter string="Individual Subscriptions" name="individual_subscriptions" 
                        domain="[('subscription_scope', '=', 'individual')]"/>
                <filter string="Enterprise Subscriptions" name="enterprise_subscriptions" 
                        domain="[('subscription_scope', '=', 'enterprise')]"/>
            </xpath>
            
            <!-- Add subscription type filters -->
            <xpath expr="//filter[@name='subscription_products']" position="after">
                <separator/>
                <filter string="Membership Subscriptions" name="membership_subscriptions" 
                        domain="[('subscription_product_type', '=', 'membership')]"/>
                <filter string="Chapter Subscriptions" name="chapter_subscriptions" 
                        domain="[('subscription_product_type', '=', 'chapter')]"/>
                <filter string="Committee Subscriptions" name="committee_subscriptions" 
                        domain="[('subscription_product_type', '=', 'committee')]"/>
                <filter string="Publication Subscriptions" name="publication_subscriptions" 
                        domain="[('subscription_product_type', '=', 'publication')]"/>
            </xpath>
            
            <!-- Add feature filters -->
            <xpath expr="//filter[@name='publication_subscriptions']" position="after">
                <separator/>
                <filter string="Auto-Renewable" name="auto_renewable" 
                        domain="[('auto_renewal_enabled', '=', True)]"/>
                <filter string="Requires Approval" name="requires_approval" 
                        domain="[('requires_approval', '=', True)]"/>
                <filter string="Members Only" name="members_only" 
                        domain="[('member_only', '=', True)]"/>
                <filter string="Has Pricing Tiers" name="has_pricing_tiers" 
                        domain="[('pricing_tier_count', '>', 0)]"/>
            </xpath>
            
            <!-- Add group by options -->
            <xpath expr="//filter[@name='categ_id']" position="after">
                <filter string="Subscription Scope" name="group_by_subscription_scope" 
                        context="{'group_by': 'subscription_scope'}"/>
                <filter string="Subscription Type" name="group_by_subscription_type" 
                        context="{'group_by': 'subscription_product_type'}"/>
            </xpath>
            
        </field>
    </record>

    <!-- Subscription Products Action -->
    <record id="action_subscription_products" model="ir.actions.act_window">
        <field name="name">Subscription Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True)]</field>
        <field name="context">{
            'search_default_subscription_products': 1,
            'default_is_subscription_product': True,
            'default_detailed_type': 'service',
            'default_sale_ok': True
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first subscription product
            </p>
            <p>
                Transform any product into a subscription offering with member-specific 
                pricing, renewal management, and advanced configuration options.
            </p>
            <p>
                Use the "Subscription" toggle on any product to enable subscription features.
            </p>
        </field>
    </record>

    <!-- Individual Subscription Products Action -->
    <record id="action_individual_subscription_products" model="ir.actions.act_window">
        <field name="name">Individual Subscriptions</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('subscription_scope', '=', 'individual')]</field>
        <field name="context">{
            'search_default_individual_subscriptions': 1,
            'default_is_subscription_product': True,
            'default_subscription_scope': 'individual',
            'default_detailed_type': 'service'
        }</field>
    </record>

    <!-- Enterprise Subscription Products Action -->
    <record id="action_enterprise_subscription_products" model="ir.actions.act_window">
        <field name="name">Enterprise Subscriptions</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('subscription_scope', '=', 'enterprise')]</field>
        <field name="context">{
            'search_default_enterprise_subscriptions': 1,
            'default_is_subscription_product': True,
            'default_subscription_scope': 'enterprise',
            'default_detailed_type': 'service'
        }</field>
    </record>

    <!-- Membership Subscription Products Action -->
    <record id="action_membership_subscription_products" model="ir.actions.act_window">
        <field name="name">Membership Subscriptions</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('subscription_product_type', '=', 'membership')]</field>
        <field name="context">{
            'search_default_membership_subscriptions': 1,
            'default_is_subscription_product': True,
            'default_subscription_product_type': 'membership',
            'default_detailed_type': 'service'
        }</field>
    </record>

    <!-- Menu Structure under AMS Products -->
    <menuitem id="menu_subscription_products_main" 
              name="Subscriptions" 
              parent="ams_products_base.menu_ams_products_main"
              action="action_subscription_products" 
              sequence="50"/>

    <!-- Subscription type submenus -->
    <menuitem id="menu_individual_subscriptions" 
              name="Individual Subscriptions" 
              parent="menu_subscription_products_main"
              action="action_individual_subscription_products" 
              sequence="10"/>

    <menuitem id="menu_enterprise_subscriptions" 
              name="Enterprise Subscriptions" 
              parent="menu_subscription_products_main"
              action="action_enterprise_subscription_products" 
              sequence="20"/>

    <menuitem id="menu_membership_subscriptions" 
              name="Membership Subscriptions" 
              parent="menu_subscription_products_main"
              action="action_membership_subscription_products" 
              sequence="30"/>

</odoo>