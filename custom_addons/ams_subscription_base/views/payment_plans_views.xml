<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Payment Plan Views -->
    <record id="view_payment_plan_tree" model="ir.ui.view">
        <field name="name">subscription.payment.plan.tree</field>
        <field name="model">subscription.payment.plan</field>
        <field name="arch" type="xml">
            <tree decoration-muted="not active">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="code"/>
                <field name="total_amount"/>
                <field name="installments"/>
                <field name="frequency"/>
                <field name="active_payment_plans_count"/>
                <field name="active"/>
                <field name="currency_id" invisible="1"/>
            </tree>
        </field>
    </record>

    <record id="view_payment_plan_form" model="ir.ui.view">
        <field name="name">subscription.payment.plan.form</field>
        <field name="model">subscription.payment.plan</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_view_subscriptions" string="View Subscriptions" type="object" class="oe_highlight"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_view_subscriptions" icon="fa-credit-card">
                            <field string="Active Plans" name="active_payment_plans_count" widget="statinfo"/>
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Archived" bg_color="bg-danger" attrs="{'invisible': [('active', '=', True)]}"/>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" placeholder="Payment Plan Name"/>
                        </h1>
                    </div>
                    <group>
                        <group name="basic_info">
                            <field name="code"/>
                            <field name="sequence"/>
                            <field name="active"/>
                            <field name="currency_id"/>
                        </group>
                        <group name="plan_config">
                            <field name="total_amount"/>
                            <field name="installments"/>
                            <field name="frequency"/>
                        </group>
                    </group>
                    
                    <group name="custom_frequency" string="Custom Frequency" attrs="{'invisible': [('frequency', '!=', 'custom')]}">
                        <field name="custom_interval_number"/>
                        <field name="custom_interval_type"/>
                    </group>
                    
                    <group name="fees" string="Fees and Charges">
                        <group>
                            <field name="setup_fee"/>
                            <field name="installment_fee"/>
                            <field name="late_fee"/>
                        </group>
                        <group>
                            <field name="grace_period_days"/>
                        </group>
                    </group>
                    
                    <group name="payment_terms" string="Payment Terms">
                        <group>
                            <field name="first_payment_due"/>
                            <field name="custom_first_payment_days" attrs="{'invisible': [('first_payment_due', '!=', 'custom')]}"/>
                        </group>
                    </group>
                    
                    <group name="eligibility" string="Eligibility">
                        <group>
                            <field name="min_total_amount"/>
                            <field name="max_total_amount"/>
                        </group>
                        <group>
                            <field name="subscription_plan_ids" widget="many2many_tags"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Description">
                            <field name="description" nolabel="1" placeholder="Description of payment plan terms..."/>
                        </page>
                        <page string="Statistics">
                            <group>
                                <field name="active_payment_plans_count"/>
                                <field name="total_revenue"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Installment Views -->
    <record id="view_installment_tree" model="ir.ui.view">
        <field name="name">subscription.installment.tree</field>
        <field name="model">subscription.installment</field>
        <field name="arch" type="xml">
            <tree decoration-success="status=='paid'" decoration-warning="status=='pending'" decoration-danger="status=='overdue'">
                <field name="subscription_id"/>
                <field name="installment_number"/>
                <field name="due_date"/>
                <field name="amount"/>
                <field name="late_fee"/>
                <field name="total_due"/>
                <field name="status"/>
                <field name="payment_method"/>
                <field name="paid_date"/>
                <field name="currency_id" invisible="1"/>
            </tree>
        </field>
    </record>

    <record id="view_installment_form" model="ir.ui.view">
        <field name="name">subscription.installment.form</field>
        <field name="model">subscription.installment</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_mark_paid" string="Mark as Paid" type="object" 
                            attrs="{'invisible': [('status', 'in', ['paid', 'cancelled'])]}" 
                            class="oe_highlight"/>
                    <button name="action_send_reminder" string="Send Reminder" type="object" 
                            attrs="{'invisible': [('status', '!=', 'pending')]}"/>
                    <button name="action_create_invoice" string="Create Invoice" type="object" 
                            attrs="{'invisible': ['|', ('invoice_id', '!=', False), ('status', 'in', ['paid', 'cancelled'])]}"/>
                    <field name="status" widget="statusbar" statusbar_visible="pending,paid,overdue"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            Installment <field name="installment_number" class="oe_inline"/> of 
                            <field name="payment_plan_id" class="oe_inline" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group name="installment_info">
                            <field name="subscription_id" readonly="1"/>
                            <field name="due_date"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                        <group name="payment_info">
                            <field name="amount"/>
                            <field name="late_fee"/>
                            <field name="total_due"/>
                        </group>
                    </group>
                    <group name="payment_details" string="Payment Details" attrs="{'invisible': [('status', '=', 'pending')]}">
                        <group>
                            <field name="paid_date"/>
                            <field name="paid_amount"/>
                            <field name="payment_method"/>
                        </group>
                        <group>
                            <field name="payment_reference"/>
                            <field name="invoice_id"/>
                        </group>
                    </group>
                    <group name="reminders" string="Reminder History">
                        <field name="reminder_sent_date"/>
                        <field name="overdue_notice_sent_date"/>
                    </group>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record id="view_installment_search" model="ir.ui.view">
        <field name="name">subscription.installment.search</field>
        <field name="model">subscription.installment</field>
        <field name="arch" type="xml">
            <search>
                <field name="subscription_id"/>
                <field name="installment_number"/>
                <field name="status"/>
                <filter string="Pending" name="pending" domain="[('status', '=', 'pending')]"/>
                <filter string="Paid" name="paid" domain="[('status', '=', 'paid')]"/>
                <filter string="Overdue" name="overdue" domain="[('status', '=', 'overdue')]"/>
                <filter string="Due This Week" name="due_this_week" 
                        domain="[('due_date', '&gt;=', (datetime.datetime.now()).strftime('%Y-%m-%d')), 
                                 ('due_date', '&lt;=', (datetime.datetime.now() + datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <filter string="Due This Month" name="due_this_month" 
                        domain="[('due_date', '&gt;=', (datetime.datetime.now().replace(day=1)).strftime('%Y-%m-%d')), 
                                 ('due_date', '&lt;=', (datetime.datetime.now().replace(day=1) + datetime.timedelta(days=32)).replace(day=1) - datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <group expand="0" string="Group By">
                    <filter string="Status" name="group_status" context="{'group_by': 'status'}"/>
                    <filter string="Due Date" name="group_due_date" context="{'group_by': 'due_date'}"/>
                    <filter string="Subscription" name="group_subscription" context="{'group_by': 'subscription_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Enhanced Subscription Form with Payment Plan Features -->
    <record id="view_subscription_form_payment_plans" model="ir.ui.view">
        <field name="name">subscription.subscription.form.payment.plans</field>
        <field name="model">subscription.subscription</field>
        <field name="inherit_id" ref="ams_subscription_base.view_subscription_form"/>
        <field name="arch" type="xml">
            <xpath expr="//group[@name='settings']" position="inside">
                <field name="payment_plan_id"/>
                <field name="uses_payment_plan" invisible="1"/>
            </xpath>
            
            <xpath expr="//header" position="inside">
                <button name="action_setup_payment_plan" string="Setup Payment Plan" type="object" 
                        attrs="{'invisible': ['|', ('uses_payment_plan', '=', False), ('installment_ids', '!=', [])]}"/>
                <button name="action_view_installments" string="View Installments" type="object" 
                        attrs="{'invisible': [('uses_payment_plan', '=', False)]}"/>
                <button name="action_create_all_invoices" string="Create All Invoices" type="object" 
                        attrs="{'invisible': [('uses_payment_plan', '=', False)]}"/>
            </xpath>
            
            <xpath expr="//group[@name='financial']" position="inside">
                <field name="next_payment_date" attrs="{'invisible': [('uses_payment_plan', '=', False)]}"/>
                <field name="next_payment_amount" attrs="{'invisible': [('uses_payment_plan', '=', False)]}"/>
            </xpath>
            
            <xpath expr="//notebook" position="inside">
                <page string="Payment Plan" attrs="{'invisible': [('uses_payment_plan', '=', False)]}">
                    <group>
                        <group>
                            <field name="total_installments"/>
                            <field name="paid_installments"/>
                            <field name="overdue_installments"/>
                        </group>
                    </group>
                    <field name="installment_ids">
                        <tree>
                            <field name="installment_number"/>
                            <field name="due_date"/>
                            <field name="amount"/>
                            <field name="late_fee"/>
                            <field name="total_due"/>
                            <field name="status"/>
                            <field name="paid_date"/>
                        </tree>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Enhanced Partner Form with Payment Plan Features -->
    <record id="view_partner_form_payment_plans" model="ir.ui.view">
        <field name="name">res.partner.form.payment.plans</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="ams_subscription_base.view_partner_form_subscription"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_installments" icon="fa-calendar-check-o"
                        attrs="{'invisible': [('total_payment_plan_subscriptions', '=', 0)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="overdue_installments_count"/>
                        </span>
                        <span class="o_stat_text">Overdue</span>
                    </div>
                </button>
            </xpath>
            <xpath expr="//group[1]/group[2]" position="inside">
                <field name="total_payment_plan_subscriptions"/>
                <field name="next_installment_due"/>
            </xpath>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_payment_plan" model="ir.actions.act_window">
        <field name="name">Payment Plans</field>
        <field name="res_model">subscription.payment.plan</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first payment plan!
            </p>
            <p>
                Payment plans allow members to pay their subscriptions in installments.
            </p>
        </field>
    </record>

    <record id="action_installment" model="ir.actions.act_window">
        <field name="name">Installments</field>
        <field name="res_model">subscription.installment</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_installment_search"/>
        <field name="context">{'search_default_pending': 1}</field>
    </record>

</odoo>