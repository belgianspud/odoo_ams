<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend res.partner form view to add participations tab -->
    <record id="view_partner_form_participation" model="ir.ui.view">
        <field name="name">res.partner.form.participation</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <!-- Add smart buttons for participations -->
            <div name="button_box" position="inside">
                <button name="action_view_participations" type="object" 
                        class="oe_stat_button" icon="fa-users"
                        invisible="participation_count == 0">
                    <field name="participation_count" widget="statinfo" string="Participations"/>
                </button>
                
                <button name="action_create_participation" type="object" 
                        class="oe_stat_button" icon="fa-plus-circle"
                        help="Create new participation">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_text">New Participation</span>
                    </div>
                </button>
            </div>

            <!-- Add participations notebook page -->
            <notebook position="inside">
                <page string="Participations" name="participations" 
                      invisible="participation_count == 0 and active_participation_count == 0">
                    
                    <!-- Participation Summary -->
                    <group string="Participation Summary" name="participation_summary">
                        <field name="active_participation_count" invisible="1"/>
                        <field name="has_active_membership" invisible="1"/>
                        <field name="primary_membership_id" invisible="1"/>
                        
                        <div class="alert alert-success" role="alert" 
                             invisible="active_participation_count == 0">
                            <strong>Member Status: Active</strong> - 
                            This member has <field name="active_participation_count" readonly="1" style="display: inline"/> 
                            active participation(s).
                        </div>
                        
                        <div class="alert alert-warning" role="alert" 
                             invisible="active_participation_count > 0">
                            <strong>Member Status: Inactive</strong> - 
                            This member has no active participations.
                        </div>
                        
                        <div class="alert alert-info" role="alert" 
                             invisible="not has_active_membership">
                            <strong>Membership:</strong> This member has an active membership.
                            <span invisible="not primary_membership_id">
                                Primary membership: <field name="primary_membership_id" readonly="1" style="display: inline"/>
                            </span>
                        </div>
                    </group>

                    <separator/>

                    <!-- Participation Actions -->
                    <group string="Participation Management" name="participation_actions">
                        <p class="text-muted">
                            Use the buttons below to view and manage this member's participations.
                        </p>
                        
                        <div class="oe_clear">
                            <group>
                                <div class="oe_left">
                                    <button name="action_view_participations" string="View All Participations" 
                                            type="object" class="btn-primary"
                                            invisible="participation_count == 0"/>
                                    <button name="action_create_participation" string="Add New Participation" 
                                            type="object" class="btn-success"/>
                                </div>
                            </group>
                        </div>
                    </group>

                    <!-- Quick Participation Info (Summary Table) -->
                    <group string="Participation Summary" name="participation_info" 
                           invisible="participation_count == 0">
                        <p class="text-muted">
                            This member has <field name="participation_count" readonly="1" style="display: inline"/> 
                            total participation(s) with <field name="active_participation_count" readonly="1" style="display: inline"/> 
                            currently active.
                        </p>
                        
                        <p class="text-info">
                            <strong>Primary Membership:</strong> 
                            <field name="primary_membership_id" readonly="1" invisible="not primary_membership_id"/>
                            <span invisible="primary_membership_id">No active membership found.</span>
                        </p>
                    </group>
                </page>
            </notebook>
        </field>
    </record>

    <!-- Member-specific participation action -->
    <record id="action_member_participations" model="ir.actions.act_window">
        <field name="name">Member Participations</field>
        <field name="res_model">ams.participation</field>
        <field name="view_mode">list,form</field>
        <field name="context">{
            'search_default_active': 1,
            'default_partner_id': active_id if not context.get('default_is_company') else False,
            'default_company_id': active_id if context.get('default_is_company') else False
        }</field>
    </record>
</odoo>