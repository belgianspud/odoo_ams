<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Enhanced Participation Form View with better formatting -->
    <record id="view_ams_participation_form_enhanced" model="ir.ui.view">
        <field name="name">ams.participation.form.enhanced</field>
        <field name="model">ams.participation</field>
        <field name="arch" type="xml">
            <form string="Participation">
                <header>
                    <button name="action_activate" string="Activate" type="object" 
                            class="btn-primary" invisible="status != 'prospect'"
                            confirm="Are you sure you want to activate this participation?"/>
                    <button name="action_suspend" string="Suspend" type="object" 
                            class="btn-warning" invisible="status not in ('active', 'grace')"
                            confirm="Are you sure you want to suspend this participation?"/>
                    <button name="action_cancel" string="Cancel" type="object" 
                            class="btn-secondary" invisible="status in ('cancelled', 'terminated')"
                            confirm="Are you sure you want to cancel this participation?"/>
                    <field name="status" widget="statusbar" 
                           statusbar_visible="prospect,active,grace,suspended,terminated,cancelled"
                           statusbar_colors="{'prospect':'blue','active':'green','grace':'orange','suspended':'red','terminated':'red','cancelled':'red'}"/>
                </header>
                
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_history" type="object" 
                                class="oe_stat_button" icon="fa-history"
                                help="View complete status change history">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">History</span>
                            </div>
                        </button>
                        
                        <button name="action_view_member" type="object" 
                                class="oe_stat_button" icon="fa-user"
                                help="View member profile">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Member</span>
                            </div>
                        </button>
                        
                        <button type="object" name="toggle_active" 
                                class="oe_stat_button" icon="fa-archive"
                                help="Archive/Unarchive this participation">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Archive</span>
                            </div>
                        </button>
                    </div>

                    <!-- Status-based alerts -->
                    <div class="alert alert-info" role="alert" invisible="status != 'prospect'">
                        <strong>Prospect:</strong> This participation is pending activation. 
                        Consider activating once payment is received or requirements are met.
                    </div>
                    
                    <div class="alert alert-warning" role="alert" invisible="status != 'grace'">
                        <strong>Grace Period:</strong> This participation has expired but is in grace period until 
                        <field name="grace_period_end_date" readonly="1" style="display: inline;"/>.
                    </div>
                    
                    <div class="alert alert-danger" role="alert" invisible="not is_expired or status == 'grace'">
                        <strong>Expired:</strong> This participation expired on 
                        <field name="paid_through_date" readonly="1" style="display: inline;"/>.
                    </div>

                    <div class="oe_title">
                        <label for="display_name" class="oe_edit_only"/>
                        <h1>
                            <field name="display_name" readonly="1" class="oe_inline"/>
                        </h1>
                        <div class="o_row">
                            <div class="o_address_format">
                                <field name="participation_type" widget="radio" options="{'horizontal': true}"/>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Information Card -->
                    <div class="o_group">
                        <div class="o_group_col_12">
                            <group string="Member Information" class="o_label_nowrap">
                                <field name="partner_id" 
                                       invisible="company_id" 
                                       options="{'no_create': True, 'no_open': False}"
                                       context="{'show_address': 1}"
                                       domain="[('is_company', '=', False)]"/>
                                <field name="company_id" 
                                       invisible="partner_id" 
                                       options="{'no_create': True, 'no_open': False}"
                                       context="{'show_address': 1}"
                                       domain="[('is_company', '=', True)]"/>
                                <field name="member_display_name" invisible="1"/>
                            </group>
                        </div>
                    </div>

                    <notebook>
                        <!-- Overview Tab -->
                        <page string="Overview" name="overview">
                            <div class="row">
                                <div class="col-lg-6">
                                    <group string="Participation Details" class="o_label_nowrap">
                                        <field name="participation_type" readonly="1"/>
                                        <field name="committee_position_id" 
                                               invisible="participation_type != 'committee_position'"
                                               placeholder="Select committee position..."/>
                                        <field name="join_date" 
                                               help="When this member first joined in this capacity"/>
                                    </group>
                                    
                                    <group string="Current Status" class="o_label_nowrap">
                                        <field name="status" readonly="1"/>
                                        <field name="is_expired" invisible="1"/>
                                        <field name="is_in_grace" invisible="1"/>
                                        <field name="is_renewable"/>
                                        <field name="days_remaining" 
                                               decoration-success="days_remaining > 30"
                                               decoration-warning="days_remaining <= 30 and days_remaining > 0"
                                               decoration-danger="days_remaining <= 0"/>
                                    </group>
                                </div>
                                
                                <div class="col-lg-6">
                                    <group string="Term Period" class="o_label_nowrap">
                                        <field name="begin_date"/>
                                        <field name="end_date"/>
                                        <label for="bill_through_date" string="Billing Period"/>
                                        <div class="o_row">
                                            <field name="bill_through_date" class="oe_inline"/>
                                            <span class="oe_inline oe_grey"> to </span>
                                            <field name="paid_through_date" class="oe_inline"/>
                                        </div>
                                    </group>
                                    
                                    <group string="Status Dates" class="o_label_nowrap">
                                        <field name="grace_period_end_date" 
                                               invisible="status != 'grace'"
                                               decoration-danger="grace_period_end_date and grace_period_end_date &lt; current_date"/>
                                        <field name="suspend_end_date" 
                                               invisible="status != 'suspended'"/>
                                        <field name="terminated_date" 
                                               invisible="status not in ('terminated', 'cancelled')"
                                               readonly="1"/>
                                    </group>
                                </div>
                            </div>
                        </page>

                        <!-- Financial Tab -->
                        <page string="Financial" name="financial" 
                              invisible="not related_invoice_id and not subscription_product_id and not auto_pay">
                            <group>
                                <group string="Billing Integration" class="o_label_nowrap">
                                    <field name="related_invoice_id" 
                                           options="{'no_create': True}"
                                           context="{'show_address': 1}"/>
                                    <field name="subscription_product_id"
                                           placeholder="Reference to subscription product..."/>
                                </group>
                                <group string="Renewal Settings" class="o_label_nowrap">
                                    <field name="auto_pay"/>
                                    <field name="renew_to_product_id" 
                                           invisible="not auto_pay"
                                           placeholder="Product for renewal..."/>
                                </group>
                            </group>
                        </page>

                        <!-- Cancellation Tab -->
                        <page string="Cancellation" name="cancellation" 
                              invisible="status not in ('cancelled', 'terminated')">
                            <div class="alert alert-warning" role="alert">
                                <strong>This participation has been ended.</strong> 
                                Review the details below for cancellation information and processing notes.
                            </div>
                            <group>
                                <group string="Cancellation Details" class="o_label_nowrap">
                                    <field name="cancellation_reason_id" 
                                           options="{'no_create': True}"/>
                                    <field name="terminated_date" readonly="1"/>
                                </group>
                            </group>
                            
                            <!-- Show cancellation reason details -->
                            <group string="Reason Information" 
                                   invisible="not cancellation_reason_id">
                                <field name="cancellation_reason_id" invisible="1"/>
                                <div class="o_row" invisible="not cancellation_reason_id">
                                    <label for="cancellation_reason_id"/>
                                    <div>
                                        <strong><field name="cancellation_reason_id" readonly="1" options="{'no_open': True}"/></strong>
                                        <br/>
                                        <span class="text-muted">
                                            Category: <field name="cancellation_reason_id" readonly="1" options="{'no_open': True}"/>
                                        </span>
                                    </div>
                                </div>
                            </group>
                        </page>

                        <!-- History Tab -->
                        <page string="Change History" name="history">
                            <p class="text-muted">
                                Complete audit trail of all status changes for this participation.
                                History entries are automatically created and cannot be modified.
                            </p>
                            <field name="history_ids" readonly="1" nolabel="1">
                                <tree string="Status Changes" create="false" edit="false" delete="false" 
                                      default_order="change_date desc">
                                    <field name="change_date"/>
                                    <field name="old_status" 
                                           decoration-success="old_status == 'prospect'"
                                           decoration-info="old_status == 'active'"
                                           decoration-warning="old_status == 'grace'"
                                           decoration-danger="old_status in ('suspended', 'terminated', 'cancelled')"/>
                                    <field name="new_status" 
                                           decoration-success="new_status == 'active'"
                                           decoration-warning="new_status == 'grace'"
                                           decoration-danger="new_status in ('suspended', 'terminated', 'cancelled')"/>
                                    <field name="changed_by"/>
                                    <field name="automated" widget="boolean_toggle"/>
                                    <field name="reason"/>
                                    <field name="reference_document"/>
                                </tree>
                                <form string="History Entry">
                                    <sheet>
                                        <group>
                                            <group>
                                                <field name="change_date" readonly="1"/>
                                                <field name="old_status" readonly="1"/>
                                                <field name="new_status" readonly="1"/>
                                                <field name="changed_by" readonly="1"/>
                                                <field name="automated" readonly="1"/>
                                            </group>
                                            <group>
                                                <field name="effective_date" readonly="1"/>
                                                <field name="reference_document" readonly="1"/>
                                            </group>
                                        </group>
                                        <group string="Reason">
                                            <field name="reason" readonly="1" nolabel="1"/>
                                        </group>
                                    </sheet>
                                </form>
                            </field>
                        </page>

                        <!-- Administrative Tab -->
                        <page string="Administrative" name="admin">
                            <group string="Internal Notes">
                                <field name="notes" nolabel="1" 
                                       placeholder="Administrative notes about this participation. These notes are internal and not visible to members."/>
                            </group>
                            
                            <group>
                                <group string="System Information">
                                    <field name="create_date" readonly="1"/>
                                    <field name="create_uid" readonly="1"/>
                                    <field name="write_date" readonly="1"/>
                                    <field name="write_uid" readonly="1"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Update the action to use the enhanced form -->
    <record id="action_ams_participation" model="ir.actions.act_window">
        <field name="name">All Participations</field>
        <field name="res_model">ams.participation</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="view_id" eval="False"/>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first participation
            </p>
            <p>
                Participations track all member engagement with your association - 
                from basic memberships to committee positions and chapter roles. 
                Each participation has its own lifecycle, billing relationships, 
                and status management.
            </p>
        </field>
    </record>
</odoo>