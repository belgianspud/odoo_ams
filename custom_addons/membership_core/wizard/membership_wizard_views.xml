<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Membership Create Wizard Form -->
    <record id="membership_create_wizard_form_view" model="ir.ui.view">
        <field name="name">membership.create.wizard.form</field>
        <field name="model">membership.create.wizard</field>
        <field name="arch" type="xml">
            <form string="Create Membership">
                <sheet>
                    <div class="oe_title">
                        <h1>Create New Membership</h1>
                    </div>
                    
                    <!-- Validation Warning -->
                    <div class="alert alert-warning" role="alert" 
                         attrs="{'invisible': [('has_conflicting_membership', '=', False)]}">
                        <strong>Warning:</strong> <field name="validation_message" readonly="1"/>
                        <div class="mt-2">
                            <button name="action_view_conflicting_membership" type="object" 
                                    string="View Conflicting Membership" class="btn btn-warning btn-sm"/>
                            <button name="action_override_conflict" type="object" 
                                    string="Override (Manager Only)" class="btn btn-danger btn-sm"
                                    groups="membership_core.group_membership_manager"/>
                        </div>
                    </div>
                    
                    <group>
                        <group string="Member Information">
                            <field name="is_new_partner"/>
                            <field name="partner_id" attrs="{'invisible': [('is_new_partner', '=', True)], 'required': [('is_new_partner', '=', False)]}" 
                                   options="{'no_create': True, 'no_open': True}"/>
                            
                            <!-- New Partner Fields -->
                            <field name="partner_name" attrs="{'invisible': [('is_new_partner', '=', False)], 'required': [('is_new_partner', '=', True)]}"/>
                            <field name="partner_email" attrs="{'invisible': [('is_new_partner', '=', False)]}"/>
                            <field name="partner_phone" attrs="{'invisible': [('is_new_partner', '=', False)]}"/>
                            <field name="partner_is_company" attrs="{'invisible': [('is_new_partner', '=', False)]}"/>
                        </group>
                        
                        <group string="Membership Configuration">
                            <field name="membership_type_id" options="{'no_create': True}"/>
                            <field name="membership_category" readonly="1"/>
                            <field name="price" readonly="1" widget="monetary"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Dates">
                            <field name="start_date"/>
                            <field name="custom_end_date"/>
                            <field name="end_date" attrs="{'invisible': [('custom_end_date', '=', False)], 'required': [('custom_end_date', '=', True)]}"/>
                            <field name="calculated_end_date" readonly="1" attrs="{'invisible': [('custom_end_date', '=', True)]}"/>
                        </group>
                        
                        <group string="Financial Information">
                            <field name="amount_paid" widget="monetary"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Options">
                            <field name="auto_activate"/>
                            <field name="send_welcome_email" attrs="{'invisible': [('auto_activate', '=', False)]}"/>
                        </group>
                    </group>
                    
                    <group>
                        <field name="notes" placeholder="Additional notes about this membership..."/>
                    </group>
                    
                    <!-- Validation Info -->
                    <group attrs="{'invisible': [('has_conflicting_membership', '=', False)]}">
                        <field name="has_conflicting_membership" invisible="1"/>
                        <field name="conflicting_membership_id" invisible="1"/>
                    </group>
                </sheet>
                
                <footer>
                    <button string="Create Membership" name="action_create_membership" type="object" 
                            class="btn-primary" attrs="{'invisible': [('has_conflicting_membership', '=', True)]}"/>
                    <button string="Create Anyway (Override)" name="action_override_conflict" type="object" 
                            class="btn-danger" attrs="{'invisible': [('has_conflicting_membership', '=', False)]}"
                            groups="membership_core.group_membership_manager"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>
    
    <!-- Membership Renewal Wizard Form -->
    <record id="membership_renewal_wizard_form_view" model="ir.ui.view">
        <field name="name">membership.renewal.wizard.form</field>
        <field name="model">membership.renewal.wizard</field>
        <field name="arch" type="xml">
            <form string="Renew Membership">
                <sheet>
                    <div class="oe_title">
                        <h1>Renew Membership</h1>
                        <h3><field name="membership_id" readonly="1"/></h3>
                    </div>
                    
                    <!-- Renewal Warning -->
                    <div class="alert alert-warning" role="alert" 
                         attrs="{'invisible': [('renewal_warning', '=', False)]}">
                        <strong>Warning:</strong><br/>
                        <field name="renewal_warning" readonly="1"/>
                    </div>
                    
                    <!-- Cannot Renew Warning -->
                    <div class="alert alert-danger" role="alert" 
                         attrs="{'invisible': [('can_renew', '=', True)]}">
                        <strong>Cannot Renew:</strong> This membership cannot be renewed in its current state.
                    </div>
                    
                    <group>
                        <group string="Current Membership">
                            <field name="partner_id" readonly="1"/>
                            <field name="membership_type_id" readonly="1"/>
                            <field name="current_state" readonly="1" widget="badge"/>
                            <field name="current_end_date" readonly="1"/>
                            <field name="days_since_expiry" readonly="1"/>
                            <field name="is_early_renewal" readonly="1"/>
                        </group>
                        
                        <group string="Renewal Configuration">
                            <field name="renewal_type"/>
                            <field name="renewal_months" attrs="{'invisible': [('renewal_type', 'not in', ['custom_period'])], 'required': [('renewal_type', '=', 'custom_period')]}"/>
                            <field name="custom_end_date" attrs="{'invisible': [('renewal_type', '!=', 'custom_date')], 'required': [('renewal_type', '=', 'custom_date')]}"/>
                            <field name="new_end_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Pricing">
                            <field name="base_price" readonly="1" widget="monetary"/>
                            <field name="renewal_price" widget="monetary"/>
                            <field name="discount_amount" widget="monetary"/>
                            <field name="final_price" readonly="1" widget="monetary"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                        
                        <group string="Payment">
                            <field name="payment_received"/>
                            <field name="amount_paid" widget="monetary" attrs="{'required': [('payment_received', '=', True)]}"/>
                            <field name="payment_method" attrs="{'invisible': [('payment_received', '=', False)]}"/>
                            <field name="payment_reference" attrs="{'invisible': [('payment_received', '=', False)]}"/>
                        </group>
                    </group>
                    
                    <group>
                        <group string="Options">
                            <field name="send_confirmation_email"/>
                            <field name="reset_grace_period"/>
                        </group>
                    </group>
                    
                    <group>
                        <field name="notes" placeholder="Notes about this renewal..."/>
                    </group>
                    
                    <!-- Hidden fields for computations -->
                    <group invisible="1">
                        <field name="can_renew"/>
                    </group>
                </sheet>
                
                <footer>
                    <button string="Preview Renewal" name="action_preview_renewal" type="object" 
                            class="btn-secondary"/>
                    <button string="Create Invoice" name="action_create_invoice" type="object" 
                            class="btn-info" attrs="{'invisible': [('final_price', '=', 0)]}"/>
                    <button string="Process Renewal" name="action_renew_membership" type="object" 
                            class="btn-primary" attrs="{'invisible': [('can_renew', '=', False)]}"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>
    
    <!-- Bulk Renewal Wizard Form -->
    <record id="membership_bulk_renewal_wizard_form_view" model="ir.ui.view">
        <field name="name">membership.bulk.renewal.wizard.form</field>
        <field name="model">membership.bulk.renewal.wizard</field>
        <field name="arch" type="xml">
            <form string="Bulk Membership Renewal">
                <sheet>
                    <div class="oe_title">
                        <h1>Bulk Membership Renewal</h1>
                    </div>
                    
                    <group>
                        <group string="Selection Criteria">
                            <field name="membership_type_ids" widget="many2many_tags"/>
                            <field name="expiry_date_from"/>
                            <field name="expiry_date_to"/>
                            <field name="include_states"/>
                            <field name="custom_states" attrs="{'invisible': [('include_states', '!=', 'custom')], 'required': [('include_states', '=', 'custom')]}"/>
                        </group>
                        
                        <group string="Renewal Settings">
                            <field name="renewal_months"/>
                            <field name="auto_process"/>
                            <field name="membership_count" readonly="1"/>
                        </group>
                    </group>
                    
                    <group>
                        <div class="alert alert-info" role="alert">
                            <strong>Note:</strong> This will process <field name="membership_count" readonly="1"/> memberships.
                            Use "Preview" to see the list before processing.
                        </div>
                    </group>
                </sheet>
                
                <footer>
                    <button string="Preview Memberships" name="action_preview_bulk_renewal" type="object" 
                            class="btn-secondary"/>
                    <button string="Process Bulk Renewal" name="action_process_bulk_renewal" type="object" 
                            class="btn-primary" 
                            confirm="Are you sure you want to process renewal for all selected memberships?"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>
    
    <!-- Action for Create Membership Wizard -->
    <record id="action_membership_create_wizard" model="ir.actions.act_window">
        <field name="name">Create Membership</field>
        <field name="res_model">membership.create.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="membership_create_wizard_form_view"/>
    </record>
    
    <!-- Action for Renewal Wizard -->
    <record id="action_membership_renewal_wizard" model="ir.actions.act_window">
        <field name="name">Renew Membership</field>
        <field name="res_model">membership.renewal.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="membership_renewal_wizard_form_view"/>
        <field name="context">{
            'default_membership_id': active_id,
        }</field>
    </record>
    
    <!-- Action for Bulk Renewal Wizard -->
    <record id="action_membership_bulk_renewal_wizard" model="ir.actions.act_window">
        <field name="name">Bulk Membership Renewal</field>
        <field name="res_model">membership.bulk.renewal.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="view_id" ref="membership_bulk_renewal_wizard_form_view"/>
    </record>
    
    <!-- Menu item for Bulk Renewal -->
    <menuitem id="menu_membership_bulk_renewal"
              name="Bulk Renewal"
              parent="membership_menus.menu_membership_management"
              action="action_membership_bulk_renewal_wizard"
              sequence="50"
              groups="membership_core.group_membership_manager"/>

</odoo>