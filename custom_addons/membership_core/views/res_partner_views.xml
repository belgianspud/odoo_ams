<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Partner Form View Extension - Add Membership Tab -->
    <record id="res_partner_form_membership_view" model="ir.ui.view">
        <field name="name">res.partner.form.membership</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            
            <!-- Add membership info in button box -->
            <div name="button_box" position="inside">
                <button name="action_view_memberships" type="object" 
                        class="oe_stat_button" icon="fa-id-card"
                        attrs="{'invisible': [('membership_count', '=', 0)]}">
                    <field name="membership_count" widget="statinfo" string="Memberships"/>
                </button>
                <button name="%(action_membership_active)d" type="action" 
                        class="oe_stat_button" icon="fa-check-circle"
                        attrs="{'invisible': [('active_membership_count', '=', 0)]}"
                        context="{'search_default_partner_id': active_id}">
                    <field name="active_membership_count" widget="statinfo" string="Active"/>
                </button>
                <button name="action_view_membership_revenue" type="object" 
                        class="oe_stat_button" icon="fa-money"
                        attrs="{'invisible': [('total_membership_paid', '=', 0)]}">
                    <field name="total_membership_paid" widget="statinfo" string="Total Paid"/>
                </button>
            </div>
            
            <!-- Add membership status indicator -->
            <widget name="web_ribbon" title="Member" bg_color="bg-success" 
                    attrs="{'invisible': [('is_member', '=', False)]}"/>
            
            <!-- Add membership fields in contact information -->
            <field name="category_id" position="after">
                <field name="is_member" readonly="1"/>
                <field name="membership_state" readonly="1" 
                       attrs="{'invisible': [('is_member', '=', False)]}"
                       widget="badge" 
                       decoration-success="membership_state=='active'"
                       decoration-warning="membership_state in ['grace', 'suspended']"
                       decoration-danger="membership_state in ['terminated', 'cancelled']"/>
                <field name="membership_type_id" readonly="1"
                       attrs="{'invisible': [('is_member', '=', False)]}"/>
                <field name="membership_expiry_date" readonly="1"
                       attrs="{'invisible': ['|', ('is_member', '=', False), ('membership_expiry_date', '=', False)]}"/>
            </field>
            
            <!-- Add Membership tab -->
            <notebook position="inside">
                <page string="Memberships" name="memberships" 
                      attrs="{'invisible': [('membership_count', '=', 0)]}">
                    
                    <group>
                        <group string="Current Membership Status">
                            <field name="is_member" readonly="1"/>
                            <field name="active_membership_id" readonly="1" 
                                   attrs="{'invisible': [('active_membership_id', '=', False)]}"
                                   options="{'no_create': True, 'no_open': True}"/>
                            <field name="membership_state" readonly="1"
                                   attrs="{'invisible': [('active_membership_id', '=', False)]}"
                                   widget="badge"/>
                            <field name="membership_type_id" readonly="1"
                                   attrs="{'invisible': [('active_membership_id', '=', False)]}"/>
                            <field name="membership_expiry_date" readonly="1"
                                   attrs="{'invisible': ['|', ('active_membership_id', '=', False), ('membership_expiry_date', '=', False)]}"/>
                        </group>
                        <group string="Membership Statistics">
                            <field name="membership_count" readonly="1"/>
                            <field name="active_membership_count" readonly="1"/>
                            <field name="total_membership_paid" readonly="1"/>
                        </group>
                    </group>
                    
                    <separator string="Membership History"/>
                    <field name="membership_ids" nolabel="1" readonly="1">
                        <tree decoration-success="state=='active'" 
                              decoration-warning="state=='grace'" 
                              decoration-danger="state in ['suspended', 'terminated', 'cancelled']"
                              decoration-muted="state=='draft'">
                            <field name="name"/>
                            <field name="membership_type_id"/>
                            <field name="state" widget="badge" 
                                   decoration-success="state=='active'"
                                   decoration-warning="state in ['grace', 'suspended']"
                                   decoration-danger="state in ['terminated', 'cancelled']"
                                   decoration-info="state=='draft'"/>
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="amount_paid" widget="monetary"/>
                            <field name="currency_id" invisible="1"/>
                            <button name="action_renew" type="object" string="Renew" 
                                    class="btn-success btn-sm" 
                                    attrs="{'invisible': [('state', 'not in', ['active', 'grace'])]}"/>
                        </tree>
                    </field>
                    
                    <div class="oe_clear"/>
                    <div class="mt-3">
                        <button name="%(action_create_membership_wizard)d" type="action" 
                                string="Create New Membership" class="btn-primary"
                                context="{'default_partner_id': active_id}"/>
                        <button name="action_view_memberships" type="object" 
                                string="View All Memberships" class="btn-secondary"/>
                    </div>
                </page>
            </notebook>
            
        </field>
    </record>
    
    <!-- Partner Tree View Extension - Add Membership Columns -->
    <record id="res_partner_tree_membership_view" model="ir.ui.view">
        <field name="name">res.partner.tree.membership</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <field name="display_name" position="after">
                <field name="is_member" optional="show"/>
                <field name="membership_state" optional="show"
                       widget="badge" 
                       decoration-success="membership_state=='active'"
                       decoration-warning="membership_state in ['grace', 'suspended']"
                       decoration-danger="membership_state in ['terminated', 'cancelled']"/>
                <field name="membership_type_id" optional="hide"/>
                <field name="membership_expiry_date" optional="hide"/>
            </field>
        </field>
    </record>
    
    <!-- Partner Kanban View Extension - Add Membership Info -->
    <record id="res_partner_kanban_membership_view" model="ir.ui.view">
        <field name="name">res.partner.kanban.membership</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.res_partner_kanban_view"/>
        <field name="arch" type="xml">
            <field name="display_name" position="after">
                <field name="is_member"/>
                <field name="membership_state"/>
                <field name="membership_type_id"/>
                <field name="membership_expiry_date"/>
            </field>
            
            <div class="oe_kanban_details" position="inside">
                <div t-if="record.is_member.raw_value" class="row">
                    <div class="col-12">
                        <span class="badge badge-success">Member</span>
                        <t t-if="record.membership_type_id.raw_value">
                            - <field name="membership_type_id"/>
                        </t>
                    </div>
                </div>
                <div t-if="record.membership_expiry_date.raw_value" class="row">
                    <div class="col-12">
                        <small class="text-muted">
                            Expires: <field name="membership_expiry_date"/>
                        </small>
                    </div>
                </div>
            </div>
        </field>
    </record>
    
    <!-- Partner Search View Extension - Add Membership Filters -->
    <record id="res_partner_search_membership_view" model="ir.ui.view">
        <field name="name">res.partner.search.membership</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <field name="category_id" position="after">
                <field name="membership_type_id" string="Membership Type"/>
                <field name="membership_state" string="Membership Status"/>
            </field>
            
            <filter name="customer" position="after">
                <separator/>
                <filter string="Members" name="is_member" 
                        domain="[('is_member', '=', True)]"/>
                <filter string="Non-Members" name="not_member" 
                        domain="[('is_member', '=', False)]"/>
                <separator/>
                <filter string="Active Members" name="active_members" 
                        domain="[('membership_state', '=', 'active')]"/>
                <filter string="Grace Period" name="grace_members" 
                        domain="[('membership_state', '=', 'grace')]"/>
                <filter string="Suspended Members" name="suspended_members" 
                        domain="[('membership_state', '=', 'suspended')]"/>
                <separator/>
                <filter string="Expiring Soon" name="expiring_members" 
                        domain="[('membership_expiry_date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d')), ('membership_expiry_date', '&gt;=', context_today().strftime('%Y-%m-%d')), ('membership_state', 'in', ['active', 'grace'])]"/>
                <filter string="Expired" name="expired_members" 
                        domain="[('membership_expiry_date', '&lt;', context_today().strftime('%Y-%m-%d')), ('membership_state', 'in', ['grace', 'suspended'])]"/>
            </filter>
            
            <group position="inside">
                <filter string="Membership Status" name="group_membership_state" 
                        context="{'group_by': 'membership_state'}"/>
                <filter string="Membership Type" name="group_membership_type" 
                        context="{'group_by': 'membership_type_id'}"/>
            </group>
        </field>
    </record>
    
    <!-- Members-only View Action -->
    <record id="action_res_partner_members" model="ir.actions.act_window">
        <field name="name">Members</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_member', '=', True)]</field>
        <field name="context">{
            'search_default_active_members': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No members found!
            </p>
            <p>
                This view shows all partners who have active memberships with your organization.
                Members are automatically identified when they have active or grace period memberships.
            </p>
        </field>
    </record>
    
    <!-- Active Members View Action -->
    <record id="action_res_partner_active_members" model="ir.actions.act_window">
        <field name="name">Active Members</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('membership_state', '=', 'active')]</field>
        <field name="context">{
            'search_default_group_membership_type': 1,
        }</field>
    </record>
    
    <!-- Expiring Members View Action -->
    <record id="action_res_partner_expiring_members" model="ir.actions.act_window">
        <field name="name">Expiring Members</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="domain">[('membership_expiry_date', '&lt;=', (context_today() + datetime.timedelta(days=30)).strftime('%Y-%m-%d')), ('membership_expiry_date', '&gt;=', context_today().strftime('%Y-%m-%d')), ('membership_state', 'in', ['active', 'grace'])]</field>
        <field name="context">{
            'search_default_group_by_membership_expiry_date': 1,
        }</field>
    </record>
    
    <!-- Action for Create Membership Wizard -->
    <record id="action_create_membership_wizard" model="ir.actions.act_window">
        <field name="name">Create Membership</field>
        <field name="res_model">membership.create.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{
            'default_partner_id': active_id,
        }</field>
    </record>
    
    <!-- Partner membership revenue action -->
    <record id="action_partner_membership_revenue" model="ir.actions.act_window">
        <field name="name">Membership Revenue</field>
        <field name="res_model">membership.membership</field>
        <field name="view_mode">pivot,graph,tree</field>
        <field name="domain">[('partner_id', '=', active_id)]</field>
        <field name="context">{
            'search_default_group_by_membership_type_id': 1,
            'search_default_group_by_state': 1,
        }</field>
    </record>

</odoo>