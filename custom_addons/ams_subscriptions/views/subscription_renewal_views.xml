<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Subscription Renewal Management Views -->
    
    <!-- Renewal Dashboard Form View -->
    <record id="view_ams_renewal_dashboard_form" model="ir.ui.view">
        <field name="name">ams.renewal.dashboard.form</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <form string="Renewal Dashboard" create="false" edit="false">
                <sheet>
                    <div class="o_form_sheet_bg">
                        <div class="oe_title">
                            <h1>Subscription Renewal Dashboard</h1>
                            <p>Monitor and manage subscription renewals across your association</p>
                        </div>
                    </div>
                    
                    <!-- Key Metrics Row -->
                    <group>
                        <group string="Today's Renewals">
                            <field name="renewals_due_today" readonly="1"/>
                            <field name="renewal_revenue_today" readonly="1"/>
                            <field name="overdue_renewals_count" readonly="1"/>
                        </group>
                        <group string="This Month">
                            <field name="renewals_due_this_month" readonly="1"/>
                            <field name="projected_renewal_revenue" readonly="1"/>
                            <field name="renewal_success_rate" readonly="1"/>
                        </group>
                    </group>
                    
                    <!-- Action Buttons -->
                    <group>
                        <div class="o_row">
                            <button name="action_process_due_renewals" string="Process Due Renewals" 
                                    type="object" class="btn-primary"/>
                            <button name="action_send_renewal_reminders" string="Send Reminders" 
                                    type="object" class="btn-info"/>
                            <button name="action_generate_renewal_report" string="Generate Report" 
                                    type="object" class="btn-secondary"/>
                        </div>
                    </group>
                    
                    <notebook>
                        <page string="Due Today" name="due_today">
                            <field name="renewals_due_today_ids" nolabel="1">
                                <list>
                                    <field name="partner_id"/>
                                    <field name="name"/>
                                    <field name="subscription_type_id"/>
                                    <field name="chapter_id" optional="hide"/>
                                    <field name="amount"/>
                                    <field name="next_renewal_date"/>
                                    <field name="auto_renewal"/>
                                    <field name="payment_status"/>
                                    <button name="action_create_renewal_invoice" string="Generate Invoice" 
                                            type="object" class="btn-primary" 
                                            invisible="renewal_invoice_id"/>
                                    <button name="action_process_auto_renewal" string="Auto Renew" 
                                            type="object" class="btn-success" 
                                            invisible="not auto_renewal or renewal_invoice_id"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="This Week" name="this_week">
                            <field name="renewals_due_this_week_ids" nolabel="1">
                                <list>
                                    <field name="partner_id"/>
                                    <field name="name"/>
                                    <field name="subscription_type_id"/>
                                    <field name="next_renewal_date"/>
                                    <field name="amount"/>
                                    <field name="auto_renewal"/>
                                    <field name="days_until_renewal"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Overdue" name="overdue">
                            <field name="overdue_renewals_ids" nolabel="1">
                                <list decoration-danger="true">
                                    <field name="partner_id"/>
                                    <field name="name"/>
                                    <field name="subscription_type_id"/>
                                    <field name="next_renewal_date"/>
                                    <field name="amount"/>
                                    <field name="days_overdue"/>
                                    <field name="state"/>
                                    <button name="action_send_overdue_notice" string="Send Notice" 
                                            type="object" class="btn-warning"/>
                                    <button name="action_suspend_subscription" string="Suspend" 
                                            type="object" class="btn-danger" 
                                            confirm="Are you sure you want to suspend this subscription?"/>
                                </list>
                            </field>
                        </page>
                        
                        <page string="Pending Payment" name="pending_payment">
                            <field name="pending_payment_renewals_ids" nolabel="1">
                                <list>
                                    <field name="partner_id"/>
                                    <field name="name"/>
                                    <field name="subscription_type_id"/>
                                    <field name="renewal_invoice_id"/>
                                    <field name="invoice_status"/>
                                    <field name="amount"/>
                                    <field name="payment_status"/>
                                    <button name="action_view_renewal_invoice" string="View Invoice" 
                                            type="object" icon="fa-file-text-o"/>
                                    <button name="action_send_payment_reminder" string="Payment Reminder" 
                                            type="object" class="btn-info"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Renewal Management List View -->
    <record id="view_ams_renewal_management_list" model="ir.ui.view">
        <field name="name">ams.renewal.management.list</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <list string="Renewal Management" create="false" multi_edit="1">
                <field name="partner_id"/>
                <field name="name"/>
                <field name="subscription_type_id"/>
                <field name="chapter_id" optional="hide"/>
                <field name="next_renewal_date" 
                       decoration-danger="next_renewal_date and next_renewal_date &lt; current_date"
                       decoration-warning="next_renewal_date and next_renewal_date &lt;= (current_date + datetime.timedelta(days=7))"/>
                <field name="amount"/>
                <field name="state"/>
                <field name="auto_renewal"/>
                <field name="renewal_invoice_id" optional="show"/>
                <field name="payment_status" optional="show"/>
                <field name="days_until_renewal" optional="show"/>
                <field name="renewal_reminder_sent" optional="hide"/>
                <field name="last_renewal_reminder_date" optional="hide"/>
                
                <!-- Action Buttons -->
                <button name="action_create_renewal_invoice" string="Generate Invoice" 
                        type="object" icon="fa-file-text-o" class="btn-primary"
                        invisible="renewal_invoice_id or state != 'active'"/>
                <button name="action_process_renewal" string="Process Renewal" 
                        type="object" icon="fa-check" class="btn-success"
                        invisible="state != 'pending_renewal' or not renewal_invoice_id"/>
                <button name="action_send_renewal_reminder" string="Send Reminder" 
                        type="object" icon="fa-envelope" class="btn-info"/>
                <button name="action_postpone_renewal" string="Postpone" 
                        type="object" icon="fa-clock-o" class="btn-warning"
                        invisible="state not in ('active', 'pending_renewal')"/>
            </list>
        </field>
    </record>

    <!-- Renewal Calendar View -->
    <record id="view_ams_renewal_calendar" model="ir.ui.view">
        <field name="name">ams.renewal.calendar</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <calendar string="Renewal Calendar" 
                      date_start="next_renewal_date" 
                      color="subscription_type_id"
                      event_open_popup="true"
                      quick_add="false">
                <field name="partner_id"/>
                <field name="name"/>
                <field name="subscription_type_id"/>
                <field name="amount"/>
                <field name="auto_renewal"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Renewal Kanban View -->
    <record id="view_ams_renewal_kanban" model="ir.ui.view">
        <field name="name">ams.renewal.kanban</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <kanban default_group_by="renewal_status" class="o_kanban_small_column">
                <field name="partner_id"/>
                <field name="name"/>
                <field name="subscription_type_id"/>
                <field name="amount"/>
                <field name="currency_id"/>
                <field name="next_renewal_date"/>
                <field name="auto_renewal"/>
                <field name="state"/>
                <field name="renewal_status"/>
                <field name="payment_status"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click" 
                             t-att-class="'border-left-3 border-' + 
                                         (record.renewal_status.raw_value == 'due_today' ? 'danger' : 
                                          record.renewal_status.raw_value == 'due_this_week' ? 'warning' : 
                                          record.renewal_status.raw_value == 'overdue' ? 'dark' : 
                                          record.renewal_status.raw_value == 'pending_payment' ? 'info' : 'success')">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="partner_id"/>
                                    </strong>
                                    <div class="o_kanban_record_subtitle">
                                        <field name="name"/>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="o_kanban_record_body">
                                <span class="badge badge-pill badge-primary">
                                    <field name="subscription_type_id"/>
                                </span>
                                <br/>
                                <strong>
                                    <field name="amount" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                                </strong>
                                <br/>
                                <span>Due: <field name="next_renewal_date"/></span>
                                <span t-if="record.auto_renewal.raw_value" class="badge badge-success">
                                    Auto Renew
                                </span>
                            </div>
                            
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left">
                                    <span t-att-class="'badge badge-' + 
                                                      (record.payment_status.raw_value == 'paid' ? 'success' : 
                                                       record.payment_status.raw_value == 'overdue' ? 'danger' : 'warning')">
                                        <field name="payment_status"/>
                                    </span>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <span t-att-class="'badge badge-' + 
                                                      (record.state.raw_value == 'active' ? 'success' : 
                                                       record.state.raw_value == 'pending_renewal' ? 'warning' : 'secondary')">
                                        <field name="state"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Renewal Pivot View for Analytics -->
    <record id="view_ams_renewal_pivot" model="ir.ui.view">
        <field name="name">ams.renewal.pivot</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <pivot string="Renewal Analytics">
                <field name="subscription_type_id" type="row"/>
                <field name="next_renewal_date" interval="month" type="col"/>
                <field name="amount" type="measure"/>
                <field name="partner_id" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Renewal Graph View -->
    <record id="view_ams_renewal_graph" model="ir.ui.view">
        <field name="name">ams.renewal.graph</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <graph string="Renewal Trends" type="line">
                <field name="next_renewal_date" interval="month"/>
                <field name="amount" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Renewal Search View -->
    <record id="view_ams_renewal_search" model="ir.ui.view">
        <field name="name">ams.renewal.search</field>
        <field name="model">ams.subscription</field>
        <field name="arch" type="xml">
            <search string="Renewal Management">
                <field name="partner_id"/>
                <field name="name"/>
                <field name="subscription_type_id"/>
                <field name="chapter_id"/>
                <separator/>
                
                <!-- Renewal Status Filters -->
                <filter string="Due Today" name="due_today" 
                        domain="[('next_renewal_date', '=', context_today().strftime('%Y-%m-%d')), 
                                ('state', '=', 'active')]"/>
                <filter string="Due This Week" name="due_this_week" 
                        domain="[('next_renewal_date', '>=', context_today().strftime('%Y-%m-%d')),
                                ('next_renewal_date', '<=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d')), 
                                ('state', '=', 'active')]"/>
                <filter string="Due This Month" name="due_this_month" 
                        domain="[('next_renewal_date', '>=', context_today().strftime('%Y-%m-01')),
                                ('next_renewal_date', '<=', (context_today() + relativedelta(months=1)).strftime('%Y-%m-01')), 
                                ('state', '=', 'active')]"/>
                <filter string="Overdue" name="overdue" 
                        domain="[('next_renewal_date', '&lt;', context_today().strftime('%Y-%m-%d')), 
                                ('state', '=', 'active')]"/>
                <separator/>
                
                <!-- Renewal Processing Status -->
                <filter string="Pending Renewal" name="pending_renewal" 
                        domain="[('state', '=', 'pending_renewal')]"/>
                <filter string="Invoice Generated" name="invoice_generated" 
                        domain="[('renewal_invoice_id', '!=', False)]"/>
                <filter string="Payment Pending" name="payment_pending" 
                        domain="[('renewal_invoice_id', '!=', False), ('payment_status', '!=', 'paid')]"/>
                <filter string="Payment Received" name="payment_received" 
                        domain="[('renewal_invoice_id', '!=', False), ('payment_status', '=', 'paid')]"/>
                <separator/>
                
                <!-- Auto-Renewal Filters -->
                <filter string="Auto Renewal Enabled" name="auto_renewal_enabled" 
                        domain="[('auto_renewal', '=', True)]"/>
                <filter string="Manual Renewal" name="manual_renewal" 
                        domain="[('auto_renewal', '=', False)]"/>
                <filter string="Reminder Sent" name="reminder_sent" 
                        domain="[('renewal_reminder_sent', '=', True)]"/>
                <filter string="No Reminder Sent" name="no_reminder_sent" 
                        domain="[('renewal_reminder_sent', '=', False)]"/>
                <separator/>
                
                <!-- Subscription Type Filters -->
                <filter string="Membership Renewals" name="membership_renewals" 
                        domain="[('subscription_code', '=', 'membership')]"/>
                <filter string="Chapter Renewals" name="chapter_renewals" 
                        domain="[('subscription_code', '=', 'chapter')]"/>
                <filter string="Publication Renewals" name="publication_renewals" 
                        domain="[('subscription_code', '=', 'publication')]"/>
                <separator/>
                
                <!-- Amount Filters -->
                <filter string="High Value (>$500)" name="high_value" 
                        domain="[('amount', '>', 500)]"/>
                <filter string="Medium Value ($100-$500)" name="medium_value" 
                        domain="[('amount', '>=', 100), ('amount', '<=', 500)]"/>
                <filter string="Low Value (<$100)" name="low_value" 
                        domain="[('amount', '&lt;', 100)]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Renewal Date" name="group_renewal_date" 
                            context="{'group_by': 'next_renewal_date:month'}"/>
                    <filter string="Subscription Type" name="group_subscription_type" 
                            context="{'group_by': 'subscription_type_id'}"/>
                    <filter string="Chapter" name="group_chapter" 
                            context="{'group_by': 'chapter_id'}"/>
                    <filter string="State" name="group_state" 
                            context="{'group_by': 'state'}"/>
                    <filter string="Auto Renewal" name="group_auto_renewal" 
                            context="{'group_by': 'auto_renewal'}"/>
                    <filter string="Payment Status" name="group_payment_status" 
                            context="{'group_by': 'payment_status'}"/>
                    <filter string="Member" name="group_partner" 
                            context="{'group_by': 'partner_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Main Renewal Dashboard Action -->
    <record id="action_renewal_dashboard" model="ir.actions.act_window">
        <field name="name">Renewal Dashboard</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_ams_renewal_dashboard_form"/>
        <field name="target">current</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Welcome to the Renewal Dashboard!
            </p>
            <p>
                Monitor and manage subscription renewals from this central dashboard.
                Track due renewals, process payments, and maintain member continuity.
            </p>
        </field>
    </record>

    <!-- Due Renewals Action -->
    <record id="action_due_renewals" model="ir.actions.act_window">
        <field name="name">Due Renewals</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,kanban,form,calendar</field>
        <field name="domain">[
            ('is_recurring', '=', True),
            ('state', '=', 'active'),
            ('next_renewal_date', '&lt;=', context_today().strftime('%Y-%m-%d'))
        ]</field>
        <field name="context">{'search_default_due_today': 1}</field>
        <field name="view_id" ref="view_ams_renewal_management_list"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No renewals due today!
            </p>
            <p>Subscriptions that are due for renewal will appear here.</p>
        </field>
    </record>

    <!-- Pending Renewals Action -->
    <record id="action_pending_renewals" model="ir.actions.act_window">
        <field name="name">Pending Renewals</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="domain">[('state', '=', 'pending_renewal')]</field>
        <field name="context">{'search_default_pending_renewal': 1}</field>
        <field name="view_id" ref="view_ams_renewal_management_list"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No pending renewals!
            </p>
            <p>Subscriptions with renewal invoices waiting for payment will appear here.</p>
        </field>
    </record>

    <!-- Overdue Renewals Action -->
    <record id="action_overdue_renewals" model="ir.actions.act_window">
        <field name="name">Overdue Renewals</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[
            ('next_renewal_date', '&lt;', context_today().strftime('%Y-%m-%d')),
            ('state', '=', 'active')
        ]</field>
        <field name="context">{'search_default_overdue': 1}</field>
        <field name="view_id" ref="view_ams_renewal_management_list"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No overdue renewals!
            </p>
            <p>Subscriptions with overdue renewal dates will appear here.</p>
        </field>
    </record>

    <!-- Renewal Calendar Action -->
    <record id="action_renewal_calendar" model="ir.actions.act_window">
        <field name="name">Renewal Calendar</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">calendar,list,form</field>
        <field name="domain">[('is_recurring', '=', True), ('state', '=', 'active')]</field>
        <field name="view_id" ref="view_ams_renewal_calendar"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No recurring subscriptions yet!
            </p>
            <p>View upcoming renewals in calendar format to plan renewal activities.</p>
        </field>
    </record>

    <!-- Renewal Analytics Action -->
    <record id="action_renewal_analytics" model="ir.actions.act_window">
        <field name="name">Renewal Analytics</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">pivot,graph,list</field>
        <field name="domain">[('is_recurring', '=', True)]</field>
        <field name="context">{
            'search_default_group_subscription_type': 1,
            'search_default_group_renewal_date': 1
        }</field>
        <field name="view_id" ref="view_ams_renewal_pivot"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No renewal data yet!
            </p>
            <p>Analyze renewal trends, revenue projections, and member retention patterns.</p>
        </field>
    </record>

    <!-- Auto-Renewal Management Action -->
    <record id="action_auto_renewal_management" model="ir.actions.act_window">
        <field name="name">Auto-Renewal Management</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('auto_renewal', '=', True), ('state', '=', 'active')]</field>
        <field name="context">{'search_default_auto_renewal_enabled': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No auto-renewal subscriptions yet!
            </p>
            <p>Manage subscriptions with automatic renewal enabled.</p>
        </field>
    </record>

    <!-- Renewal Reminder Management Action -->
    <record id="action_renewal_reminder_management" model="ir.actions.act_window">
        <field name="name">Renewal Reminders</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[
            ('is_recurring', '=', True),
            ('state', '=', 'active'),
            ('next_renewal_date', '<=', (context_today() + datetime.timedelta(days=60)).strftime('%Y-%m-%d'))
        ]</field>
        <field name="context">{'search_default_group_renewal_date': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No upcoming renewals!
            </p>
            <p>Manage renewal reminders for subscriptions expiring in the next 60 days.</p>
        </field>
    </record>

</odoo>