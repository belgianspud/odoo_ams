<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Add Subscriptions to Portal Home Page -->
    <template id="portal_my_home_subscriptions" inherit_id="portal.portal_my_home" name="Portal: My Subscriptions">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="title">My Subscriptions</t>
                <t t-set="url" t-value="'/my/subscriptions'"/>
                <t t-set="placeholder_count" t-value="'subscription_count'"/>
            </t>
        </xpath>
    </template>

    <!-- Main Subscriptions List Template -->
    <template id="portal_my_subscriptions" name="My Subscriptions">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Subscriptions</t>
            </t>
            
            <t t-if="not subscriptions">
                <div class="alert alert-warning mt-3" role="alert">
                    <h4><i class="fa fa-exclamation-triangle me-2"/>No subscriptions found!</h4>
                    <p>You don't have any subscriptions yet.</p>
                    <a href="/shop" class="btn btn-primary">
                        <i class="fa fa-shopping-cart me-1"/>Browse Memberships
                    </a>
                </div>
            </t>
            <t t-else="">
                <t t-call="portal.portal_table">
                    <thead>
                        <tr class="active">
                            <th>Subscription</th>
                            <th>Type</th>
                            <th>Tier</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>Paid Through</th>
                            <th class="text-center">Seats</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="subscriptions" t-as="subscription">
                            <tr>
                                <td>
                                    <a t-attf-href="/my/subscription/#{subscription.id}" class="text-decoration-none">
                                        <strong t-field="subscription.name"/>
                                    </a>
                                </td>
                                <td>
                                    <span t-attf-class="badge #{subscription.subscription_type == 'enterprise' and 'bg-primary' or 'bg-secondary'}">
                                        <t t-esc="dict(subscription._fields['subscription_type'].selection)[subscription.subscription_type]"/>
                                    </span>
                                </td>
                                <td t-field="subscription.tier_id.name"/>
                                <td>
                                    <span t-attf-class="badge #{subscription.state == 'active' and 'bg-success' or subscription.state == 'grace' and 'bg-warning' or subscription.state == 'paused' and 'bg-info' or 'bg-secondary'}">
                                        <t t-esc="subscription.state.title()"/>
                                    </span>
                                </td>
                                <td t-field="subscription.start_date"/>
                                <td t-field="subscription.paid_through_date"/>
                                <td class="text-center">
                                    <t t-if="subscription.subscription_type == 'enterprise'">
                                        <span class="badge bg-light text-dark border">
                                            <t t-esc="len(subscription.seat_ids.filtered('active'))"/>/<t t-esc="subscription.total_seats"/>
                                        </span>
                                    </t>
                                    <t t-else="">-</t>
                                </td>
                                <td class="text-end">
                                    <div class="btn-group btn-group-sm">
                                        <a t-attf-href="/my/subscription/#{subscription.id}" class="btn btn-outline-primary btn-sm" title="View Details">
                                            <i class="fa fa-eye"/>
                                        </a>
                                        <t t-if="subscription.state == 'active' and subscription.allow_modifications">
                                            <a t-attf-href="/my/subscription/#{subscription.id}/modify" class="btn btn-outline-secondary btn-sm" title="Modify">
                                                <i class="fa fa-edit"/>
                                            </a>
                                        </t>
                                    </div>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </t>
            </t>
        </t>
    </template>

    <!-- Subscription Detail Template -->
    <template id="portal_subscription_detail" name="Subscription Detail">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <t t-call="portal.portal_record_layout">
                <t t-set="card_header">
                    <h4 class="mb-0">
                        <i class="fa fa-id-card me-2"/>
                        <span t-field="subscription.name"/>
                        <small class="text-muted ms-2">
                            (<span t-field="subscription.subscription_type"/>)
                        </small>
                    </h4>
                </t>
                <t t-set="card_body">
                    <!-- Flash Messages -->
                    <t t-if="message">
                        <div t-attf-class="alert alert-#{message.get('type', 'info')} alert-dismissible fade show" role="alert">
                            <t t-esc="message.get('text', '')"/>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </t>

                    <!-- Status and Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-sm-6">
                                    <strong>Status:</strong>
                                    <span t-attf-class="badge ms-2 #{subscription.state == 'active' and 'bg-success' or subscription.state == 'grace' and 'bg-warning' or subscription.state == 'paused' and 'bg-info' or 'bg-secondary'}">
                                        <t t-esc="subscription.state.title()"/>
                                    </span>
                                </div>
                                <div class="col-sm-6">
                                    <strong>Tier:</strong> <span t-field="subscription.tier_id.name"/>
                                </div>
                                <div class="col-sm-6 mt-2">
                                    <strong>Start Date:</strong> <span t-field="subscription.start_date"/>
                                </div>
                                <div class="col-sm-6 mt-2">
                                    <strong>Paid Through:</strong> <span t-field="subscription.paid_through_date"/>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group-vertical">
                                <t t-if="subscription.state == 'active' and subscription.allow_modifications">
                                    <a t-attf-href="/my/subscription/#{subscription.id}/modify" class="btn btn-primary btn-sm mb-1">
                                        <i class="fa fa-arrow-up me-1"/>Modify Subscription
                                    </a>
                                </t>
                                <t t-if="subscription.state == 'active' and subscription.allow_pausing">
                                    <form method="post" t-attf-action="/my/subscription/#{subscription.id}/pause" class="mb-1">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        <button type="submit" class="btn btn-warning btn-sm w-100" onclick="return confirm('Are you sure you want to pause this subscription?')">
                                            <i class="fa fa-pause me-1"/>Pause
                                        </button>
                                    </form>
                                </t>
                                <t t-if="subscription.state == 'paused'">
                                    <form method="post" t-attf-action="/my/subscription/#{subscription.id}/resume" class="mb-1">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        <button type="submit" class="btn btn-success btn-sm w-100">
                                            <i class="fa fa-play me-1"/>Resume
                                        </button>
                                    </form>
                                </t>
                                <a t-attf-href="/my/subscription/#{subscription.id}/cancel" class="btn btn-outline-danger btn-sm">
                                    <i class="fa fa-times me-1"/>Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enterprise Seats (if applicable) -->
                    <t t-if="subscription.subscription_type == 'enterprise'">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fa fa-users me-2"/>Seat Assignments</h6>
                                <span class="badge bg-info">
                                    <t t-esc="len(subscription.seat_ids.filtered('active'))"/>/<t t-esc="subscription.total_seats"/> Used
                                </span>
                            </div>
                            <div class="card-body">
                                <t t-if="subscription.seat_ids">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Email</th>
                                                    <th>Assigned Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="subscription.seat_ids" t-as="seat">
                                                    <tr t-attf-class="#{not seat.active and 'text-muted' or ''}">
                                                        <td t-field="seat.contact_id.name"/>
                                                        <td t-field="seat.contact_id.email"/>
                                                        <td t-field="seat.assigned_date"/>
                                                        <td>
                                                            <span t-attf-class="badge #{seat.active and 'bg-success' or 'bg-secondary'}">
                                                                <t t-esc="seat.active and 'Active' or 'Inactive'"/>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                    </div>
                                </t>
                                <t t-else="">
                                    <p class="text-muted">No seat assignments yet.</p>
                                </t>
                                <a href="/my/enterprise-seats" class="btn btn-outline-primary btn-sm">
                                    <i class="fa fa-cog me-1"/>Manage Seats
                                </a>
                            </div>
                        </div>
                    </t>
                    
                    <!-- Modification History -->
                    <t t-if="modifications">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-history me-2"/>Modification History</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Details</th>
                                                <th class="text-end">Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="modifications[:5]" t-as="mod">
                                                <tr>
                                                    <td t-field="mod.modification_date"/>
                                                    <td>
                                                        <span t-attf-class="badge #{mod.modification_type == 'upgrade' and 'bg-success' or mod.modification_type == 'downgrade' and 'bg-warning' or 'bg-info'}">
                                                            <t t-esc="mod.modification_type.title()"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <t t-if="mod.old_tier_id and mod.new_tier_id and mod.old_tier_id != mod.new_tier_id">
                                                            <span t-field="mod.old_tier_id.name"/> → <span t-field="mod.new_tier_id.name"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span t-field="mod.reason"/>
                                                        </t>
                                                    </td>
                                                    <td class="text-end">
                                                        <t t-if="mod.proration_amount">
                                                            <span t-attf-class="#{mod.proration_amount > 0 and 'text-success' or 'text-info'}">
                                                                $<t t-esc="'{:,.2f}'.format(abs(mod.proration_amount))"/>
                                                                <t t-if="mod.proration_amount > 0"> <small class="text-muted">(Charged)</small></t>
                                                                <t t-else=""> <small class="text-muted">(Credit)</small></t>
                                                            </span>
                                                        </t>
                                                        <t t-else="">-</t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </t>
                    
                    <!-- Payment History -->
                    <t t-if="payment_history">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fa fa-credit-card me-2"/>Recent Payment History</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Method</th>
                                                <th>Status</th>
                                                <th>Invoice</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="payment_history" t-as="payment">
                                                <tr>
                                                    <td t-field="payment.payment_date"/>
                                                    <td>$<t t-esc="'{:,.2f}'.format(payment.amount)"/></td>
                                                    <td t-field="payment.payment_method"/>
                                                    <td>
                                                        <span t-attf-class="badge #{payment.payment_status == 'success' and 'bg-success' or payment.payment_status == 'failed' and 'bg-danger' or payment.payment_status == 'nsf' and 'bg-warning' or 'bg-secondary'}">
                                                            <t t-esc="payment.payment_status.upper()"/>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <t t-if="payment.invoice_id">
                                                            <a t-attf-href="/my/invoices/#{payment.invoice_id.id}?access_token=#{payment.invoice_id.access_token}" target="_blank">
                                                                <t t-esc="payment.invoice_id.name"/>
                                                            </a>
                                                        </t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </t>
                </t>
            </t>
        </t>
    </template>

    <!-- Subscription Modify Template -->
    <template id="portal_subscription_modify" name="Modify Subscription">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fa fa-edit me-2"/>
                                Modify Subscription: <span t-field="subscription.name"/>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Flash Messages -->
                            <t t-if="message">
                                <div t-attf-class="alert alert-#{message.get('type', 'info')} alert-dismissible fade show" role="alert">
                                    <t t-esc="message.get('text', '')"/>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            </t>
                            
                            <form method="post" t-attf-action="/my/subscription/#{subscription.id}/modify">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Current Tier:</strong>
                                        <div class="alert alert-info mt-2">
                                            <strong t-field="subscription.tier_id.name"/>
                                            <p class="mb-0 small" t-field="subscription.tier_id.description"/>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Current Status:</strong>
                                        <div class="mt-2">
                                            <span t-attf-class="badge badge-lg #{subscription.state == 'active' and 'bg-success' or 'bg-secondary'}">
                                                <t t-esc="subscription.state.title()"/>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="new_tier_id" class="form-label">
                                        <strong>Select New Tier:</strong>
                                    </label>
                                    <select id="new_tier_id" name="new_tier_id" class="form-select" required="required">
                                        <option value="">-- Select a tier --</option>
                                        <t t-foreach="available_tiers" t-as="tier">
                                            <option t-att-value="tier.id">
                                                <t t-esc="tier.name"/>
                                                <t t-if="tier.description"> - <t t-esc="tier.description"/></t>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="reason" class="form-label">Reason for Change:</label>
                                    <textarea id="reason" name="reason" class="form-control" rows="3" placeholder="Please describe why you're making this change..."></textarea>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <a t-attf-href="/my/subscription/#{subscription.id}" class="btn btn-secondary">
                                        <i class="fa fa-arrow-left me-1"/>Back
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fa fa-check me-1"/>Confirm Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Subscription Cancel Template -->
    <template id="portal_subscription_cancel" name="Cancel Subscription">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fa fa-times me-2"/>
                                Cancel Subscription: <span t-field="subscription.name"/>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Flash Messages -->
                            <t t-if="message">
                                <div t-attf-class="alert alert-#{message.get('type', 'info')} alert-dismissible fade show" role="alert">
                                    <t t-esc="message.get('text', '')"/>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            </t>

                            <div class="alert alert-warning">
                                <h6><i class="fa fa-exclamation-triangle me-2"/>Important Information</h6>
                                <ul class="mb-0">
                                    <li>Your subscription is currently paid through <strong t-field="subscription.paid_through_date"/></li>
                                    <li>You can choose to cancel immediately or at the end of your current period</li>
                                    <li>Cancellation may not be reversible depending on your membership type</li>
                                </ul>
                            </div>
                            
                            <form method="post" t-attf-action="/my/subscription/#{subscription.id}/cancel">
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                
                                <div class="mb-3">
                                    <label class="form-label"><strong>Why are you cancelling?</strong> <span class="text-danger">*</span></label>
                                    <t t-foreach="cancellation_reasons" t-as="reason">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="cancellation_reason" t-att-value="reason[0]" t-att-id="reason[0]" required="required"/>
                                            <label class="form-check-label" t-att-for="reason[0]">
                                                <t t-esc="reason[1]"/>
                                            </label>
                                        </div>
                                    </t>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="detailed_feedback" class="form-label">Additional Feedback:</label>
                                    <textarea id="detailed_feedback" name="detailed_feedback" class="form-control" rows="4" placeholder="Please help us improve by sharing more details about your decision..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label"><strong>When should the cancellation take effect?</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="effective_date" value="immediate" id="immediate"/>
                                        <label class="form-check-label" for="immediate">
                                            <strong>Cancel Immediately</strong> - Lose access right away
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="effective_date" value="period_end" id="period_end" checked="checked"/>
                                        <label class="form-check-label" for="period_end">
                                            <strong>Cancel at Period End</strong> - Keep access until <span t-field="subscription.paid_through_date"/> (Recommended)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="request_refund" id="request_refund"/>
                                        <label class="form-check-label" for="request_refund">
                                            Request refund for unused portion (subject to terms and conditions)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <a t-attf-href="/my/subscription/#{subscription.id}" class="btn btn-secondary">
                                        <i class="fa fa-arrow-left me-1"/>Keep Subscription
                                    </a>
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this subscription? This action may not be reversible.')">
                                        <i class="fa fa-times me-1"/>Confirm Cancellation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- Enterprise Seats Management Template -->
    <template id="portal_enterprise_seats" name="Manage Enterprise Seats">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa fa-users me-2"/>
                        Enterprise Seat Management
                    </h5>
                    <a href="/my/subscriptions" class="btn btn-outline-secondary btn-sm">
                        <i class="fa fa-arrow-left me-1"/>Back to Subscriptions
                    </a>
                </div>
                <div class="card-body">
                    <!-- Flash Messages -->
                    <t t-if="message">
                        <div t-attf-class="alert alert-#{message.get('type', 'info')} alert-dismissible fade show" role="alert">
                            <t t-esc="message.get('text', '')"/>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </t>
                    
                    <t t-foreach="enterprise_subscriptions" t-as="subscription">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <span t-field="subscription.name"/>
                                    <small class="text-muted">(<span t-field="subscription.tier_id.name"/>)</small>
                                </h6>
                                <span class="badge bg-info">
                                    <t t-esc="len(subscription.seat_ids.filtered('active'))"/>/<t t-esc="subscription.total_seats"/> Seats Used
                                </span>
                            </div>
                            <div class="card-body">
                                <!-- Current seat assignments would be shown here -->
                                <p class="text-muted">Seat management functionality available.</p>
                            </div>
                        </div>
                    </t>
                </div>
            </div>
        </t>
    </template>

    <!-- No Enterprise Subscriptions Template -->
    <template id="portal_no_enterprise_subscriptions" name="No Enterprise Subscriptions">
        <t t-call="portal.portal_layout">
            <div class="alert alert-info text-center">
                <h4><i class="fa fa-info-circle me-2"/>No Enterprise Subscriptions</h4>
                <p>You don't have any active enterprise subscriptions that allow seat management.</p>
                <a href="/my/subscriptions" class="btn btn-primary">
                    <i class="fa fa-arrow-left me-1"/>View My Subscriptions
                </a>
            </div>
        </t>
    </template>
</odoo>