<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <!-- ===== AUDIT SECURITY CATEGORIES ===== -->
        <record id="module_category_ams_audit" model="ir.module.category">
            <field name="name">AMS Audit</field>
            <field name="description">Audit logging and compliance permissions</field>
            <field name="sequence">60</field>
        </record>

        <!-- ===== AUDIT USER GROUPS ===== -->
        
        <!-- Audit Viewer Group - Read-only access to audit logs -->
        <record id="group_audit_viewer" model="res.groups">
            <field name="name">Audit Viewer</field>
            <field name="category_id" ref="module_category_ams_audit"/>
            <field name="implied_ids" eval="[(4, ref('ams_core_base.group_ams_staff'))]"/>
            <field name="comment">Read-only access to audit logs for compliance monitoring</field>
        </record>

        <!-- Audit Manager Group - Full audit management access -->
        <record id="group_audit_manager" model="res.groups">
            <field name="name">Audit Manager</field>
            <field name="category_id" ref="module_category_ams_audit"/>
            <field name="implied_ids" eval="[(4, ref('group_audit_viewer'))]"/>
            <field name="comment">Full audit management including log review, retention policies, and cleanup</field>
        </record>

        <!-- Audit Administrator Group - System-level audit configuration -->
        <record id="group_audit_admin" model="res.groups">
            <field name="name">Audit Administrator</field>
            <field name="category_id" ref="module_category_ams_audit"/>
            <field name="implied_ids" eval="[(4, ref('group_audit_manager')), (4, ref('ams_core_base.group_ams_admin'))]"/>
            <field name="comment">System-level audit configuration and security management</field>
        </record>

        <!-- Compliance Officer Group - Specialized compliance access -->
        <record id="group_compliance_officer" model="res.groups">
            <field name="name">Compliance Officer</field>
            <field name="category_id" ref="module_category_ams_audit"/>
            <field name="implied_ids" eval="[(4, ref('group_audit_viewer'))]"/>
            <field name="comment">Specialized access for compliance monitoring and reporting</field>
        </record>

        <!-- ===== RECORD RULES FOR AUDIT LOGS ===== -->
        
        <!-- Audit Viewers can read all audit logs -->
        <record id="audit_log_viewer_rule" model="ir.rule">
            <field name="name">Audit Logs: Viewers can read all</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_audit_viewer'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Audit Managers can review and manage audit logs -->
        <record id="audit_log_manager_rule" model="ir.rule">
            <field name="name">Audit Logs: Managers can review and manage</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_audit_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Audit Administrators have full access -->
        <record id="audit_log_admin_rule" model="ir.rule">
            <field name="name">Audit Logs: Administrators have full access</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('group_audit_admin'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="True"/>
        </record>

        <!-- Compliance Officers can read audit logs with compliance focus -->
        <record id="audit_log_compliance_rule" model="ir.rule">
            <field name="name">Audit Logs: Compliance Officers focused access</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">['|', ('category', 'in', ['privacy', 'financial', 'security']), ('requires_review', '=', True)]</field>
            <field name="groups" eval="[(4, ref('group_compliance_officer'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== FIELD-LEVEL SECURITY ===== -->
        
        <!-- Restrict sensitive audit fields to managers+ -->
        <record id="field_audit_log_ip_address" model="ir.model.fields">
            <field name="name">ip_address</field>
            <field name="model">ams.audit.log</field>
            <field name="groups" eval="[(4, ref('group_audit_manager'))]"/>
        </record>

        <record id="field_audit_log_user_agent" model="ir.model.fields">
            <field name="name">user_agent</field>
            <field name="model">ams.audit.log</field>
            <field name="groups" eval="[(4, ref('group_audit_manager'))]"/>
        </record>

        <record id="field_audit_log_session_id" model="ir.model.fields">
            <field name="name">session_id</field>
            <field name="model">ams.audit.log</field>
            <field name="groups" eval="[(4, ref('group_audit_manager'))]"/>
        </record>

        <record id="field_audit_log_field_changes_json" model="ir.model.fields">
            <field name="name">field_changes_json</field>
            <field name="model">ams.audit.log</field>
            <field name="groups" eval="[(4, ref('group_audit_viewer'))]"/>
        </record>

        <!-- ===== MENU SECURITY ===== -->
        
        <!-- Audit menu access restricted to audit viewers+ -->
        <record id="menu_audit_access_rule" model="ir.rule">
            <field name="name">Audit Menu Access</field>
            <field name="model_id" ref="base.model_ir_ui_menu"/>
            <field name="domain_force">[('id', 'child_of', ref('menu_audit_root'))]</field>
            <field name="groups" eval="[(4, ref('group_audit_viewer'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== DATA RETENTION RULES ===== -->
        
        <!-- High-risk audit logs have extended retention -->
        <record id="audit_retention_high_risk" model="ir.rule">
            <field name="name">High Risk Audit Retention</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('risk_level', 'in', ['high', 'critical'])]</field>
            <field name="groups" eval="[(4, ref('group_audit_admin'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Financial audit logs have special retention rules -->
        <record id="audit_retention_financial" model="ir.rule">
            <field name="name">Financial Audit Retention</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('category', '=', 'financial')]</field>
            <field name="groups" eval="[(4, ref('group_audit_admin'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Privacy audit logs have GDPR retention rules -->
        <record id="audit_retention_privacy" model="ir.rule">
            <field name="name">Privacy Audit Retention</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('category', '=', 'privacy')]</field>
            <field name="groups" eval="[(4, ref('group_audit_admin'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== SYSTEM PARAMETER ACCESS ===== -->
        
        <!-- Audit configuration parameters restricted to audit admins -->
        <record id="config_param_audit_access" model="ir.rule">
            <field name="name">Audit Configuration Access</field>
            <field name="model_id" ref="base.model_ir_config_parameter"/>
            <field name="domain_force">[('key', '=like', 'ams.audit%')]</field>
            <field name="groups" eval="[(4, ref('group_audit_admin'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="True"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== AUTOMATED AUDIT ACTIONS ===== -->
        
        <!-- System action to create audit logs (restricted to system) -->
        <record id="action_create_audit_log" model="ir.actions.server">
            <field name="name">Create Audit Log</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="state">code</field>
            <field name="code">
                # This action is for system use only
                if not env.user.has_group('ams_core_audit.group_audit_admin'):
                    raise AccessError(_('Unauthorized access to audit system'))
            </field>
            <field name="groups_id" eval="[(4, ref('group_audit_admin'))]"/>
        </record>

        <!-- ===== COMPLIANCE MONITORING RULES ===== -->
        
        <!-- Members can only view their own audit logs -->
        <record id="audit_log_member_self_rule" model="ir.rule">
            <field name="name">Members: Own Audit Logs Only</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('related_partner_id', '=', user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('ams_core_base.group_ams_member'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Privacy officers have special access to privacy-related logs -->
        <record id="audit_log_privacy_officer_rule" model="ir.rule">
            <field name="name">Privacy Officers: Privacy-related Audit Logs</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">['|', ('privacy_impact', '=', True), ('category', '=', 'privacy')]</field>
            <field name="groups" eval="[(4, ref('ams_core_base.group_ams_privacy_officer'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== AUDIT TRAIL INTEGRITY ===== -->
        
        <!-- Prevent modification of critical audit fields -->
        <record id="audit_integrity_rule" model="ir.rule">
            <field name="name">Audit Integrity Protection</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('id', '>', 0)]</field>
            <field name="groups" eval="[(4, ref('base.group_user'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Override for audit managers to allow review updates -->
        <record id="audit_review_rule" model="ir.rule">
            <field name="name">Audit Review Updates</field>
            <field name="model_id" ref="model_ams_audit_log"/>
            <field name="domain_force">[('id', '>', 0)]</field>
            <field name="groups" eval="[(4, ref('group_audit_manager'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- ===== DEFAULT GROUP ASSIGNMENTS ===== -->
        
        <!-- Assign AMS Admin to Audit Admin group -->
        <record id="ams_admin_audit_admin" model="res.groups">
            <field name="id" ref="group_audit_admin"/>
            <field name="implied_ids" eval="[(4, ref('ams_core_base.group_ams_admin'))]"/>
        </record>

        <!-- Assign AMS Manager to Audit Manager group -->
        <record id="ams_manager_audit_manager" model="res.groups">
            <field name="id" ref="group_audit_manager"/>
            <field name="implied_ids" eval="[(4, ref('ams_core_base.group_ams_manager'))]"/>
        </record>

        <!-- Assign Privacy Officer to Compliance Officer group -->
        <record id="privacy_officer_compliance" model="res.groups">
            <field name="id" ref="group_compliance_officer"/>
            <field name="implied_ids" eval="[(4, ref('ams_core_base.group_ams_privacy_officer'))]"/>
        </record>

    </data>
</odoo>