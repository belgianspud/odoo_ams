<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Communication Preference List View -->
    <record id="view_ams_communication_preference_list" model="ir.ui.view">
        <field name="name">ams.communication.preference.list</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <list string="Communication Preferences" default_order="partner_id,communication_type,category" editable="bottom">
                <field name="partner_id" readonly="1"/>
                <field name="communication_type"/>
                <field name="category"/>
                <field name="opted_in" widget="boolean_toggle"/>
                <field name="date_updated" readonly="1"/>
                <field name="consent_method" optional="hide"/>
                <field name="consent_source" optional="hide"/>
                <field name="is_member" optional="hide" readonly="1"/>
                <field name="partner_email" optional="hide" readonly="1"/>
                <field name="partner_phone" optional="hide" readonly="1"/>
            </list>
        </field>
    </record>

    <!-- Communication Preference Form View -->
    <record id="view_ams_communication_preference_form" model="ir.ui.view">
        <field name="name">ams.communication.preference.form</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <form string="Communication Preference">
                <header>
                    <button name="action_opt_in" string="Opt In" type="object" 
                            class="btn-success" 
                            modifiers='{"invisible": [["opted_in", "=", true]]}'/>
                    <button name="action_opt_out" string="Opt Out" type="object" 
                            class="btn-warning"
                            modifiers='{"invisible": [["opted_in", "=", false]]}'/>
                    <button name="toggle_preference" string="Toggle" type="object" 
                            class="btn-secondary"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="display_name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="partner_id" options="{'no_create': True}"/>
                            <field name="communication_type"/>
                            <field name="category"/>
                            <field name="opted_in" widget="boolean_toggle"/>
                        </group>
                        <group>
                            <field name="date_updated" readonly="1"/>
                            <field name="consent_method"/>
                            <field name="consent_source"/>
                            <field name="ip_address" readonly="1" 
                                   groups="base.group_system"
                                   help="IP address recorded for GDPR compliance"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Partner Information">
                            <group>
                                <group>
                                    <field name="partner_email" readonly="1"/>
                                    <field name="partner_phone" readonly="1"/>
                                    <field name="partner_mobile" readonly="1"/>
                                    <field name="is_member" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Compliance Information" groups="base.group_system">
                            <group>
                                <field name="ip_address"/>
                                <field name="consent_source"/>
                                <field name="consent_method"/>
                                <field name="date_updated" readonly="1"/>
                            </group>
                            <div class="alert alert-info" role="alert">
                                <p><strong>GDPR Compliance:</strong></p>
                                <ul>
                                    <li>IP Address: Required for online consent verification</li>
                                    <li>Consent Source: Document where/how consent was obtained</li>
                                    <li>Date Updated: Automatic tracking of preference changes</li>
                                    <li>Consent Method: How the consent was collected</li>
                                </ul>
                            </div>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Communication Preference Search View -->
    <record id="view_ams_communication_preference_search" model="ir.ui.view">
        <field name="name">ams.communication.preference.search</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <search string="Search Communication Preferences">
                <field name="partner_id"/>
                <field name="communication_type"/>
                <field name="category"/>
                <field name="consent_source"/>
                
                <!-- Quick Filters -->
                <filter string="Opted In" name="opted_in" 
                        domain="[('opted_in', '=', True)]"/>
                <filter string="Opted Out" name="opted_out" 
                        domain="[('opted_in', '=', False)]"/>
                
                <separator/>
                
                <filter string="Email" name="email" 
                        domain="[('communication_type', '=', 'email')]"/>
                <filter string="SMS" name="sms" 
                        domain="[('communication_type', '=', 'sms')]"/>
                <filter string="Mail" name="mail" 
                        domain="[('communication_type', '=', 'mail')]"/>
                <filter string="Phone" name="phone" 
                        domain="[('communication_type', '=', 'phone')]"/>
                
                <separator/>
                
                <filter string="Marketing" name="marketing" 
                        domain="[('category', '=', 'marketing')]"/>
                <filter string="Membership" name="membership" 
                        domain="[('category', '=', 'membership')]"/>
                <filter string="Events" name="events" 
                        domain="[('category', '=', 'events')]"/>
                <filter string="Education" name="education" 
                        domain="[('category', '=', 'education')]"/>
                <filter string="Committee" name="committee" 
                        domain="[('category', '=', 'committee')]"/>
                <filter string="Fundraising" name="fundraising" 
                        domain="[('category', '=', 'fundraising')]"/>
                <filter string="Emergency" name="emergency" 
                        domain="[('category', '=', 'emergency')]"/>
                
                <separator/>
                
                <filter string="Members Only" name="members_only" 
                        domain="[('is_member', '=', True)]"/>
                <filter string="Recent Updates" name="recent_updates" 
                        domain="[('date_updated', '>=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Partner" name="group_partner" 
                            context="{'group_by': 'partner_id'}"/>
                    <filter string="Communication Type" name="group_type" 
                            context="{'group_by': 'communication_type'}"/>
                    <filter string="Category" name="group_category" 
                            context="{'group_by': 'category'}"/>
                    <filter string="Opted In Status" name="group_opted_in" 
                            context="{'group_by': 'opted_in'}"/>
                    <filter string="Consent Method" name="group_consent_method" 
                            context="{'group_by': 'consent_method'}"/>
                    <filter string="Date Updated" name="group_date" 
                            context="{'group_by': 'date_updated:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Communication Preference Kanban View -->
    <record id="view_ams_communication_preference_kanban" model="ir.ui.view">
        <field name="name">ams.communication.preference.kanban</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_small_column">
                <field name="partner_id"/>
                <field name="communication_type"/>
                <field name="category"/>
                <field name="opted_in"/>
                <field name="date_updated"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top mb8">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="partner_id"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_subtitle text-muted">
                                        <t t-esc="record.communication_type.value"/> - <t t-esc="record.category.value"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-12">
                                            <span t-if="record.opted_in.raw_value" 
                                                  class="badge badge-success">Opted In</span>
                                            <span t-if="!record.opted_in.raw_value" 
                                                  class="badge badge-danger">Opted Out</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span class="text-muted">
                                            Updated: <field name="date_updated" widget="date"/>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Communication Preference Pivot View -->
    <record id="view_ams_communication_preference_pivot" model="ir.ui.view">
        <field name="name">ams.communication.preference.pivot</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <pivot string="Communication Preferences Analysis">
                <field name="communication_type" type="col"/>
                <field name="category" type="row"/>
                <field name="opted_in" type="measure"/>
            </pivot>
        </field>
    </record>

    <!-- Communication Preference Graph View -->
    <record id="view_ams_communication_preference_graph" model="ir.ui.view">
        <field name="name">ams.communication.preference.graph</field>
        <field name="model">ams.communication.preference</field>
        <field name="arch" type="xml">
            <graph string="Communication Preferences Chart" type="bar">
                <field name="category" type="row"/>
                <field name="opted_in" type="measure"/>
            </graph>
        </field>
    </record>

    <!-- Main Action for Communication Preferences -->
    <record id="action_ams_communication_preference" model="ir.actions.act_window">
        <field name="name">Communication Preferences</field>
        <field name="res_model">ams.communication.preference</field>
        <field name="view_mode">list,kanban,form,pivot,graph</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No communication preferences found
            </p>
            <p>
                Communication preferences control how and when members receive 
                different types of communications from your association.
            </p>
            <p>
                Each member can have specific preferences for different communication
                types (email, SMS, mail, phone) and categories (marketing, membership,
                events, education, etc.).
            </p>
        </field>
    </record>

    <!-- Action for Opted Out Preferences -->
    <record id="action_ams_communication_preference_opted_out" model="ir.actions.act_window">
        <field name="name">Opted Out Communications</field>
        <field name="res_model">ams.communication.preference</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('opted_in', '=', False)]</field>
        <field name="context">{'search_default_opted_out': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No opt-outs found - great engagement!
            </p>
            <p>
                This view shows members who have opted out of specific communication
                types or categories. Use this to understand member communication 
                preferences and identify potential issues.
            </p>
        </field>
    </record>

    <!-- Action for Marketing Opt-Outs -->
    <record id="action_ams_communication_preference_marketing_optout" model="ir.actions.act_window">
        <field name="name">Marketing Opt-Outs</field>
        <field name="res_model">ams.communication.preference</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('category', '=', 'marketing'), ('opted_in', '=', False)]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No marketing opt-outs found
            </p>
            <p>
                Members who have opted out of marketing communications. 
                Respect these preferences to maintain member trust and 
                comply with communication regulations.
            </p>
        </field>
    </record>

    <!-- Server Action: Create Default Preferences -->
    <record id="action_server_create_default_preferences" model="ir.actions.server">
        <field name="name">Create Default Communication Preferences</field>
        <field name="model_id" ref="base.model_res_partner"/>
        <field name="binding_model_id" ref="base.model_res_partner"/>
        <field name="state">code</field>
        <field name="code">
if records:
    for partner in records:
        if partner.member_type_id and not partner.communication_preference_ids:
            partner.create_default_communication_preferences()
        </field>
    </record>

    <!-- Server Action: Opt Out All Marketing -->
    <record id="action_server_opt_out_marketing" model="ir.actions.server">
        <field name="name">Opt Out of All Marketing</field>
        <field name="model_id" ref="base.model_res_partner"/>
        <field name="binding_model_id" ref="base.model_res_partner"/>
        <field name="state">code</field>
        <field name="code">
if records:
    for partner in records:
        partner.opt_out_all_marketing()
        </field>
    </record>

    <!-- Menu Items -->
    <menuitem id="menu_ams_communication" 
              name="Communication" 
              parent="ams_system_config.menu_ams_root" 
              sequence="50"/>

    <menuitem id="menu_ams_communication_preferences" 
              name="Member Preferences" 
              parent="menu_ams_communication" 
              action="action_ams_communication_preference" 
              sequence="10"/>

    <menuitem id="menu_ams_communication_optouts" 
              name="Opt-Outs" 
              parent="menu_ams_communication" 
              action="action_ams_communication_preference_opted_out" 
              sequence="20"/>

    <!-- Reports Menu (will be populated by other modules) -->
    <menuitem id="menu_ams_communication_reports" 
              name="Reports" 
              parent="menu_ams_communication" 
              sequence="90"/>

</odoo>