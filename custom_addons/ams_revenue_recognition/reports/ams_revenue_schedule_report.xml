<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Revenue Schedule Analysis Report -->
    <record id="action_report_revenue_schedule_analysis" model="ir.actions.report">
        <field name="name">Revenue Schedule Analysis</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ams_revenue_recognition.report_revenue_schedule_analysis</field>
        <field name="report_file">ams_revenue_recognition.report_revenue_schedule_analysis</field>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="ams_revenue_recognition.paperformat_revenue_recognition"/>
    </record>

    <!-- Revenue Schedule Analysis Template -->
    <template id="report_revenue_schedule_analysis">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <h2>Revenue Schedule Analysis Report</h2>
                    <h4>Generated on <span t-esc="context_today().strftime('%B %d, %Y')"/></h4>
                    
                    <!-- Summary Statistics -->
                    <h3>Summary Statistics</h3>
                    <div class="row">
                        <div class="col-6">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td><strong>Total Schedules</strong></td>
                                        <td class="text-right"><span t-esc="len(docs)"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Active Schedules</strong></td>
                                        <td class="text-right">
                                            <span t-esc="len(docs.filtered(lambda s: s.state == 'active'))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Completed Schedules</strong></td>
                                        <td class="text-right">
                                            <span t-esc="len(docs.filtered(lambda s: s.state == 'completed'))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Paused Schedules</strong></td>
                                        <td class="text-right">
                                            <span t-esc="len(docs.filtered(lambda s: s.state == 'paused'))"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-6">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td><strong>Total Contract Value</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(sum(docs.mapped('total_contract_value')))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Recognized</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(sum(docs.mapped('recognized_revenue')))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Deferred</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(sum(docs.mapped('deferred_revenue_balance')))"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Average Completion</strong></td>
                                        <td class="text-right">
                                            <span t-esc="'{:.1f}%'.format(sum(docs.mapped('completion_percentage')) / len(docs) if docs else 0)"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Schedule Breakdown by Status -->
                    <h3>Schedule Breakdown by Status</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th class="text-right">Count</th>
                                <th class="text-right">Total Contract Value</th>
                                <th class="text-right">Recognized Revenue</th>
                                <th class="text-right">Deferred Balance</th>
                                <th class="text-right">Avg Completion %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="['active', 'completed', 'paused', 'cancelled']" t-as="status">
                                <t t-set="status_schedules" t-value="docs.filtered(lambda s: s.state == status)"/>
                                <tr t-if="status_schedules">
                                    <td><span t-esc="status.title()"/></td>
                                    <td class="text-right"><span t-esc="len(status_schedules)"/></td>
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(sum(status_schedules.mapped('total_contract_value')))"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(sum(status_schedules.mapped('recognized_revenue')))"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(sum(status_schedules.mapped('deferred_revenue_balance')))"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="'{:.1f}%'.format(sum(status_schedules.mapped('completion_percentage')) / len(status_schedules) if status_schedules else 0)"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- Recognition Method Analysis -->
                    <h3>Recognition Method Analysis</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Recognition Method</th>
                                <th class="text-right">Count</th>
                                <th class="text-right">Total Contract Value</th>
                                <th class="text-right">Average Contract Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="docs.mapped('recognition_method')" t-as="method">
                                <t t-set="method_schedules" t-value="docs.filtered(lambda s: s.recognition_method == method)"/>
                                <tr>
                                    <td><span t-esc="method.replace('_', ' ').title()"/></td>
                                    <td class="text-right"><span t-esc="len(method_schedules)"/></td>
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(sum(method_schedules.mapped('total_contract_value')))"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="'{:,.2f}'.format(sum(method_schedules.mapped('total_contract_value')) / len(method_schedules) if method_schedules else 0)"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <div style="page-break-before: always;"></div>

                    <!-- Detailed Schedule Listing -->
                    <h3>Detailed Schedule Listing</h3>
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Schedule Name</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th class="text-right">Contract Value</th>
                                <th class="text-right">Recognized</th>
                                <th class="text-right">% Complete</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="docs.sorted('start_date')" t-as="schedule">
                                <tr>
                                    <td><span t-field="schedule.name"/></td>
                                    <td><span t-field="schedule.partner_id.name"/></td>
                                    <td><span t-field="schedule.product_id.name"/></td>
                                    <td>
                                        <span t-field="schedule.state" 
                                              t-attf-class="badge badge-#{schedule.state == 'active' and 'success' or schedule.state == 'completed' and 'primary' or schedule.state == 'paused' and 'warning' or 'secondary'}"/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="schedule.total_contract_value" 
                                              t-options='{"widget": "monetary", "display_currency": schedule.company_id.currency_id}'/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="schedule.recognized_revenue" 
                                              t-options='{"widget": "monetary", "display_currency": schedule.company_id.currency_id}'/>
                                    </td>
                                    <td class="text-right">
                                        <span t-esc="'{:.1f}%'.format(schedule.completion_percentage)"/>
                                    </td>
                                    <td><span t-field="schedule.start_date"/></td>
                                    <td><span t-field="schedule.end_date"/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>

                    <!-- Recognition Timeline -->
                    <h3>Recognition Timeline (Next 6 Months)</h3>
                    <t t-set="future_recognitions" t-value="docs.env['ams.revenue.recognition'].search([
                        ('state', '=', 'draft'),
                        ('recognition_date', '>=', context_today()),
                        ('recognition_date', '<=', (context_today() + relativedelta(months=6)).strftime('%Y-%m-%d')),
                        ('schedule_id', 'in', docs.ids)
                    ]).sorted('recognition_date')"/>
                    
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Recognition Date</th>
                                <th>Schedule</th>
                                <th>Customer</th>
                                <th class="text-right">Planned Amount</th>
                                <th class="text-right">Period</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="future_recognitions" t-as="recognition">
                                <tr>
                                    <td><span t-field="recognition.recognition_date"/></td>
                                    <td><span t-field="recognition.schedule_id.name"/></td>
                                    <td><span t-field="recognition.partner_id.name"/></td>
                                    <td class="text-right">
                                        <span t-field="recognition.planned_amount" 
                                              t-options='{"widget": "monetary", "display_currency": recognition.schedule_id.company_id.currency_id}'/>
                                    </td>
                                    <td class="text-right">
                                        <span t-field="recognition.period_number"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Total Future Recognition (6 months)</th>
                                <th class="text-right">
                                    <span t-esc="'{:,.2f}'.format(sum(future_recognitions.mapped('planned_amount')))"/>
                                </th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

    <!-- Individual Schedule Performance Report -->
    <record id="action_report_schedule_performance" model="ir.actions.report">
        <field name="name">Schedule Performance Report</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">ams_revenue_recognition.report_schedule_performance</field>
        <field name="report_file">ams_revenue_recognition.report_schedule_performance</field>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="ams_revenue_recognition.paperformat_revenue_recognition"/>
    </record>

    <!-- Schedule Performance Template -->
    <template id="report_schedule_performance">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        
                        <h2>Schedule Performance Report</h2>
                        <h3><span t-field="doc.name"/></h3>
                        
                        <!-- Key Performance Indicators -->
                        <div class="row mt32 mb32">
                            <div class="col-3 text-center">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h4 class="text-primary">
                                            <span t-esc="'{:.1f}%'.format(doc.completion_percentage)"/>
                                        </h4>
                                        <p class="card-text">Completion Rate</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card border-success">
                                    <div class="card-body">
                                        <h4 class="text-success">
                                            <span t-esc="'{:,.0f}'.format(doc.recognized_revenue)"/>
                                        </h4>
                                        <p class="card-text">Recognized Revenue</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card border-warning">
                                    <div class="card-body">
                                        <h4 class="text-warning">
                                            <span t-esc="'{:,.0f}'.format(doc.deferred_revenue_balance)"/>
                                        </h4>
                                        <p class="card-text">Deferred Balance</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-3 text-center">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h4 class="text-info">
                                            <span t-field="doc.periods_completed"/>/<span t-field="doc.period_count"/>
                                        </h4>
                                        <p class="card-text">Periods Complete</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Information -->
                        <div class="row">
                            <div class="col-6">
                                <h4>Schedule Details</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Customer:</strong></td>
                                        <td><span t-field="doc.partner_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Product:</strong></td>
                                        <td><span t-field="doc.product_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Subscription:</strong></td>
                                        <td><span t-field="doc.subscription_id.name"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Performance Obligation:</strong></td>
                                        <td><span t-field="doc.performance_obligation_id"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Status:</strong></td>
                                        <td><span t-field="doc.state"/></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-6">
                                <h4>Recognition Settings</h4>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Start Date:</strong></td>
                                        <td><span t-field="doc.start_date"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>End Date:</strong></td>
                                        <td><span t-field="doc.end_date"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Recognition Method:</strong></td>
                                        <td><span t-field="doc.recognition_method"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Recognition Frequency:</strong></td>
                                        <td><span t-field="doc.recognition_frequency"/></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Auto Recognition:</strong></td>
                                        <td><span t-esc="'Yes' if doc.is_auto_recognition else 'No'"/></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Recognition Progress Chart -->
                        <h4>Recognition Progress</h4>
                        <div class="progress mb-3" style="height: 30px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 t-attf-style="width: #{doc.completion_percentage}%" 
                                 t-attf-aria-valuenow="#{doc.completion_percentage}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                <span t-esc="'{:.1f}%'.format(doc.completion_percentage)"/> Complete
                            </div>
                        </div>

                        <!-- Monthly Recognition Analysis -->
                        <h4>Monthly Recognition Analysis</h4>
                        <t t-set="monthly_recognitions" t-value="{}"/>
                        <t t-foreach="doc.recognition_ids.filtered(lambda r: r.state == 'posted')" t-as="recognition">
                            <t t-set="month_key" t-value="recognition.recognition_date.strftime('%Y-%m')"/>
                            <t t-if="month_key not in monthly_recognitions" t-set="monthly_recognitions" t-value="monthly_recognitions.update({month_key: {'amount': 0, 'count': 0}}) or monthly_recognitions"/>
                            <t t-set="monthly_recognitions" t-value="monthly_recognitions.update({month_key: {'amount': monthly_recognitions[month_key]['amount'] + recognition.recognized_amount, 'count': monthly_recognitions[month_key]['count'] + 1}}) or monthly_recognitions"/>
                        </t>

                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th class="text-right">Recognized Amount</th>
                                    <th class="text-right">Recognition Count</th>
                                    <th class="text-right">Average per Recognition</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="sorted(monthly_recognitions.keys())" t-as="month">
                                    <t t-set="month_data" t-value="monthly_recognitions[month]"/>
                                    <tr>
                                        <td><span t-esc="month"/></td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(month_data['amount'])"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="month_data['count']"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(month_data['amount'] / month_data['count'] if month_data['count'] > 0 else 0)"/>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>

                        <!-- Modifications Impact -->
                        <t t-if="doc.modification_ids">
                            <h4>Contract Modifications Impact</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Modification Date</th>
                                        <th>Type</th>
                                        <th class="text-right">Value Change</th>
                                        <th class="text-right">Adjustment Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.modification_ids.sorted('modification_date')" t-as="modification">
                                        <tr>
                                            <td><span t-field="modification.modification_date"/></td>
                                            <td><span t-field="modification.modification_type"/></td>
                                            <td class="text-right">
                                                <span t-field="modification.value_change" 
                                                      t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/>
                                            </td>
                                            <td class="text-right">
                                                <span t-field="modification.adjustment_amount" 
                                                      t-options='{"widget": "monetary", "display_currency": doc.company_id.currency_id}'/>
                                            </td>
                                            <td><span t-field="modification.state"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="2">Total Impact</th>
                                        <th class="text-right">
                                            <span t-esc="'{:,.2f}'.format(sum(doc.modification_ids.mapped('value_change')))"/>
                                        </th>
                                        <th class="text-right">
                                            <span t-esc="'{:,.2f}'.format(sum(doc.modification_ids.mapped('adjustment_amount')))"/>
                                        </th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </t>

                        <div class="oe_structure"/>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>