<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Manual Recognition Wizard Form View -->
    <record id="view_ams_recognition_manual_wizard_form" model="ir.ui.view">
        <field name="name">ams.recognition.manual.wizard.form</field>
        <field name="model">ams.recognition.manual.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="oe_title">
                        <h1>Manual Revenue Recognition</h1>
                        <p>Create revenue recognition entries manually for special circumstances.</p>
                    </div>

                    <!-- Validation Warnings -->
                    <div class="alert alert-warning" role="alert" invisible="not exceeds_remaining">
                        <strong><i class="fa fa-exclamation-triangle"/> Exceeds Remaining Contract Value</strong>
                        <p>The recognition amount exceeds the remaining unrecognized contract value.</p>
                    </div>

                    <div class="alert alert-info" role="alert" invisible="not future_dated">
                        <strong><i class="fa fa-info-circle"/> Future Recognition Date</strong>
                        <p>This recognition is dated in the future. Manager approval may be required.</p>
                    </div>

                    <group string="Revenue Schedule">
                        <field name="schedule_id" options="{'no_create': True}"/>
                        <field name="subscription_id" readonly="1"/>
                        <field name="partner_id" readonly="1"/>
                        <field name="remaining_contract_value" readonly="1"/>
                    </group>

                    <group string="Recognition Mode">
                        <field name="recognition_mode" widget="radio"/>
                    </group>

                    <!-- Single Recognition -->
                    <group string="Single Recognition" invisible="recognition_mode != 'single'">
                        <field name="recognition_date"/>
                        <field name="recognition_amount"/>
                    </group>

                    <!-- Batch Recognition -->
                    <group string="Batch Recognition" invisible="recognition_mode != 'batch'">
                        <group>
                            <field name="batch_start_date"/>
                            <field name="batch_end_date"/>
                            <field name="batch_frequency"/>
                        </group>
                        <group>
                            <field name="batch_amount_per_period"/>
                        </group>
                    </group>

                    <!-- Catch-up Recognition -->
                    <group string="Catch-up Recognition" invisible="recognition_mode != 'catch_up'">
                        <field name="catch_up_through_date"/>
                        <field name="catch_up_method"/>
                    </group>

                    <!-- Milestone Recognition -->
                    <group string="Milestone Recognition" invisible="recognition_mode != 'milestone'">
                        <group>
                            <field name="milestone_description"/>
                            <field name="milestone_percentage"/>
                        </group>
                        <group>
                            <field name="milestone_amount" readonly="1"/>
                            <field name="recognition_date"/>
                        </group>
                    </group>

                    <group string="Processing Options">
                        <group>
                            <field name="create_journal_entry"/>
                            <field name="post_immediately"/>
                        </group>
                        <group>
                            <field name="override_validation" 
                                   groups="ams_revenue_recognition.group_ams_revenue_recognition_manager"/>
                        </group>
                    </group>

                    <group string="Recognition Details">
                        <field name="recognition_reason"/>
                        <field name="detailed_notes" nolabel="1" placeholder="Provide detailed explanation for this manual recognition..."/>
                    </group>

                    <group string="Preview" col="4">
                        <field name="total_amount_to_recognize" readonly="1"/>
                        <field name="entries_to_create" readonly="1"/>
                        <field name="exceeds_remaining" invisible="1"/>
                        <field name="future_dated" invisible="1"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_validate_and_preview" string="Preview" type="object" class="btn-secondary"/>
                    <button name="action_create_recognition" string="Create Recognition" type="object" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Manual Recognition Preview Form View -->
    <record id="view_ams_recognition_manual_preview_form" model="ir.ui.view">
        <field name="name">ams.recognition.manual.preview.form</field>
        <field name="model">ams.recognition.manual.preview</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="oe_title">
                        <h1>Manual Recognition Preview</h1>
                        <p>Review the manual recognition details before creating.</p>
                    </div>

                    <group string="Recognition Summary">
                        <field name="wizard_id" invisible="1"/>
                        <field name="preview_data" readonly="1" widget="text"/>
                    </group>

                    <div class="alert alert-info" role="alert">
                        <strong>What will be created:</strong>
                        <ul>
                            <li>Recognition Mode: <t t-esc="wizard_id.recognition_mode.title()"/></li>
                            <li>Revenue Schedule: <t t-esc="wizard_id.schedule_id.name"/></li>
                            <li>Total Amount: $<t t-esc="'{:,.2f}'.format(wizard_id.total_amount_to_recognize)"/></li>
                            <li>Number of Entries: <t t-esc="wizard_id.entries_to_create"/></li>
                            <li t-if="wizard_id.recognition_mode == 'single'">
                                Recognition Date: <t t-esc="wizard_id.recognition_date"/>
                            </li>
                            <li t-if="wizard_id.recognition_mode == 'batch'">
                                Period: <t t-esc="wizard_id.batch_start_date"/> to <t t-esc="wizard_id.batch_end_date"/>
                            </li>
                            <li t-if="wizard_id.recognition_mode == 'milestone'">
                                Milestone: <t t-esc="wizard_id.milestone_description"/> (<t t-esc="wizard_id.milestone_percentage"/>%)
                            </li>
                            <li t-if="wizard_id.post_immediately">
                                Entries will be posted immediately
                            </li>
                        </ul>
                    </div>

                    <div class="alert alert-warning" role="alert" t-if="wizard_id.exceeds_remaining">
                        <strong>Warning:</strong> This recognition exceeds the remaining contract value.
                    </div>

                    <div class="alert alert-info" role="alert" t-if="wizard_id.future_dated">
                        <strong>Note:</strong> This recognition includes future-dated entries.
                    </div>
                </sheet>
                <footer>
                    <button name="action_create_recognition" string="Create Recognition" type="object" class="btn-primary"/>
                    <button name="action_back_to_wizard" string="Back to Wizard" type="object" class="btn-secondary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Manual Recognition Wizard Action -->
    <record id="action_ams_recognition_manual_wizard" model="ir.actions.act_window">
        <field name="name">Manual Revenue Recognition</field>
        <field name="res_model">ams.recognition.manual.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="groups_id" eval="[(4, ref('ams_revenue_recognition.group_ams_revenue_recognition_user'))]"/>
    </record>

    <!-- Server Action for Quick Manual Recognition -->
    <record id="action_server_manual_recognition_from_schedule" model="ir.actions.server">
        <field name="name">Create Manual Recognition</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# Open manual recognition wizard for selected schedules
if records:
    context = {
        'default_recognition_mode': 'single',
        'default_recognition_reason': 'manual_adjustment',
    }
    
    if len(records) == 1:
        context['default_schedule_id'] = records[0].id
        context['default_recognition_amount'] = records[0].daily_recognition_amount
        context['default_batch_amount_per_period'] = records[0].monthly_recognition_amount
    
    action = {
        'type': 'ir.actions.act_window',
        'name': 'Manual Revenue Recognition',
        'res_model': 'ams.recognition.manual.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': context,
    }
        </field>
    </record>

    <!-- Catch-up Recognition Server Action -->
    <record id="action_server_catch_up_recognition" model="ir.actions.server">
        <field name="name">Catch-up Recognition</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
# Open catch-up recognition wizard for selected schedules
if records:
    context = {
        'default_recognition_mode': 'catch_up',
        'default_recognition_reason': 'catch_up_processing',
        'default_catch_up_method': 'prorated',
    }
    
    if len(records) == 1:
        context['default_schedule_id'] = records[0].id
        context['default_catch_up_through_date'] = fields.Date.today()
    
    action = {
        'type': 'ir.actions.act_window',
        'name': 'Catch-up Revenue Recognition',
        'res_model': 'ams.recognition.manual.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': context,
    }
        </field>
    </record>

    <!-- Milestone Recognition Server Action -->
    <record id="action_server_milestone_recognition" model="ir.actions.server">
        <field name="name">Milestone Recognition</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# Open milestone recognition wizard for selected schedules
if records:
    context = {
        'default_recognition_mode': 'milestone',
        'default_recognition_reason': 'milestone_completion',
    }
    
    if len(records) == 1:
        context['default_schedule_id'] = records[0].id
        context['default_milestone_percentage'] = 25.0  # Default 25% milestone
    
    action = {
        'type': 'ir.actions.act_window',
        'name': 'Milestone Revenue Recognition',
        'res_model': 'ams.recognition.manual.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': context,
    }
        </field>
    </record>
</odoo>