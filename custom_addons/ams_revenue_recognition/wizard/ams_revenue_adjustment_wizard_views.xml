<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Revenue Adjustment Wizard Form View -->
    <record id="view_ams_revenue_adjustment_wizard_form" model="ir.ui.view">
        <field name="name">ams.revenue.adjustment.wizard.form</field>
        <field name="model">ams.revenue.adjustment.wizard</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="oe_title">
                        <h1>Revenue Recognition Adjustment</h1>
                        <p>Make adjustments to revenue recognition entries for compliance and corrections.</p>
                    </div>

                    <!-- High Impact Warning -->
                    <div class="alert alert-warning" role="alert" invisible="not requires_approval">
                        <strong><i class="fa fa-exclamation-triangle"/> High Impact Adjustment</strong>
                        <p>This adjustment has a total impact of $<span t-field="total_impact_amount"/> and requires manager approval.</p>
                    </div>

                    <group string="Adjustment Target">
                        <field name="adjustment_target" widget="radio"/>
                        <field name="schedule_id" invisible="adjustment_target != 'schedule'" 
                               options="{'no_create': True}" required="adjustment_target == 'schedule'"/>
                        <field name="recognition_id" invisible="adjustment_target != 'recognition'" 
                               options="{'no_create': True}" required="adjustment_target == 'recognition'"/>
                    </group>

                    <group string="Period Range" invisible="adjustment_target != 'period'">
                        <field name="period_start_date" required="adjustment_target == 'period'"/>
                        <field name="period_end_date" required="adjustment_target == 'period'"/>
                    </group>

                    <group>
                        <group string="Adjustment Type">
                            <field name="adjustment_type" widget="radio"/>
                            <field name="adjustment_reason"/>
                        </group>
                        <group string="Impact Assessment">
                            <field name="affected_entries_count" readonly="1"/>
                            <field name="total_impact_amount" readonly="1"/>
                            <field name="requires_approval" readonly="1"/>
                        </group>
                    </group>

                    <group string="Amount Adjustment" invisible="adjustment_type != 'amount'">
                        <group>
                            <field name="original_amount" readonly="1"/>
                            <field name="new_amount"/>
                        </group>
                        <group>
                            <field name="adjustment_amount" readonly="1"/>
                        </group>
                    </group>

                    <group string="Date Adjustment" invisible="adjustment_type != 'date'">
                        <field name="original_date" readonly="1"/>
                        <field name="new_date"/>
                    </group>

                    <group string="Reversal Options" invisible="adjustment_type != 'reverse'">
                        <field name="create_reversal_entry"/>
                    </group>

                    <group string="Split Recognition" invisible="adjustment_type != 'split'">
                        <field name="split_amounts" placeholder="e.g., 1000, 2000, 1500"/>
                        <field name="split_dates" placeholder="e.g., 2024-01-15, 2024-02-15, 2024-03-15"/>
                    </group>

                    <group string="Processing Options">
                        <field name="post_immediately"/>
                        <field name="create_journal_entry"/>
                    </group>

                    <group string="Explanation">
                        <field name="detailed_reason" nolabel="1" placeholder="Provide a detailed explanation for this adjustment..." required="1"/>
                    </group>
                </sheet>
                <footer>
                    <button name="action_preview_adjustment" string="Preview" type="object" class="btn-secondary"/>
                    <button name="action_apply_adjustment" string="Apply Adjustment" type="object" class="btn-primary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Revenue Adjustment Preview Form View -->
    <record id="view_ams_revenue_adjustment_preview_form" model="ir.ui.view">
        <field name="name">ams.revenue.adjustment.preview.form</field>
        <field name="model">ams.revenue.adjustment.preview</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <div class="oe_title">
                        <h1>Adjustment Preview</h1>
                        <p>Review the adjustment details before applying.</p>
                    </div>

                    <group string="Adjustment Summary">
                        <field name="wizard_id" invisible="1"/>
                        <field name="preview_data" readonly="1" widget="text"/>
                    </group>

                    <div class="alert alert-info" role="alert">
                        <strong>What will happen:</strong>
                        <ul>
                            <li t-if="wizard_id.adjustment_type == 'amount'">
                                Revenue recognition amounts will be adjusted from $<t t-esc="wizard_id.original_amount"/> to $<t t-esc="wizard_id.new_amount"/>
                            </li>
                            <li t-if="wizard_id.adjustment_type == 'date'">
                                Recognition dates will be changed from <t t-esc="wizard_id.original_date"/> to <t t-esc="wizard_id.new_date"/>
                            </li>
                            <li t-if="wizard_id.adjustment_type == 'reverse'">
                                Revenue recognition entries will be reversed
                            </li>
                            <li t-if="wizard_id.create_journal_entry">
                                Journal entries will be created automatically
                            </li>
                            <li t-if="wizard_id.post_immediately">
                                Adjustments will be posted immediately
                            </li>
                        </ul>
                    </div>

                    <div class="alert alert-warning" role="alert" t-if="wizard_id.requires_approval">
                        <strong>Manager Approval Required</strong>
                        <p>This adjustment requires manager approval due to its high financial impact.</p>
                    </div>
                </sheet>
                <footer>
                    <button name="action_apply_adjustment" string="Apply Adjustment" type="object" class="btn-primary"/>
                    <button name="action_back_to_wizard" string="Back to Wizard" type="object" class="btn-secondary"/>
                    <button string="Cancel" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Revenue Adjustment Wizard Action -->
    <record id="action_ams_revenue_adjustment_wizard" model="ir.actions.act_window">
        <field name="name">Revenue Recognition Adjustment</field>
        <field name="res_model">ams.revenue.adjustment.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="groups_id" eval="[(4, ref('ams_revenue_recognition.group_ams_revenue_recognition_user'))]"/>
    </record>

    <!-- Server Action for Quick Revenue Adjustment -->
    <record id="action_server_quick_revenue_adjustment" model="ir.actions.server">
        <field name="name">Adjust Revenue Recognition</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="binding_model_id" ref="model_ams_revenue_recognition"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# Open revenue adjustment wizard for selected records
if records:
    context = {
        'default_adjustment_target': 'recognition',
        'default_adjustment_type': 'amount',
    }
    
    if len(records) == 1:
        context['default_recognition_id'] = records[0].id
        context['default_original_amount'] = records[0].recognized_amount
        context['default_new_amount'] = records[0].recognized_amount
        context['default_original_date'] = records[0].recognition_date
    
    action = {
        'type': 'ir.actions.act_window',
        'name': 'Adjust Revenue Recognition',
        'res_model': 'ams.revenue.adjustment.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': context,
    }
        </field>
    </record>

    <!-- Server Action for Schedule Adjustment -->
    <record id="action_server_schedule_adjustment" model="ir.actions.server">
        <field name="name">Adjust Revenue Schedule</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_model_id" ref="model_ams_revenue_schedule"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# Open revenue adjustment wizard for selected schedules
if records:
    context = {
        'default_adjustment_target': 'schedule',
        'default_adjustment_type': 'amount',
    }
    
    if len(records) == 1:
        context['default_schedule_id'] = records[0].id
        context['default_period_start_date'] = records[0].start_date
        context['default_period_end_date'] = records[0].end_date
    
    action = {
        'type': 'ir.actions.act_window',
        'name': 'Adjust Revenue Schedule',
        'res_model': 'ams.revenue.adjustment.wizard',
        'view_mode': 'form',
        'target': 'new',
        'context': context,
    }
        </field>
    </record>
</odoo>