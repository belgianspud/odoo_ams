<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Revenue Schedule Form View -->
    <record id="view_ams_revenue_schedule_form" model="ir.ui.view">
        <field name="name">ams.revenue.schedule.form</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_activate" string="Activate" type="object" 
                            invisible="state != 'draft'" class="btn-primary"/>
                    <button name="action_pause" string="Pause" type="object" 
                            invisible="state != 'active'" class="btn-warning"/>
                    <button name="action_resume" string="Resume" type="object" 
                            invisible="state != 'paused'" class="btn-success"/>
                    <button name="action_complete" string="Complete" type="object" 
                            invisible="state not in ['active', 'paused']" class="btn-info"/>
                    <button name="action_cancel" string="Cancel" type="object" 
                            invisible="state in ['completed', 'cancelled']" class="btn-danger"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,active,paused,completed,cancelled"/>
                </header>
                <sheet>
                    <!-- Smart Buttons -->
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_recognitions" type="object" class="oe_stat_button" icon="fa-calendar-check-o">
                            <field name="periods_completed" widget="statinfo" string="Completed"/>
                        </button>
                        <button name="action_view_recognitions" type="object" class="oe_stat_button" icon="fa-calendar-o">
                            <field name="periods_remaining" widget="statinfo" string="Remaining"/>
                        </button>
                        <button name="action_view_modifications" type="object" class="oe_stat_button" icon="fa-edit" 
                                invisible="not modification_ids">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value"><t t-esc="len(modification_ids)"/></span>
                                <span class="o_stat_text">Modifications</span>
                            </div>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" class="o_text_overflow" style="width: 70%"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Basic Information">
                            <field name="subscription_id" options="{'no_create': True}"/>
                            <field name="partner_id" readonly="1"/>
                            <field name="product_id" readonly="1"/>
                            <field name="total_contract_value"/>
                        </group>
                        <group string="Recognition Method">
                            <field name="recognition_method"/>
                            <field name="recognition_frequency"/>
                            <field name="is_auto_recognition"/>
                            <field name="performance_obligation_id"/>
                        </group>
                    </group>

                    <group>
                        <group string="Schedule Dates">
                            <field name="start_date"/>
                            <field name="end_date"/>
                            <field name="last_recognition_date" readonly="1"/>
                            <field name="next_recognition_date" readonly="1"/>
                        </group>
                        <group string="Progress & Statistics">
                            <field name="period_count" readonly="1"/>
                            <field name="completion_percentage" widget="progressbar" readonly="1"/>
                            <field name="daily_recognition_amount" readonly="1"/>
                            <field name="monthly_recognition_amount" readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group string="Revenue Amounts">
                            <field name="recognized_revenue" readonly="1"/>
                            <field name="remaining_revenue" readonly="1"/>
                            <field name="deferred_revenue_balance" readonly="1"/>
                        </group>
                        <group string="Accounting References">
                            <field name="deferred_account_id" options="{'no_create': True}"/>
                            <field name="revenue_account_id" options="{'no_create': True}"/>
                            <field name="invoice_id" readonly="1"/>
                            <field name="invoice_line_id" readonly="1"/>
                        </group>
                    </group>

                    <group string="Advanced Settings" groups="ams_revenue_recognition.group_ams_revenue_recognition_manager">
                        <group>
                            <field name="is_prorated"/>
                            <field name="proration_factor"/>
                            <field name="original_schedule_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="contract_start_date"/>
                            <field name="contract_end_date"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Recognition Entries">
                            <field name="recognition_ids">
                                <tree decoration-success="state == 'posted'" decoration-muted="state == 'cancelled'" decoration-danger="state == 'error'">
                                    <field name="recognition_date"/>
                                    <field name="planned_amount"/>
                                    <field name="recognized_amount"/>
                                    <field name="state"/>
                                    <field name="is_adjustment"/>
                                    <field name="period_number"/>
                                    <field name="is_final_period"/>
                                    <button name="action_recognize" string="Recognize" type="object" 
                                            icon="fa-play" invisible="state != 'draft'" class="btn-sm btn-primary"/>
                                    <button name="action_cancel" string="Cancel" type="object" 
                                            icon="fa-times" invisible="state != 'draft'" class="btn-sm btn-secondary"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Contract Modifications" invisible="not modification_ids">
                            <field name="modification_ids">
                                <tree decoration-info="state == 'draft'" decoration-success="state == 'processed'">
                                    <field name="modification_date"/>
                                    <field name="modification_type"/>
                                    <field name="original_contract_value"/>
                                    <field name="new_contract_value"/>
                                    <field name="adjustment_amount"/>
                                    <field name="state"/>
                                    <button name="action_validate" string="Validate" type="object" 
                                            icon="fa-check" invisible="state != 'draft'" class="btn-sm btn-primary"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- Revenue Schedule Tree View -->
    <record id="view_ams_revenue_schedule_tree" model="ir.ui.view">
        <field name="name">ams.revenue.schedule.tree</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="arch" type="xml">
            <tree decoration-success="state == 'active'" decoration-info="state == 'paused'" 
                  decoration-muted="state in ['completed', 'cancelled']">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="subscription_id"/>
                <field name="total_contract_value"/>
                <field name="recognition_method"/>
                <field name="start_date"/>
                <field name="end_date"/>
                <field name="completion_percentage" widget="progressbar"/>
                <field name="deferred_revenue_balance"/>
                <field name="state"/>
                <field name="next_recognition_date"/>
            </tree>
        </field>
    </record>

    <!-- Revenue Schedule Search View -->
    <record id="view_ams_revenue_schedule_search" model="ir.ui.view">
        <field name="name">ams.revenue.schedule.search</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="subscription_id"/>
                <field name="product_id"/>
                <field name="performance_obligation_id"/>
                
                <filter name="filter_active" string="Active" domain="[('state', '=', 'active')]"/>
                <filter name="filter_paused" string="Paused" domain="[('state', '=', 'paused')]"/>
                <filter name="filter_completed" string="Completed" domain="[('state', '=', 'completed')]"/>
                <filter name="filter_cancelled" string="Cancelled" domain="[('state', '=', 'cancelled')]"/>
                
                <separator/>
                <filter name="filter_auto_recognition" string="Auto Recognition" domain="[('is_auto_recognition', '=', True)]"/>
                <filter name="filter_manual_recognition" string="Manual Recognition" domain="[('is_auto_recognition', '=', False)]"/>
                <filter name="filter_prorated" string="Prorated" domain="[('is_prorated', '=', True)]"/>
                
                <separator/>
                <filter name="filter_recognition_due" string="Recognition Due" 
                        domain="[('next_recognition_date', '&lt;=', context_today()), ('state', '=', 'active')]"/>
                <filter name="filter_high_value" string="High Value (&gt;$10K)" 
                        domain="[('total_contract_value', '&gt;=', 10000)]"/>
                
                <separator/>
                <group expand="0" string="Group By">
                    <filter name="group_by_state" string="Status" domain="[]" context="{'group_by': 'state'}"/>
                    <filter name="group_by_partner" string="Customer" domain="[]" context="{'group_by': 'partner_id'}"/>
                    <filter name="group_by_product" string="Product" domain="[]" context="{'group_by': 'product_id'}"/>
                    <filter name="group_by_method" string="Recognition Method" domain="[]" context="{'group_by': 'recognition_method'}"/>
                    <filter name="group_by_frequency" string="Recognition Frequency" domain="[]" context="{'group_by': 'recognition_frequency'}"/>
                    <filter name="group_by_start_month" string="Start Month" domain="[]" context="{'group_by': 'start_date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Revenue Schedule Kanban View -->
    <record id="view_ams_revenue_schedule_kanban" model="ir.ui.view">
        <field name="name">ams.revenue.schedule.kanban</field>
        <field name="model">ams.revenue.schedule</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state" class="o_kanban_small_column">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="subscription_id"/>
                <field name="total_contract_value"/>
                <field name="completion_percentage"/>
                <field name="deferred_revenue_balance"/>
                <field name="state"/>
                <field name="next_recognition_date"/>
                <field name="recognition_method"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_title">
                                    <strong><field name="name"/></strong>
                                </div>
                                <div class="o_kanban_record_subtitle">
                                    <field name="partner_id"/>
                                </div>
                                <div class="o_kanban_record_body">
                                    <span class="badge" 
                                          t-attf-class="badge-#{record.recognition_method.raw_value == 'immediate' ? 'success' : 'primary'}">
                                        <field name="recognition_method"/>
                                    </span>
                                    <br/>
                                    <small>
                                        Contract Value: $<t t-esc="record.total_contract_value.value.toFixed(2)"/>
                                    </small>
                                    <br/>
                                    <small>
                                        Deferred: $<t t-esc="record.deferred_revenue_balance.value.toFixed(2)"/>
                                    </small>
                                    <div class="mt-2">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar" 
                                                 t-attf-style="width: #{record.completion_percentage.value}%"
                                                 t-attf-title="#{record.completion_percentage.value}% Complete"/>
                                        </div>
                                        <small><t t-esc="Math.round(record.completion_percentage.value)"/>% Complete</small>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <t t-if="record.next_recognition_date.value">
                                            <small>Next: <field name="next_recognition_date"/></small>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Revenue Schedule Action -->
    <record id="action_ams_revenue_schedule" model="ir.actions.act_window">
        <field name="name">Revenue Schedules</field>
        <field name="res_model">ams.revenue.schedule</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="context">{'search_default_filter_active': 1}</field>
    </record>

    <!-- Active Revenue Schedules Action -->
    <record id="action_ams_revenue_schedule_active" model="ir.actions.act_window">
        <field name="name">Active Revenue Schedules</field>
        <field name="res_model">ams.revenue.schedule</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('state', '=', 'active')]</field>
        <field name="context">{'default_state': 'active'}</field>
    </record>

    <!-- Recognition Due Action -->
    <record id="action_ams_revenue_schedule_due" model="ir.actions.act_window">
        <field name="name">Revenue Recognition Due</field>
        <field name="res_model">ams.revenue.schedule</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('next_recognition_date', '&lt;=', context_today()), ('state', '=', 'active')]</field>
        <field name="context">{'search_default_filter_recognition_due': 1}</field>
    </record>
</odoo>