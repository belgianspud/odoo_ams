<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- FIXED: Define all actions FIRST, then menu items that reference them -->
    
    <!-- Enhanced Invoice Action for AMS -->
    <record id="action_move_ams_invoices" model="ir.actions.act_window">
        <field name="name">AMS Invoices</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('move_type', '=', 'out_invoice'), ('has_ams_products', '=', True)]</field>
        <field name="context">{
            'default_move_type': 'out_invoice',
            'search_default_has_ams_products': 1
        }</field>
    </record>

    <!-- FIXED: Action for products with deferred revenue (define before menu) -->
    <record id="action_products_with_deferred_revenue" model="ir.actions.act_window">
        <field name="name">Products with Deferred Revenue</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('revenue_recognition_method', '=', 'deferred')]</field>
        <field name="context">{
            'search_default_filter_deferred_recognition': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No products with deferred revenue found!
            </p>
            <p>
                This view shows subscription products that use deferred revenue recognition.
                Monitor deferred revenue balances and processing status.
            </p>
        </field>
    </record>

    <!-- FIXED: Action for products needing review (define before menu) -->
    <record id="action_products_needing_review" model="ir.actions.act_window">
        <field name="name">Products Needing Recognition Review</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('use_ams_accounting', '=', True)]</field>
        <field name="context">{
            'search_default_filter_auto_recognition': 1,
            'search_default_group_by_recognition_method': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Review product revenue recognition settings!
            </p>
            <p>
                Use this view to review and configure revenue recognition for subscription products.
            </p>
        </field>
    </record>

    <!-- NOW define menu items that reference the actions above -->
    
    <!-- Revenue Recognition Menu Items -->
    <!-- Add to existing AMS Accounting menu structure -->
    
    <!-- Revenue Recognition Schedules -->
    <menuitem id="menu_ams_revenue_schedules"
              name="Revenue Schedules"
              parent="ams_base_accounting.menu_ams_accounting"
              action="action_ams_revenue_schedule"
              sequence="30"/>

    <!-- Revenue Recognition Entries -->
    <menuitem id="menu_ams_revenue_recognition_entries"
              name="Recognition Entries"
              parent="ams_base_accounting.menu_ams_accounting"
              action="action_ams_revenue_recognition"
              sequence="31"/>

    <!-- Due Revenue Recognition -->
    <menuitem id="menu_ams_revenue_recognition_due"
              name="Recognition Due"
              parent="ams_base_accounting.menu_ams_accounting"
              action="action_ams_revenue_recognition_due"
              sequence="32"/>

    <!-- Revenue Recognition Dashboard -->
    <menuitem id="menu_ams_revenue_recognition_dashboard"
              name="Recognition Dashboard"
              parent="ams_base_accounting.menu_ams_accounting"
              action="action_ams_revenue_recognition_dashboard"
              sequence="33"/>

    <!-- Reporting Menu Items -->
    <menuitem id="menu_ams_revenue_reporting"
              name="Revenue Reporting"
              parent="ams_base_accounting.menu_ams_accounting"
              sequence="40"/>

    <!-- Products with Revenue Recognition -->
    <menuitem id="menu_ams_products_revenue_recognition"
              name="Products - Revenue Recognition"
              parent="menu_ams_revenue_reporting"
              action="action_product_revenue_recognition"
              sequence="10"/>

    <!-- Subscriptions with Revenue Recognition -->
    <menuitem id="menu_ams_subscriptions_revenue_recognition"
              name="Subscriptions - Revenue Recognition"
              parent="menu_ams_revenue_reporting"
              action="action_subscription_revenue_recognition_dashboard"
              sequence="20"/>

    <!-- Invoices with Revenue Recognition -->
    <menuitem id="menu_ams_invoices_revenue_recognition"
              name="Invoices - Revenue Recognition"
              parent="menu_ams_revenue_reporting"
              action="action_invoice_revenue_recognition"
              sequence="30"/>

    <!-- Invoice Lines Needing Recognition -->
    <menuitem id="menu_ams_invoice_lines_need_recognition"
              name="Lines Needing Recognition"
              parent="menu_ams_revenue_reporting"
              action="action_invoice_lines_need_revenue_recognition"
              sequence="40"/>

    <!-- FIXED: Now we can safely reference the action defined above -->
    <menuitem id="menu_ams_products_with_deferred_revenue"
              name="Products with Deferred Revenue"
              parent="menu_ams_revenue_reporting"
              action="action_products_with_deferred_revenue"
              sequence="50"/>

    <!-- Add to AMS Members section for easy access to subscription revenue -->
    <menuitem id="menu_ams_subscription_revenue_schedules"
              name="Revenue Recognition"
              parent="ams_subscriptions.menu_ams_members"
              action="action_subscription_revenue_recognition_dashboard"
              sequence="40"/>

</odoo>