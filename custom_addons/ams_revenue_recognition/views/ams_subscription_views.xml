<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extend AMS Subscription Form with Revenue Recognition -->
    <record id="view_ams_subscription_form_revenue_recognition" model="ir.ui.view">
        <field name="name">ams.subscription.form.revenue.recognition</field>
        <field name="model">ams.subscription</field>
        <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_form"/>
        <field name="arch" type="xml">
            <!-- Add Revenue Recognition tab after existing tabs -->
            <xpath expr="//notebook" position="inside">
                <page string="Revenue Recognition" invisible="recognition_status == 'none'">
                    <div class="alert alert-success" role="alert" invisible="recognition_status != 'completed'">
                        <h6><i class="fa fa-check-circle"/> Revenue Recognition Completed</h6>
                        <p>All revenue for this subscription has been recognized.</p>
                    </div>
                    
                    <div class="alert alert-info" role="alert" invisible="recognition_status != 'active'">
                        <h6><i class="fa fa-play-circle"/> Revenue Recognition Active</h6>
                        <p>Revenue recognition is active with <field name="active_schedules_count" readonly="1"/> schedule(s).</p>
                        <p>Next recognition date: <field name="next_recognition_date" readonly="1"/></p>
                    </div>
                    
                    <div class="alert alert-warning" role="alert" invisible="recognition_status != 'pending'">
                        <h6><i class="fa fa-clock-o"/> Revenue Recognition Pending</h6>
                        <p>Revenue recognition schedules need to be created or activated.</p>
                        <button name="action_create_recognition_schedules" type="object" 
                                class="btn btn-primary btn-sm">
                            <i class="fa fa-plus"/> Create Recognition Schedules
                        </button>
                    </div>
                    
                    <group>
                        <group string="Recognition Status">
                            <field name="recognition_status" readonly="1"/>
                            <field name="next_recognition_date" readonly="1"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                        <group string="Revenue Amounts">
                            <field name="total_deferred_revenue" readonly="1"/>
                            <field name="total_recognized_revenue" readonly="1"/>
                            <field name="active_schedules_count" readonly="1"/>
                        </group>
                    </group>
                    
                    <div class="oe_button_box" name="revenue_recognition_buttons">
                        <button name="action_view_revenue_schedules" type="object" 
                                class="oe_stat_button" icon="fa-calendar-o"
                                invisible="active_schedules_count == 0">
                            <field name="active_schedules_count" widget="statinfo" string="Schedules"/>
                        </button>
                        <button name="action_process_recognition" type="object" 
                                class="oe_stat_button" icon="fa-play"
                                invisible="recognition_status != 'active'">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Process</span>
                                <span class="o_stat_text">Recognition</span>
                            </div>
                        </button>
                    </div>
                    
                    <group string="Revenue Recognition Schedules">
                        <field name="revenue_schedule_ids" nolabel="1">
                            <list>
                                <field name="display_name"/>
                                <field name="recognition_method"/>
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="total_amount" sum="Total"/>
                                <field name="recognized_amount" sum="Recognized"/>
                                <field name="deferred_amount" sum="Deferred"/>
                                <field name="state"/>
                            </list>
                        </field>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend AMS Subscription Tree View -->
    <record id="view_ams_subscription_tree_revenue_recognition" model="ir.ui.view">
        <field name="name">ams.subscription.tree.revenue.recognition</field>
        <field name="model">ams.subscription</field>
        <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="before">
                <field name="recognition_status" string="Recognition" optional="hide"/>
                <field name="total_deferred_revenue" string="Deferred" optional="hide" sum="Total Deferred"/>
                <field name="next_recognition_date" string="Next Recognition" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Extend AMS Subscription Search View -->
    <record id="view_ams_subscription_search_revenue_recognition" model="ir.ui.view">
        <field name="name">ams.subscription.search.revenue.recognition</field>
        <field name="model">ams.subscription</field>
        <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_search"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='filter_suspended']" position="after">
                <separator/>
                <filter name="filter_recognition_pending" string="Recognition Pending" 
                        domain="[('recognition_status', '=', 'pending')]"/>
                <filter name="filter_recognition_active" string="Recognition Active" 
                        domain="[('recognition_status', '=', 'active')]"/>
                <filter name="filter_recognition_completed" string="Recognition Completed" 
                        domain="[('recognition_status', '=', 'completed')]"/>
                <filter name="filter_has_deferred_revenue" string="Has Deferred Revenue" 
                        domain="[('total_deferred_revenue', '>', 0)]"/>
                <filter name="filter_recognition_due" string="Recognition Due Today" 
                        domain="[('next_recognition_date', '&lt;=', context_today().strftime('%Y-%m-%d'))]"/>
            </xpath>
            
            <xpath expr="//group[@expand='0']" position="inside">
                <filter name="group_by_recognition_status" string="Recognition Status" 
                        domain="[]" context="{'group_by': 'recognition_status'}"/>
            </xpath>
        </field>
    </record>

    <!-- Subscription Revenue Recognition Dashboard Action -->
    <record id="action_subscription_revenue_recognition_dashboard" model="ir.actions.act_window">
        <field name="name">Subscriptions - Revenue Recognition</field>
        <field name="res_model">ams.subscription</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('recognition_status', '!=', 'none')]</field>
        <field name="context">{
            'search_default_filter_recognition_active': 1,
            'search_default_group_by_recognition_status': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No subscriptions with revenue recognition found!
            </p>
            <p>
                This view shows subscriptions that have revenue recognition enabled.
                Monitor recognition status and process due recognitions.
            </p>
        </field>
    </record>

</odoo>