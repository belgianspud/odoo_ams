<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extend Account Move Form with Revenue Recognition -->
    <record id="view_account_move_form_revenue_recognition" model="ir.ui.view">
        <field name="name">account.move.form.revenue.recognition</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="ams_base_accounting.view_account_move_form_ams"/>
        <field name="arch" type="xml">
            <!-- Add Revenue Recognition fields after AMS fields -->
            <xpath expr="//field[@name='has_ams_products']" position="after">
                <field name="has_revenue_recognition" invisible="1"/>
                <field name="revenue_recognition_status" invisible="not has_revenue_recognition"/>
            </xpath>
        </field>
    </record>

    <!-- Add Revenue Recognition tab to Invoice Form -->
    <record id="view_account_move_form_revenue_recognition_tab" model="ir.ui.view">
        <field name="name">account.move.form.revenue.recognition.tab</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//notebook" position="inside">
                <page string="Revenue Recognition" attrs="{'invisible': [('has_revenue_recognition', '=', False)]}">
                    <div class="alert alert-success" role="alert" attrs="{'invisible': [('revenue_recognition_status', '!=', 'completed')]}">
                        <h6><i class="fa fa-check-circle"/> Revenue Recognition Completed</h6>
                        <p>All revenue for this invoice has been recognized.</p>
                    </div>
                    
                    <div class="alert alert-info" role="alert" attrs="{'invisible': [('revenue_recognition_status', '!=', 'active')]}">
                        <h6><i class="fa fa-play-circle"/> Revenue Recognition Active</h6>
                        <p>Revenue recognition schedules are active and processing.</p>
                    </div>
                    
                    <div class="alert alert-warning" role="alert" attrs="{'invisible': [('revenue_recognition_status', '!=', 'pending')]}">
                        <h6><i class="fa fa-clock-o"/> Revenue Recognition Pending</h6>
                        <p>This invoice contains subscription products that need revenue recognition schedules.</p>
                        <button name="action_create_revenue_recognition_schedules" type="object" 
                                class="btn btn-primary btn-sm">
                            <i class="fa fa-plus"/> Create Recognition Schedules
                        </button>
                    </div>
                    
                    <group>
                        <group string="Recognition Summary">
                            <field name="revenue_recognition_status" readonly="1"/>
                            <field name="has_revenue_recognition" invisible="1"/>
                        </group>
                        <group string="Revenue Amounts">
                            <field name="total_deferred_revenue" readonly="1"/>
                            <field name="total_recognized_revenue" readonly="1"/>
                        </group>
                    </group>
                    
                    <div class="oe_button_box" name="revenue_recognition_buttons">
                        <button name="action_view_revenue_schedules" type="object" 
                                class="oe_stat_button" icon="fa-calendar-o"
                                attrs="{'invisible': [('revenue_schedule_ids', '=', [])]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value"><field name="revenue_schedule_ids" widget="statinfo" string="Schedules"/></span>
                                <span class="o_stat_text">Recognition</span>
                                <span class="o_stat_text">Schedules</span>
                            </div>
                        </button>
                        <button name="action_process_revenue_recognition" type="object" 
                                class="oe_stat_button" icon="fa-play"
                                attrs="{'invisible': [('revenue_recognition_status', '!=', 'active')]}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Process</span>
                                <span class="o_stat_text">Recognition</span>
                            </div>
                        </button>
                    </div>
                    
                    <group string="Revenue Recognition Schedules">
                        <field name="revenue_schedule_ids" nolabel="1">
                            <list>
                                <field name="display_name"/>
                                <field name="product_id"/>
                                <field name="recognition_method"/>
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="total_amount" sum="Total"/>
                                <field name="recognized_amount" sum="Recognized"/>
                                <field name="deferred_amount" sum="Deferred"/>
                                <field name="state"/>
                            </list>
                        </field>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend Account Move Tree View -->
    <record id="view_account_move_tree_revenue_recognition" model="ir.ui.view">
        <field name="name">account.move.tree.revenue.recognition</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="ams_base_accounting.view_account_move_tree_ams"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='ams_transaction_type']" position="after">
                <field name="has_revenue_recognition" string="Rev Rec" optional="hide"/>
                <field name="revenue_recognition_status" string="Recognition Status" optional="hide"/>
                <field name="total_deferred_revenue" string="Deferred" optional="hide" sum="Total Deferred"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Account Move Search View -->
    <record id="view_account_move_search_revenue_recognition" model="ir.ui.view">
        <field name="name">account.move.search.revenue.recognition</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="ams_base_accounting.view_account_move_search_ams"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='filter_publication_payments']" position="after">
                <separator/>
                <filter name="filter_has_revenue_recognition" string="Has Revenue Recognition" 
                        domain="[('has_revenue_recognition', '=', True)]"/>
                <filter name="filter_recognition_pending" string="Recognition Pending" 
                        domain="[('revenue_recognition_status', '=', 'pending')]"/>
                <filter name="filter_recognition_active" string="Recognition Active" 
                        domain="[('revenue_recognition_status', '=', 'active')]"/>
                <filter name="filter_recognition_completed" string="Recognition Completed" 
                        domain="[('revenue_recognition_status', '=', 'completed')]"/>
                <filter name="filter_has_deferred_revenue" string="Has Deferred Revenue" 
                        domain="[('total_deferred_revenue', '>', 0)]"/>
            </xpath>
            
            <xpath expr="//group[@expand='0']" position="inside">
                <filter name="group_by_revenue_recognition_status" string="Recognition Status" 
                        domain="[]" context="{'group_by': 'revenue_recognition_status'}"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Account Move Line Form -->
    <record id="view_account_move_line_form_revenue_recognition" model="ir.ui.view">
        <field name="name">account.move.line.form.revenue.recognition</field>
        <field name="model">account.move.line</field>
        <field name="inherit_id" ref="ams_base_accounting.view_account_move_line_form_ams"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='is_ams_line']" position="after">
                <field name="has_revenue_recognition" invisible="1"/>
                <field name="needs_revenue_recognition" invisible="1"/>
                <field name="revenue_schedule_id" invisible="not has_revenue_recognition"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Account Move Line Tree -->
    <record id="view_account_move_line_tree_revenue_recognition" model="ir.ui.view">
        <field name="name">account.move.line.tree.revenue.recognition</field>
        <field name="model">account.move.line</field>
        <field name="inherit_id" ref="ams_base_accounting.view_account_move_line_tree_ams"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='ams_product_type']" position="after">
                <field name="has_revenue_recognition" string="Rev Rec" optional="hide"/>
                <field name="needs_revenue_recognition" string="Needs Rev Rec" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Invoice Revenue Recognition Action -->
    <record id="action_invoice_revenue_recognition" model="ir.actions.act_window">
        <field name="name">Invoices - Revenue Recognition</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('move_type', '=', 'out_invoice'), ('has_revenue_recognition', '=', True)]</field>
        <field name="context">{
            'default_move_type': 'out_invoice',
            'search_default_has_revenue_recognition': 1,
            'search_default_group_by_revenue_recognition_status': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No invoices with revenue recognition found!
            </p>
            <p>
                This view shows invoices that contain subscription products with revenue recognition.
                Monitor recognition status and manage revenue schedules.
            </p>
        </field>
    </record>

    <!-- Invoice Lines Needing Revenue Recognition Action -->
    <record id="action_invoice_lines_need_revenue_recognition" model="ir.actions.act_window">
        <field name="name">Invoice Lines - Need Revenue Recognition</field>
        <field name="res_model">account.move.line</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('needs_revenue_recognition', '=', True)]</field>
        <field name="context">{'search_default_needs_revenue_recognition': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No invoice lines need revenue recognition!
            </p>
            <p>
                This view shows invoice lines from subscription products that need revenue recognition schedules.
                Use this to identify and create missing recognition schedules.
            </p>
        </field>
    </record>

</odoo>