<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extend Product Template Form with Revenue Recognition -->
    <record id="view_product_template_form_revenue_recognition" model="ir.ui.view">
        <field name="name">product.template.form.revenue.recognition</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="ams_base_accounting.view_product_template_form_ams_accounting"/>
        <field name="arch" type="xml">
            <!-- Add Revenue Recognition tab after existing tabs -->
            <xpath expr="//notebook" position="inside">
                <page string="Revenue Recognition" invisible="not is_subscription_product">
                    <div class="alert alert-info" role="alert" invisible="revenue_recognition_method == 'immediate'">
                        <h6><i class="fa fa-info-circle"/> Revenue Recognition Active</h6>
                        <p>This product uses <strong><field name="revenue_recognition_method" readonly="1"/></strong> revenue recognition.</p>
                        <p>Revenue will be recognized over <strong><field name="recognition_period" readonly="1"/></strong> periods.</p>
                    </div>
                    
                    <div class="alert alert-warning" role="alert" invisible="revenue_recognition_method != 'immediate'">
                        <h6><i class="fa fa-bolt"/> Immediate Recognition</h6>
                        <p>Revenue for this product is recognized immediately when invoiced.</p>
                    </div>
                    
                    <group>
                        <group string="Recognition Configuration">
                            <field name="revenue_recognition_method" readonly="1"/>
                            <field name="recognition_period" invisible="revenue_recognition_method == 'immediate'"/>
                            <field name="auto_create_recognition"/>
                            <field name="auto_process_recognition"/>
                        </group>
                        <group string="Revenue Statistics">
                            <field name="total_deferred_revenue" readonly="1"/>
                            <field name="total_recognized_revenue" readonly="1"/>
                            <field name="active_recognition_schedules" readonly="1"/>
                        </group>
                    </group>
                    
                    <div class="oe_button_box" name="revenue_recognition_buttons">
                        <button name="action_view_recognition_schedules" type="object" 
                                class="oe_stat_button" icon="fa-calendar-o"
                                invisible="active_recognition_schedules == 0">
                            <field name="active_recognition_schedules" widget="statinfo" string="Active Schedules"/>
                        </button>
                        <button name="action_process_due_recognitions" type="object" 
                                class="oe_stat_button" icon="fa-play-circle"
                                invisible="active_recognition_schedules == 0">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Process Due</span>
                                <span class="o_stat_text">Recognition</span>
                            </div>
                        </button>
                    </div>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend Product Template List View -->
    <record id="view_product_template_list_revenue_recognition" model="ir.ui.view">
        <field name="name">product.template.list.revenue.recognition</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="ams_base_accounting.view_product_template_tree_ams_accounting"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='ams_accounts_configured']" position="after">
                <field name="revenue_recognition_method" string="Recognition" optional="hide"/>
                <field name="total_deferred_revenue" string="Deferred Revenue" optional="hide" sum="Total Deferred"/>
                <field name="active_recognition_schedules" string="Active Schedules" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Extend Product Template Search View -->
    <record id="view_product_template_search_revenue_recognition" model="ir.ui.view">
        <field name="name">product.template.search.revenue.recognition</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="ams_base_accounting.view_product_template_search_ams_accounting"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='filter_subscription_products']" position="after">
                <separator/>
                <filter name="filter_immediate_recognition" string="Immediate Recognition" 
                        domain="[('revenue_recognition_method', '=', 'immediate')]"/>
                <filter name="filter_deferred_recognition" string="Deferred Recognition" 
                        domain="[('revenue_recognition_method', '=', 'deferred')]"/>
                <filter name="filter_auto_recognition" string="Auto Recognition" 
                        domain="[('auto_create_recognition', '=', True)]"/>
                <filter name="filter_has_deferred_revenue" string="Has Deferred Revenue" 
                        domain="[('total_deferred_revenue', '>', 0)]"/>
            </xpath>
            
            <xpath expr="//group[@expand='0']" position="inside">
                <filter name="group_by_recognition_method" string="Recognition Method" 
                        domain="[]" context="{'group_by': 'revenue_recognition_method'}"/>
            </xpath>
        </field>
    </record>

    <!-- Product Revenue Recognition Action -->
    <record id="action_product_revenue_recognition" model="ir.actions.act_window">
        <field name="name">Products - Revenue Recognition</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('is_subscription_product', '=', True), ('use_ams_accounting', '=', True)]</field>
        <field name="context">{
            'search_default_filter_deferred_recognition': 1,
            'search_default_group_by_recognition_method': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Configure revenue recognition for subscription products!
            </p>
            <p>
                This view shows subscription products with AMS accounting enabled.
                Configure how revenue should be recognized for each product.
            </p>
        </field>
    </record>

</odoo>