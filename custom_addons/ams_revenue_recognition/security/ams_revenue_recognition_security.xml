<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- AMS Revenue Recognition Security Groups -->
    
    <!-- Revenue Recognition Manager Group -->
    <record id="group_ams_revenue_recognition_manager" model="res.groups">
        <field name="name">AMS Revenue Recognition Manager</field>
        <field name="category_id" ref="base.module_category_accounting"/>
        <field name="comment">Full access to AMS revenue recognition features including:
        - Create, modify, and delete recognition schedules
        - Process contract modifications
        - Access to all revenue recognition reports and dashboards
        - Ability to override system controls
        - Manual revenue recognition adjustments</field>
    </record>

    <!-- Revenue Recognition User Group -->
    <record id="group_ams_revenue_recognition_user" model="res.groups">
        <field name="name">AMS Revenue Recognition User</field>
        <field name="category_id" ref="base.module_category_accounting"/>
        <field name="implied_ids" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="comment">Standard access to AMS revenue recognition features including:
        - View recognition schedules and entries
        - Create basic contract modifications
        - Access to standard reports
        - Limited manual adjustment capabilities</field>
    </record>

    <!-- Revenue Recognition Viewer Group -->
    <record id="group_ams_revenue_recognition_viewer" model="res.groups">
        <field name="name">AMS Revenue Recognition Viewer</field>
        <field name="category_id" ref="base.module_category_accounting"/>
        <field name="implied_ids" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="comment">Read-only access to AMS revenue recognition features including:
        - View recognition schedules and entries
        - Access to reports and dashboards
        - No modification capabilities</field>
    </record>

    <!-- Auditor Group (Special access for auditing) -->
    <record id="group_ams_revenue_recognition_auditor" model="res.groups">
        <field name="name">AMS Revenue Recognition Auditor</field>
        <field name="category_id" ref="base.module_category_accounting"/>
        <field name="comment">Auditor access to AMS revenue recognition including:
        - Read-only access to all revenue recognition data
        - Access to audit trails and compliance reports
        - View modification history and journal entries
        - No modification capabilities</field>
    </record>

    <!-- Portal User Access (Customer Self-Service) -->
    <record id="group_ams_revenue_recognition_portal" model="res.groups">
        <field name="name">AMS Revenue Recognition Portal</field>
        <field name="category_id" ref="base.module_category_portal"/>
        <field name="comment">Portal access for customers to view their own revenue recognition information</field>
    </record>

    <!-- Multi-Company Rules -->
    
    <!-- Revenue Schedule Multi-Company Rule -->
    <record id="ams_revenue_schedule_comp_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule Multi-Company</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="domain_force">['|',('company_id','=',False),('company_id', 'in', company_ids)]</field>
    </record>

    <!-- Revenue Recognition Multi-Company Rule -->
    <record id="ams_revenue_recognition_comp_rule" model="ir.rule">
        <field name="name">AMS Revenue Recognition Multi-Company</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="domain_force">['|',('schedule_id.company_id','=',False),('schedule_id.company_id', 'in', company_ids)]</field>
    </record>

    <!-- Contract Modification Multi-Company Rule -->
    <record id="ams_contract_modification_comp_rule" model="ir.rule">
        <field name="name">AMS Contract Modification Multi-Company</field>
        <field name="model_id" ref="model_ams_contract_modification"/>
        <field name="domain_force">['|',('schedule_id.company_id','=',False),('schedule_id.company_id', 'in', company_ids)]</field>
    </record>

    <!-- User Access Rules -->
    
    <!-- Revenue Schedule User Access Rule -->
    <record id="ams_revenue_schedule_user_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule User Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Revenue Schedule Manager Access Rule -->
    <record id="ams_revenue_schedule_manager_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule Manager Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Revenue Schedule Viewer Access Rule -->
    <record id="ams_revenue_schedule_viewer_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule Viewer Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_viewer'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Revenue Recognition Posted Entry Protection -->
    <record id="ams_revenue_recognition_posted_rule" model="ir.rule">
        <field name="name">AMS Revenue Recognition Posted Protection</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('state', '!=', 'posted')]</field>
        <field name="perm_write" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Contract Modification Draft Access Rule -->
    <record id="ams_contract_modification_draft_rule" model="ir.rule">
        <field name="name">AMS Contract Modification Draft Access</field>
        <field name="model_id" ref="model_ams_contract_modification"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('state', 'in', ['draft', 'validated'])]</field>
        <field name="perm_write" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Portal User Access Rules -->
    
    <!-- Portal Revenue Schedule Access -->
    <record id="ams_revenue_schedule_portal_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule Portal Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_portal'))]"/>
        <field name="domain_force">[('partner_id', '=', user.partner_id.id)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Portal Revenue Recognition Access -->
    <record id="ams_revenue_recognition_portal_rule" model="ir.rule">
        <field name="name">AMS Revenue Recognition Portal Access</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_portal'))]"/>
        <field name="domain_force">[('partner_id', '=', user.partner_id.id)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Auditor Access Rules -->
    
    <!-- Auditor Read-Only Access to All Records -->
    <record id="ams_revenue_schedule_auditor_rule" model="ir.rule">
        <field name="name">AMS Revenue Schedule Auditor Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_auditor'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <record id="ams_revenue_recognition_auditor_rule" model="ir.rule">
        <field name="name">AMS Revenue Recognition Auditor Access</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_auditor'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <record id="ams_contract_modification_auditor_rule" model="ir.rule">
        <field name="name">AMS Contract Modification Auditor Access</field>
        <field name="model_id" ref="model_ams_contract_modification"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_auditor'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Field-Level Security -->
    
    <!-- Sensitive Financial Data Access -->
    <record id="revenue_recognition_financial_access" model="ir.rule">
        <field name="name">Revenue Recognition Financial Data Access</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('account.group_account_user'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Journal Entry Access Control -->
    <record id="revenue_recognition_journal_access" model="ir.rule">
        <field name="name">Revenue Recognition Journal Access</field>
        <field name="model_id" ref="account.model_account_move"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('ref', 'ilike', 'Revenue Recognition')]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- State-Based Access Controls -->
    
    <!-- Active Schedule Modification Control -->
    <record id="active_schedule_modification_control" model="ir.rule">
        <field name="name">Active Schedule Modification Control</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('state', '!=', 'completed')]</field>
        <field name="perm_write" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Completed Schedule Protection -->
    <record id="completed_schedule_protection" model="ir.rule">
        <field name="name">Completed Schedule Protection</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[('state', '=', 'completed')]</field>
        <field name="perm_write" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Time-Based Access Controls -->
    
    <!-- Current Period Modification Access -->
    <record id="current_period_modification_access" model="ir.rule">
        <field name="name">Current Period Modification Access</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('recognition_date', '>=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]</field>
        <field name="perm_write" eval="True"/>
    </record>

    <!-- Historical Data Protection -->
    <record id="historical_data_protection" model="ir.rule">
        <field name="name">Historical Data Protection</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[('recognition_date', '&lt;', (context_today() - datetime.timedelta(days=90)).strftime('%Y-%m-%d'))]</field>
        <field name="perm_write" eval="True"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Integration with Existing Odoo Security -->
    
    <!-- Inherit from Accounting Security -->
    <record id="group_ams_revenue_recognition_manager" model="res.groups">
        <field name="implied_ids" eval="[(4, ref('account.group_account_manager'))]"/>
    </record>

    <record id="group_ams_revenue_recognition_user" model="res.groups">
        <field name="implied_ids" eval="[(4, ref('account.group_account_user'))]"/>
    </record>

    <!-- Inherit from AMS Base Security if Available -->
    <record id="group_ams_revenue_recognition_manager" model="res.groups">
        <field name="implied_ids" eval="[(4, ref('ams_base_accounting.group_ams_accounting_manager'))]"/>
    </record>

    <record id="group_ams_revenue_recognition_user" model="res.groups">
        <field name="implied_ids" eval="[(4, ref('ams_base_accounting.group_ams_accounting_user'))]"/>
    </record>

    <!-- Subscription Access Integration -->
    <record id="group_ams_revenue_recognition_user" model="res.groups">
        <field name="implied_ids" eval="[(4, ref('ams_subscriptions.group_ams_subscription_user'))]"/>
    </record>

    <!-- Menu Security -->
    
    <!-- Revenue Recognition Menus -->
    <record id="menu_ams_revenue_recognition_root" model="ir.ui.menu">
        <field name="groups_id" eval="[(4, ref('group_ams_revenue_recognition_viewer'))]"/>
    </record>

    <!-- Configuration Menus (Manager Only) -->
    <record id="menu_ams_revenue_recognition_config" model="ir.ui.menu">
        <field name="groups_id" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
    </record>

    <!-- Report Security -->
    
    <!-- Financial Reports Access -->
    <record id="revenue_recognition_reports_access" model="ir.rule">
        <field name="name">Revenue Recognition Reports Access</field>
        <field name="model_id" ref="base.model_ir_actions_report"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_viewer'))]"/>
        <field name="domain_force">[('report_name', 'ilike', 'ams_revenue_recognition')]</field>
        <field name="perm_read" eval="True"/>
    </record>

    <!-- Compliance and Audit Trail Security -->
    
    <!-- Audit Trail Access -->
    <record id="audit_trail_access" model="ir.rule">
        <field name="name">Revenue Recognition Audit Trail Access</field>
        <field name="model_id" ref="mail.model_mail_message"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_auditor'))]"/>
        <field name="domain_force">[('model', 'in', ['ams.revenue.schedule', 'ams.revenue.recognition', 'ams.contract.modification'])]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Activity Tracking Access -->
    <record id="activity_tracking_access" model="ir.rule">
        <field name="name">Revenue Recognition Activity Access</field>
        <field name="model_id" ref="mail.model_mail_activity"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_user'))]"/>
        <field name="domain_force">[('res_model', 'in', ['ams.revenue.schedule', 'ams.revenue.recognition', 'ams.contract.modification'])]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
    </record>

    <!-- Automated Processing Security -->
    
    <!-- Cron Job Access -->
    <record id="cron_job_access" model="ir.rule">
        <field name="name">Revenue Recognition Cron Access</field>
        <field name="model_id" ref="base.model_ir_cron"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[('name', 'ilike', 'Revenue Recognition')]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <!-- Data Import/Export Security -->
    
    <!-- Export Access Control -->
    <record id="export_access_control" model="ir.rule">
        <field name="name">Revenue Recognition Export Access</field>
        <field name="model_id" ref="model_ams_revenue_recognition"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_export" eval="True"/>
    </record>

    <!-- Import Access Control -->
    <record id="import_access_control" model="ir.rule">
        <field name="name">Revenue Recognition Import Access</field>
        <field name="model_id" ref="model_ams_revenue_schedule"/>
        <field name="groups" eval="[(4, ref('group_ams_revenue_recognition_manager'))]"/>
        <field name="domain_force">[(1,'=',1)]</field>
        <field name="perm_import" eval="True"/>
    </record>

</odoo>