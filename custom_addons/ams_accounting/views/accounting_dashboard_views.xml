<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- AMS Accounting Dashboard Views -->
    
    <!-- Main Dashboard View -->
    <record id="view_ams_accounting_dashboard" model="ir.ui.view">
        <field name="name">ams.accounting.dashboard</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <form string="AMS Accounting Dashboard">
                <sheet>
                    <div class="o_dashboard">
                        <h1 class="o_dashboard_title">AMS Accounting Dashboard</h1>
                        
                        <!-- KPI Cards Row -->
                        <div class="row o_dashboard_section">
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card bg-primary text-white">
                                    <div class="card-body">
                                        <h4>Total Revenue YTD</h4>
                                        <h2 id="total_revenue_ytd">Loading...</h2>
                                        <small>Year to Date</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card bg-success text-white">
                                    <div class="card-body">
                                        <h4>Active Subscriptions</h4>
                                        <h2 id="active_subscriptions">Loading...</h2>
                                        <small>Currently Active</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card bg-warning text-white">
                                    <div class="card-body">
                                        <h4>Outstanding Receivables</h4>
                                        <h2 id="total_receivables">Loading...</h2>
                                        <small>Amount Due</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card bg-info text-white">
                                    <div class="card-body">
                                        <h4>Deferred Revenue</h4>
                                        <h2 id="deferred_revenue">Loading...</h2>
                                        <small>To Be Recognized</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions Row -->
                        <div class="row o_dashboard_section">
                            <div class="col-12">
                                <h3>Quick Actions</h3>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <a href="#" class="btn btn-outline-primary btn-block mb-2" 
                                   data-action="ams_accounting.action_due_revenue_recognition">
                                    <i class="fa fa-clock-o"></i> Process Due Revenue Recognition
                                </a>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <a href="#" class="btn btn-outline-success btn-block mb-2" 
                                   data-action="ams_accounting.action_subscription_accounting_pending">
                                    <i class="fa fa-cog"></i> Setup Pending Accounting
                                </a>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <a href="#" class="btn btn-outline-warning btn-block mb-2" 
                                   data-action="ams_accounting.action_overdue_customers">
                                    <i class="fa fa-exclamation-triangle"></i> View Overdue Customers
                                </a>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <a href="#" class="btn btn-outline-info btn-block mb-2" 
                                   data-action="ams_accounting.action_subscription_revenue_analytics">
                                    <i class="fa fa-bar-chart"></i> Revenue Analytics
                                </a>
                            </div>
                        </div>
                        
                        <!-- Charts and Analytics Row -->
                        <div class="row o_dashboard_section">
                            <div class="col-lg-6 col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Revenue by Subscription Type</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="revenue_by_type_chart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Monthly Revenue Trend</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthly_revenue_chart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity Row -->
                        <div class="row o_dashboard_section">
                            <div class="col-lg-6 col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Recent Revenue Recognition</h5>
                                        <a href="#" class="btn btn-sm btn-outline-primary float-right" 
                                           data-action="ams_accounting.action_ams_revenue_recognition">
                                            View All
                                        </a>
                                    </div>
                                    <div class="card-body">
                                        <div id="recent_revenue_recognition">
                                            Loading recent activity...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Payment Status Summary</h5>
                                        <a href="#" class="btn btn-sm btn-outline-primary float-right" 
                                           data-action="ams_accounting.action_ams_customers">
                                            View All Customers
                                        </a>
                                    </div>
                                    <div class="card-body">
                                        <div id="payment_status_summary">
                                            Loading payment status...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons Row -->
                        <div class="row o_dashboard_section">
                            <div class="col-12">
                                <h3>Management Tools</h3>
                            </div>
                            <div class="col-lg-4 col-md-6 col-sm-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fa fa-users fa-3x text-primary mb-3"></i>
                                        <h5>Customer Management</h5>
                                        <p>Manage AMS customers and their financial status</p>
                                        <a href="#" class="btn btn-primary" 
                                           data-action="ams_accounting.action_ams_customers">
                                            Manage Customers
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 col-sm-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fa fa-cogs fa-3x text-success mb-3"></i>
                                        <h5>Account Mappings</h5>
                                        <p>Configure product to account mappings</p>
                                        <a href="#" class="btn btn-success" 
                                           data-action="ams_accounting.action_product_account_mapping">
                                            Manage Mappings
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6 col-sm-12">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fa fa-line-chart fa-3x text-info mb-3"></i>
                                        <h5>Chart of Accounts</h5>
                                        <p>Manage AMS chart of accounts and templates</p>
                                        <a href="#" class="btn btn-info" 
                                           data-action="ams_accounting.action_ams_account_chart">
                                            Manage Charts
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Financial Summary Dashboard -->
    <record id="view_ams_financial_summary_dashboard" model="ir.ui.view">
        <field name="name">ams.financial.summary.dashboard</field>
        <field name="model">account.move.line</field>
        <field name="arch" type="xml">
            <form string="AMS Financial Summary">
                <sheet>
                    <div class="o_dashboard">
                        <h1 class="o_dashboard_title">AMS Financial Summary</h1>
                        
                        <!-- Financial Overview -->
                        <div class="row o_dashboard_section">
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Total Revenue</h6>
                                        <h4 class="text-success">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Membership Revenue</h6>
                                        <h4 class="text-primary">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Chapter Revenue</h6>
                                        <h4 class="text-info">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Publication Revenue</h6>
                                        <h4 class="text-warning">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Receivables</h6>
                                        <h4 class="text-danger">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6>Deferred Revenue</h6>
                                        <h4 class="text-secondary">$0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Cards -->
                        <div class="row o_dashboard_section">
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6>Revenue Recognition</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>Process scheduled revenue recognition entries</p>
                                        <a href="#" class="btn btn-primary btn-sm" 
                                           data-action="ams_accounting.action_due_revenue_recognition">
                                            Process Now
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6>Account Setup</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>Configure accounting for new subscriptions</p>
                                        <a href="#" class="btn btn-success btn-sm" 
                                           data-action="ams_accounting.action_subscription_accounting_pending">
                                            Setup Accounts
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-white">
                                        <h6>Collections</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>Follow up on overdue customer accounts</p>
                                        <a href="#" class="btn btn-warning btn-sm" 
                                           data-action="ams_accounting.action_overdue_customers">
                                            View Overdue
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6>Analytics</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>View detailed revenue and financial analytics</p>
                                        <a href="#" class="btn btn-info btn-sm" 
                                           data-action="ams_accounting.action_subscription_revenue_analytics">
                                            View Analytics
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Revenue Recognition Dashboard -->
    <record id="view_revenue_recognition_dashboard" model="ir.ui.view">
        <field name="name">revenue.recognition.dashboard</field>
        <field name="model">ams.revenue.recognition</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_dashboard" create="false">
                <field name="recognition_date"/>
                <field name="amount"/>
                <field name="state"/>
                <field name="subscription_id"/>
                <field name="partner_id"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                            <div class="o_kanban_image_fill_left d-none d-md-block" 
                                 t-attf-style="background-color: #{kanban_color(record.state.raw_value)}"/>
                            <div class="oe_kanban_details">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="subscription_id"/>
                                        </strong>
                                        <div class="o_kanban_record_subtitle">
                                            <field name="partner_id"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_manage_button_section">
                                        <span class="badge" 
                                              t-attf-class="badge-#{record.state.raw_value == 'processed' and 'success' or record.state.raw_value == 'scheduled' and 'warning' or 'secondary'}">
                                            <field name="state"/>
                                        </span>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>Amount:</strong> <field name="amount" widget="monetary"/>
                                        </div>
                                        <div class="col-6">
                                            <strong>Date:</strong> <field name="recognition_date"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Actions for Dashboard -->
    <record id="action_ams_accounting_dashboard" model="ir.actions.act_window">
        <field name="name">AMS Accounting Dashboard</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_ams_accounting_dashboard"/>
        <field name="target">current</field>
        <field name="context">{}</field>
    </record>

    <record id="action_ams_financial_summary" model="ir.actions.act_window">
        <field name="name">AMS Financial Summary</field>
        <field name="res_model">account.move.line</field>
        <field name="view_mode">form</field>
        <field name="view_id" ref="view_ams_financial_summary_dashboard"/>
        <field name="target">current</field>
        <field name="domain">[('is_ams_line', '=', True)]</field>
    </record>

    <record id="action_revenue_recognition_dashboard" model="ir.actions.act_window">
        <field name="name">Revenue Recognition Dashboard</field>
        <field name="res_model">ams.revenue.recognition</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="view_id" ref="view_revenue_recognition_dashboard"/>
        <field name="domain">[('state', '=', 'scheduled')]</field>
        <field name="context">{'search_default_scheduled': 1}</field>
    </record>

    <!-- Widget for Dashboard Integration -->
    <template id="dashboard_widget_template">
        <div class="o_dashboard_widget">
            <script type="text/javascript">
                odoo.define('ams_accounting.dashboard', function (require) {
                    'use strict';
                    
                    var core = require('web.core');
                    var Widget = require('web.Widget');
                    var rpc = require('web.rpc');
                    
                    var DashboardWidget = Widget.extend({
                        template: 'ams_accounting.dashboard_widget',
                        
                        init: function (parent, options) {
                            this._super.apply(this, arguments);
                            this.options = options || {};
                        },
                        
                        start: function () {
                            var self = this;
                            return this._super().then(function () {
                                self.load_data();
                                self.setup_click_handlers();
                            });
                        },
                        
                        load_data: function () {
                            var self = this;
                            rpc.query({
                                model: 'ams.subscription',
                                method: 'get_dashboard_data',
                                args: []
                            }).then(function (data) {
                                self.update_dashboard(data);
                            });
                        },
                        
                        update_dashboard: function (data) {
                            $('#total_revenue_ytd').text(data.total_revenue_ytd || '$0.00');
                            $('#active_subscriptions').text(data.active_subscriptions || '0');
                            $('#total_receivables').text(data.total_receivables || '$0.00');
                            $('#deferred_revenue').text(data.deferred_revenue || '$0.00');
                        },
                        
                        setup_click_handlers: function () {
                            this.$('a[data-action]').on('click', function (e) {
                                e.preventDefault();
                                var action = $(this).data('action');
                                if (action) {
                                    self.do_action(action);
                                }
                            });
                        }
                    });
                    
                    return DashboardWidget;
                });
            </script>
        </div>
    </template>
</odoo>