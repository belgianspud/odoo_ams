<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- AMS Chapter Financial Views -->
    
    <!-- Tree View -->
    <record id="view_ams_chapter_financial_tree" model="ir.ui.view">
        <field name="name">ams.chapter.financial.tree</field>
        <field name="model">ams.chapter</field>
        <field name="arch" type="xml">
            <tree string="Chapter Financials" decoration-success="financial_health_score &gt;= 80" decoration-warning="financial_health_score &lt; 60" decoration-danger="budget_status=='critical'">
                <field name="name"/>
                <field name="code"/>
                <field name="active_member_count"/>
                <field name="current_year_revenue" widget="monetary"/>
                <field name="current_year_expenses" widget="monetary"/>
                <field name="chapter_net_income" widget="monetary"/>
                <field name="chapter_profit_margin" widget="percentage"/>
                <field name="budget_utilization" widget="percentage"/>
                <field name="budget_status" widget="badge" decoration-success="budget_status=='on_track'" decoration-warning="budget_status=='over'" decoration-danger="budget_status=='critical'"/>
                <field name="financial_health_score" widget="progressbar"/>
            </tree>
        </field>
    </record>

    <!-- Form View -->
    <record id="view_ams_chapter_financial_form" model="ir.ui.view">
        <field name="name">ams.chapter.financial.form</field>
        <field name="model">ams.chapter</field>
        <field name="arch" type="xml">
            <form string="Chapter Financial Management">
                <header>
                    <button name="action_create_chapter_budget" type="object" string="Create Budget" class="btn-primary"/>
                    <button name="action_view_chapter_financial_report" type="object" string="Financial Report" class="btn-secondary"/>
                    <button name="action_view_chapter_analytics" type="object" string="Analytics" class="btn-secondary"/>
                    <button name="process_parent_allocation" type="object" string="Process Parent Allocation" class="btn-warning" attrs="{'invisible': [('parent_organization_allocation', '=', 0)]}"/>
                    <field name="budget_status" widget="statusbar" statusbar_visible="under,on_track,over,critical"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                        <h2>
                            Chapter Code: <field name="code" readonly="1"/>
                        </h2>
                    </div>
                    
                    <!-- Financial Health Summary -->
                    <div class="alert alert-info" role="alert">
                        <strong>Financial Health Score: </strong>
                        <field name="financial_health_score" widget="progressbar" style="width: 200px; display: inline-block;"/>
                        <span style="margin-left: 10px;"><field name="financial_health_score" widget="float"/> / 100</span>
                    </div>
                    
                    <group>
                        <group name="revenue_summary">
                            <field name="current_year_revenue" widget="monetary"/>
                            <field name="last_year_revenue" widget="monetary"/>
                            <field name="total_chapter_revenue" widget="monetary"/>
                            <field name="revenue_growth_rate" widget="percentage"/>
                        </group>
                        <group name="expense_summary">
                            <field name="current_year_expenses" widget="monetary"/>
                            <field name="total_chapter_expenses" widget="monetary"/>
                            <field name="chapter_net_income" widget="monetary"/>
                            <field name="chapter_profit_margin" widget="percentage"/>
                        </group>
                    </group>
                    
                    <group>
                        <group name="member_metrics">
                            <field name="active_member_count"/>
                            <field name="member_count"/>
                            <field name="total_member_fees_collected" widget="monetary"/>
                            <field name="outstanding_member_fees" widget="monetary"/>
                            <field name="average_member_value" widget="monetary"/>
                            <field name="member_retention_rate" widget="percentage"/>
                        </group>
                        <group name="collection_metrics">
                            <field name="collection_efficiency" widget="percentage"/>
                            <field name="chapter_cash_inflow" widget="monetary"/>
                            <field name="chapter_cash_outflow" widget="monetary"/>
                            <field name="chapter_net_cash_flow" widget="monetary"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Budget Management" name="budget">
                            <group>
                                <group name="budget_info">
                                    <field name="annual_budget" widget="monetary"/>
                                    <field name="budget_utilization" widget="percentage"/>
                                    <field name="budget_variance" widget="monetary"/>
                                    <field name="budget_status" widget="badge"/>
                                </group>
                                <group name="allocations">
                                    <field name="parent_organization_allocation" widget="percentage"/>
                                    <field name="reserve_fund_allocation" widget="percentage"/>
                                </group>
                            </group>
                            
                            <div class="mt16">
                                <button name="action_create_chapter_budget" type="object" string="Create New Budget" class="btn-primary"/>
                            </div>
                        </page>
                        
                        <page string="Accounting Setup" name="accounting">
                            <group>
                                <group name="accounts">
                                    <field name="chapter_account_id"/>
                                    <field name="expense_account_id"/>
                                    <field name="analytic_account_id"/>
                                </group>
                                <group name="banking">
                                    <field name="chapter_bank_account_id"/>
                                    <field name="separate_accounting"/>
                                </group>
                            </group>
                            
                            <div class="mt16" attrs="{'invisible': [('analytic_account_id', '!=', False)]}">
                                <button name="create_analytic_account" type="object" string="Create Analytic Account" class="btn-primary"/>
                                <p class="text-muted">Create an analytic account to track this chapter's finances separately.</p>
                            </div>
                        </page>
                        
                        <page string="Member Subscriptions" name="subscriptions">
                            <field name="subscription_ids" domain="[('subscription_code', '=', 'chapter')]">
                                <tree>
                                    <field name="partner_id"/>
                                    <field name="subscription_type_id"/>
                                    <field name="state"/>
                                    <field name="amount" widget="monetary"/>
                                    <field name="total_invoiced" widget="monetary"/>
                                    <field name="outstanding_balance" widget="monetary"/>
                                    <field name="start_date"/>
                                    <field name="end_date"/>
                                </tree>
                            </field>
                            
                            <div class="mt16">
                                <button name="action_view_member_payments" type="object" string="View All Member Payments" class="btn-primary"/>
                            </div>
                        </page>
                        
                        <page string="Financial Reports" name="reports">
                            <group>
                                <div class="row">
                                    <div class="col-6">
                                        <button name="action_view_chapter_financial_report" type="object" string="Comprehensive Financial Report" class="btn-primary btn-block"/>
                                    </div>
                                    <div class="col-6">
                                        <button name="action_view_chapter_analytics" type="object" string="Detailed Analytics" class="btn-secondary btn-block"/>
                                    </div>
                                </div>
                            </group>
                            
                            <!-- Quick financial overview charts would go here -->
                            <group string="Quick Overview" class="mt16">
                                <div class="row">
                                    <div class="col-4">
                                        <div class="text-center">
                                            <h4>Revenue Growth</h4>
                                            <field name="revenue_growth_rate" widget="percentage" style="font-size: 24px;"/>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <h4>Profit Margin</h4>
                                            <field name="chapter_profit_margin" widget="percentage" style="font-size: 24px;"/>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center">
                                            <h4>Budget Status</h4>
                                            <field name="budget_utilization" widget="percentage" style="font-size: 24px;"/>
                                        </div>
                                    </div>
                                </div>
                            </group>
                        </page>
                        
                        <page string="Cash Flow" name="cash_flow">
                            <group>
                                <group name="cash_inflow">
                                    <label for="chapter_cash_inflow" string="Cash Inflow"/>
                                    <field name="chapter_cash_inflow" widget="monetary"/>
                                </group>
                                <group name="cash_outflow">
                                    <label for="chapter_cash_outflow" string="Cash Outflow"/>
                                    <field name="chapter_cash_outflow" widget="monetary"/>
                                </group>
                            </group>
                            
                            <group>
                                <group name="net_cash_flow">
                                    <label for="chapter_net_cash_flow" string="Net Cash Flow"/>
                                    <field name="chapter_net_cash_flow" widget="monetary" style="font-size: 18px; font-weight: bold;"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_ams_chapter_financial_search" model="ir.ui.view">
        <field name="name">ams.chapter.financial.search</field>
        <field name="model">ams.chapter</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="code"/>
                
                <filter name="profitable_chapters" string="Profitable" domain="[('chapter_net_income', '&gt;', 0)]"/>
                <filter name="loss_making_chapters" string="Loss Making" domain="[('chapter_net_income', '&lt;', 0)]"/>
                <filter name="over_budget" string="Over Budget" domain="[('budget_status', 'in', ['over', 'critical'])]"/>
                <filter name="under_budget" string="Under Budget" domain="[('budget_status', '=', 'under')]"/>
                <filter name="high_health_score" string="Healthy (80+ Score)" domain="[('financial_health_score', '&gt;=', 80)]"/>
                <filter name="low_health_score" string="Needs Attention (&lt;60 Score)" domain="[('financial_health_score', '&lt;', 60)]"/>
                <filter name="has_outstanding" string="Has Outstanding Fees" domain="[('outstanding_member_fees', '&gt;', 0)]"/>
                <filter name="separate_accounting" string="Separate Accounting" domain="[('separate_accounting', '=', True)]"/>
                
                <separator/>
                <filter name="group_by_budget_status" string="Budget Status" context="{'group_by': 'budget_status'}"/>
                <filter name="group_by_region" string="Region" context="{'group_by': 'region'}"/>
            </search>
        </field>
    </record>

    <!-- Kanban View for Dashboard -->
    <record id="view_ams_chapter_financial_kanban" model="ir.ui.view">
        <field name="name">ams.chapter.financial.kanban</field>
        <field name="model">ams.chapter</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="code"/>
                <field name="current_year_revenue"/>
                <field name="chapter_net_income"/>
                <field name="financial_health_score"/>
                <field name="budget_status"/>
                <field name="active_member_count"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card">
                            <div class="oe_kanban_content">
                                <strong><field name="name"/></strong>
                                <div class="text-muted">Code: <field name="code"/></div>
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div><small>Revenue:</small> <field name="current_year_revenue" widget="monetary"/></div>
                                        <div><small>Net Income:</small> <field name="chapter_net_income" widget="monetary"/></div>
                                    </div>
                                    <div class="col-6">
                                        <div><small>Members:</small> <field name="active_member_count"/></div>
                                        <div><small>Health:</small> <field name="financial_health_score"/>%</div>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <field name="financial_health_score" widget="progressbar"/>
                                </div>
                                <div class="mt-2">
                                    <field name="budget_status" widget="badge"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Action -->
    <record id="action_ams_chapter_financial" model="ir.actions.act_window">
        <field name="name">Chapter Financial Management</field>
        <field name="res_model">ams.chapter</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_ids" eval="[(5, 0, 0), (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_ams_chapter_financial_kanban')}), (0, 0, {'view_mode': 'tree', 'view_id': ref('view_ams_chapter_financial_tree')}), (0, 0, {'view_mode': 'form', 'view_id': ref('view_ams_chapter_financial_form')})]"/>
        <field name="search_view_id" ref="view_ams_chapter_financial_search"/>
        <field name="domain">[('active', '=', True)]</field>
        <field name="context">{'search_default_profitable_chapters': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No chapters found with financial data
            </p>
            <p>
                Chapters with members and subscriptions will appear here for financial management.
            </p>
        </field>
    </record>

    <!-- Dashboard Action for Financial Overview -->
    <record id="action_chapter_financial_dashboard" model="ir.actions.act_window">
        <field name="name">Chapter Financial Dashboard</field>
        <field name="res_model">ams.chapter</field>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="view_ams_chapter_financial_kanban"/>
        <field name="domain">[('active', '=', True), ('current_year_revenue', '>', 0)]</field>
    </record>

</odoo>