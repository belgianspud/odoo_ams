<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Extend AMS Subscription Form with Billing Information -->
        <record id="view_ams_subscription_form_billing" model="ir.ui.view">
            <field name="name">ams.subscription.form.billing</field>
            <field name="model">ams.subscription</field>
            <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_form"/>
            <field name="arch" type="xml">
                
                <!-- Add billing buttons to button box -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button name="action_view_billing_schedules" type="object" 
                            class="oe_stat_button" icon="fa-calendar"
                            invisible="not billing_schedule_ids">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value">
                                <field name="billing_schedule_ids" widget="statinfo" string="Schedules"/>
                            </span>
                            <span class="o_stat_text">Billing</span>
                        </div>
                    </button>
                    
                    <button name="action_view_invoices" type="object" 
                            class="oe_stat_button" icon="fa-file-text-o"
                            invisible="not subscription_invoice_ids">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value">
                                <field name="subscription_invoice_ids" widget="statinfo" string="Invoices"/>
                            </span>
                            <span class="o_stat_text">Subscription</span>
                        </div>
                    </button>
                    
                    <button name="action_view_billing_events" type="object" 
                            class="oe_stat_button" icon="fa-bolt"
                            invisible="not billing_event_ids">
                        <div class="o_field_widget o_stat_info">
                            <span class="o_stat_value">
                                <field name="billing_event_ids" widget="statinfo" string="Events"/>
                            </span>
                            <span class="o_stat_text">Billing</span>
                        </div>
                    </button>
                </xpath>
                
                <!-- Add billing status after subscription status -->
                <xpath expr="//field[@name='state']" position="after">
                    <field name="payment_status" invisible="not enable_auto_billing"/>
                    <field name="days_overdue" invisible="not has_overdue_invoices"/>
                </xpath>
                
                <!-- Add Billing tab to notebook -->
                <xpath expr="//notebook" position="inside">
                    <page string="Billing &amp; Payments" invisible="not enable_auto_billing">
                        
                        <!-- Billing Status Section -->
                        <div class="alert alert-success" role="alert" invisible="payment_status != 'current'">
                            <h6><i class="fa fa-check-circle"/> Payment Status: Current</h6>
                            <p>All invoices are paid on time.</p>
                        </div>
                        
                        <div class="alert alert-warning" role="alert" invisible="payment_status != 'pending'">
                            <h6><i class="fa fa-clock-o"/> Payment Status: Pending</h6>
                            <p>Recent invoices are pending payment but not yet overdue.</p>
                        </div>
                        
                        <div class="alert alert-danger" role="alert" invisible="payment_status != 'overdue'">
                            <h6><i class="fa fa-exclamation-triangle"/> Payment Status: Overdue</h6>
                            <p>This customer has overdue invoices (<field name="days_overdue" readonly="1"/> days overdue).</p>
                            <button name="action_send_payment_reminder" type="object" 
                                    class="btn btn-danger btn-sm">
                                <i class="fa fa-envelope"/> Send Payment Reminder
                            </button>
                        </div>
                        
                        <!-- Billing Configuration -->
                        <group>
                            <group string="Billing Configuration">
                                <field name="enable_auto_billing"/>
                                <field name="auto_send_invoices" invisible="not enable_auto_billing"/>
                                <field name="next_billing_date" readonly="1"/>
                                <field name="last_billing_date" readonly="1"/>
                            </group>
                            <group string="Financial Summary">
                                <field name="total_invoiced" readonly="1" widget="monetary"/>
                                <field name="total_paid" readonly="1" widget="monetary"/>
                                <field name="outstanding_balance" readonly="1" widget="monetary"/>
                                <field name="has_overdue_invoices" invisible="1"/>
                            </group>
                        </group>
                        
                        <!-- Billing Actions -->
                        <div class="oe_button_box mt16" invisible="not enable_auto_billing">
                            <button name="action_enable_billing" type="object" 
                                    string="Enable Billing" class="btn-primary"
                                    invisible="enable_auto_billing"/>
                            <button name="action_disable_billing" type="object" 
                                    string="Disable Billing" class="btn-secondary"
                                    invisible="not enable_auto_billing"/>
                            <button name="action_bill_now" type="object" 
                                    string="Bill Now" class="btn-warning"
                                    invisible="not enable_auto_billing or state != 'active'"/>
                        </div>
                        
                        <!-- Billing Schedules -->
                        <separator string="Billing Schedules" invisible="not billing_schedule_ids"/>
                        <field name="billing_schedule_ids" invisible="not billing_schedule_ids" readonly="1">
                            <tree string="Billing Schedules">
                                <field name="name"/>
                                <field name="billing_frequency"/>
                                <field name="next_billing_date"/>
                                <field name="last_billing_date"/>
                                <field name="total_invoices"/>
                                <field name="total_billed_amount" widget="monetary"/>
                                <field name="state" widget="badge"/>
                                <field name="currency_id" column_invisible="1"/>
                            </tree>
                        </field>
                        
                        <!-- Recent Billing Events -->
                        <separator string="Recent Billing Events" invisible="not billing_event_ids"/>
                        <field name="billing_event_ids" invisible="not billing_event_ids" readonly="1" 
                               domain="[('subscription_id', '=', active_id)]" 
                               context="{'default_subscription_id': active_id}">
                            <tree string="Billing Events" limit="10">
                                <field name="name"/>
                                <field name="event_date"/>
                                <field name="event_type"/>
                                <field name="invoice_amount" widget="monetary"/>
                                <field name="invoice_sent" widget="boolean_toggle"/>
                                <field name="state" widget="badge"/>
                                <field name="currency_id" column_invisible="1"/>
                            </tree>
                        </field>
                        
                        <!-- Recent Invoices -->
                        <separator string="Recent Invoices" invisible="not subscription_invoice_ids"/>
                        <field name="subscription_invoice_ids" invisible="not subscription_invoice_ids" readonly="1"
                               domain="[('subscription_id', '=', active_id)]"
                               context="{'default_subscription_id': active_id}">
                            <tree string="Subscription Invoices" limit="10" decoration-danger="is_overdue==True">
                                <field name="name"/>
                                <field name="invoice_date"/>
                                <field name="invoice_date_due"/>
                                <field name="amount_total" widget="monetary"/>
                                <field name="amount_residual" widget="monetary"/>
                                <field name="payment_state" widget="badge"/>
                                <field name="is_overdue" invisible="1"/>
                                <field name="days_overdue" invisible="not is_overdue"/>
                                <field name="currency_id" column_invisible="1"/>
                            </tree>
                        </field>
                        
                    </page>
                </xpath>
                
            </field>
        </record>
        
        <!-- Extend AMS Subscription Tree View -->
        <record id="view_ams_subscription_tree_billing" model="ir.ui.view">
            <field name="name">ams.subscription.tree.billing</field>
            <field name="model">ams.subscription</field>
            <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='state']" position="before">
                    <field name="enable_auto_billing" string="Auto Bill" widget="boolean_toggle" optional="hide"/>
                    <field name="payment_status" string="Payment" optional="show"/>
                    <field name="next_billing_date" string="Next Bill" optional="hide"/>
                    <field name="outstanding_balance" string="Outstanding" widget="monetary" optional="hide" sum="Total Outstanding"/>
                </xpath>
            </field>
        </record>
        
        <!-- Extend AMS Subscription Search View -->
        <record id="view_ams_subscription_search_billing" model="ir.ui.view">
            <field name="name">ams.subscription.search.billing</field>
            <field name="model">ams.subscription</field>
            <field name="inherit_id" ref="ams_subscriptions.view_ams_subscription_search"/>
            <field name="arch" type="xml">
                <xpath expr="//search" position="inside">
                    <separator/>
                    <!-- Billing Status Filters -->
                    <filter name="filter_auto_billing" string="Auto Billing Enabled" 
                            domain="[('enable_auto_billing', '=', True)]"/>
                    <filter name="filter_payment_current" string="Payment Current" 
                            domain="[('payment_status', '=', 'current')]"/>
                    <filter name="filter_payment_overdue" string="Payment Overdue" 
                            domain="[('payment_status', '=', 'overdue')]"/>
                    <filter name="filter_has_outstanding" string="Has Outstanding Balance" 
                            domain="[('outstanding_balance', '>', 0)]"/>
                    
                    <!-- Billing Date Filters -->
                    <separator/>
                    <filter name="filter_billing_due_today" string="Billing Due Today" 
                            domain="[('next_billing_date', '=', context_today())]"/>
                    <filter name="filter_billing_overdue" string="Billing Overdue" 
                            domain="[('next_billing_date', '&lt;', context_today()), ('enable_auto_billing', '=', True)]"/>
                    
                    <!-- Group By -->
                    <group expand="0" string="Group By">
                        <filter name="group_by_payment_status" string="Payment Status" 
                                domain="[]" context="{'group_by': 'payment_status'}"/>
                        <filter name="group_by_next_billing" string="Next Billing Date" 
                                domain="[]" context="{'group_by': 'next_billing_date'}"/>
                    </group>
                </xpath>
            </field>
        </record>
        
        <!-- Subscription Billing Dashboard Action -->
        <record id="action_ams_subscription_billing_dashboard" model="ir.actions.act_window">
            <field name="name">Subscription Billing Dashboard</field>
            <field name="res_model">ams.subscription</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="domain">[('enable_auto_billing', '=', True)]</field>
            <field name="context">{
                'search_default_filter_auto_billing': 1,
                'search_default_group_by_payment_status': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No subscriptions with billing enabled!
                </p>
                <p>
                    Enable auto-billing on your subscriptions to see them here.
                    This dashboard shows all subscriptions with automatic billing configured.
                </p>
            </field>
        </record>
        
        <!-- Overdue Subscriptions Action -->
        <record id="action_ams_subscription_overdue" model="ir.actions.act_window">
            <field name="name">Overdue Subscriptions</field>
            <field name="res_model">ams.subscription</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('payment_status', '=', 'overdue')]</field>
            <field name="context">{'search_default_filter_payment_overdue': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No overdue subscriptions!
                </p>
                <p>
                    This view shows subscriptions with overdue invoices that need attention.
                </p>
            </field>
        </record>
        
    </data>
</odoo>