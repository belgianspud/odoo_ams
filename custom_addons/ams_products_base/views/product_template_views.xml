<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ========================================================================== -->
    <!-- MINIMAL SAFE AMS PRODUCT TEMPLATE FORM VIEW -->
    <!-- ========================================================================== -->
    <record id="product_template_form_view_ams" model="ir.ui.view">
        <field name="name">product.template.form.ams</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            
            <!-- Add AMS Product checkbox to General Information tab -->
            <xpath expr="//field[@name='categ_id']" position="after">
                <field name="inventory_status" readonly="1" invisible="not is_ams_product"/>
                <field name="is_ams_product" string="Enable AMS Features"/>
                <div class="text-muted" invisible="not is_ams_product" style="margin-left: 20px; font-style: italic;">
                    Enables member pricing, digital delivery, and inventory integration
                </div>
                <field name="sku" invisible="not is_ams_product" 
                       placeholder="Leave blank for auto-generation"/>
            </xpath>
            
            <!-- Make the existing AMS Product Type field conditional -->
            <xpath expr="//field[@name='ams_product_type_id']" position="attributes">
                <attribute name="invisible">not is_ams_product</attribute>
            </xpath>
            
            <!-- Add Member Pricing after list price with proper group structure -->
            <xpath expr="//field[@name='list_price']" position="after">
                <group string="Member Pricing" invisible="not is_ams_product" col="2" class="oe_inline">
                    <field name="has_member_pricing" string="Enable Member Pricing" widget="boolean_toggle" 
                           help="Allow different prices for association members vs non-members" colspan="2"/>
                    <field name="member_price" string="Member Price" widget="monetary"
                           invisible="not has_member_pricing" placeholder="Price for association members"/>
                    <field name="non_member_price" string="Non-Member Price" widget="monetary"
                           invisible="not has_member_pricing" placeholder="Price for non-members"/>
                </group>
            </xpath>
            
            <!-- Add a simple AMS tab -->
            <xpath expr="//notebook" position="inside">
                <page string="AMS Features" name="ams_features" invisible="not is_ams_product">
                    <group>
                        <group string="Product Configuration">
                            <field name="is_digital_product" widget="boolean_toggle"/>
                            <field name="stock_controlled" widget="boolean_toggle"/>
                            <field name="requires_membership" widget="boolean_toggle"/>
                            <field name="inventory_status" readonly="1"/>
                        </group>
                        <group string="Digital Content" invisible="not is_digital_product">
                            <field name="digital_download_url" widget="url"/>
                            <field name="digital_attachment_id"/>
                            <field name="auto_fulfill_digital" widget="boolean_toggle"/>
                        </group>
                    </group>
                    
                    <group string="Routes" invisible="not stock_controlled">
                        <field name="ams_fulfillment_route_id"/>
                    </group>
                    
                    <group string="System Information" groups="base.group_system">
                        <group>
                            <field name="legacy_product_id"/>
                            <field name="effective_member_price" readonly="1" widget="monetary"/>
                            <field name="effective_non_member_price" readonly="1" widget="monetary"/>
                        </group>
                    </group>
                </page>
            </xpath>
            
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- ENHANCED PRODUCT TEMPLATE LIST VIEW -->
    <!-- ========================================================================== -->
    <record id="product_template_tree_view_ams" model="ir.ui.view">
        <field name="name">product.template.tree.ams</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='categ_id']" position="after">
                <field name="sku" optional="show"/>
                <field name="is_ams_product" widget="boolean_toggle" optional="hide"/>
                <field name="has_member_pricing" widget="boolean_toggle" optional="hide"/>
                <field name="is_digital_product" widget="boolean_toggle" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- ENHANCED PRODUCT TEMPLATE SEARCH VIEW -->
    <!-- ========================================================================== -->
    <record id="product_template_search_view_ams" model="ir.ui.view">
        <field name="name">product.template.search.ams</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="sku" filter_domain="[('sku', 'ilike', self)]"/>
                <field name="ams_product_type_id"/>
            </xpath>
            
            <xpath expr="//filter[@name='filter_to_sell']" position="after">
                <separator/>
                <filter name="ams_products" string="AMS Products" domain="[('is_ams_product', '=', True)]"/>
                <filter name="member_pricing" string="Member Pricing" domain="[('has_member_pricing', '=', True)]"/>
                <filter name="digital_products" string="Digital Products" domain="[('is_digital_product', '=', True)]"/>
            </xpath>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- AMS PRODUCT ACTIONS -->
    <!-- ========================================================================== -->
    <record id="action_ams_products" model="ir.actions.act_window">
        <field name="name">AMS Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('is_ams_product', '=', True)]</field>
        <field name="context">{'default_is_ams_product': True}</field>
    </record>

    <record id="action_member_pricing_products" model="ir.actions.act_window">
        <field name="name">Member Pricing Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('has_member_pricing', '=', True)]</field>
    </record>

    <record id="action_digital_products" model="ir.actions.act_window">
        <field name="name">Digital Products</field>
        <field name="res_model">product.template</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('is_digital_product', '=', True)]</field>
    </record>

</odoo>